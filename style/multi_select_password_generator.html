<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>现代密码生成器</title>
    <style>
        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-card: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #b8b8d1;
            --accent-primary: #4c6ef5;
            --accent-secondary: #7950f2;
            --success: #51cf66;
            --warning: #ffd43b;
            --error: #ff6b6b; /* Added explicit error color */
            --border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(76, 110, 245, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            background: var(--bg-card);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 40px;
            width: 100%;
            max-width: 480px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 12px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 15px;
        }

        .checkbox-grid {
            display: grid;
            gap: 12px;
        }

        .checkbox-item {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .checkbox-item.checked {
            background: rgba(76, 110, 245, 0.2);
            border-color: var(--accent-primary);
            box-shadow: 0 4px 20px rgba(76, 110, 245, 0.3);
        }

        .checkbox-input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .checkbox-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .checkbox-item.checked .checkbox-custom {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .checkbox-custom::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transform: scale(0);
            transition: var(--transition);
        }

        .checkbox-item.checked .checkbox-custom::after {
            opacity: 1;
            transform: scale(1);
        }

        .checkbox-label {
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            flex: 1;
        }

        .checkbox-description {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 2px;
        }

        .input-wrapper {
            position: relative;
        }

        .form-input {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        .form-input::-webkit-outer-spin-button,
        .form-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(76, 110, 245, 0.2);
            background: rgba(255, 255, 255, 0.1);
        }

        .slider-container {
            margin-top: 12px;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            transition: var(--transition);
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(76, 110, 245, 0.4);
            transition: var(--transition);
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 20px rgba(76, 110, 245, 0.6);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 10px rgba(76, 110, 245, 0.4);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 32px;
        }

        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            box-shadow: 0 4px 20px rgba(76, 110, 245, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(76, 110, 245, 0.6);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .password-output {
            margin-top: 32px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .password-strength {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .strength-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .strength-meter {
            display: flex;
            gap: 4px;
        }

        .strength-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: var(--transition);
        }

        /* Dynamic strength dot colors set by JS */
        .strength-dot.weak { background: var(--error); box-shadow: 0 0 10px rgba(255, 107, 107, 0.5); }
        .strength-dot.medium { background: var(--warning); box-shadow: 0 0 10px rgba(255, 212, 59, 0.5); }
        .strength-dot.strong { background: var(--success); box-shadow: 0 0 10px rgba(81, 207, 102, 0.5); }


        .password-display {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 18px;
            color: var(--text-primary);
            word-break: break-all;
            line-height: 1.5;
            min-height: 60px;
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
        }

        .password-display:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .password-placeholder {
            color: var(--text-secondary);
            font-style: italic;
        }

        .copy-indicator {
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-50%);
            background: var(--success);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: var(--transition);
            pointer-events: none; /* Make sure it doesn't block clicks */
        }

        .copy-indicator.show {
            opacity: 1;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Added specific style for crack time to stand out */
        .stat-item.crack-time .stat-value {
            font-size: 18px; /* Slightly smaller for longer text */
            white-space: nowrap; /* Prevent line breaks for numbers */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .stat-item.crack-time .stat-label {
            white-space: nowrap;
        }


        @media (max-width: 600px) {
            .container {
                padding: 24px;
                margin: 10px;
            }
            
            .title {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 14px;
            }

            .form-input {
                padding: 12px 16px;
                font-size: 14px;
            }

            .btn {
                padding: 12px 18px;
                font-size: 14px;
            }

            .button-group {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-value {
                font-size: 18px;
            }

            .stat-label {
                font-size: 11px;
            }

            .password-display {
                font-size: 16px;
                min-height: 50px;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .icon {
            width: 18px;
            height: 18px;
            display: inline-block;
            vertical-align: middle;
        }

        /* Notification styles */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            opacity: 0; /* Start hidden */
            transition: opacity 0.3s ease-out;
        }
        .notification.show {
            opacity: 1; /* Show when 'show' class is added */
        }
        .notification.info {
            background: var(--accent-primary);
        }
        .notification.warning {
            background: var(--warning);
            color: #333; /* Darker text for better contrast on warning */
        }
        .notification.error {
            background: var(--error);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">密码生成器</h1>
            <p class="subtitle">创建安全、强度高的随机密码</p>
        </div>

        <div class="form-group">
            <label class="form-label">字符类型</label>
            <div class="checkbox-grid">
                <div class="checkbox-item checked" data-type="digits">
                    <input type="checkbox" id="digits" class="checkbox-input" checked aria-label="Include digits">
                    <div class="checkbox-custom"></div>
                    <div>
                        <div class="checkbox-label">数字</div>
                        <div class="checkbox-description">0-9</div>
                    </div>
                </div>
                <div class="checkbox-item checked" data-type="letters">
                    <input type="checkbox" id="letters" class="checkbox-input" checked aria-label="Include letters">
                    <div class="checkbox-custom"></div>
                    <div>
                        <div class="checkbox-label">字母</div>
                        <div class="checkbox-description">a-z, A-Z</div>
                    </div>
                </div>
                <div class="checkbox-item" data-type="special">
                    <input type="checkbox" id="special" class="checkbox-input" aria-label="Include special characters">
                    <div class="checkbox-custom"></div>
                    <div>
                        <div class="checkbox-label">特殊字符</div>
                        <div class="checkbox-description">!@#$%^&*</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">密码长度: <span id="lengthValue">12</span></label>
            <div class="input-wrapper">
                <input type="number" id="passwordLength" class="form-input" min="6" max="64" value="12" aria-label="Password length input">
                <div class="slider-container">
                    <input type="range" id="lengthSlider" class="slider" min="6" max="64" value="12" aria-label="Password length slider">
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" id="generateBtn" aria-label="Generate Password">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                </svg>
                生成密码
            </button>
            <button class="btn btn-secondary" id="copyBtn" aria-label="Copy Password">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
                复制密码
            </button>
        </div>

        <div class="password-output">
            <div class="password-strength">
                <span class="strength-label">密码强度</span>
                <div class="strength-meter">
                    <div class="strength-dot"></div>
                    <div class="strength-dot"></div>
                    <div class="strength-dot"></div>
                    <div class="strength-dot"></div>
                    <div class="strength-dot"></div>
                </div>
            </div>
            <div class="password-display" id="passwordDisplay" aria-live="polite">
                <span class="password-placeholder">点击生成密码按钮开始</span>
            </div>
            <div class="copy-indicator" id="copyIndicator">已复制!</div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="charCount">0</div>
                <div class="stat-label">字符数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="charTypes">0</div>
                <div class="stat-label">字符类型</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="entropy">0</div>
                <div class="stat-label">熵值</div>
            </div>
            <div class="stat-item crack-time">
                <div class="stat-value" id="crackTime">N/A</div>
                <div class="stat-label">破解时间 (GPU)</div>
            </div>
        </div>
    </div>

    <script>
        class PasswordGenerator {
            constructor() {
                this.chars = {
                    digits: '0123456789',
                    letters: 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ',
                    special: '!@#$%^&*()_+-=[]{}|;:,.<>?'
                };
                
                this.currentPassword = '';
                this.initializeElements();
                this.bindEvents();
                // Generate an initial password when the page loads
                this.generateInitialPassword();
            }

            initializeElements() {
                this.checkboxItems = document.querySelectorAll('.checkbox-item');
                this.passwordLengthInput = document.getElementById('passwordLength');
                this.lengthSlider = document.getElementById('lengthSlider');
                this.lengthValue = document.getElementById('lengthValue');
                this.generateBtn = document.getElementById('generateBtn');
                this.copyBtn = document.getElementById('copyBtn');
                this.passwordDisplay = document.getElementById('passwordDisplay');
                this.copyIndicator = document.getElementById('copyIndicator');
                this.strengthDots = document.querySelectorAll('.strength-dot');
                this.charCount = document.getElementById('charCount');
                this.charTypes = document.getElementById('charTypes');
                this.entropy = document.getElementById('entropy');
                this.crackTime = document.getElementById('crackTime'); 
            }

            bindEvents() {
                // Checkbox events
                this.checkboxItems.forEach(item => {
                    const checkbox = item.querySelector('.checkbox-input');
                    
                    item.addEventListener('click', (e) => {
                        // Prevent double-toggling if the actual checkbox is clicked directly
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                        }
                        this.updateCheckboxState(item, checkbox.checked);
                        this.generatePassword(); // Regenerate password on type change, which will call updateStats
                    });

                    checkbox.addEventListener('change', (e) => {
                        this.updateCheckboxState(item, e.target.checked);
                        this.generatePassword(); // Regenerate password on type change, which will call updateStats
                    });
                });

                // Length input events
                this.passwordLengthInput.addEventListener('input', (e) => {
                    // Ensure the input value is within min/max bounds
                    const value = Math.max(parseInt(e.target.min), Math.min(parseInt(e.target.max), parseInt(e.target.value) || parseInt(e.target.min)));
                    this.passwordLengthInput.value = value; 
                    this.lengthSlider.value = value;
                    this.lengthValue.textContent = value;
                    this.generatePassword(); // Regenerate password on length change, which will call updateStats
                });

                this.lengthSlider.addEventListener('input', (e) => {
                    const value = e.target.value;
                    this.passwordLengthInput.value = value;
                    this.lengthValue.textContent = value;
                    this.generatePassword(); // Regenerate password on length change, which will call updateStats
                });

                // Button events
                this.generateBtn.addEventListener('click', () => this.generatePassword());
                this.copyBtn.addEventListener('click', () => this.copyPassword());

                // Password display click to copy
                this.passwordDisplay.addEventListener('click', () => {
                    if (this.currentPassword) {
                        this.copyPassword();
                    }
                });
            }

            updateCheckboxState(item, checked) {
                if (checked) {
                    item.classList.add('checked');
                } else {
                    // Check if at least one checkbox is still checked
                    const checkedCount = Array.from(this.checkboxItems).filter(i => i.querySelector('.checkbox-input').checked).length;
                    if (checkedCount === 0) { // If this is the last one being unchecked
                        item.classList.add('checked'); // Keep it checked
                        item.querySelector('.checkbox-input').checked = true;
                        this.showNotification('至少需要选择一种字符类型', 'warning');
                        return; // Prevent unchecking and stop
                    }
                    item.classList.remove('checked');
                }
            }

            generatePassword() {
                this.showButtonLoading(this.generateBtn);

                // Delay for visual effect and to allow DOM to update before calculations
                setTimeout(() => {
                    const length = parseInt(this.passwordLengthInput.value);
                    let characterSet = '';
                    const selectedTypes = [];

                    // Collect selected character types
                    this.checkboxItems.forEach(item => {
                        const checkbox = item.querySelector('.checkbox-input');
                        if (checkbox.checked) {
                            const type = item.dataset.type;
                            characterSet += this.chars[type];
                            selectedTypes.push(type);
                        }
                    });

                    if (characterSet.length === 0) {
                        this.showNotification('请至少选择一种字符类型', 'error');
                        this.hideButtonLoading(this.generateBtn);
                        this.displayPassword('<span class="password-placeholder">请选择字符类型</span>');
                        this.currentPassword = '';
                        this.updatePasswordStrength('');
                        this.updateStats(0, 0); // Pass 0 for length and charSetSize to reset stats
                        return;
                    }

                    if (length < 6 || length > 64 || isNaN(length)) {
                        this.showNotification('密码长度必须在6到64之间', 'error');
                        this.hideButtonLoading(this.generateBtn);
                        this.displayPassword('<span class="password-placeholder">长度范围错误</span>');
                        this.currentPassword = '';
                        this.updatePasswordStrength('');
                        this.updateStats(0, 0); // Pass 0 for length and charSetSize to reset stats
                        return;
                    }

                    let password = '';
                    
                    // Ensure each selected character type appears at least once
                    // Only apply this logic if length allows for it
                    if (length >= selectedTypes.length) {
                        // Add one character from each selected type
                        selectedTypes.forEach(type => {
                            const chars = this.chars[type];
                            password += chars[Math.floor(Math.random() * chars.length)];
                        });
                    } else {
                        // If length is too short for all selected types, pick randomly from a subset
                        // This ensures 'length' characters are generated, even if not all types are represented
                        const shuffledTypes = selectedTypes.sort(() => Math.random() - 0.5);
                        for (let i = 0; i < length; i++) {
                            const type = shuffledTypes[i % shuffledTypes.length];
                            const chars = this.chars[type];
                            password += chars[Math.floor(Math.random() * chars.length)];
                        }
                    }

                    // Fill remaining length with random characters from the combined set
                    for (let i = password.length; i < length; i++) {
                        password += characterSet[Math.floor(Math.random() * characterSet.length)];
                    }

                    // Shuffle the entire password to randomize character positions
                    password = password.split('').sort(() => Math.random() - 0.5).join('');

                    this.currentPassword = password;
                    this.displayPassword(password);
                    this.updatePasswordStrength(password);
                    // Pass current length and characterSet.length directly to updateStats
                    this.updateStats(length, characterSet.length, selectedTypes.length); 
                    this.hideButtonLoading(this.generateBtn);
                }, 100); 
            }

            displayPassword(passwordHtml) {
                // Instantly update innerHTML then fade in
                this.passwordDisplay.style.opacity = '0'; 
                setTimeout(() => { // Small delay to allow opacity change to register
                    this.passwordDisplay.innerHTML = passwordHtml;
                    this.passwordDisplay.style.opacity = '1';
                }, 50); 
            }

            updatePasswordStrength(password) {
                const strength = this.calculatePasswordStrength(password);
                
                this.strengthDots.forEach((dot, index) => {
                    dot.classList.remove('weak', 'medium', 'strong'); // Reset classes
                    dot.classList.toggle('active', index < strength);

                    if (index < strength) {
                        if (strength <= 2) dot.classList.add('weak');
                        else if (strength <= 4) dot.classList.add('medium');
                        else dot.classList.add('strong');
                    } else {
                        dot.style.backgroundColor = ''; // Reset to default CSS
                    }
                });
            }

            calculatePasswordStrength(password) {
                let score = 0;
                
                // --- 调整后的密码强度评分逻辑 ---
                // 长度分数
                if (password.length >= 8) score += 1;
                if (password.length >= 12) score += 1;
                if (password.length >= 16) score += 1;
                if (password.length >= 24) score += 1; // 调整：更长密码加更多分
                if (password.length >= 32) score += 1; // 调整：再加分，最高 5 分的长度部分
                
                // 字符类型分数
                let hasLower = /[a-z]/.test(password);
                let hasUpper = /[A-Z]/.test(password);
                let hasDigit = /[0-9]/.test(password);
                let hasSpecial = /[^a-zA-Z0-9]/.test(password);

                if (hasLower) score += 1;
                if (hasUpper) score += 1;
                if (hasDigit) score += 1;
                if (hasSpecial) score += 1;

                // 组合奖励 (更多类型，更高分数)
                let charTypeCount = (hasLower ? 1 : 0) + (hasUpper ? 1 : 0) + (hasDigit ? 1 : 0) + (hasSpecial ? 1 : 0);
                if (charTypeCount >= 3) score += 1; // 3种类型以上加分
                if (charTypeCount >= 4) score += 1; // 4种类型全有再加分

                // If at max length (64) and includes all char types, ensure max score
                if (password.length === 64 && charTypeCount === 4) {
                    return 5;
                }
                
                // Map total score to 5 strength dots
                return Math.min(5, Math.floor(score / 2)); // Adjusted divisor for smoother mapping and easier max score
            }

            // Modified updateStats to accept parameters, ensuring correct values are passed
            updateStats(length = null, characterSetSize = null, typeCount = null) {
                // If parameters are not provided, calculate them
                if (length === null) {
                    length = parseInt(this.passwordLengthInput.value) || 0;
                }
                
                let actualCharacterSet = '';
                if (characterSetSize === null || typeCount === null) {
                    typeCount = 0; // Reset typeCount
                    this.checkboxItems.forEach(item => {
                        const checkbox = item.querySelector('.checkbox-input');
                        if (checkbox.checked) {
                            const type = item.dataset.type;
                            actualCharacterSet += this.chars[type];
                            typeCount++;
                        }
                    });
                    characterSetSize = actualCharacterSet.length;
                }
                
                // Shannon entropy formula: E = L * log2(N)
                // L = password length, N = size of the character set
                const entropy = characterSetSize > 0 && length > 0 ? 
                                length * (Math.log(characterSetSize) / Math.log(2)) : 0; // Use log base 2
                
                this.charCount.textContent = length;
                this.charTypes.textContent = typeCount;
                this.entropy.textContent = Math.floor(entropy); // Display integer entropy

                // Calculate and display crack time using the correct characterSetSize
                this.calculateAndDisplayCrackTime(length, characterSetSize);
            }

            calculateAndDisplayCrackTime(length, characterSetSize) {
                if (length === 0 || characterSetSize === 0) {
                    this.crackTime.textContent = 'N/A';
                    return;
                }

                // Assume attacker speed: 1 trillion (10^12) attempts per second
                const crackSpeed = 1e12; 
                
                // Total possible combinations (search space)
                // Use Math.log and Math.exp to handle potentially very large exponents more robustly
                // log(A^B) = B * log(A)
                // A^B = exp(B * log(A))
                const logTotalCombinations = length * Math.log(characterSetSize);
                const logTimeInSeconds = logTotalCombinations - Math.log(crackSpeed);

                let timeInSeconds;
                if (logTimeInSeconds > Math.log(Number.MAX_VALUE)) {
                    // If the log is too large, the actual number will be Infinity, so display "infinity" text
                    timeInSeconds = Infinity;
                } else {
                    timeInSeconds = Math.exp(logTimeInSeconds);
                }

                // Handle very large numbers
                if (timeInSeconds === Infinity) {
                    this.crackTime.textContent = '数万亿年+'; // Effectively infinite
                    return;
                }

                // Convert seconds to a human-readable format (years, trillion years, etc.)
                const secondsInMinute = 60;
                const secondsInHour = secondsInMinute * 60;
                const secondsInDay = secondsInHour * 24;
                const secondsInYear = secondsInDay * 365.25; // Account for leap years

                let displayTime = '';
                if (timeInSeconds < 1) {
                    displayTime = '<1 秒';
                } else if (timeInSeconds < secondsInMinute) {
                    displayTime = `${Math.round(timeInSeconds)} 秒`;
                } else if (timeInSeconds < secondsInHour) {
                    displayTime = `${Math.round(timeInSeconds / secondsInMinute)} 分钟`;
                } else if (timeInSeconds < secondsInDay) {
                    displayTime = `${Math.round(timeInSeconds / secondsInHour)} 小时`;
                } else if (timeInSeconds < secondsInYear) {
                    displayTime = `${Math.round(timeInSeconds / secondsInDay)} 天`;
                } else if (timeInSeconds < secondsInYear * 1e3) { // Up to thousands of years
                    displayTime = `${(timeInSeconds / secondsInYear).toFixed(1)} 年`;
                } else if (timeInSeconds < secondsInYear * 1e6) { // Up to millions of years
                    displayTime = `${(timeInSeconds / (secondsInYear * 1e3)).toFixed(1)} 千年`;
                } else if (timeInSeconds < secondsInYear * 1e9) { // Up to billions of years
                    displayTime = `${(timeInSeconds / (secondsInYear * 1e6)).toFixed(1)} 百万年`;
                } else if (timeInSeconds < secondsInYear * 1e12) { // Up to trillions of years
                    displayTime = `${(timeInSeconds / (secondsInYear * 1e9)).toFixed(1)} 十亿年`;
                } else { // Trillions and beyond
                    displayTime = `${(timeInSeconds / (secondsInYear * 1e12)).toFixed(1)} 万亿年`;
                }
                this.crackTime.textContent = displayTime;
            }

            async copyPassword() {
                if (!this.currentPassword) {
                    this.showNotification('请先生成密码', 'warning');
                    return;
                }

                try {
                    await navigator.clipboard.writeText(this.currentPassword);
                    this.showCopySuccess();
                } catch (err) {
                    // Fallback method for older browsers or restricted environments
                    const textArea = document.createElement('textarea');
                    textArea.value = this.currentPassword;
                    textArea.style.position = 'fixed'; 
                    textArea.style.left = '-9999px';
                    textArea.style.top = '10px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        this.showCopySuccess();
                    } catch (e) {
                        this.showNotification('复制失败，请手动选择复制', 'error');
                    } finally {
                        document.body.removeChild(textArea);
                    }
                }
            }

            showCopySuccess() {
                this.copyIndicator.classList.add('show');
                setTimeout(() => {
                    this.copyIndicator.classList.remove('show');
                }, 2000);
            }

            showButtonLoading(button) {
                // Store original content if not already stored
                if (!button.originalContent) {
                    button.originalContent = button.innerHTML;
                }
                button.innerHTML = '<div class="loading"></div> 生成中...';
                button.disabled = true;
            }

            hideButtonLoading(button) {
                if (button.originalContent) {
                    button.innerHTML = button.originalContent;
                }
                button.disabled = false;
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.classList.add('notification', type);
                
                document.body.appendChild(notification);
                
                // Force reflow to ensure animation plays
                void notification.offsetWidth; 
                notification.classList.add('show');

                setTimeout(() => {
                    notification.classList.remove('show');
                    notification.addEventListener('transitionend', () => notification.remove(), { once: true });
                }, 3000);
            }

            generateInitialPassword() {
                // Ensure initial stats are updated based on default settings
                let characterSet = '';
                let typeCount = 0;
                this.checkboxItems.forEach(item => {
                    const checkbox = item.querySelector('.checkbox-input');
                    if (checkbox.checked) {
                        const type = item.dataset.type;
                        characterSet += this.chars[type];
                        typeCount++;
                    }
                });
                this.updateStats(parseInt(this.passwordLengthInput.value), characterSet.length, typeCount);
                this.generatePassword(); 
            }
        }

        // Initialize the PasswordGenerator when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            new PasswordGenerator();
        });
    </script>
</body>
</html>
