<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>danmu - å­¦ä¹ ç¬”è®°ç®¡ç†</title>

    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/danmu.png">
    
    <style>
        :root {
            --primary: #0969da;
            --danger: #cf222e;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --border: #d0d7de;
            --text-main: #1f2328;
            --text-muted: #656d76;
            --selected-bg: #e6f6ff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            padding-bottom: 110px; /* å¢åŠ åº•éƒ¨ç•™ç™½ */
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        /* å¤´éƒ¨ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            background: #fff;
        }
        h1 { margin: 0; font-size: 18px; }

        .header-actions { display: flex; gap: 8px; }
        .icon-btn {
            background: #f6f8fa; border: 1px solid var(--border);
            border-radius: 6px; padding: 6px 12px; 
            font-size: 13px; font-weight: 500; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
        }
        .icon-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* é¢åŒ…å±‘ */
        .breadcrumb {
            background: #f3f4f6; padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            font-size: 14px; overflow-x: auto; white-space: nowrap;
        }
        .breadcrumb-item { color: var(--primary); font-weight: 500; cursor: pointer; }
        .breadcrumb-separator { margin: 0 6px; color: #999; }
        .breadcrumb-current { color: #666; }

        /* åˆ—è¡¨åŒºåŸŸ */
        ul { list-style: none; padding: 0; margin: 0; }
        li { border-bottom: 1px solid #eaecef; }
        li:last-child { border-bottom: none; }

        .list-item {
            display: flex; 
            align-items: center;
            padding: 16px 15px; 
            text-decoration: none; 
            color: var(--text-main);
            cursor: pointer;
            position: relative;
            background: #fff;
            user-select: none; 
        }
        .list-item:active { background-color: #f2f2f2; }

        .list-item.selected { background-color: var(--selected-bg); }
        .list-item.selected::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0;
            width: 4px; background: var(--primary);
        }

        .item-content { flex: 1; min-width: 0; display: flex; align-items: center; }
        .item-icon { margin-right: 12px; font-size: 20px; flex-shrink: 0; width: 24px; text-align: center; }
        
        .item-info { flex: 1; min-width: 0; }
        .item-name { font-weight: 600; font-size: 16px; display: block; line-height: 1.4; word-break: break-all; }
        .item-meta { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        /* å¤é€‰æ¡† */
        .select-checkbox {
            margin-right: 15px; width: 22px; height: 22px;
            flex-shrink: 0; display: none;
            pointer-events: none; 
            transform: scale(1.1);
        }
        .selection-mode .select-checkbox { display: block; }
        
        .arrow-icon { color: #ccc; font-size: 18px; margin-left: 10px; }
        .selection-mode .arrow-icon { display: none; }

        /* åº•éƒ¨æ“ä½œæ  */
        .action-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px);
            background: #24292f; color: white;
            padding: 12px 20px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 1000; width: 90%; max-width: 420px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .action-bar.visible { transform: translateX(-50%) translateY(0); }
        .action-count { font-weight: bold; font-size: 14px; white-space: nowrap; margin-right: 10px; }
        
        .action-btn-group { display: flex; gap: 8px; flex-wrap: nowrap; }
        .action-btn {
            border: none; color: white;
            padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;
        }
        .btn-move { background: var(--primary); }
        .btn-del { background: var(--danger); }
        .btn-edit { background: #2da44e; } /* ç»¿è‰²ç¼–è¾‘æŒ‰é’® */
        .action-btn:disabled { background: #57606a; opacity: 0.6; cursor: not-allowed; }

        /* å¼¹çª—é€šç”¨ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 85%; max-width: 360px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .modal h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #d0d7de; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .form-group .hint { font-size: 12px; color: #666; margin-top: 5px; }
        
        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .btn { padding: 10px 16px; border-radius: 6px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-secondary { background: #f3f4f6; color: #24292f; }
        .btn-primary { background: var(--primary); color: white; }
        
        .loading { padding: 40px; text-align: center; color: #666; }
        .progress-log { font-size: 12px; color: #666; max-height: 150px; overflow-y: auto; background: #f8f8f8; padding: 10px; border-radius: 4px; border: 1px solid #eee; margin-top: 10px; }
        .log-item { margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ“š è‹±è¯­å­¦ä¹ ç¬”è®°</h1>
        <div class="header-actions">
            <button id="batch-btn" class="icon-btn" onclick="toggleBatchMode()">
                <span>âœ… é€‰æ‹©</span>
            </button>
            <button class="icon-btn" onclick="openSettings()">
                <span>âš™ï¸</span>
            </button>
        </div>
    </header>

    <div id="breadcrumb" class="breadcrumb"></div>
    <div id="latest-container"></div>

    <div id="file-list">
        <div class="loading">æ­£åœ¨åŠ è½½...</div>
    </div>
</div>

<div id="action-bar" class="action-bar">
    <span class="action-count">å·²é€‰ 0 é¡¹</span>
    <div class="action-btn-group">
        <button id="edit-btn" class="action-btn btn-edit" onclick="openEditModal()" disabled>âœï¸ ç¼–è¾‘</button>
        <button id="move-btn" class="action-btn btn-move" onclick="openMoveModal()" disabled>ç§»åŠ¨</button>
        <button id="del-btn" class="action-btn btn-del" onclick="execDelete()" disabled>åˆ é™¤</button>
    </div>
</div>

<div id="edit-modal" class="modal-overlay">
    <div class="modal">
        <h3>âœï¸ ç¼–è¾‘æ–‡ä»¶ä¿¡æ¯</h3>
        <div class="form-group">
            <label>æ ‡é¢˜åç§°</label>
            <input type="text" id="edit-name-input">
        </div>
        <div class="form-group">
            <label>æ—¥æœŸå’Œæ—¶é—´</label>
            <input type="datetime-local" id="edit-time-input">
            <div class="hint">ä¿®æ”¹æ—¶é—´ä¼šæ”¹å˜æ’åº (å€’åºæ’åˆ—)ã€‚</div>
        </div>
        <div id="edit-log" class="progress-log" style="display:none;"></div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button id="btn-save-edit" class="btn btn-primary" onclick="execEdit()">ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>
</div>

<div id="move-modal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ“‚ ç§»åŠ¨æ–‡ä»¶</h3>
        <div class="form-group">
            <label>ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„</label>
            <input type="text" id="move-target-path" placeholder="ä¾‹å¦‚: Notes/2026">
        </div>
        <div id="move-log" class="progress-log" style="display:none;"></div>
        <div class="btn-group">
            <button id="btn-cancel-move" class="btn btn-secondary" onclick="closeMoveModal()">å–æ¶ˆ</button>
            <button id="btn-confirm-move" class="btn btn-primary" onclick="execMove()">ç¡®è®¤ç§»åŠ¨</button>
        </div>
    </div>
</div>

<div id="delete-modal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ—‘ï¸ åˆ é™¤è¿›åº¦</h3>
        <div id="delete-log" class="progress-log"></div>
        <div class="btn-group">
            <button id="btn-done-del" class="btn btn-primary" onclick="closeDeleteModal()" style="display:none; width:100%">å®Œæˆ</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal">
        <h3>âš™ï¸ è®¾ç½®</h3>
        <div class="form-group">
            <label>GitHub Token</label>
            <input type="password" id="cfg-token" placeholder="å¿…å¡«: github_pat_...">
        </div>
        <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="cfg-user">
        </div>
        <div class="form-group">
            <label>ä»“åº“å</label>
            <input type="text" id="cfg-repo">
        </div>
        <div class="form-group">
            <label>æ ¹ç›®å½•</label>
            <input type="text" id="cfg-root">
        </div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
    const DEFAULTS = {
        user: 'moodHappy',
        repo: 'moodHappy.gitHub.io-nce',
        rootPath: 'Notes/danmu',
        token: ''
    };

    let config = {};
    let currentPath = '';
    let currentFiles = []; 
    let currentDirs = [];
    let isBatchMode = false;
    let selectedFilesMap = new Map(); 

    function getConfig() {
        const stored = localStorage.getItem('gh_nav_config_v5'); 
        return stored ? { ...DEFAULTS, ...JSON.parse(stored) } : DEFAULTS;
    }

    async function init() {
        config = getConfig();
        const urlParams = new URLSearchParams(window.location.search);
        const startPath = urlParams.get('path') || config.rootPath;
        await loadPath(startPath, false);

        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.path) loadPath(event.state.path, false);
            else loadPath(config.rootPath, false);
        });
    }

    async function ghFetch(url, options = {}) {
        const headers = options.headers || {};
        if (config.token) headers['Authorization'] = `token ${config.token}`;
        
        const response = await fetch(url, { ...options, headers });
        if (response.status === 204) return true;
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    }

    async function loadPath(path, addToHistory = true) {
        if (isBatchMode) toggleBatchMode(); 
        currentPath = path;

        if (addToHistory) {
            const newUrl = `${window.location.pathname}?path=${encodeURIComponent(path)}`;
            history.pushState({ path: path }, '', newUrl);
        }

        renderBreadcrumb(path);
        
        const listEl = document.getElementById('file-list');
        const latestEl = document.getElementById('latest-container');
        listEl.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        if(latestEl) latestEl.innerHTML = '';

        try {
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`);
            
            if (!Array.isArray(data)) {
                window.location.href = data.html_url || data.download_url;
                return;
            }

            let dirs = [], files = [];
            data.forEach(item => {
                if(item.name === 'index.html') return;
                if(item.type === 'dir') dirs.push(item);
                else if(item.name.match(/\.(html|json)$/)) {
                    // è§£ææ–‡ä»¶åä¸­çš„æ—¶é—´æˆ³
                    const ts = (item.name.match(/_(\d{13})\./) || [])[1];
                    files.push({
                        ...item,
                        timestamp: ts ? parseInt(ts) : 0,
                        dateStr: ts ? new Date(parseInt(ts)).toLocaleString('zh-CN', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', hour12: false}) : ''
                    });
                }
            });

            dirs.sort((a, b) => b.name.localeCompare(a.name));
            files.sort((a, b) => b.timestamp - a.timestamp); // æŒ‰æ—¶é—´å€’åº
            
            currentDirs = dirs;
            currentFiles = files;

            if (path === config.rootPath && dirs.length > 0) {
                 const yearDir = dirs.find(d => /^\d{4}$/.test(d.name));
                 if(yearDir) fetchLatestInDir(yearDir);
            }

            renderList();

        } catch (e) {
            listEl.innerHTML = `<div class="loading" style="color:red">${e.message}</div>`;
        }
    }

    function renderList() {
        const listEl = document.getElementById('file-list');
        const ul = document.createElement('ul');
        if(isBatchMode) ul.classList.add('selection-mode');

        if (currentDirs.length === 0 && currentFiles.length === 0) {
            listEl.innerHTML = '<div class="loading">æš‚æ— æ–‡ä»¶</div>';
            return;
        }

        currentDirs.forEach(dir => {
            const li = document.createElement('li');
            const opacity = isBatchMode ? '0.6' : '1';
            li.innerHTML = `
                <div class="list-item" style="opacity:${opacity}" onclick="loadPath('${dir.path}')">
                    <div class="item-content">
                        <span class="item-icon">ğŸ“</span>
                        <div class="item-info"><span class="item-name">${dir.name}</span></div>
                    </div>
                    <span class="arrow-icon">â€º</span>
                </div>`;
            ul.appendChild(li);
        });

        currentFiles.forEach(file => {
            const li = document.createElement('li');
            const isSelected = selectedFilesMap.has(file.sha);
            
            let itemClass = "list-item";
            if (isSelected && isBatchMode) itemClass += " selected";

            // æ ¼å¼åŒ–çº¯å‡€çš„æ ‡é¢˜ï¼ˆå»æ‰ _æ—¶é—´æˆ³.htmlï¼‰
            let cleanName = file.name.replace(/_\d{13}\.(html|json)/, '').replace(/_/g, ' ');

            li.innerHTML = `
                <div class="${itemClass}" onclick="handleItemClick('${file.sha}')">
                    <input type="checkbox" class="select-checkbox" ${isSelected ? 'checked' : ''}>
                    <div class="item-content">
                        <span class="item-icon">ğŸ“„</span>
                        <div class="item-info">
                            <span class="item-name">${cleanName}</span>
                            ${file.dateStr ? `<div class="item-meta">ğŸ“… ${file.dateStr}</div>` : ''}
                        </div>
                    </div>
                    ${!isBatchMode ? '<span class="arrow-icon">â€º</span>' : ''}
                </div>`;
            ul.appendChild(li);
        });

        listEl.innerHTML = '';
        listEl.appendChild(ul);
    }

    function handleItemClick(sha) {
        const file = currentFiles.find(f => f.sha === sha);
        if (!file) return;

        if (isBatchMode) {
            toggleFileSelect(file);
        } else {
            const url = `https://${config.user}.github.io/${config.repo}/${file.path}`;
            window.open(url, '_blank');
        }
    }

    function toggleBatchMode() {
        isBatchMode = !isBatchMode;
        const btn = document.getElementById('batch-btn');
        const actionBar = document.getElementById('action-bar');
        
        if (isBatchMode) {
            btn.classList.add('active');
            btn.innerHTML = '<span>âŒ å–æ¶ˆ</span>';
            actionBar.classList.add('visible');
        } else {
            btn.classList.remove('active');
            btn.innerHTML = '<span>âœ… é€‰æ‹©</span>';
            actionBar.classList.remove('visible');
            selectedFilesMap.clear();
            updateActionBar();
        }
        renderList();
    }

    function toggleFileSelect(file) {
        if (selectedFilesMap.has(file.sha)) {
            selectedFilesMap.delete(file.sha);
        } else {
            selectedFilesMap.set(file.sha, file);
        }
        updateActionBar();
        renderList(); 
    }

    function updateActionBar() {
        const count = selectedFilesMap.size;
        document.querySelector('.action-count').innerText = `å·²é€‰ ${count} é¡¹`;
        
        // ç§»åŠ¨å’Œåˆ é™¤ï¼šåªè¦æœ‰é€‰ä¸­å°±å¯ä»¥
        document.getElementById('move-btn').disabled = count === 0;
        document.getElementById('del-btn').disabled = count === 0;

        // ç¼–è¾‘ï¼šå¿…é¡»ä¸¥æ ¼é€‰ä¸­ 1 ä¸ªæ–‡ä»¶
        document.getElementById('edit-btn').disabled = count !== 1;
    }

    // --- ç¼–è¾‘/é‡å‘½åé€»è¾‘ (æ ¸å¿ƒæ–°åŠŸèƒ½) ---
    function openEditModal() {
        if (selectedFilesMap.size !== 1) return;
        
        const file = selectedFilesMap.values().next().value; // è·å–é€‰ä¸­çš„é‚£ä¸ªæ–‡ä»¶
        
        // 1. æå–å½“å‰åç§°ï¼ˆå»æ‰æ—¶é—´æˆ³åç¼€ï¼‰
        const match = file.name.match(/(.*)_(\d{13})\.(html|json)$/);
        let currentTitle = file.name;
        let currentTs = Date.now();
        let ext = '.html';

        if (match) {
            currentTitle = match[1]; // æ ‡é¢˜éƒ¨åˆ†
            currentTs = parseInt(match[2]); // æ—¶é—´æˆ³éƒ¨åˆ†
            ext = '.' + match[3];
        }

        // 2. è½¬æ¢æ—¶é—´ä¸º datetime-local æ ¼å¼ (YYYY-MM-DDTHH:mm)
        // æ³¨æ„ï¼šdatetime-local éœ€è¦æœ¬åœ°æ—¶é—´ï¼Œè¿™é‡Œåšä¸€ä¸ªç®€å•çš„åç§»å¤„ç†
        const dateObj = new Date(currentTs);
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        const hours = String(dateObj.getHours()).padStart(2, '0');
        const minutes = String(dateObj.getMinutes()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}T${hours}:${minutes}`;

        // 3. å¡«å…… Input
        document.getElementById('edit-name-input').value = currentTitle;
        document.getElementById('edit-time-input').value = dateStr;
        document.getElementById('edit-name-input').dataset.ext = ext; // æš‚å­˜åç¼€

        document.getElementById('edit-log').style.display = 'none';
        document.getElementById('edit-modal').style.display = 'flex';
        document.getElementById('btn-save-edit').disabled = false;
        document.getElementById('btn-save-edit').innerText = "ä¿å­˜ä¿®æ”¹";
    }

    function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    async function execEdit() {
        if (!config.token) { alert("è¯·å…ˆè®¾ç½® Token"); openSettings(); return; }
        
        const file = selectedFilesMap.values().next().value;
        const newTitle = document.getElementById('edit-name-input').value.trim();
        const newTimeStr = document.getElementById('edit-time-input').value;
        const ext = document.getElementById('edit-name-input').dataset.ext || '.html';
        const logDiv = document.getElementById('edit-log');
        const btn = document.getElementById('btn-save-edit');

        if (!newTitle || !newTimeStr) { alert("åç§°å’Œæ—¶é—´ä¸èƒ½ä¸ºç©º"); return; }

        // 1. ç”Ÿæˆæ–°æ–‡ä»¶å
        const newDate = new Date(newTimeStr);
        const newTs = newDate.getTime();
        const newFilename = `${newTitle}_${newTs}${ext}`;

        // å¦‚æœåå­—å’Œæ—¶é—´éƒ½æ²¡å˜ï¼Œç›´æ¥å…³é—­
        if (newFilename === file.name) { closeEditModal(); return; }

        btn.disabled = true;
        btn.innerText = "ä¿å­˜ä¸­...";
        logDiv.style.display = 'block';
        logDiv.innerHTML = `<div class="log-item">â³ æ­£åœ¨é‡å‘½åä¸º...<br>${newTitle}</div>`;

        try {
            // æ­¥éª¤ A: è·å–åŸæ–‡ä»¶å†…å®¹
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`);
            
            // æ­¥éª¤ B: åˆ›å»ºæ–°æ–‡ä»¶ (PUT)
            // æ³¨æ„ï¼špath è¦ä¿æŒåœ¨å½“å‰ç›®å½•
            const newPath = currentPath + '/' + newFilename;
            
            await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${newPath}`, {
                method: 'PUT',
                body: JSON.stringify({
                    message: `Rename to ${newFilename}`,
                    content: data.content // ä¿æŒåŸæœ‰å†…å®¹
                })
            });

            // æ­¥éª¤ C: åˆ é™¤æ—§æ–‡ä»¶ (DELETE)
            await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`, {
                method: 'DELETE',
                body: JSON.stringify({
                    message: `Delete old file after rename`,
                    sha: file.sha
                })
            });

            logDiv.innerHTML += `<div style="color:green">âœ… ä¿®æ”¹æˆåŠŸï¼</div>`;
            
            setTimeout(() => {
                closeEditModal();
                toggleBatchMode(); // é€€å‡ºé€‰æ‹©æ¨¡å¼
                loadPath(currentPath); // åˆ·æ–°åˆ—è¡¨
            }, 1000);

        } catch (e) {
            logDiv.innerHTML += `<div style="color:red">âŒ å¤±è´¥: ${e.message}</div>`;
            btn.disabled = false;
            btn.innerText = "é‡è¯•";
        }
    }

    // --- ç§»åŠ¨é€»è¾‘ ---
    function openMoveModal() {
        if (!config.token) { alert("è¯·å…ˆè®¾ç½® Token"); openSettings(); return; }
        document.getElementById('move-target-path').value = currentPath; 
        document.getElementById('move-log').style.display = 'none';
        document.getElementById('move-modal').style.display = 'flex';
        document.getElementById('btn-confirm-move').disabled = false;
        document.getElementById('btn-confirm-move').innerText = "ç¡®è®¤ç§»åŠ¨";
    }

    function closeMoveModal() { document.getElementById('move-modal').style.display = 'none'; }

    async function execMove() {
        const targetDir = document.getElementById('move-target-path').value.trim().replace(/\/+$/, '');
        const logDiv = document.getElementById('move-log');
        const btn = document.getElementById('btn-confirm-move');
        
        if (!targetDir || targetDir === currentPath) { alert("ç›®æ ‡è·¯å¾„æ— æ•ˆ"); return; }
        
        btn.disabled = true;
        btn.innerText = "å¤„ç†ä¸­...";
        logDiv.style.display = 'block';
        logDiv.innerHTML = '';

        const files = Array.from(selectedFilesMap.values());
        let successCount = 0;

        for (const file of files) {
            logDiv.innerHTML += `<div class="log-item">â³ ${file.name}</div>`;
            try {
                const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`);
                await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${targetDir}/${file.name}`, {
                    method: 'PUT',
                    body: JSON.stringify({ message: `Move ${file.name}`, content: data.content })
                });
                await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ message: `Del original`, sha: file.sha })
                });
                successCount++;
                logDiv.lastElementChild.innerHTML = `<span style="color:green">âœ… æˆåŠŸ</span>`;
            } catch (e) {
                logDiv.lastElementChild.innerHTML = `<span style="color:red">âŒ å¤±è´¥: ${e.message}</span>`;
            }
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        if (successCount > 0) {
            setTimeout(() => {
                closeMoveModal();
                toggleBatchMode();
                loadPath(currentPath);
            }, 1000);
        } else {
            btn.disabled = false;
            btn.innerText = "é‡è¯•";
        }
    }

    // --- åˆ é™¤é€»è¾‘ ---
    async function execDelete() {
        if (!config.token) { alert("è¯·å…ˆè®¾ç½® Token"); openSettings(); return; }
        const count = selectedFilesMap.size;
        
        if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªæ–‡ä»¶å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;

        const modal = document.getElementById('delete-modal');
        const logDiv = document.getElementById('delete-log');
        const doneBtn = document.getElementById('btn-done-del');
        
        modal.style.display = 'flex';
        logDiv.innerHTML = '';
        doneBtn.style.display = 'none';

        const files = Array.from(selectedFilesMap.values());
        let successCount = 0;

        for (const file of files) {
            logDiv.innerHTML += `<div class="log-item">â³ åˆ é™¤ä¸­: ${file.name}...</div>`;
            try {
                await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ message: `Batch Delete`, sha: file.sha })
                });
                successCount++;
                logDiv.lastElementChild.innerHTML = `<span style="color:green">âœ… å·²åˆ é™¤</span>`;
            } catch (e) {
                logDiv.lastElementChild.innerHTML = `<span style="color:red">âŒ å¤±è´¥: ${e.message}</span>`;
            }
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        logDiv.innerHTML += `<div style="margin-top:10px; font-weight:bold">ğŸ å®Œæˆ</div>`;
        doneBtn.style.display = 'block'; 
        
        if (successCount > 0) {
            toggleBatchMode();
            loadPath(currentPath);
        }
    }

    function closeDeleteModal() { document.getElementById('delete-modal').style.display = 'none'; }

    // --- è¾…åŠ©é€»è¾‘ ---
    async function fetchLatestInDir(dirItem) {
        try {
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${dirItem.path}`);
            const files = data.filter(i => i.name.match(/\.(html|json)$/));
            if(files.length > 0) {
                 const f = files.sort((a,b)=>b.name.localeCompare(a.name))[0]; 
                 const url = `https://${config.user}.github.io/${config.repo}/${f.path}`;
                 document.getElementById('latest-container').innerHTML = `
                    <div style="background:#e6f6ff; border:1px solid #b6e3ff; padding:12px; border-radius:6px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;" onclick="window.open('${url}','_blank')">
                        <div>
                            <div style="font-size:12px; font-weight:bold; color:#0969da">NEW IN ${dirItem.name}</div>
                            <div style="font-weight:600; margin-top:2px;">${f.name.replace(/_\d{13}\..*$/,'').replace(/_/g,' ')}</div>
                        </div>
                        <span style="color:#0969da; font-weight:bold;">â†’</span>
                    </div>`;
            }
        } catch(e){}
    }

    function renderBreadcrumb(path) {
        const c = document.getElementById('breadcrumb');
        let html = `<span class="breadcrumb-item" onclick="loadPath('${config.rootPath}')">ğŸ </span>`;
        if (path !== config.rootPath) {
            const parts = path.substring(config.rootPath.length).split('/').filter(p=>p);
            let build = config.rootPath;
            parts.forEach((p, i) => {
                build += '/' + p;
                html += `<span class="breadcrumb-separator">/</span>`;
                if(i===parts.length-1) html += `<span class="breadcrumb-current">${p}</span>`;
                else html += `<span class="breadcrumb-item" onclick="loadPath('${build}')">${p}</span>`;
            });
        }
        c.innerHTML = html;
    }

    function openSettings() { 
        document.getElementById('settings-modal').style.display = 'flex'; 
        document.getElementById('cfg-user').value = config.user;
        document.getElementById('cfg-repo').value = config.repo;
        document.getElementById('cfg-root').value = config.rootPath;
        document.getElementById('cfg-token').value = config.token;
    }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function saveSettings() {
        const newCfg = {
            user: document.getElementById('cfg-user').value.trim(),
            repo: document.getElementById('cfg-repo').value.trim(),
            rootPath: document.getElementById('cfg-root').value.trim().replace(/\/+$/,''),
            token: document.getElementById('cfg-token').value.trim()
        };
        localStorage.setItem('gh_nav_config_v5', JSON.stringify(newCfg));
        location.reload();
    }
    
    window.onclick = (e) => { if(e.target.classList.contains('modal-overlay')) e.target.style.display='none'; };

    init();
</script>
</body>
</html>
