<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>danmu - å…¼å®¹ç‰ˆ</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/Miyetsuko.png">

    <style>
        :root {
            --primary: #0969da;
            --danger: #cf222e;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --border: #d0d7de;
            --text-main: #1f2328;
            --text-muted: #656d76;
            --selected-bg: #e6f6ff;
            --mark-color: #eac54f; /* æ ‡è®°é¢œè‰² */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            padding-bottom: 120px; 
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            background: #fff;
        }
        h1 { margin: 0; font-size: 18px; font-weight: 700; }

        .header-actions { display: flex; gap: 10px; }
        .icon-btn {
            background: #f6f8fa; border: 1px solid var(--border);
            border-radius: 6px; padding: 6px 12px; 
            font-size: 14px; color: var(--text-main); cursor: pointer;
            transition: all 0.2s;
            text-decoration: none; display: flex; align-items: center;
        }
        .icon-btn:hover { background: #eaeef2; }
        .icon-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .breadcrumb {
            background: #f3f4f6; padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            font-size: 14px; overflow-x: auto; white-space: nowrap;
            display: flex; align-items: center;
        }
        .breadcrumb-item { 
            color: var(--primary); text-decoration: none; font-weight: 500; 
            padding: 2px 4px; border-radius: 4px;
        }
        .breadcrumb-item:hover { background: rgba(9, 105, 218, 0.1); }
        .breadcrumb-separator { margin: 0 4px; color: #999; font-size: 12px; }
        .breadcrumb-current { color: var(--text-muted); font-weight: 600; padding: 0 4px; }

        ul { list-style: none; padding: 0; margin: 0; }
        li { border-bottom: 1px solid #eaecef; }
        li:last-child { border-bottom: none; }

        .list-item {
            display: flex; 
            align-items: center;
            padding: 16px 15px; 
            text-decoration: none;
            color: var(--text-main);
            cursor: pointer;
            position: relative;
            background: #fff;
            transition: background 0.15s;
            -webkit-user-select: none;
            user-select: none;
        }
        .list-item:hover { background-color: #f8f9fa; }
        .list-item:active { background-color: #f0f0f0; }

        /* æ ‡è®°æ ·å¼ */
        .list-item.marked { background-color: #fffdf2; }
        .mark-btn {
            padding: 10px;
            margin-right: 5px;
            font-size: 18px;
            filter: grayscale(1);
            opacity: 0.3;
            transition: all 0.2s;
            cursor: pointer;
            z-index: 10;
        }
        .marked .mark-btn {
            filter: grayscale(0);
            opacity: 1;
        }

        .list-item.selected { background-color: var(--selected-bg); }
        .list-item.selected::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0;
            width: 4px; background: var(--primary);
        }

        .item-content { flex: 1; min-width: 0; display: flex; align-items: center; }
        .item-icon { margin-right: 12px; font-size: 20px; flex-shrink: 0; width: 24px; text-align: center; }

        .item-info { flex: 1; min-width: 0; }
        .item-name { font-weight: 600; font-size: 15px; display: block; line-height: 1.4; word-break: break-all; color: var(--text-main); }
        .item-meta { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        .select-checkbox {
            margin-right: 15px; width: 20px; height: 20px;
            flex-shrink: 0; display: none;
            accent-color: var(--primary);
            pointer-events: none;
        }
        .selection-mode .select-checkbox { display: block; }

        .arrow-icon { color: #d0d7de; font-size: 18px; margin-left: 10px; font-weight: bold; }
        .selection-mode .arrow-icon { display: none; }

        .action-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px);
            background: #24292f; color: white;
            padding: 10px 16px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 9999;
            width: 90%; max-width: 400px;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .action-bar.visible { transform: translateX(-50%) translateY(0); }
        .action-count { font-weight: bold; font-size: 14px; white-space: nowrap; margin-right: 10px; }

        .action-btn-group { display: flex; gap: 8px; }
        .action-btn {
            border: none; color: white;
            padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;
        }
        .btn-move { background: var(--primary); }
        .btn-del { background: var(--danger); }
        .btn-edit { background: #2da44e; }
        .action-btn:disabled { background: #57606a; opacity: 0.5; cursor: not-allowed; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 85%; max-width: 360px; box-shadow: 0 20px 40px rgba(0,0,0,0.25); }
        .modal h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #d0d7de; border-radius: 6px; box-sizing: border-box; font-size: 16px; }

        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 10px 16px; border-radius: 6px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-secondary { background: #f3f4f6; color: #24292f; }
        .btn-primary { background: var(--primary); color: white; }

        .loading { padding: 40px; text-align: center; color: #666; font-size: 14px; }
        .progress-log { font-size: 12px; color: #666; max-height: 150px; overflow-y: auto; background: #f8f8f8; padding: 10px; border-radius: 4px; border: 1px solid #eee; margin-top: 10px; }
        .log-item { margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }

        .latest-card {
            background: #f1f8ff; border: 1px solid #c8e1ff; 
            padding: 12px 15px; border-radius: 8px; 
            margin-bottom: 15px; text-decoration: none; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .latest-badge { font-size: 11px; font-weight: bold; color: #0969da; text-transform: uppercase; margin-bottom: 2px; display: block; }
        .latest-title { font-weight: 600; color: #1f2328; font-size: 15px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ“š è‹±è¯­ç¬”è®°ç®¡ç†</h1>
        <div class="header-actions">
            <button id="batch-btn" class="icon-btn" onclick="toggleBatchMode()">
                <span>âœ… é€‰æ‹©</span>
            </button>
            <button class="icon-btn" onclick="openSettings()">
                <span>âš™ï¸</span>
            </button>
        </div>
    </header>

    <div id="breadcrumb" class="breadcrumb"></div>
    <div id="latest-container"></div>

    <div id="file-list">
        <div class="loading">æ­£åœ¨è¿æ¥ GitHub...</div>
    </div>
</div>

<div id="action-bar" class="action-bar">
    <span class="action-count">å·²é€‰ 0 é¡¹</span>
    <div class="action-btn-group">
        <button id="edit-btn" class="action-btn btn-edit" onclick="openEditModal()" disabled>âœï¸</button>
        <button id="move-btn" class="action-btn btn-move" onclick="openMoveModal()" disabled>ç§»åŠ¨</button>
        <button id="del-btn" class="action-btn btn-del" onclick="execDelete()" disabled>åˆ é™¤</button>
    </div>
</div>

<div id="edit-modal" class="modal-overlay">
    <div class="modal">
        <h3>âœï¸ ç¼–è¾‘ / é‡å‘½å</h3>
        <div class="form-group">
            <label>æ ‡é¢˜åç§°</label>
            <input type="text" id="edit-name-input">
        </div>
        <div class="form-group">
            <label>æ—¥æœŸæ—¶é—´ (å†³å®šæ’åº)</label>
            <input type="datetime-local" id="edit-time-input">
        </div>
        <div id="edit-log" class="progress-log" style="display:none;"></div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button id="btn-save-edit" class="btn btn-primary" onclick="execEdit()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="move-modal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ“‚ ç§»åŠ¨æ–‡ä»¶</h3>
        <div class="form-group">
            <label>ç›®æ ‡è·¯å¾„ (ä¾‹å¦‚ Notes/2025)</label>
            <input type="text" id="move-target-path">
        </div>
        <div id="move-log" class="progress-log" style="display:none;"></div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeMoveModal()">å–æ¶ˆ</button>
            <button id="btn-confirm-move" class="btn btn-primary" onclick="execMove()">ç§»åŠ¨</button>
        </div>
    </div>
</div>

<div id="delete-modal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶</h3>
        <div id="delete-log" class="progress-log"></div>
        <div class="btn-group">
            <button id="btn-done-del" class="btn btn-primary" onclick="closeDeleteModal()" style="display:none; width:100%">å®Œæˆ</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal">
        <h3>âš™ï¸ GitHub é…ç½®</h3>
        <div class="form-group">
            <label>Token (å¿…å¡«)</label>
            <input type="password" id="cfg-token" placeholder="github_pat_...">
        </div>
        <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="cfg-user">
        </div>
        <div class="form-group">
            <label>ä»“åº“å</label>
            <input type="text" id="cfg-repo">
        </div>
        <div class="form-group">
            <label>æ ¹ç›®å½•è·¯å¾„</label>
            <input type="text" id="cfg-root">
        </div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜å¹¶åˆ·æ–°</button>
        </div>
    </div>
</div>

<script>
    const DEFAULTS = {
        user: 'moodHappy',
        repo: 'moodHappy.gitHub.io-nce',
        rootPath: 'Notes/danmu',
        token: ''
    };

    let config = {};
    let currentPath = '';
    let currentFiles = []; 
    let currentDirs = [];
    let isBatchMode = false;
    let selectedFilesMap = new Map(); 
    
    // --- æ ‡è®°åŠŸèƒ½åˆå§‹åŒ– ---
    let markedPaths = new Set(JSON.parse(localStorage.getItem('gh_marked_paths') || '[]'));

    function getConfig() {
        const stored = localStorage.getItem('gh_nav_config_v5'); 
        return stored ? { ...DEFAULTS, ...JSON.parse(stored) } : DEFAULTS;
    }

    async function init() {
        config = getConfig();
        const urlParams = new URLSearchParams(window.location.search);
        const startPath = urlParams.get('path') || config.rootPath;
        await loadPath(startPath, false);

        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.path) loadPath(event.state.path, false);
            else loadPath(config.rootPath, false);
        });
    }

    async function ghFetch(url, options = {}) {
        const headers = options.headers || {};
        if (config.token) headers['Authorization'] = `token ${config.token}`;
        const noCacheUrl = url + (url.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
        const response = await fetch(noCacheUrl, { ...options, headers });
        if (response.status === 204) return true;
        if (!response.ok) {
            const err = await response.json().catch(()=>({}));
            throw new Error(err.message || `HTTP ${response.status}`);
        }
        return await response.json();
    }

    async function loadPath(path, addToHistory = true) {
        if (isBatchMode) toggleBatchMode(); 
        currentPath = path;

        if (addToHistory) {
            const newUrl = `${window.location.pathname}?path=${encodeURIComponent(path)}`;
            history.pushState({ path: path }, '', newUrl);
        }

        renderBreadcrumb(path);
        const listEl = document.getElementById('file-list');
        const latestEl = document.getElementById('latest-container');
        listEl.innerHTML = '<div class="loading">æ­£åœ¨è·å–åˆ—è¡¨...</div>';
        if(latestEl) latestEl.innerHTML = '';

        try {
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`);
            if (!Array.isArray(data)) {
                window.location.href = `https://${config.user}.github.io/${config.repo}/${path}`;
                return;
            }

            let dirs = [], files = [];
            data.forEach(item => {
                if(item.name.toLowerCase() === 'index.html') return;
                if(item.type === 'dir') {
                    dirs.push(item);
                } else if(item.name.match(/\.(html|json)$/)) {
                    const ts = (item.name.match(/_(\d{13})\./) || [])[1];
                    files.push({
                        ...item,
                        timestamp: ts ? parseInt(ts) : 0,
                        dateStr: ts ? new Date(parseInt(ts)).toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12: false}) : ''
                    });
                }
            });

            dirs.sort((a, b) => b.name.localeCompare(a.name));
            files.sort((a, b) => b.timestamp - a.timestamp);

            currentDirs = dirs;
            currentFiles = files;

            if (path === config.rootPath && dirs.length > 0) {
                 const yearDir = dirs.find(d => /^\d{4}$/.test(d.name));
                 if(yearDir) fetchLatestInDir(yearDir);
            }
            renderList();
        } catch (e) {
            listEl.innerHTML = `<div class="loading" style="color:#cf222e;">âŒ åŠ è½½å¤±è´¥: ${e.message}</div>`;
        }
    }

    // --- æ¸²æŸ“åˆ—è¡¨ (é›†æˆæ ‡è®°åŠŸèƒ½) ---
    function renderList() {
        const listEl = document.getElementById('file-list');
        const ul = document.createElement('ul');
        if(isBatchMode) ul.classList.add('selection-mode');

        if (currentDirs.length === 0 && currentFiles.length === 0) {
            listEl.innerHTML = '<div class="loading">æ­¤æ–‡ä»¶å¤¹ä¸ºç©º</div>';
            return;
        }

        currentDirs.forEach(dir => {
            const li = document.createElement('li');
            const opacity = isBatchMode ? '0.5' : '1';
            const href = `?path=${encodeURIComponent(dir.path)}`;
            li.innerHTML = `
                <a href="${href}" class="list-item" style="opacity:${opacity};" onclick="handleDirClick(event, '${dir.path}')">
                    <div class="item-content">
                        <span class="item-icon" style="color:#54aeff">ğŸ“</span>
                        <div class="item-info"><span class="item-name">${dir.name}</span></div>
                    </div>
                    <span class="arrow-icon">â€º</span>
                </a>`;
            ul.appendChild(li);
        });

        currentFiles.forEach(file => {
            const li = document.createElement('li');
            const isSelected = selectedFilesMap.has(file.sha);
            const isMarked = markedPaths.has(file.path);

            let itemClass = "list-item";
            if (isSelected && isBatchMode) itemClass += " selected";
            if (isMarked) itemClass += " marked";

            let cleanName = file.name.replace(/_\d{13}\.(html|json)/, '').replace(/_/g, ' ');
            const realUrl = `https://${config.user}.github.io/${config.repo}/${file.path}`;

            li.innerHTML = `
                <a href="${realUrl}" target="_blank" class="${itemClass}" onclick="handleFileClick(event, '${file.sha}')">
                    <input type="checkbox" class="select-checkbox" ${isSelected ? 'checked' : ''}>
                    
                    <span class="mark-btn" onclick="handleMarkClick(event, '${file.path}')">â­</span>

                    <div class="item-content">
                        <span class="item-icon" style="color:#656d76">ğŸ“„</span>
                        <div class="item-info">
                            <span class="item-name">${cleanName}</span>
                            ${file.dateStr ? `<div class="item-meta">ğŸ“… ${file.dateStr}</div>` : ''}
                        </div>
                    </div>
                    ${!isBatchMode ? '<span class="arrow-icon" style="color:#0969da">â†—</span>' : ''}
                </a>`;
            ul.appendChild(li);
        });

        listEl.innerHTML = '';
        listEl.appendChild(ul);
    }

    // --- æ ‡è®°å¤„ç†é€»è¾‘ ---
    function handleMarkClick(e, path) {
        e.preventDefault();
        e.stopPropagation(); // é˜²æ­¢è§¦å‘æ–‡ä»¶è·³è½¬
        
        if (markedPaths.has(path)) {
            markedPaths.delete(path);
        } else {
            // å¦‚æœä½ æƒ³åªä¿ç•™ä¸€ä¸ªæ ‡è®°ï¼ˆâ€œè¯»åˆ°å“ªäº†â€ï¼‰ï¼Œå¯ä»¥å…ˆ clear
            // markedPaths.clear(); 
            markedPaths.add(path);
        }
        
        // æŒä¹…åŒ–å­˜å‚¨
        localStorage.setItem('gh_marked_paths', JSON.stringify(Array.from(markedPaths)));
        renderList();
    }

    function handleDirClick(e, path) {
        if(isBatchMode) { e.preventDefault(); return; }
        e.preventDefault();
        loadPath(path);
    }

    function handleFileClick(e, sha) {
        if (isBatchMode) {
            e.preventDefault();
            const file = currentFiles.find(f => f.sha === sha);
            if (file) toggleFileSelect(file);
        }
    }

    function toggleBatchMode() {
        isBatchMode = !isBatchMode;
        const btn = document.getElementById('batch-btn');
        const actionBar = document.getElementById('action-bar');
        if (isBatchMode) {
            btn.classList.add('active');
            btn.innerHTML = '<span>âŒ å–æ¶ˆ</span>';
            actionBar.classList.add('visible');
        } else {
            btn.classList.remove('active');
            btn.innerHTML = '<span>âœ… é€‰æ‹©</span>';
            actionBar.classList.remove('visible');
            selectedFilesMap.clear();
            updateActionBar();
        }
        renderList();
    }

    function toggleFileSelect(file) {
        if (selectedFilesMap.has(file.sha)) {
            selectedFilesMap.delete(file.sha);
        } else {
            selectedFilesMap.set(file.sha, file);
        }
        updateActionBar();
        renderList(); 
    }

    function updateActionBar() {
        const count = selectedFilesMap.size;
        document.querySelector('.action-count').innerText = `å·²é€‰ ${count} é¡¹`;
        document.getElementById('move-btn').disabled = count === 0;
        document.getElementById('del-btn').disabled = count === 0;
        document.getElementById('edit-btn').disabled = count !== 1;
    }

    // --- ä¿æŒåŸæœ‰ç¼–è¾‘/ç§»åŠ¨/åˆ é™¤é€»è¾‘ä¸å˜ ---
    function openEditModal() {
        if (selectedFilesMap.size !== 1) return;
        const file = selectedFilesMap.values().next().value;
        const match = file.name.match(/(.*)_(\d{13})\.(html|json)$/);
        let currentTitle = match ? match[1] : file.name;
        let currentTs = match ? parseInt(match[2]) : Date.now();
        let ext = match ? '.'+match[3] : '.html';

        const dateObj = new Date(currentTs);
        const pad = (n) => String(n).padStart(2,'0');
        const dateStr = `${dateObj.getFullYear()}-${pad(dateObj.getMonth()+1)}-${pad(dateObj.getDate())}T${pad(dateObj.getHours())}:${pad(dateObj.getMinutes())}`;

        document.getElementById('edit-name-input').value = currentTitle;
        document.getElementById('edit-time-input').value = dateStr;
        document.getElementById('edit-name-input').dataset.ext = ext; 
        document.getElementById('edit-log').style.display = 'none';
        document.getElementById('edit-modal').style.display = 'flex';
    }

    function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; }

    async function execEdit() {
        const file = selectedFilesMap.values().next().value;
        const newTitle = document.getElementById('edit-name-input').value.trim();
        const newTimeStr = document.getElementById('edit-time-input').value;
        const ext = document.getElementById('edit-name-input').dataset.ext || '.html';
        if (!newTitle || !newTimeStr) return;

        const newTs = new Date(newTimeStr).getTime();
        const newFilename = `${newTitle}_${newTs}${ext}`;
        if (newFilename === file.name) { closeEditModal(); return; }

        const logDiv = document.getElementById('edit-log');
        logDiv.style.display = 'block';
        logDiv.innerHTML = `â³ æ­£åœ¨é‡å‘½å...`;

        try {
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`);
            await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${currentPath}/${newFilename}`, {
                method: 'PUT',
                body: JSON.stringify({ message: `Rename`, content: data.content })
            });
            await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`, {
                method: 'DELETE',
                body: JSON.stringify({ message: `Cleanup`, sha: file.sha })
            });
            
            // å¦‚æœæ—§æ–‡ä»¶è¢«æ ‡è®°äº†ï¼Œæ›´æ–°æ ‡è®°åˆ°æ–°è·¯å¾„
            if(markedPaths.has(file.path)) {
                markedPaths.delete(file.path);
                markedPaths.add(currentPath + '/' + newFilename);
                localStorage.setItem('gh_marked_paths', JSON.stringify(Array.from(markedPaths)));
            }

            closeEditModal();
            toggleBatchMode();
            loadPath(currentPath);
        } catch (e) { logDiv.innerHTML = `âŒ é”™è¯¯: ${e.message}`; }
    }

    function openMoveModal() {
        document.getElementById('move-target-path').value = currentPath; 
        document.getElementById('move-modal').style.display = 'flex';
    }
    function closeMoveModal() { document.getElementById('move-modal').style.display = 'none'; }

    async function execMove() {
        const targetDir = document.getElementById('move-target-path').value.trim();
        const files = Array.from(selectedFilesMap.values());
        for (const file of files) {
            try {
                const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`);
                await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${targetDir}/${file.name}`, {
                    method: 'PUT',
                    body: JSON.stringify({ message: `Move`, content: data.content })
                });
                await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ message: `Del`, sha: file.sha })
                });
                if(markedPaths.has(file.path)) {
                    markedPaths.delete(file.path);
                    markedPaths.add(targetDir + '/' + file.name);
                }
            } catch (e) {}
        }
        localStorage.setItem('gh_marked_paths', JSON.stringify(Array.from(markedPaths)));
        closeMoveModal(); toggleBatchMode(); loadPath(currentPath);
    }

    async function execDelete() {
        if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedFilesMap.size} ä¸ªæ–‡ä»¶å—ï¼Ÿ`)) return;
        document.getElementById('delete-modal').style.display = 'flex';
        const files = Array.from(selectedFilesMap.values());
        for (const file of files) {
            try {
                await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ message: `Delete`, sha: file.sha })
                });
                markedPaths.delete(file.path);
            } catch (e) {}
        }
        localStorage.setItem('gh_marked_paths', JSON.stringify(Array.from(markedPaths)));
        document.getElementById('btn-done-del').style.display = 'block';
        toggleBatchMode(); loadPath(currentPath);
    }

    function closeDeleteModal() { document.getElementById('delete-modal').style.display = 'none'; }

    async function fetchLatestInDir(dirItem) {
        try {
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${dirItem.path}`);
            const files = data.filter(i => i.name.match(/\.(html|json)$/));
            if(files.length > 0) {
                 const f = files.sort((a,b)=>b.name.localeCompare(a.name))[0]; 
                 const url = `https://${config.user}.github.io/${config.repo}/${f.path}`;
                 const name = f.name.replace(/_\d{13}\..*$/,'').replace(/_/g,' ');
                 document.getElementById('latest-container').innerHTML = `
                    <a href="${url}" target="_blank" class="latest-card">
                        <div>
                            <span class="latest-badge">NEW IN ${dirItem.name}</span>
                            <div class="latest-title">${name}</div>
                        </div>
                        <span style="color:#0969da; font-weight:bold;">ç«‹å³é˜…è¯» â†’</span>
                    </a>`;
            }
        } catch(e){}
    }

    function renderBreadcrumb(path) {
        const c = document.getElementById('breadcrumb');
        let html = `<a href="?path=${config.rootPath}" class="breadcrumb-item" onclick="handleDirClick(event, '${config.rootPath}')">ğŸ </a>`;
        if (path !== config.rootPath) {
            const parts = path.substring(config.rootPath.length).split('/').filter(p=>p);
            let build = config.rootPath;
            parts.forEach((p, i) => {
                build += '/' + p;
                html += `<span class="breadcrumb-separator">/</span>`;
                if(i===parts.length-1) html += `<span class="breadcrumb-current">${p}</span>`;
                else html += `<a href="?path=${build}" class="breadcrumb-item" onclick="handleDirClick(event, '${build}')">${p}</a>`;
            });
        }
        c.innerHTML = html;
    }

    function openSettings() { 
        document.getElementById('settings-modal').style.display = 'flex'; 
        document.getElementById('cfg-user').value = config.user;
        document.getElementById('cfg-repo').value = config.repo;
        document.getElementById('cfg-root').value = config.rootPath;
        document.getElementById('cfg-token').value = config.token;
    }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function saveSettings() {
        const newCfg = {
            user: document.getElementById('cfg-user').value.trim(),
            repo: document.getElementById('cfg-repo').value.trim(),
            rootPath: document.getElementById('cfg-root').value.trim().replace(/\/+$/,''),
            token: document.getElementById('cfg-token').value.trim()
        };
        localStorage.setItem('gh_nav_config_v5', JSON.stringify(newCfg));
        location.reload();
    }

    window.onclick = (e) => { if(e.target.classList.contains('modal-overlay')) e.target.style.display='none'; };

    init();
</script>
</body>
</html>
