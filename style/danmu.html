<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>danmu - å­¦ä¹ ç¬”è®°</title>

    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/danmu.png">
    
    <style>
        :root {
            --primary: #0969da;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --border: #d0d7de;
            --text-main: #1f2328;
            --text-muted: #656d76;
            --selected-bg: #e6f6ff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        /* å¤´éƒ¨ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            background: #fff;
        }
        h1 { margin: 0; font-size: 18px; }

        .header-actions { display: flex; gap: 8px; }
        .icon-btn {
            background: #f6f8fa; border: 1px solid var(--border);
            border-radius: 6px; padding: 6px 12px; 
            font-size: 13px; font-weight: 500; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
        }
        .icon-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* é¢åŒ…å±‘ */
        .breadcrumb {
            background: #f3f4f6; padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            font-size: 14px; overflow-x: auto; white-space: nowrap;
        }
        .breadcrumb-item { color: var(--primary); font-weight: 500; cursor: pointer; }
        .breadcrumb-separator { margin: 0 6px; color: #999; }
        .breadcrumb-current { color: #666; }

        /* åˆ—è¡¨åŒºåŸŸ */
        ul { list-style: none; padding: 0; margin: 0; }
        li { border-bottom: 1px solid #eaecef; }
        li:last-child { border-bottom: none; }

        .list-item {
            display: flex; 
            align-items: center;
            padding: 16px 15px; 
            text-decoration: none; 
            color: var(--text-main);
            cursor: pointer;
            position: relative;
            background: #fff;
            user-select: none; 
        }
        .list-item:active { background-color: #f2f2f2; }

        .list-item.selected { background-color: var(--selected-bg); }
        .list-item.selected::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0;
            width: 4px; background: var(--primary);
        }

        .item-content { flex: 1; min-width: 0; display: flex; align-items: center; }
        .item-icon { margin-right: 12px; font-size: 20px; flex-shrink: 0; width: 24px; text-align: center; }
        
        .item-info { flex: 1; min-width: 0; }
        .item-name { font-weight: 600; font-size: 16px; display: block; line-height: 1.4; word-break: break-all; }
        .item-meta { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        /* å¤é€‰æ¡† */
        .select-checkbox {
            margin-right: 15px; width: 22px; height: 22px;
            flex-shrink: 0; display: none;
            pointer-events: none; 
            transform: scale(1.1);
        }
        .selection-mode .select-checkbox { display: block; }
        
        .arrow-icon { color: #ccc; font-size: 18px; margin-left: 10px; }
        .selection-mode .arrow-icon { display: none; }

        /* åº•éƒ¨æ“ä½œæ  */
        .action-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px);
            background: #24292f; color: white;
            padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 1000; width: 85%; max-width: 400px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .action-bar.visible { transform: translateX(-50%) translateY(0); }
        .action-count { font-weight: bold; font-size: 15px; }
        .action-btn {
            background: var(--primary); border: none; color: white;
            padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: 600;
        }
        .action-btn:disabled { background: #57606a; opacity: 0.7; }

        /* å¼¹çª— */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 85%; max-width: 360px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #d0d7de; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        
        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .btn { padding: 10px 16px; border-radius: 6px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-secondary { background: #f3f4f6; color: #24292f; }
        .btn-primary { background: var(--primary); color: white; }
        
        .loading { padding: 40px; text-align: center; color: #666; }
        .progress-log { font-size: 12px; color: #666; max-height: 120px; overflow-y: auto; background: #f8f8f8; padding: 8px; border-radius: 4px; border: 1px solid #eee; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ“š è‹±è¯­å­¦ä¹ ç¬”è®°</h1>
        <div class="header-actions">
            <button id="batch-btn" class="icon-btn" onclick="toggleBatchMode()">
                <span>âœ… é€‰æ‹©</span>
            </button>
            <button class="icon-btn" onclick="openSettings()">
                <span>âš™ï¸</span>
            </button>
        </div>
    </header>

    <div id="breadcrumb" class="breadcrumb"></div>
    <div id="latest-container"></div>

    <div id="file-list">
        <div class="loading">æ­£åœ¨åŠ è½½...</div>
    </div>
</div>

<div id="action-bar" class="action-bar">
    <span class="action-count">å·²é€‰ 0 é¡¹</span>
    <button id="move-btn" class="action-btn" onclick="openMoveModal()" disabled>ç§»åŠ¨</button>
</div>

<div id="move-modal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ“‚ ç§»åŠ¨æ–‡ä»¶</h3>
        <div class="form-group">
            <label>ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„</label>
            <input type="text" id="move-target-path" placeholder="ä¾‹å¦‚: Notes/2026">
        </div>
        <div id="move-log" class="progress-log" style="display:none;"></div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeMoveModal()">å–æ¶ˆ</button>
            <button id="btn-confirm-move" class="btn btn-primary" onclick="execMove()">ç¡®è®¤ç§»åŠ¨</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal">
        <h3>âš™ï¸ è®¾ç½®</h3>
        <div class="form-group">
            <label>GitHub Token</label>
            <input type="password" id="cfg-token" placeholder="å¿…å¡«: github_pat_...">
        </div>
        <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="cfg-user">
        </div>
        <div class="form-group">
            <label>ä»“åº“å</label>
            <input type="text" id="cfg-repo">
        </div>
        <div class="form-group">
            <label>æ ¹ç›®å½•</label>
            <input type="text" id="cfg-root">
        </div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
    const DEFAULTS = {
        user: 'moodHappy',
        repo: 'moodHappy.gitHub.io-nce',
        rootPath: 'Notes/danmu',
        token: ''
    };

    let config = {};
    let currentPath = '';
    let currentFiles = []; 
    let currentDirs = [];
    let isBatchMode = false;
    let selectedFilesMap = new Map(); 

    function getConfig() {
        const stored = localStorage.getItem('gh_nav_config_v5'); 
        return stored ? { ...DEFAULTS, ...JSON.parse(stored) } : DEFAULTS;
    }

    // --- åˆå§‹åŒ–ï¼šæ”¯æŒ URL å‚æ•° ---
    async function init() {
        config = getConfig();
        
        // 1. æ£€æŸ¥ URL ä¸­æ˜¯å¦æœ‰ ?path=... å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const pathParam = urlParams.get('path');

        // 2. å¦‚æœæœ‰å‚æ•°å°±ç”¨å‚æ•°ï¼Œæ²¡æœ‰åˆ™ç”¨æ ¹ç›®å½•
        // åˆå§‹åŠ è½½ä¸éœ€è¦ pushStateï¼Œæ‰€ä»¥ä¼  false
        const startPath = pathParam || config.rootPath;
        await loadPath(startPath, false);

        // 3. ç›‘å¬æµè§ˆå™¨å‰è¿›/åé€€äº‹ä»¶ (PopState)
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.path) {
                // å¦‚æœå†å²è®°å½•é‡Œæœ‰ pathï¼Œå°±åŠ è½½å®ƒ
                loadPath(event.state.path, false);
            } else {
                // å¦åˆ™å›é€€åˆ°æ ¹ç›®å½• (æˆ–è€…åˆå§‹é¡µé¢)
                loadPath(config.rootPath, false);
            }
        });
    }

    async function ghFetch(url, options = {}) {
        const headers = options.headers || {};
        if (config.token) headers['Authorization'] = `token ${config.token}`;
        
        const response = await fetch(url, { ...options, headers });
        if (response.status === 204) return true;
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    }

    // --- æ ¸å¿ƒåŠ è½½å‡½æ•° (å¢åŠ  history å¤„ç†) ---
    // addToHistory: true ä»£è¡¨æ˜¯ç”¨æˆ·ç‚¹å‡»è·³è½¬ï¼Œéœ€è¦æ›´æ–° URL
    // addToHistory: false ä»£è¡¨æ˜¯æµè§ˆå™¨åé€€æˆ–åˆå§‹åŒ–ï¼Œä¸éœ€è¦å†æ¬¡æ›´æ–° URL
    async function loadPath(path, addToHistory = true) {
        if (isBatchMode) toggleBatchMode(); 
        
        currentPath = path;

        // --- æ›´æ–°åœ°å€æ é€»è¾‘ ---
        if (addToHistory) {
            // æ„å»ºæ–° URLï¼Œä¾‹å¦‚ ?path=Notes/danmu/2026
            const newUrl = `${window.location.pathname}?path=${encodeURIComponent(path)}`;
            // æ¨å…¥å†å²è®°å½•
            history.pushState({ path: path }, '', newUrl);
        }

        renderBreadcrumb(path);
        
        const listEl = document.getElementById('file-list');
        const latestEl = document.getElementById('latest-container');
        listEl.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        if(latestEl) latestEl.innerHTML = '';

        try {
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`);
            
            if (!Array.isArray(data)) {
                window.location.href = data.html_url || data.download_url;
                return;
            }

            let dirs = [], files = [];
            data.forEach(item => {
                if(item.name === 'index.html') return;
                if(item.type === 'dir') dirs.push(item);
                else if(item.name.match(/\.(html|json)$/)) {
                    const ts = (item.name.match(/_(\d{13})\./) || [])[1];
                    files.push({
                        ...item,
                        timestamp: ts ? parseInt(ts) : 0,
                        dateStr: ts ? new Date(parseInt(ts)).toLocaleString('zh-CN', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}) : ''
                    });
                }
            });

            dirs.sort((a, b) => b.name.localeCompare(a.name));
            files.sort((a, b) => b.timestamp - a.timestamp);
            
            currentDirs = dirs;
            currentFiles = files;

            // æ ¹ç›®å½•æ˜¾ç¤ºæœ€æ–°
            if (path === config.rootPath && dirs.length > 0) {
                 const yearDir = dirs.find(d => /^\d{4}$/.test(d.name));
                 if(yearDir) fetchLatestInDir(yearDir);
            }

            renderList();

        } catch (e) {
            listEl.innerHTML = `<div class="loading" style="color:red">${e.message}</div>`;
        }
    }

    // --- æ¸²æŸ“åˆ—è¡¨ ---
    function renderList() {
        const listEl = document.getElementById('file-list');
        const ul = document.createElement('ul');
        if(isBatchMode) ul.classList.add('selection-mode');

        if (currentDirs.length === 0 && currentFiles.length === 0) {
            listEl.innerHTML = '<div class="loading">æš‚æ— æ–‡ä»¶</div>';
            return;
        }

        // æ–‡ä»¶å¤¹
        currentDirs.forEach(dir => {
            const li = document.createElement('li');
            const opacity = isBatchMode ? '0.6' : '1';
            // ç‚¹å‡»æ–‡ä»¶å¤¹ï¼šloadPath é»˜è®¤ç¬¬äºŒä¸ªå‚æ•°æ˜¯ trueï¼Œä¼šæ›´æ–° URL
            li.innerHTML = `
                <div class="list-item" style="opacity:${opacity}" onclick="loadPath('${dir.path}')">
                    <div class="item-content">
                        <span class="item-icon">ğŸ“</span>
                        <div class="item-info"><span class="item-name">${dir.name}</span></div>
                    </div>
                    <span class="arrow-icon">â€º</span>
                </div>`;
            ul.appendChild(li);
        });

        // æ–‡ä»¶
        currentFiles.forEach(file => {
            const li = document.createElement('li');
            const isSelected = selectedFilesMap.has(file.sha);
            
            let itemClass = "list-item";
            if (isSelected && isBatchMode) itemClass += " selected";

            // ä¿®å¤ï¼šæ‰¾å›äº† ğŸ“… å›¾æ ‡
            li.innerHTML = `
                <div class="${itemClass}" onclick="handleItemClick('${file.sha}')">
                    <input type="checkbox" class="select-checkbox" ${isSelected ? 'checked' : ''}>
                    <div class="item-content">
                        <span class="item-icon">ğŸ“„</span>
                        <div class="item-info">
                            <span class="item-name">${file.name.replace(/_\d{13}\.(html|json)/, '').replace(/_/g, ' ')}</span>
                            ${file.dateStr ? `<div class="item-meta">ğŸ“… ${file.dateStr}</div>` : ''}
                        </div>
                    </div>
                    ${!isBatchMode ? '<span class="arrow-icon">â€º</span>' : ''}
                </div>`;
            ul.appendChild(li);
        });

        listEl.innerHTML = '';
        listEl.appendChild(ul);
    }

    function handleItemClick(sha) {
        const file = currentFiles.find(f => f.sha === sha);
        if (!file) return;

        if (isBatchMode) {
            toggleFileSelect(file);
        } else {
            const url = `https://${config.user}.github.io/${config.repo}/${file.path}`;
            window.open(url, '_blank');
        }
    }

    // --- æ‰¹é‡é€‰æ‹©é€»è¾‘ ---
    function toggleBatchMode() {
        isBatchMode = !isBatchMode;
        const btn = document.getElementById('batch-btn');
        const actionBar = document.getElementById('action-bar');
        
        if (isBatchMode) {
            btn.classList.add('active');
            btn.innerHTML = '<span>âŒ å–æ¶ˆ</span>';
            actionBar.classList.add('visible');
        } else {
            btn.classList.remove('active');
            btn.innerHTML = '<span>âœ… é€‰æ‹©</span>';
            actionBar.classList.remove('visible');
            selectedFilesMap.clear();
            updateActionBar();
        }
        renderList();
    }

    function toggleFileSelect(file) {
        if (selectedFilesMap.has(file.sha)) {
            selectedFilesMap.delete(file.sha);
        } else {
            selectedFilesMap.set(file.sha, file);
        }
        updateActionBar();
        renderList(); 
    }

    function updateActionBar() {
        const count = selectedFilesMap.size;
        document.querySelector('.action-count').innerText = `å·²é€‰ ${count} é¡¹`;
        document.getElementById('move-btn').disabled = count === 0;
        document.getElementById('move-btn').innerHTML = count > 0 ? `ç§»åŠ¨ (${count})` : 'ç§»åŠ¨';
    }

    // --- ç§»åŠ¨é€»è¾‘ ---
    function openMoveModal() {
        if (!config.token) { alert("è¯·å…ˆè®¾ç½® Token"); openSettings(); return; }
        document.getElementById('move-target-path').value = currentPath; 
        document.getElementById('move-log').style.display = 'none';
        document.getElementById('move-modal').style.display = 'flex';
        document.getElementById('btn-confirm-move').disabled = false;
        document.getElementById('btn-confirm-move').innerText = "ç¡®è®¤ç§»åŠ¨";
    }

    function closeMoveModal() { document.getElementById('move-modal').style.display = 'none'; }

    async function execMove() {
        const targetDir = document.getElementById('move-target-path').value.trim().replace(/\/+$/, '');
        const logDiv = document.getElementById('move-log');
        const btn = document.getElementById('btn-confirm-move');
        
        if (!targetDir || targetDir === currentPath) { alert("ç›®æ ‡è·¯å¾„æ— æ•ˆ"); return; }
        
        btn.disabled = true;
        btn.innerText = "å¤„ç†ä¸­...";
        logDiv.style.display = 'block';
        logDiv.innerHTML = '';

        const files = Array.from(selectedFilesMap.values());
        let success = 0;

        for (const file of files) {
            logDiv.innerHTML += `<div>â³ ç§»åŠ¨: ${file.name}...</div>`;
            try {
                // 1. è¯»
                const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`);
                // 2. å†™
                await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${targetDir}/${file.name}`, {
                    method: 'PUT',
                    body: JSON.stringify({ message: `Move ${file.name}`, content: data.content })
                });
                // 3. åˆ 
                await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ message: `Del original`, sha: file.sha })
                });
                success++;
                logDiv.innerHTML += `<div style="color:green">âœ… å®Œæˆ</div>`;
            } catch (e) {
                logDiv.innerHTML += `<div style="color:red">âŒ å¤±è´¥: ${e.message}</div>`;
            }
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        if (success > 0) {
            setTimeout(() => {
                closeMoveModal();
                toggleBatchMode();
                loadPath(currentPath);
            }, 1500);
        } else {
            btn.disabled = false;
            btn.innerText = "é‡è¯•";
        }
    }

    // --- è¾…åŠ©é€»è¾‘ ---
    async function fetchLatestInDir(dirItem) {
        try {
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${dirItem.path}`);
            const files = data.filter(i => i.name.match(/\.(html|json)$/));
            if(files.length > 0) {
                 const f = files.sort((a,b)=>b.name.localeCompare(a.name))[0]; 
                 const url = `https://${config.user}.github.io/${config.repo}/${f.path}`;
                 document.getElementById('latest-container').innerHTML = `
                    <div style="background:#e6f6ff; border:1px solid #b6e3ff; padding:12px; border-radius:6px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;" onclick="window.open('${url}','_blank')">
                        <div>
                            <div style="font-size:12px; font-weight:bold; color:#0969da">NEW IN ${dirItem.name}</div>
                            <div style="font-weight:600; margin-top:2px;">${f.name.replace(/_\d{13}\..*$/,'').replace(/_/g,' ')}</div>
                        </div>
                        <span style="color:#0969da; font-weight:bold;">â†’</span>
                    </div>`;
            }
        } catch(e){}
    }

    function renderBreadcrumb(path) {
        const c = document.getElementById('breadcrumb');
        let html = `<span class="breadcrumb-item" onclick="loadPath('${config.rootPath}')">ğŸ </span>`;
        if (path !== config.rootPath) {
            const parts = path.substring(config.rootPath.length).split('/').filter(p=>p);
            let build = config.rootPath;
            parts.forEach((p, i) => {
                build += '/' + p;
                html += `<span class="breadcrumb-separator">/</span>`;
                if(i===parts.length-1) html += `<span class="breadcrumb-current">${p}</span>`;
                else html += `<span class="breadcrumb-item" onclick="loadPath('${build}')">${p}</span>`;
            });
        }
        c.innerHTML = html;
    }

    // è®¾ç½®é€»è¾‘
    function openSettings() { 
        document.getElementById('settings-modal').style.display = 'flex'; 
        document.getElementById('cfg-user').value = config.user;
        document.getElementById('cfg-repo').value = config.repo;
        document.getElementById('cfg-root').value = config.rootPath;
        document.getElementById('cfg-token').value = config.token;
    }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function saveSettings() {
        const newCfg = {
            user: document.getElementById('cfg-user').value.trim(),
            repo: document.getElementById('cfg-repo').value.trim(),
            rootPath: document.getElementById('cfg-root').value.trim().replace(/\/+$/,''),
            token: document.getElementById('cfg-token').value.trim()
        };
        localStorage.setItem('gh_nav_config_v5', JSON.stringify(newCfg));
        location.reload();
    }
    
    // å¼¹çª—å…³é—­
    window.onclick = (e) => { if(e.target.classList.contains('modal-overlay')) e.target.style.display='none'; };

    init();
</script>
</body>
</html>
