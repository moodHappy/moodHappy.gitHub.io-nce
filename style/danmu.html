<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>danmu - å…¼å®¹ç‰ˆ</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/Miyetsuko.png">

    <style>
        :root {
            --primary: #0969da;
            --danger: #cf222e;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --border: #d0d7de;
            --text-main: #1f2328;
            --text-muted: #656d76;
            --selected-bg: #e6f6ff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            padding-bottom: 120px; /* ç•™è¶³åº•éƒ¨ç©ºé—´ç»™æ“ä½œæ å’Œè„šæœ¬æŒ‰é’® */
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            background: #fff;
        }
        h1 { margin: 0; font-size: 18px; font-weight: 700; }

        .header-actions { display: flex; gap: 10px; }
        .icon-btn {
            background: #f6f8fa; border: 1px solid var(--border);
            border-radius: 6px; padding: 6px 12px; 
            font-size: 14px; color: var(--text-main); cursor: pointer;
            transition: all 0.2s;
            text-decoration: none; display: flex; align-items: center;
        }
        .icon-btn:hover { background: #eaeef2; }
        .icon-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Breadcrumb */
        .breadcrumb {
            background: #f3f4f6; padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            font-size: 14px; overflow-x: auto; white-space: nowrap;
            display: flex; align-items: center;
        }
        .breadcrumb-item { 
            color: var(--primary); text-decoration: none; font-weight: 500; 
            padding: 2px 4px; border-radius: 4px;
        }
        .breadcrumb-item:hover { background: rgba(9, 105, 218, 0.1); }
        .breadcrumb-separator { margin: 0 4px; color: #999; font-size: 12px; }
        .breadcrumb-current { color: var(--text-muted); font-weight: 600; padding: 0 4px; }

        /* List Area */
        ul { list-style: none; padding: 0; margin: 0; }
        li { border-bottom: 1px solid #eaecef; }
        li:last-child { border-bottom: none; }

        /* List Item - Now using <a> tag */
        .list-item {
            display: flex; 
            align-items: center;
            padding: 16px 15px; 
            text-decoration: none; /* å»æ‰ä¸‹åˆ’çº¿ */
            color: var(--text-main);
            cursor: pointer;
            position: relative;
            background: #fff;
            transition: background 0.15s;
            -webkit-user-select: none; /* ä¼˜åŒ–è§¦æ‘¸ä½“éªŒ */
            user-select: none;
        }
        .list-item:hover { background-color: #f8f9fa; }
        .list-item:active { background-color: #f0f0f0; }

        .list-item.selected { background-color: var(--selected-bg); }
        .list-item.selected::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0;
            width: 4px; background: var(--primary);
        }

        .item-content { flex: 1; min-width: 0; display: flex; align-items: center; }
        .item-icon { margin-right: 12px; font-size: 20px; flex-shrink: 0; width: 24px; text-align: center; }

        .item-info { flex: 1; min-width: 0; }
        .item-name { font-weight: 600; font-size: 15px; display: block; line-height: 1.4; word-break: break-all; color: var(--text-main); }
        .item-meta { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        /* Checkbox & Selection */
        .select-checkbox {
            margin-right: 15px; width: 20px; height: 20px;
            flex-shrink: 0; display: none;
            accent-color: var(--primary);
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ç»™çˆ¶çº§å¤„ç† */
        }
        .selection-mode .select-checkbox { display: block; }
        
        .arrow-icon { color: #d0d7de; font-size: 18px; margin-left: 10px; font-weight: bold; }
        .selection-mode .arrow-icon { display: none; }

        /* Bottom Action Bar */
        .action-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px);
            background: #24292f; color: white;
            padding: 10px 16px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 9999; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ï¼Œä½†ä¸è¦æŒ¡ä½è„šæœ¬çš„ Alert */
            width: 90%; max-width: 400px;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .action-bar.visible { transform: translateX(-50%) translateY(0); }
        .action-count { font-weight: bold; font-size: 14px; white-space: nowrap; margin-right: 10px; }

        .action-btn-group { display: flex; gap: 8px; }
        .action-btn {
            border: none; color: white;
            padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;
        }
        .btn-move { background: var(--primary); }
        .btn-del { background: var(--danger); }
        .btn-edit { background: #2da44e; }
        .action-btn:disabled { background: #57606a; opacity: 0.5; cursor: not-allowed; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 85%; max-width: 360px; box-shadow: 0 20px 40px rgba(0,0,0,0.25); }
        .modal h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #d0d7de; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .form-group .hint { font-size: 12px; color: #666; margin-top: 5px; }

        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 10px 16px; border-radius: 6px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-secondary { background: #f3f4f6; color: #24292f; }
        .btn-primary { background: var(--primary); color: white; }

        /* Logs & Loading */
        .loading { padding: 40px; text-align: center; color: #666; font-size: 14px; }
        .progress-log { font-size: 12px; color: #666; max-height: 150px; overflow-y: auto; background: #f8f8f8; padding: 10px; border-radius: 4px; border: 1px solid #eee; margin-top: 10px; }
        .log-item { margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }

        /* Latest Card */
        .latest-card {
            background: #f1f8ff; border: 1px solid #c8e1ff; 
            padding: 12px 15px; border-radius: 8px; 
            margin-bottom: 15px; text-decoration: none; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .latest-card:hover { background: #def; }
        .latest-badge { font-size: 11px; font-weight: bold; color: #0969da; text-transform: uppercase; margin-bottom: 2px; display: block; }
        .latest-title { font-weight: 600; color: #1f2328; font-size: 15px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ“š è‹±è¯­ç¬”è®°ç®¡ç†</h1>
        <div class="header-actions">
            <button id="batch-btn" class="icon-btn" onclick="toggleBatchMode()">
                <span>âœ… é€‰æ‹©</span>
            </button>
            <button class="icon-btn" onclick="openSettings()">
                <span>âš™ï¸</span>
            </button>
        </div>
    </header>

    <div id="breadcrumb" class="breadcrumb"></div>
    <div id="latest-container"></div>

    <div id="file-list">
        <div class="loading">æ­£åœ¨è¿æ¥ GitHub...</div>
    </div>
</div>

<div id="action-bar" class="action-bar">
    <span class="action-count">å·²é€‰ 0 é¡¹</span>
    <div class="action-btn-group">
        <button id="edit-btn" class="action-btn btn-edit" onclick="openEditModal()" disabled>âœï¸</button>
        <button id="move-btn" class="action-btn btn-move" onclick="openMoveModal()" disabled>ç§»åŠ¨</button>
        <button id="del-btn" class="action-btn btn-del" onclick="execDelete()" disabled>åˆ é™¤</button>
    </div>
</div>

<div id="edit-modal" class="modal-overlay">
    <div class="modal">
        <h3>âœï¸ ç¼–è¾‘ / é‡å‘½å</h3>
        <div class="form-group">
            <label>æ ‡é¢˜åç§°</label>
            <input type="text" id="edit-name-input">
        </div>
        <div class="form-group">
            <label>æ—¥æœŸæ—¶é—´ (å†³å®šæ’åº)</label>
            <input type="datetime-local" id="edit-time-input">
        </div>
        <div id="edit-log" class="progress-log" style="display:none;"></div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button id="btn-save-edit" class="btn btn-primary" onclick="execEdit()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="move-modal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ“‚ ç§»åŠ¨æ–‡ä»¶</h3>
        <div class="form-group">
            <label>ç›®æ ‡è·¯å¾„ (ä¾‹å¦‚ Notes/2025)</label>
            <input type="text" id="move-target-path">
        </div>
        <div id="move-log" class="progress-log" style="display:none;"></div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeMoveModal()">å–æ¶ˆ</button>
            <button id="btn-confirm-move" class="btn btn-primary" onclick="execMove()">ç§»åŠ¨</button>
        </div>
    </div>
</div>

<div id="delete-modal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶</h3>
        <div id="delete-log" class="progress-log"></div>
        <div class="btn-group">
            <button id="btn-done-del" class="btn btn-primary" onclick="closeDeleteModal()" style="display:none; width:100%">å®Œæˆ</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal">
        <h3>âš™ï¸ GitHub é…ç½®</h3>
        <div class="form-group">
            <label>Token (å¿…å¡«, Repoæƒé™)</label>
            <input type="password" id="cfg-token" placeholder="github_pat_...">
        </div>
        <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="cfg-user">
        </div>
        <div class="form-group">
            <label>ä»“åº“å</label>
            <input type="text" id="cfg-repo">
        </div>
        <div class="form-group">
            <label>æ ¹ç›®å½•è·¯å¾„</label>
            <input type="text" id="cfg-root">
        </div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜å¹¶åˆ·æ–°</button>
        </div>
    </div>
</div>

<script>
    // --- é…ç½®ä¸çŠ¶æ€ ---
    const DEFAULTS = {
        user: 'moodHappy',
        repo: 'moodHappy.gitHub.io-nce',
        rootPath: 'Notes/danmu',
        token: ''
    };

    let config = {};
    let currentPath = '';
    let currentFiles = []; 
    let currentDirs = [];
    let isBatchMode = false;
    let selectedFilesMap = new Map(); 

    function getConfig() {
        const stored = localStorage.getItem('gh_nav_config_v5'); 
        return stored ? { ...DEFAULTS, ...JSON.parse(stored) } : DEFAULTS;
    }

    // --- æ ¸å¿ƒåˆå§‹åŒ– ---
    async function init() {
        config = getConfig();
        const urlParams = new URLSearchParams(window.location.search);
        
        // ä¼˜å…ˆè¯»å– URL ä¸­çš„ path å‚æ•°ï¼Œå®ç°å­ç›®å½•é“¾æ¥åˆ†äº«
        const startPath = urlParams.get('path') || config.rootPath;
        
        await loadPath(startPath, false);

        // å¤„ç†æµè§ˆå™¨åé€€æŒ‰é’®
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.path) loadPath(event.state.path, false);
            else loadPath(config.rootPath, false);
        });
    }

    // --- GitHub API å°è£… ---
    async function ghFetch(url, options = {}) {
        const headers = options.headers || {};
        if (config.token) headers['Authorization'] = `token ${config.token}`;

        // é˜²æ­¢ç¼“å­˜å¯¼è‡´åˆ—è¡¨ä¸æ›´æ–°
        const noCacheUrl = url + (url.includes('?') ? '&' : '?') + 't=' + new Date().getTime();

        const response = await fetch(noCacheUrl, { ...options, headers });
        if (response.status === 204) return true;
        if (!response.ok) {
            const err = await response.json().catch(()=>({}));
            throw new Error(err.message || `HTTP ${response.status}`);
        }
        return await response.json();
    }

    // --- åŠ è½½è·¯å¾„ ---
    async function loadPath(path, addToHistory = true) {
        if (isBatchMode) toggleBatchMode(); // åˆ‡æ¢ç›®å½•æ—¶é€€å‡ºå¤šé€‰æ¨¡å¼
        currentPath = path;

        // æ›´æ–° URLï¼Œæ–¹ä¾¿ç”¨æˆ·åˆ†äº«å­æ–‡ä»¶å¤¹é“¾æ¥
        if (addToHistory) {
            const newUrl = `${window.location.pathname}?path=${encodeURIComponent(path)}`;
            history.pushState({ path: path }, '', newUrl);
        }

        renderBreadcrumb(path);

        const listEl = document.getElementById('file-list');
        const latestEl = document.getElementById('latest-container');
        listEl.innerHTML = '<div class="loading">æ­£åœ¨è·å–åˆ—è¡¨...</div>';
        if(latestEl) latestEl.innerHTML = '';

        try {
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`);

            if (!Array.isArray(data)) {
                // å¦‚æœè·¯å¾„æ˜¯ä¸ªæ–‡ä»¶ï¼Œç›´æ¥è·³è½¬
                window.location.href = `https://${config.user}.github.io/${config.repo}/${path}`;
                return;
            }

            let dirs = [], files = [];
            data.forEach(item => {
                if(item.name.toLowerCase() === 'index.html') return;
                
                if(item.type === 'dir') {
                    dirs.push(item);
                } else if(item.name.match(/\.(html|json)$/)) {
                    const ts = (item.name.match(/_(\d{13})\./) || [])[1];
                    files.push({
                        ...item,
                        timestamp: ts ? parseInt(ts) : 0,
                        dateStr: ts ? new Date(parseInt(ts)).toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12: false}) : ''
                    });
                }
            });

            // æ’åºï¼šæ–‡ä»¶å¤¹æŒ‰åç§°é™åºï¼ˆå¹´ä»½ï¼‰ï¼Œæ–‡ä»¶æŒ‰æ—¶é—´å€’åº
            dirs.sort((a, b) => b.name.localeCompare(a.name));
            files.sort((a, b) => b.timestamp - a.timestamp);

            currentDirs = dirs;
            currentFiles = files;

            // æ ¹ç›®å½•ä¸‹æ£€æŸ¥æœ€æ–°ç¬”è®°
            if (path === config.rootPath && dirs.length > 0) {
                 const yearDir = dirs.find(d => /^\d{4}$/.test(d.name));
                 if(yearDir) fetchLatestInDir(yearDir);
            }

            renderList();

        } catch (e) {
            listEl.innerHTML = `<div class="loading" style="color:#cf222e; background:#ffebe9; border:1px solid #ff818266; border-radius:6px;">âŒ åŠ è½½å¤±è´¥<br>${e.message}<br><br><small>è¯·æ£€æŸ¥ Token æˆ–ç½‘ç»œ</small></div>`;
        }
    }

    // --- æ¸²æŸ“åˆ—è¡¨ (å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ <a> æ ‡ç­¾) ---
    function renderList() {
        const listEl = document.getElementById('file-list');
        const ul = document.createElement('ul');
        if(isBatchMode) ul.classList.add('selection-mode');

        if (currentDirs.length === 0 && currentFiles.length === 0) {
            listEl.innerHTML = '<div class="loading">æ­¤æ–‡ä»¶å¤¹ä¸ºç©º</div>';
            return;
        }

        // 1. æ¸²æŸ“æ–‡ä»¶å¤¹
        currentDirs.forEach(dir => {
            const li = document.createElement('li');
            const opacity = isBatchMode ? '0.5' : '1';
            const pointer = isBatchMode ? 'none' : 'auto';
            
            // æ„é€ å¸¦å‚æ•°çš„ URLï¼Œæ”¯æŒå³é”®å¤åˆ¶é“¾æ¥
            const href = `?path=${encodeURIComponent(dir.path)}`;
            
            li.innerHTML = `
                <a href="${href}" class="list-item" style="opacity:${opacity}; pointer-events:${pointer}" onclick="handleDirClick(event, '${dir.path}')">
                    <div class="item-content">
                        <span class="item-icon" style="color:#54aeff">ğŸ“</span>
                        <div class="item-info"><span class="item-name">${dir.name}</span></div>
                    </div>
                    <span class="arrow-icon">â€º</span>
                </a>`;
            ul.appendChild(li);
        });

        // 2. æ¸²æŸ“æ–‡ä»¶
        currentFiles.forEach(file => {
            const li = document.createElement('li');
            const isSelected = selectedFilesMap.has(file.sha);

            let itemClass = "list-item";
            if (isSelected && isBatchMode) itemClass += " selected";

            // æ ¼å¼åŒ–æ ‡é¢˜
            let cleanName = file.name.replace(/_\d{13}\.(html|json)/, '').replace(/_/g, ' ');

            // æ„é€ çœŸå®çš„ GitHub Pages é“¾æ¥
            const realUrl = `https://${config.user}.github.io/${config.repo}/${file.path}`;

            li.innerHTML = `
                <a href="${realUrl}" target="_blank" class="${itemClass}" onclick="handleFileClick(event, '${file.sha}')">
                    <input type="checkbox" class="select-checkbox" ${isSelected ? 'checked' : ''}>
                    <div class="item-content">
                        <span class="item-icon" style="color:#656d76">ğŸ“„</span>
                        <div class="item-info">
                            <span class="item-name">${cleanName}</span>
                            ${file.dateStr ? `<div class="item-meta">ğŸ“… ${file.dateStr}</div>` : ''}
                        </div>
                    </div>
                    ${!isBatchMode ? '<span class="arrow-icon" style="color:#0969da">â†—</span>' : ''}
                </a>`;
            ul.appendChild(li);
        });

        listEl.innerHTML = '';
        listEl.appendChild(ul);
    }

    // --- äº‹ä»¶å¤„ç† ---
    
    // ç‚¹å‡»æ–‡ä»¶å¤¹ï¼šæ‹¦æˆªé»˜è®¤è·³è½¬ï¼Œä½¿ç”¨ AJAX åŠ è½½ (SPAä½“éªŒ)
    function handleDirClick(e, path) {
        e.preventDefault(); // é˜»æ­¢æµè§ˆå™¨ç›´æ¥è·³è½¬ ?path=...
        loadPath(path);
    }

    // ç‚¹å‡»æ–‡ä»¶ï¼šå¦‚æœæ˜¯å¤šé€‰æ¨¡å¼åˆ™æ‹¦æˆªï¼Œå¦åˆ™å…è®¸æµè§ˆå™¨é»˜è®¤æ‰“å¼€æ–°æ ‡ç­¾é¡µ
    function handleFileClick(e, sha) {
        if (isBatchMode) {
            e.preventDefault(); // å¤šé€‰æ¨¡å¼ä¸‹ï¼Œç¦æ­¢è·³è½¬
            const file = currentFiles.find(f => f.sha === sha);
            if (file) toggleFileSelect(file);
        }
        // æ™®é€šæ¨¡å¼ä¸‹ï¼Œä¸æ‹¦æˆªï¼Œ<a> æ ‡ç­¾ä¼šè‡ªåŠ¨ target="_blank" æ‰“å¼€ï¼Œç¡®ä¿è„šæœ¬ç”Ÿæ•ˆ
    }

    // --- æ‰¹é‡æ¨¡å¼é€»è¾‘ ---
    function toggleBatchMode() {
        isBatchMode = !isBatchMode;
        const btn = document.getElementById('batch-btn');
        const actionBar = document.getElementById('action-bar');

        if (isBatchMode) {
            btn.classList.add('active');
            btn.innerHTML = '<span>âŒ å–æ¶ˆ</span>';
            actionBar.classList.add('visible');
        } else {
            btn.classList.remove('active');
            btn.innerHTML = '<span>âœ… é€‰æ‹©</span>';
            actionBar.classList.remove('visible');
            selectedFilesMap.clear();
            updateActionBar();
        }
        renderList();
    }

    function toggleFileSelect(file) {
        if (selectedFilesMap.has(file.sha)) {
            selectedFilesMap.delete(file.sha);
        } else {
            selectedFilesMap.set(file.sha, file);
        }
        updateActionBar();
        renderList(); 
    }

    function updateActionBar() {
        const count = selectedFilesMap.size;
        document.querySelector('.action-count').innerText = `å·²é€‰ ${count} é¡¹`;
        document.getElementById('move-btn').disabled = count === 0;
        document.getElementById('del-btn').disabled = count === 0;
        document.getElementById('edit-btn').disabled = count !== 1;
    }

    // --- åŠŸèƒ½ï¼šç¼–è¾‘/é‡å‘½å ---
    function openEditModal() {
        if (selectedFilesMap.size !== 1) return;
        const file = selectedFilesMap.values().next().value;

        const match = file.name.match(/(.*)_(\d{13})\.(html|json)$/);
        let currentTitle = file.name;
        let currentTs = Date.now();
        let ext = '.html';

        if (match) {
            currentTitle = match[1];
            currentTs = parseInt(match[2]);
            ext = '.' + match[3];
        }

        const dateObj = new Date(currentTs);
        // æ„å»º datetime-local å­—ç¬¦ä¸² (è€ƒè™‘æ—¶åŒºåç§»)
        const pad = (n) => String(n).padStart(2,'0');
        const dateStr = `${dateObj.getFullYear()}-${pad(dateObj.getMonth()+1)}-${pad(dateObj.getDate())}T${pad(dateObj.getHours())}:${pad(dateObj.getMinutes())}`;

        document.getElementById('edit-name-input').value = currentTitle;
        document.getElementById('edit-time-input').value = dateStr;
        document.getElementById('edit-name-input').dataset.ext = ext; 

        document.getElementById('edit-log').style.display = 'none';
        document.getElementById('edit-modal').style.display = 'flex';
        const btn = document.getElementById('btn-save-edit');
        btn.disabled = false;
        btn.innerText = "ä¿å­˜";
    }

    function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; }

    async function execEdit() {
        if (!config.token) { alert("è¯·å…ˆè®¾ç½® Token"); openSettings(); return; }

        const file = selectedFilesMap.values().next().value;
        const newTitle = document.getElementById('edit-name-input').value.trim();
        const newTimeStr = document.getElementById('edit-time-input').value;
        const ext = document.getElementById('edit-name-input').dataset.ext || '.html';
        const logDiv = document.getElementById('edit-log');
        const btn = document.getElementById('btn-save-edit');

        if (!newTitle || !newTimeStr) { alert("è¯·è¡¥å…¨ä¿¡æ¯"); return; }

        const newTs = new Date(newTimeStr).getTime();
        const newFilename = `${newTitle}_${newTs}${ext}`;

        if (newFilename === file.name) { closeEditModal(); return; }

        btn.disabled = true;
        btn.innerText = "å¤„ç†ä¸­...";
        logDiv.style.display = 'block';
        logDiv.innerHTML = `<div class="log-item">â³ è¯»å–åŸæ–‡ä»¶...</div>`;

        try {
            // Get content
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`);
            
            // Create new
            logDiv.innerHTML += `<div class="log-item">â³ åˆ›å»º: ${newFilename}</div>`;
            const newPath = currentPath + '/' + newFilename;
            await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${newPath}`, {
                method: 'PUT',
                body: JSON.stringify({
                    message: `Rename to ${newFilename}`,
                    content: data.content
                })
            });

            // Delete old
            logDiv.innerHTML += `<div class="log-item">â³ åˆ é™¤æ—§æ–‡ä»¶...</div>`;
            await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`, {
                method: 'DELETE',
                body: JSON.stringify({ message: `Cleanup after rename`, sha: file.sha })
            });

            logDiv.innerHTML += `<div style="color:green;font-weight:bold">âœ… ä¿®æ”¹å®Œæˆ</div>`;
            setTimeout(() => {
                closeEditModal();
                toggleBatchMode();
                loadPath(currentPath);
            }, 800);

        } catch (e) {
            logDiv.innerHTML += `<div style="color:red">âŒ é”™è¯¯: ${e.message}</div>`;
            btn.disabled = false;
            btn.innerText = "é‡è¯•";
        }
    }

    // --- åŠŸèƒ½ï¼šç§»åŠ¨ ---
    function openMoveModal() {
        if (!config.token) { alert("è¯·å…ˆè®¾ç½® Token"); openSettings(); return; }
        document.getElementById('move-target-path').value = currentPath; 
        document.getElementById('move-log').style.display = 'none';
        document.getElementById('move-modal').style.display = 'flex';
        document.getElementById('btn-confirm-move').disabled = false;
        document.getElementById('btn-confirm-move').innerText = "ç§»åŠ¨";
    }
    function closeMoveModal() { document.getElementById('move-modal').style.display = 'none'; }

    async function execMove() {
        const targetDir = document.getElementById('move-target-path').value.trim().replace(/\/+$/, '');
        const logDiv = document.getElementById('move-log');
        const btn = document.getElementById('btn-confirm-move');

        if (!targetDir) { alert("ç›®æ ‡è·¯å¾„ä¸èƒ½ä¸ºç©º"); return; }
        if (targetDir === currentPath) { alert("ç›®æ ‡è·¯å¾„ä¸èƒ½æ˜¯å½“å‰è·¯å¾„"); return; }

        btn.disabled = true;
        btn.innerText = "ç§»åŠ¨ä¸­...";
        logDiv.style.display = 'block';
        logDiv.innerHTML = '';

        const files = Array.from(selectedFilesMap.values());
        let success = 0;

        for (const file of files) {
            logDiv.innerHTML += `<div class="log-item">â³ ${file.name}</div>`;
            try {
                const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`);
                
                // Check if file exists in target (optional, but good practice to avoid overwrite error if sha not provided)
                // GitHub API PUT will update if file exists, create if not. We just create.
                
                await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${targetDir}/${file.name}`, {
                    method: 'PUT',
                    body: JSON.stringify({ message: `Move ${file.name}`, content: data.content })
                });

                await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ message: `Del original`, sha: file.sha })
                });

                success++;
                logDiv.lastElementChild.innerHTML += ` <span style="color:green">âœ…</span>`;
            } catch (e) {
                logDiv.lastElementChild.innerHTML += ` <span style="color:red">âŒ ${e.message}</span>`;
            }
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        if (success > 0) {
            setTimeout(() => { closeMoveModal(); toggleBatchMode(); loadPath(currentPath); }, 1000);
        } else {
            btn.disabled = false;
        }
    }

    // --- åŠŸèƒ½ï¼šåˆ é™¤ ---
    async function execDelete() {
        if (!config.token) { alert("è¯·å…ˆè®¾ç½® Token"); openSettings(); return; }
        const count = selectedFilesMap.size;
        if (!confirm(`âš ï¸ ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) return;

        document.getElementById('delete-modal').style.display = 'flex';
        const logDiv = document.getElementById('delete-log');
        const doneBtn = document.getElementById('btn-done-del');
        logDiv.innerHTML = '';
        doneBtn.style.display = 'none';

        const files = Array.from(selectedFilesMap.values());
        let success = 0;

        for (const file of files) {
            logDiv.innerHTML += `<div class="log-item">â³ åˆ é™¤ ${file.name}...</div>`;
            try {
                await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${file.path}`, {
                    method: 'DELETE',
                    body: JSON.stringify({ message: `Batch Delete`, sha: file.sha })
                });
                success++;
                logDiv.lastElementChild.innerHTML = `<span style="color:green">âœ… ${file.name} å·²åˆ é™¤</span>`;
            } catch (e) {
                logDiv.lastElementChild.innerHTML = `<span style="color:red">âŒ ${file.name} å¤±è´¥: ${e.message}</span>`;
            }
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        doneBtn.style.display = 'block';
        if (success > 0) {
            toggleBatchMode();
            loadPath(currentPath);
        }
    }
    function closeDeleteModal() { document.getElementById('delete-modal').style.display = 'none'; }

    // --- è¾…åŠ©ï¼šé¢åŒ…å±‘ä¸æœ€æ–°æ–‡ä»¶ ---
    async function fetchLatestInDir(dirItem) {
        try {
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${dirItem.path}`);
            const files = data.filter(i => i.name.match(/\.(html|json)$/));
            if(files.length > 0) {
                 const f = files.sort((a,b)=>b.name.localeCompare(a.name))[0]; 
                 const url = `https://${config.user}.github.io/${config.repo}/${f.path}`;
                 const name = f.name.replace(/_\d{13}\..*$/,'').replace(/_/g,' ');
                 document.getElementById('latest-container').innerHTML = `
                    <a href="${url}" target="_blank" class="latest-card">
                        <div>
                            <span class="latest-badge">NEW IN ${dirItem.name}</span>
                            <div class="latest-title">${name}</div>
                        </div>
                        <span style="color:#0969da; font-weight:bold;">ç«‹å³é˜…è¯» â†’</span>
                    </a>`;
            }
        } catch(e){}
    }

    function renderBreadcrumb(path) {
        const c = document.getElementById('breadcrumb');
        let html = `<a href="?path=${config.rootPath}" class="breadcrumb-item" onclick="handleDirClick(event, '${config.rootPath}')">ğŸ </a>`;
        
        if (path !== config.rootPath) {
            const parts = path.substring(config.rootPath.length).split('/').filter(p=>p);
            let build = config.rootPath;
            parts.forEach((p, i) => {
                build += '/' + p;
                html += `<span class="breadcrumb-separator">/</span>`;
                // æœ€åä¸€é¡¹ä¸å¯ç‚¹å‡»ï¼Œå…¶ä»–é¡¹å¯ç‚¹å‡»
                if(i===parts.length-1) {
                    html += `<span class="breadcrumb-current">${p}</span>`;
                } else {
                    html += `<a href="?path=${build}" class="breadcrumb-item" onclick="handleDirClick(event, '${build}')">${p}</a>`;
                }
            });
        }
        c.innerHTML = html;
    }

    // --- è®¾ç½®é€»è¾‘ ---
    function openSettings() { 
        document.getElementById('settings-modal').style.display = 'flex'; 
        document.getElementById('cfg-user').value = config.user;
        document.getElementById('cfg-repo').value = config.repo;
        document.getElementById('cfg-root').value = config.rootPath;
        document.getElementById('cfg-token').value = config.token;
    }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function saveSettings() {
        const newCfg = {
            user: document.getElementById('cfg-user').value.trim(),
            repo: document.getElementById('cfg-repo').value.trim(),
            rootPath: document.getElementById('cfg-root').value.trim().replace(/\/+$/,''),
            token: document.getElementById('cfg-token').value.trim()
        };
        localStorage.setItem('gh_nav_config_v5', JSON.stringify(newCfg));
        location.reload();
    }

    // ç‚¹å‡»è’™å±‚å…³é—­
    window.onclick = (e) => { 
        if(e.target.classList.contains('modal-overlay')) e.target.style.display='none'; 
    };

    init();
</script>
</body>
</html>
