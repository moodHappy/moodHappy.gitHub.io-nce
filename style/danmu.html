<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>danmu - æ‰¹é‡ç®¡ç†ç‰ˆ</title>

    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/danmu.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/danmu.png">

    <style>
        :root {
            --primary: #0969da;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --border: #d0d7de;
            --text-main: #1f2328;
            --text-muted: #656d76;
            --folder-color: #54aeff;
            --danger-bg: #ffebe9;
            --danger-text: #cf222e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            padding-bottom: 80px; /* ä¸ºåº•éƒ¨æ“ä½œæ ç•™ç©ºé—´ */
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 20px;
            box-shadow: 0 3px 6px rgba(140, 149, 159, 0.03);
            position: relative;
        }

        /* å¤´éƒ¨ä¸å¯¼èˆª */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }

        h1 { margin: 0; font-size: 18px; }

        .header-actions { display: flex; gap: 10px; }

        .icon-btn {
            background: none; border: 1px solid var(--border);
            border-radius: 6px; cursor: pointer;
            padding: 5px 10px; font-size: 13px; color: var(--text-muted);
            display: flex; align-items: center; gap: 5px;
            transition: all 0.2s;
        }
        .icon-btn:hover { background-color: #f3f4f6; color: var(--text-main); }
        .icon-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); }

        /* é¢åŒ…å±‘å¯¼èˆª */
        .breadcrumb {
            background: #f3f4f6;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .breadcrumb-item { cursor: pointer; color: var(--primary); font-weight: 500; }
        .breadcrumb-item:hover { text-decoration: underline; }
        .breadcrumb-separator { margin: 0 8px; color: var(--text-muted); }
        .breadcrumb-current { color: var(--text-muted); pointer-events: none; }

        /* ç½®é¡¶åŒºåŸŸæ ·å¼ */
        .pinned-section {
            background: #e6f6ff;
            border: 1px solid #b6e3ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .pinned-label {
            font-size: 12px; font-weight: bold; color: #0969da; text-transform: uppercase; margin-bottom: 8px; display: block;
        }
        .pinned-card {
            display: flex; justify-content: space-between; align-items: center; text-decoration: none;
        }
        .pinned-title { font-size: 16px; font-weight: 700; color: #1f2328; }
        .pinned-meta { font-size: 12px; color: #57606a; margin-top: 4px; }
        .pinned-icon { font-size: 20px; margin-right: 10px; }
        .pinned-card:hover .pinned-title { text-decoration: underline; color: #0969da; }

        /* åˆ—è¡¨æ ·å¼ */
        ul { list-style: none; padding: 0; margin: 0; }
        li { border-bottom: 1px solid #eaecef; }
        li:last-child { border-bottom: none; }

        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 10px; text-decoration: none; color: var(--text-main);
            transition: background 0.2s; cursor: pointer; border-radius: 4px;
            user-select: none; /* é˜²æ­¢åŒå‡»é€‰ä¸­æ–‡æœ¬ */
        }
        .list-item:hover { background-color: #f6f8fa; }
        /* é€‰ä¸­æ€ */
        .list-item.selected { background-color: #e6f6ff; }

        .item-left-group {
            display: flex; align-items: center; flex-grow: 1; min-width: 0;
        }

        .item-icon { margin-right: 10px; font-size: 18px; flex-shrink: 0; }
        .folder-icon { color: var(--folder-color); }
        .file-icon { color: var(--text-muted); }

        .item-info { min-width: 0; }
        .item-name { font-weight: 600; font-size: 15px; display: block; }
        .item-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

        /* å¤é€‰æ¡†æ ·å¼ */
        .select-checkbox {
            margin-right: 15px;
            width: 20px; height: 20px;
            cursor: pointer;
            display: none; /* é»˜è®¤éšè— */
        }
        .selection-mode .select-checkbox { display: block; }
        
        /* éšè—æ™®é€šæ¨¡å¼ä¸‹çš„åˆ é™¤æŒ‰é’®ï¼Œæ‰¹é‡æ¨¡å¼ä¸‹ç»Ÿä¸€æ“ä½œ */
        .delete-btn {
            background-color: var(--danger-bg);
            color: var(--danger-text);
            border: 1px solid rgba(209, 36, 47, 0.3);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 10px;
        }
        .selection-mode .delete-btn { display: none; }

        /* åº•éƒ¨æ“ä½œæ  */
        .action-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #24292f; color: white;
            padding: 12px 20px; border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 15px;
            z-index: 100;
            opacity: 0; pointer-events: none; transition: all 0.3s;
            width: 90%; max-width: 400px; justify-content: space-between;
        }
        .action-bar.visible { opacity: 1; pointer-events: auto; bottom: 30px; }
        .action-count { font-weight: bold; font-size: 14px; }
        .action-btn {
            background: var(--primary); border: none; color: white;
            padding: 8px 16px; border-radius: 20px; font-size: 14px; cursor: pointer;
        }
        .action-btn:disabled { background: #666; cursor: not-allowed; }

        .loading, .error { text-align: center; padding: 30px; color: var(--text-muted); }
        .error { color: #cf222e; background: #ffebe9; border-radius: 6px; }

        /* å¼¹çª—é€šç”¨ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 8px; width: 85%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal h3 { margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold; }
        .form-group input[type="text"], 
        .form-group input[type="password"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid var(--border); border-radius: 4px; }
        .btn { padding: 8px 16px; cursor: pointer; border: none; border-radius: 4px; font-size: 14px; }
        .btn-secondary { background: #f3f4f6; color: #24292f; margin-right: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        
        /* è¿›åº¦æ¡ */
        .progress-log { font-size: 12px; color: #666; max-height: 100px; overflow-y: auto; margin-top: 10px; background: #f8f8f8; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container" id="main-container">
    <header>
        <h1>ğŸ“š è‹±è¯­å­¦ä¹ ç¬”è®°</h1>
        <div class="header-actions">
            <button id="batch-btn" class="icon-btn" onclick="toggleBatchMode()">
                <span>âœ… é€‰æ‹©</span>
            </button>
            <button class="icon-btn" onclick="openSettings()">
                <span>âš™ï¸ è®¾ç½®</span>
            </button>
        </div>
    </header>

    <div id="breadcrumb" class="breadcrumb"></div>
    <div id="latest-container"></div>

    <div id="file-list">
        <div class="loading">æ­£åœ¨åŠ è½½...</div>
    </div>
</div>

<div id="action-bar" class="action-bar">
    <span class="action-count">å·²é€‰ 0 é¡¹</span>
    <button id="move-btn" class="action-btn" onclick="openMoveModal()">ç§»åŠ¨æ–‡ä»¶ ğŸ“‚</button>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ”§ é…ç½®</h3>
        <div class="form-group" style="display:flex; justify-content:space-between; align-items:center;">
             <label>ğŸ”´ å•æ–‡ä»¶åˆ é™¤æ¨¡å¼</label>
             <input type="checkbox" id="cfg-del-enable" style="width:auto;">
        </div>
        <div class="form-group">
            <label>GitHub Token (PAT) <span style="color:red">*</span></label>
            <input type="password" id="cfg-token" placeholder="github_pat_...">
        </div>
        <div class="form-group">
            <label>GitHub ç”¨æˆ·å</label>
            <input type="text" id="cfg-user">
        </div>
        <div class="form-group">
            <label>ä»“åº“åç§°</label>
            <input type="text" id="cfg-repo">
        </div>
        <div class="form-group">
            <label>æ ¹ç›®å½•è·¯å¾„</label>
            <input type="text" id="cfg-root">
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜å¹¶åˆ·æ–°</button>
        </div>
    </div>
</div>

<div id="move-modal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ“‚ ç§»åŠ¨åˆ°...</h3>
        <div class="form-group">
            <label>ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„</label>
            <input type="text" id="move-target-path" placeholder="ä¾‹å¦‚: Notes/2026">
            <div style="font-size:12px; color:#666; margin-top:5px;">
                æç¤º: è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„ã€‚å¦‚æœæ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºã€‚
            </div>
        </div>
        <div id="move-log" class="progress-log" style="display:none;"></div>
        <div style="text-align: right; margin-top: 20px;">
            <button id="btn-cancel-move" class="btn btn-secondary" onclick="closeMoveModal()">å–æ¶ˆ</button>
            <button id="btn-confirm-move" class="btn btn-primary" onclick="execMove()">ç¡®è®¤ç§»åŠ¨</button>
        </div>
    </div>
</div>

<script>
    // --- é…ç½®ä¸çŠ¶æ€ ---
    const DEFAULTS = {
        user: 'moodHappy',
        repo: 'moodHappy.gitHub.io-nce',
        rootPath: 'Notes/danmu',
        token: '',
        enableDelete: false
    };

    let config = {};
    let currentPath = '';
    let currentDirs = []; // å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶å¤¹åˆ—è¡¨
    let currentFiles = []; // å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨
    
    // æ‰¹é‡æ¨¡å¼çŠ¶æ€
    let isBatchMode = false;
    let selectedFiles = new Set(); // å­˜å‚¨è¢«é€‰ä¸­çš„æ–‡ä»¶å¯¹è±¡ {path, sha, name}

    function getConfig() {
        const stored = localStorage.getItem('gh_nav_config_v5'); 
        return stored ? { ...DEFAULTS, ...JSON.parse(stored) } : DEFAULTS;
    }

    async function init() {
        config = getConfig();
        if (!currentPath) currentPath = config.rootPath;
        await loadPath(currentPath);
    }

    // --- GitHub API æ ¸å¿ƒ ---
    async function ghFetch(url, options = {}) {
        const headers = options.headers || {};
        if (config.token && config.token.trim() !== '') {
            headers['Authorization'] = `token ${config.token}`;
            headers['Accept'] = 'application/vnd.github.v3+json';
        }

        const fetchOpts = { ...options, headers: headers };
        const response = await fetch(url, fetchOpts);

        if (response.status === 204) return true; // åˆ é™¤æˆåŠŸ

        if (!response.ok) {
            let errMsg = `HTTP ${response.status}`;
            try {
                const errJson = await response.json();
                if (errJson.message) errMsg += ` - ${errJson.message}`;
            } catch(e) {}
            if (response.status === 403) throw new Error("API é™åˆ¶æˆ–æ— æƒé™ (403)");
            if (response.status === 404) throw new Error("æœªæ‰¾åˆ°èµ„æº (404)");
            throw new Error(errMsg);
        }
        return await response.json();
    }

    // --- åˆ—è¡¨åŠ è½½é€»è¾‘ ---
    async function loadPath(path) {
        // åˆ‡æ¢è·¯å¾„æ—¶é€€å‡ºæ‰¹é‡æ¨¡å¼
        if (isBatchMode) toggleBatchMode();

        currentPath = path;
        renderBreadcrumb(path);

        const listContainer = document.getElementById('file-list');
        const latestContainer = document.getElementById('latest-container');
        
        listContainer.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½...</div>';
        if(latestContainer) latestContainer.innerHTML = '';

        const apiUrl = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`;

        try {
            const data = await ghFetch(apiUrl);

            if (!Array.isArray(data)) {
                // å¦‚æœæ˜¯æ–‡ä»¶ç›´æ¥è·³è½¬
                window.location.href = data.html_url || data.download_url;
                return;
            }

            // å¤„ç†æ•°æ®
            let dirs = [];
            let files = [];
            processItems(data, dirs, files);

            // æ’åº
            dirs.sort((a, b) => b.name.localeCompare(a.name));
            files.sort((a, b) => b.timestamp - a.timestamp);
            
            // ç¼“å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›æ‰¹é‡æ“ä½œä½¿ç”¨
            currentDirs = dirs;
            currentFiles = files;

            // å¦‚æœæ˜¯æ ¹ç›®å½•ï¼ŒæŸ¥æ‰¾æœ€æ–°æ–‡ä»¶
            if (path === config.rootPath) {
                checkLatestFile(dirs);
            }

            renderList();

        } catch (error) {
            console.error(error);
            listContainer.innerHTML = `<div class="error"><strong>åŠ è½½å¤±è´¥</strong><br>${error.message}</div>`;
        }
    }

    function processItems(items, dirsArr, filesArr) {
        items.forEach(item => {
            if (item.name.toLowerCase() === 'index.html') return;
            if (item.type === 'dir') {
                dirsArr.push(item);
            } else if (item.name.endsWith('.html') || item.name.endsWith('.json')) { 
                const match = item.name.match(/_(\d{13})\./);
                const timestamp = match ? parseInt(match[1]) : 0;
                filesArr.push({
                    ...item,
                    timestamp: timestamp,
                    dateStr: timestamp ? new Date(timestamp).toLocaleString('zh-CN', { hour12: false }) : ''
                });
            }
        });
    }

    // --- æ¸²æŸ“åˆ—è¡¨ (æ”¯æŒæ‰¹é‡æ¨¡å¼) ---
    function renderList() {
        const listContainer = document.getElementById('file-list');
        const containerClass = isBatchMode ? 'selection-mode' : '';
        
        if (currentDirs.length === 0 && currentFiles.length === 0) {
            listContainer.innerHTML = '<div class="loading">æ­¤æ–‡ä»¶å¤¹ä¸ºç©º</div>';
            return;
        }

        let html = `<ul class="${containerClass}">`;

        // æ–‡ä»¶å¤¹
        currentDirs.forEach(dir => {
            // æ–‡ä»¶å¤¹åœ¨æ‰¹é‡æ¨¡å¼ä¸‹å˜ç°æˆ–ä¸å¯é€‰ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæ‰¹é‡æ¨¡å¼ä¸‹ç‚¹å‡»æ–‡ä»¶å¤¹æ— æ•ˆæˆ–ä»…ç”¨äºè¿›å…¥
            // è¿™é‡Œé€»è¾‘ï¼šæ‰¹é‡æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»æ–‡ä»¶å¤¹ä¾ç„¶è¿›å…¥ï¼Œä¸æ”¯æŒç§»åŠ¨æ–‡ä»¶å¤¹
            html += `
                <li onclick="${isBatchMode ? '' : `loadPath('${dir.path}')`}">
                    <div class="list-item" style="${isBatchMode ? 'opacity:0.5' : ''}">
                        <div class="item-left-group">
                            <span class="item-icon folder-icon">ğŸ“</span>
                            <div class="item-info">
                                <span class="item-name">${dir.name}</span>
                            </div>
                        </div>
                        ${!isBatchMode ? '<span style="color:#ccc">â€º</span>' : ''}
                    </div>
                </li>
            `;
        });

        // æ–‡ä»¶
        currentFiles.forEach(file => {
            let displayName = file.name.replace(/\.(html|json)$/, '').replace(/_\d{13}$/, '').replace(/_/g, ' ');
            let fileUrl = `https://${config.user}.github.io/${config.repo}/${file.path}`;
            
            // æ£€æŸ¥æ˜¯å¦è¢«é€‰ä¸­
            const isSelected = isFileSelected(file.sha);
            const selectedClass = isSelected ? 'selected' : '';
            const checkedAttr = isSelected ? 'checked' : '';

            // æ‰¹é‡æ¨¡å¼ç‚¹å‡»è§¦å‘ toggleSelectï¼Œæ™®é€šæ¨¡å¼ç‚¹å‡»è·³è½¬
            const clickAction = isBatchMode 
                ? `toggleFileSelect('${file.sha}', '${file.path}', '${file.name}')` 
                : `window.open('${fileUrl}', '_blank')`;

            // é˜»æ­¢å†’æ³¡çš„åˆ é™¤æŒ‰é’®
            let deleteBtnHtml = '';
            if (config.enableDelete && !isBatchMode) {
                deleteBtnHtml = `<button class="delete-btn" onclick="deleteSingleFile(event, '${file.path}', '${file.sha}')">ğŸ—‘ï¸</button>`;
            }

            html += `
                <li>
                    <div class="list-item ${selectedClass}" onclick="${clickAction}">
                        <div class="item-left-group">
                            <input type="checkbox" class="select-checkbox" ${checkedAttr} disabled> 
                            ${deleteBtnHtml}
                            <span class="item-icon file-icon">ğŸ“„</span>
                            <div class="item-info">
                                <span class="item-name">${displayName}</span>
                                ${file.dateStr ? `<div class="item-meta">ğŸ“… ${file.dateStr}</div>` : ''}
                            </div>
                        </div>
                    </div>
                </li>
            `;
        });

        html += '</ul>';
        listContainer.innerHTML = html;
    }

    // --- æ‰¹é‡é€‰æ‹©é€»è¾‘ ---
    function toggleBatchMode() {
        isBatchMode = !isBatchMode;
        const btn = document.getElementById('batch-btn');
        const actionBar = document.getElementById('action-bar');
        
        if (isBatchMode) {
            btn.classList.add('active');
            btn.innerHTML = '<span>âŒ å–æ¶ˆ</span>';
            actionBar.classList.add('visible');
        } else {
            btn.classList.remove('active');
            btn.innerHTML = '<span>âœ… é€‰æ‹©</span>';
            actionBar.classList.remove('visible');
            selectedFiles.clear(); // é€€å‡ºæ¸…ç©º
            updateActionBar();
        }
        renderList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ˜¾ç¤º/éšè— checkbox
    }

    function isFileSelected(sha) {
        for (let item of selectedFiles) {
            if (item.sha === sha) return true;
        }
        return false;
    }

    function toggleFileSelect(sha, path, name) {
        // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨
        let found = null;
        for (let item of selectedFiles) {
            if (item.sha === sha) {
                found = item;
                break;
            }
        }

        if (found) {
            selectedFiles.delete(found);
        } else {
            selectedFiles.add({ sha, path, name });
        }
        
        updateActionBar();
        renderList(); // é‡æ–°æ¸²æŸ“é«˜äº®
    }

    function updateActionBar() {
        const count = selectedFiles.size;
        document.querySelector('.action-count').innerText = `å·²é€‰ ${count} é¡¹`;
        document.getElementById('move-btn').disabled = count === 0;
    }

    // --- ç§»åŠ¨æ–‡ä»¶é€»è¾‘ (æ ¸å¿ƒåŠŸèƒ½) ---
    function openMoveModal() {
        if (!config.token) {
            alert("âŒ é”™è¯¯ï¼šè¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® GitHub Token æ‰èƒ½ç§»åŠ¨æ–‡ä»¶ï¼");
            openSettings();
            return;
        }
        // é¢„å¡«å½“å‰è·¯å¾„çš„ä¸Šçº§æˆ–å½“å‰
        document.getElementById('move-target-path').value = currentPath;
        document.getElementById('move-log').style.display = 'none';
        document.getElementById('move-log').innerHTML = '';
        document.getElementById('move-modal').style.display = 'flex';
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        document.getElementById('btn-confirm-move').disabled = false;
        document.getElementById('btn-confirm-move').innerText = "ç¡®è®¤ç§»åŠ¨";
    }

    function closeMoveModal() {
        document.getElementById('move-modal').style.display = 'none';
    }

    async function execMove() {
        const targetDir = document.getElementById('move-target-path').value.trim().replace(/\/+$/, '');
        const logDiv = document.getElementById('move-log');
        const confirmBtn = document.getElementById('btn-confirm-move');
        
        if (!targetDir) {
            alert("è¯·è¾“å…¥ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„");
            return;
        }

        if (targetDir === currentPath) {
            alert("ç›®æ ‡æ–‡ä»¶å¤¹ä¸èƒ½ä¸å½“å‰æ–‡ä»¶å¤¹ç›¸åŒ");
            return;
        }

        if (!confirm(`ç¡®å®šå°† ${selectedFiles.size} ä¸ªæ–‡ä»¶ç§»åŠ¨åˆ° "${targetDir}" å—ï¼Ÿ`)) return;

        confirmBtn.disabled = true;
        confirmBtn.innerText = "ç§»åŠ¨ä¸­...";
        logDiv.style.display = 'block';
        logDiv.innerHTML = '<div>ğŸš€ å¼€å§‹å¤„ç†...</div>';

        // è½¬æ¢ä¸ºæ•°ç»„æ–¹ä¾¿å¤„ç†
        const filesToMove = Array.from(selectedFiles);
        let successCount = 0;
        let failCount = 0;

        for (const file of filesToMove) {
            const fileName = file.name;
            const sourcePath = file.path;
            const newPath = `${targetDir}/${fileName}`;

            logDiv.innerHTML += `<div>â³ æ­£åœ¨ç§»åŠ¨: ${fileName}...</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;

            try {
                // 1. è·å–åŸæ–‡ä»¶å†…å®¹
                const getUrl = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${sourcePath}`;
                const fileData = await ghFetch(getUrl);
                const content = fileData.content; // Base64 encoded content
                
                // 2. åœ¨æ–°ä½ç½®åˆ›å»ºæ–‡ä»¶ (PUT)
                const putUrl = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${newPath}`;
                await ghFetch(putUrl, {
                    method: 'PUT',
                    body: JSON.stringify({
                        message: `Move ${fileName} to ${targetDir}`,
                        content: content
                    })
                });

                // 3. åˆ é™¤æ—§æ–‡ä»¶ (DELETE)
                const delUrl = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${sourcePath}`;
                await ghFetch(delUrl, {
                    method: 'DELETE',
                    body: JSON.stringify({
                        message: `Delete original ${fileName} after move`,
                        sha: file.sha
                    })
                });

                logDiv.innerHTML += `<div style="color:green">âœ… æˆåŠŸ: ${fileName}</div>`;
                successCount++;

            } catch (e) {
                console.error(e);
                logDiv.innerHTML += `<div style="color:red">âŒ å¤±è´¥: ${fileName} - ${e.message}</div>`;
                failCount++;
            }
        }

        logDiv.innerHTML += `<div style="font-weight:bold; margin-top:5px;">ğŸ å®Œæˆ! æˆåŠŸ: ${successCount}, å¤±è´¥: ${failCount}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;

        if (successCount > 0) {
            setTimeout(() => {
                closeMoveModal();
                toggleBatchMode(); // é€€å‡ºé€‰æ‹©æ¨¡å¼
                loadPath(currentPath); // åˆ·æ–°åˆ—è¡¨
            }, 2000);
        } else {
            confirmBtn.disabled = false;
            confirmBtn.innerText = "é‡è¯•";
        }
    }

    // --- å•æ–‡ä»¶åˆ é™¤é€»è¾‘ ---
    async function deleteSingleFile(event, path, sha) {
        event.stopPropagation(); // é˜»æ­¢ç‚¹å‡»è¡Œ
        if (!config.token) {
            alert("è¯·å…ˆé…ç½® Token");
            openSettings();
            return;
        }
        if (!confirm(`ç¡®å®šåˆ é™¤ ${path} å—ï¼Ÿ`)) return;

        const btn = event.target;
        btn.innerText = "â³";
        
        try {
            const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`;
            await ghFetch(url, {
                method: 'DELETE',
                body: JSON.stringify({ message: "Delete via Web", sha: sha })
            });
            alert("åˆ é™¤æˆåŠŸ");
            loadPath(currentPath);
        } catch (e) {
            alert("åˆ é™¤å¤±è´¥: " + e.message);
            btn.innerText = "ğŸ—‘ï¸";
        }
    }

    // --- è¾…åŠ©åŠŸèƒ½ ---
    function checkLatestFile(dirs) {
        const yearDirs = dirs.filter(d => /^\d{4}$/.test(d.name));
        if (yearDirs.length > 0) {
            const latestDir = yearDirs[0];
            fetchLatestInDir(latestDir).then(file => {
                if (file) renderLatestCard(file, latestDir.name);
            });
        }
    }

    async function fetchLatestInDir(dirItem) {
        const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${dirItem.path}`;
        const data = await ghFetch(url);
        if (!Array.isArray(data)) return null;
        let files = [];
        processItems(data, [], files);
        files.sort((a, b) => b.timestamp - a.timestamp);
        return files.length > 0 ? files[0] : null;
    }

    function renderLatestCard(file, year) {
        const container = document.getElementById('latest-container');
        let displayName = file.name.replace(/\.(html|json)$/, '').replace(/_\d{13}$/, '').replace(/_/g, ' ');
        let fileUrl = `https://${config.user}.github.io/${config.repo}/${file.path}`;
        container.innerHTML = `
            <div class="pinned-section">
                <span class="pinned-label">ğŸ†• æœ€æ–°ç¬”è®° (${year})</span>
                <a href="${fileUrl}" target="_blank" class="pinned-card">
                    <div style="display:flex; align-items:center;">
                        <span class="pinned-icon">ğŸ“„</span>
                        <div>
                            <div class="pinned-title">${displayName}</div>
                            <div class="pinned-meta">ğŸ“… ${file.dateStr}</div>
                        </div>
                    </div>
                    <span style="color:#0969da">&rarr;</span>
                </a>
            </div>
        `;
    }

    function renderBreadcrumb(path) {
        const container = document.getElementById('breadcrumb');
        let html = `<span class="breadcrumb-item" onclick="loadPath('${config.rootPath}')">ğŸ  é¦–é¡µ</span>`;
        if (path !== config.rootPath && path.startsWith(config.rootPath)) {
            const relative = path.substring(config.rootPath.length);
            const parts = relative.split('/').filter(p => p);
            let build = config.rootPath;
            parts.forEach((part, index) => {
                build += '/' + part;
                html += `<span class="breadcrumb-separator">/</span>`;
                if (index === parts.length - 1) {
                    html += `<span class="breadcrumb-current">${part}</span>`;
                } else {
                    html += `<span class="breadcrumb-item" onclick="loadPath('${build}')">${part}</span>`;
                }
            });
        }
        container.innerHTML = html;
    }

    // --- è®¾ç½®ç•Œé¢æ§åˆ¶ ---
    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; loadSettingsToUI(); }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function loadSettingsToUI() {
        document.getElementById('cfg-user').value = config.user;
        document.getElementById('cfg-repo').value = config.repo;
        document.getElementById('cfg-root').value = config.rootPath;
        document.getElementById('cfg-token').value = config.token || '';
        document.getElementById('cfg-del-enable').checked = config.enableDelete;
    }
    function saveSettings() {
        const newConfig = {
            user: document.getElementById('cfg-user').value.trim(),
            repo: document.getElementById('cfg-repo').value.trim(),
            rootPath: document.getElementById('cfg-root').value.trim().replace(/\/+$/, ''),
            token: document.getElementById('cfg-token').value.trim(),
            enableDelete: document.getElementById('cfg-del-enable').checked
        };
        localStorage.setItem('gh_nav_config_v5', JSON.stringify(newConfig));
        closeSettings();
        location.reload();
    }

    // å¼¹çª—å…³é—­ç›‘å¬
    window.onclick = function(event) {
        if (event.target.classList.contains('modal-overlay')) {
            event.target.style.display = "none";
        }
    }

    // å¯åŠ¨
    init();
</script>

</body>
</html>
