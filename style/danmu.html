<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>danmu</title>

    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/danmu.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/danmu.png">

    <style>
        :root {
            --primary: #0969da;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --border: #d0d7de;
            --text-main: #1f2328;
            --text-muted: #656d76;
            --folder-color: #54aeff;
            --pinned-bg: #e6f6ff;
            --pinned-border: #b6e3ff;
            --danger-bg: #ffebe9;
            --danger-text: #cf222e;
            --danger-border: #d1242f;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 20px;
            box-shadow: 0 3px 6px rgba(140, 149, 159, 0.03);
        }

        /* å¤´éƒ¨ä¸å¯¼èˆª */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }

        h1 { margin: 0; font-size: 18px; }

        .settings-btn {
            background: none; border: 1px solid var(--border);
            border-radius: 6px; cursor: pointer;
            padding: 5px 10px; font-size: 13px; color: var(--text-muted);
            display: flex; align-items: center; gap: 5px;
        }
        .settings-btn:hover { background-color: #f3f4f6; color: var(--text-main); }

        /* é¢åŒ…å±‘å¯¼èˆª */
        .breadcrumb {
            background: #f3f4f6;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .breadcrumb-item { cursor: pointer; color: var(--primary); font-weight: 500; }
        .breadcrumb-item:hover { text-decoration: underline; }
        .breadcrumb-separator { margin: 0 8px; color: var(--text-muted); }
        .breadcrumb-current { color: var(--text-muted); pointer-events: none; }

        /* ç½®é¡¶åŒºåŸŸæ ·å¼ */
        .pinned-section {
            background: var(--pinned-bg);
            border: 1px solid var(--pinned-border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
        }
        .pinned-label {
            font-size: 12px; font-weight: bold; color: #0969da; text-transform: uppercase; margin-bottom: 8px; display: block;
        }
        .pinned-card {
            display: flex; justify-content: space-between; align-items: center; text-decoration: none;
        }
        .pinned-title { font-size: 16px; font-weight: 700; color: #1f2328; }
        .pinned-meta { font-size: 12px; color: #57606a; margin-top: 4px; }
        .pinned-icon { font-size: 20px; margin-right: 10px; }
        .pinned-arrow { color: #0969da; font-weight: bold; }
        .pinned-card:hover .pinned-title { text-decoration: underline; color: #0969da; }

        /* æ™®é€šåˆ—è¡¨æ ·å¼ */
        ul { list-style: none; padding: 0; margin: 0; }
        li { border-bottom: 1px solid #eaecef; }
        li:last-child { border-bottom: none; }

        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 10px; text-decoration: none; color: var(--text-main);
            transition: background 0.2s; cursor: pointer; border-radius: 4px;
        }
        .list-item:hover { background-color: #f6f8fa; }
        
        .item-left-group {
            display: flex; align-items: center; flex-grow: 1; min-width: 0;
        }

        .item-icon { margin-right: 10px; font-size: 18px; flex-shrink: 0; }
        .folder-icon { color: var(--folder-color); }
        .file-icon { color: var(--text-muted); }
        
        .item-info { min-width: 0; }
        .item-name { font-weight: 600; font-size: 15px; display: block; }
        .item-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        .delete-btn {
            background-color: var(--danger-bg);
            color: var(--danger-text);
            border: 1px solid rgba(209, 36, 47, 0.3);
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .delete-btn:hover {
            background-color: var(--danger-text);
            color: white;
            border-color: var(--danger-text);
        }

        .loading, .error { text-align: center; padding: 30px; color: var(--text-muted); }
        .error { color: #cf222e; background: #ffebe9; border-radius: 6px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* è®¾ç½®å¼¹çª— */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 99; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal h3 { margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold; }
        .form-group input[type="text"], 
        .form-group input[type="password"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid var(--border); border-radius: 4px; }
        .form-group .hint { font-size: 12px; color: #666; margin-top: 4px; }
        
        /* å¼€å…³æ ·å¼ */
        .toggle-group {
            display: flex; align-items: center; justify-content: space-between;
            background: #f8f8f8; padding: 10px; border-radius: 4px; border: 1px solid #eee;
        }
        .toggle-group label { margin: 0; cursor: pointer; color: var(--danger-text); }
        .toggle-group input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }

        .btn { padding: 8px 16px; cursor: pointer; border: none; border-radius: 4px; font-size: 14px; }
        .btn-secondary { background: #f3f4f6; color: #24292f; margin-right: 10px; }
        .btn-primary { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ“š è‹±è¯­å­¦ä¹ ç¬”è®°</h1>
        <button class="settings-btn" onclick="openSettings()"><span>âš™ï¸ è®¾ç½®</span></button>
    </header>

    <div id="breadcrumb" class="breadcrumb"></div>

    <div id="latest-container"></div>

    <div id="file-list">
        <div class="loading">æ­£åœ¨åŠ è½½...</div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ”§ é…ç½®</h3>
        
        <div class="form-group toggle-group">
            <label for="cfg-del-enable">ğŸ”´ å¼€å¯åˆ é™¤æ¨¡å¼ (Delete Mode)</label>
            <input type="checkbox" id="cfg-del-enable">
        </div>

        <div class="form-group">
            <label>GitHub Token (PAT) <span style="color:red">*</span></label>
            <input type="password" id="cfg-token" placeholder="github_pat_...">
            <div class="hint">ğŸ”’ Token å¿…é¡»å…·å¤‡ repo æƒé™æ‰èƒ½åˆ é™¤æ–‡ä»¶ã€‚</div>
        </div>
        <div class="form-group">
            <label>GitHub ç”¨æˆ·å</label>
            <input type="text" id="cfg-user">
        </div>
        <div class="form-group">
            <label>ä»“åº“åç§°</label>
            <input type="text" id="cfg-repo">
        </div>
        <div class="form-group">
            <label>æ ¹ç›®å½•è·¯å¾„</label>
            <input type="text" id="cfg-root">
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜å¹¶åˆ·æ–°</button>
        </div>
    </div>
</div>

<script>
    // --- é»˜è®¤é…ç½® ---
    const DEFAULTS = {
        user: 'moodHappy',
        repo: 'moodHappy.gitHub.io-nce',
        rootPath: 'Notes/danmu',
        token: '',
        enableDelete: false // é»˜è®¤ä¸ºå…³é—­
    };

    let currentPath = ''; 
    let config = {};

    function getConfig() {
        // æ›´æ–°å­˜å‚¨é”®åä¸º v5ï¼Œä»¥é˜²æ—§æ•°æ®å†²çª
        const stored = localStorage.getItem('gh_nav_config_v5'); 
        return stored ? { ...DEFAULTS, ...JSON.parse(stored) } : DEFAULTS;
    }

    async function init() {
        config = getConfig();
        if (!currentPath) currentPath = config.rootPath;
        await loadPath(currentPath);
    }

    // é€šç”¨ Fetch å‡½æ•°ï¼Œå¸¦ Token
    async function ghFetch(url, options = {}) {
        const headers = options.headers || {};
        if (config.token && config.token.trim() !== '') {
            headers['Authorization'] = `token ${config.token}`;
        }
        
        const fetchOpts = { ...options, headers: headers };
        
        const response = await fetch(url, fetchOpts);
        
        // ç‰¹æ®Šå¤„ç† 204 No Content (åˆ é™¤æˆåŠŸ)
        if (response.status === 204) return true;

        if (!response.ok) {
            let errMsg = `HTTP Error: ${response.status}`;
            try {
                const errJson = await response.json();
                if (errJson.message) errMsg += ` - ${errJson.message}`;
            } catch(e) {}

            if (response.status === 403) throw new Error("API è®¿é—®å—é™ (403)ï¼Œè¯·æ£€æŸ¥ Token æƒé™æˆ–é¢‘ç‡é™åˆ¶ã€‚");
            if (response.status === 404) throw new Error("èµ„æºæœªæ‰¾åˆ° (404)ã€‚");
            throw new Error(errMsg);
        }
        return await response.json();
    }

    async function loadPath(path) {
        currentPath = path;
        renderBreadcrumb(path);

        const listContainer = document.getElementById('file-list');
        const latestContainer = document.getElementById('latest-container');

        // æ¸…ç©ºç½®é¡¶åŒºåŸŸï¼ˆä»…åœ¨æ ¹ç›®å½•è®¡ç®—åæ˜¾ç¤ºï¼‰
        latestContainer.innerHTML = ''; 
        listContainer.innerHTML = '<div class="loading">æ­£åœ¨è·å–åˆ—è¡¨...</div>';

        const apiUrl = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`;

        try {
            const data = await ghFetch(apiUrl);

            if (!Array.isArray(data)) {
                window.location.href = data.html_url || data.download_url;
                return;
            }

            // åˆ†ç¦»æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
            let dirs = [];
            let files = [];
            processItems(data, dirs, files);

            // æ’åº
            dirs.sort((a, b) => b.name.localeCompare(a.name)); // å¹´ä»½å€’åº
            files.sort((a, b) => b.timestamp - a.timestamp);   // æ–‡ä»¶å€’åº

            // --- æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœåœ¨æ ¹ç›®å½•ï¼Œå°è¯•æŸ¥æ‰¾æœ€æ–°å¹´ä»½æ–‡ä»¶å¤¹é‡Œçš„æœ€æ–°æ–‡ä»¶ ---
            if (path === config.rootPath) {
                // æ‰¾åˆ°çœ‹èµ·æ¥åƒå¹´ä»½çš„æ–‡ä»¶å¤¹ (4ä½æ•°å­—)
                const yearDirs = dirs.filter(d => /^\d{4}$/.test(d.name));

                if (yearDirs.length > 0) {
                    const latestYearDir = yearDirs[0];
                    latestContainer.innerHTML = '<div style="text-align:center; color:#999; font-size:12px; margin-bottom:10px;">æ­£åœ¨æ£€æŸ¥æœ€æ–°ç¬”è®°...</div>';

                    // å¼‚æ­¥è·å–æœ€æ–°å¹´ä»½æ–‡ä»¶å¤¹çš„å†…å®¹
                    fetchLatestInDir(latestYearDir).then(latestFile => {
                        if (latestFile) {
                            renderLatestCard(latestFile, latestYearDir.name);
                        } else {
                            latestContainer.innerHTML = ''; // æ²¡æ‰¾åˆ°åˆ™æ¸…ç©º
                        }
                    }).catch(e => {
                        console.error("Fetch latest failed", e);
                        latestContainer.innerHTML = '';
                    });
                }
            }

            renderList(dirs, files);

        } catch (error) {
            console.error(error);
            listContainer.innerHTML = `<div class="error"><strong>åŠ è½½å¤±è´¥</strong><br>${error.message}</div>`;
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šå¤„ç† API è¿”å›çš„æ•°æ®ï¼Œæå–æ—¶é—´æˆ³
    function processItems(items, dirsArr, filesArr) {
        items.forEach(item => {
            if (item.name.toLowerCase() === 'index.html') return;

            // GitHub API è¿”å›çš„ item åŒ…å« sha å­—æ®µï¼Œè¿™å¯¹åˆ é™¤å¾ˆé‡è¦
            if (item.type === 'dir') {
                dirsArr.push(item);
            } else if (item.name.endsWith('.html') || item.name.endsWith('.json')) { 
                // å…è®¸ HTML å’Œ JSON (å¦‚æœæ–‡ä»¶å¤¹é‡Œæœ‰ JSON ä¹Ÿä¼šè¢«åˆ—å‡º)
                const match = item.name.match(/_(\d{13})\./); // ç¨å¾®æ”¾å®½æ­£åˆ™ä»¥åŒ¹é…åç¼€å‰çš„æ—¶é—´æˆ³
                const timestamp = match ? parseInt(match[1]) : 0;
                filesArr.push({
                    ...item,
                    timestamp: timestamp,
                    dateStr: timestamp ? new Date(timestamp).toLocaleString('zh-CN', { hour12: false }) : ''
                });
            }
        });
    }

    // è¾…åŠ©å‡½æ•°ï¼šå»æŒ‡å®šæ–‡ä»¶å¤¹æ‰¾æœ€æ–°æ–‡ä»¶
    async function fetchLatestInDir(dirItem) {
        const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${dirItem.path}`;
        const data = await ghFetch(url);
        if (!Array.isArray(data)) return null;

        let subFiles = [];
        let subDirs = []; 
        processItems(data, subDirs, subFiles);

        // æŒ‰æ—¶é—´å€’åº
        subFiles.sort((a, b) => b.timestamp - a.timestamp);

        return subFiles.length > 0 ? subFiles[0] : null;
    }

    // --- åˆ é™¤æ–‡ä»¶é€»è¾‘ ---
    async function deleteFile(event, path, sha) {
        event.preventDefault();     // é˜»æ­¢é“¾æ¥è·³è½¬
        event.stopPropagation();    // é˜»æ­¢å†’æ³¡

        if (!config.token) {
            alert("âŒ é”™è¯¯ï¼šè¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® GitHub Tokenï¼");
            openSettings();
            return;
        }

        const confirmMsg = `âš ï¸ è­¦å‘Š \n\nç¡®å®šè¦æ°¸ä¹…åˆ é™¤äº‘ç«¯æ–‡ä»¶å—ï¼Ÿ\næ–‡ä»¶è·¯å¾„: ${path}\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
        if (!confirm(confirmMsg)) return;

        const deleteBtn = event.target.closest('button');
        const originalText = deleteBtn.innerHTML;
        deleteBtn.innerHTML = "â³";
        deleteBtn.disabled = true;

        const url = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`;
        const body = {
            message: `Delete ${path} via Web Client`,
            sha: sha
        };

        try {
            await ghFetch(url, {
                method: 'DELETE',
                body: JSON.stringify(body)
            });
            alert("âœ… åˆ é™¤æˆåŠŸï¼");
            loadPath(currentPath); // åˆ·æ–°å½“å‰åˆ—è¡¨
        } catch (e) {
            alert("âŒ åˆ é™¤å¤±è´¥ï¼š\n" + e.message);
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        }
    }

    function renderLatestCard(file, year) {
        const container = document.getElementById('latest-container');
        let displayName = file.name.replace(/\.(html|json)$/, '').replace(/_\d{13}$/, '').replace(/_/g, ' ');
        let fileUrl = `https://${config.user}.github.io/${config.repo}/${file.path}`;

        container.innerHTML = `
            <div class="pinned-section">
                <span class="pinned-label">ğŸ†• æœ€æ–°ç¬”è®° (${year})</span>
                <a href="${fileUrl}" target="_blank" class="pinned-card">
                    <div style="display:flex; align-items:center;">
                        <span class="pinned-icon">ğŸ“„</span>
                        <div>
                            <div class="pinned-title">${displayName}</div>
                            <div class="pinned-meta">ğŸ“… ${file.dateStr}</div>
                        </div>
                    </div>
                    <div class="pinned-arrow">ç«‹å³é˜…è¯» &rarr;</div>
                </a>
            </div>
        `;
    }

    function renderList(dirs, files) {
        const listContainer = document.getElementById('file-list');
        if (dirs.length === 0 && files.length === 0) {
            listContainer.innerHTML = '<div class="loading">æ­¤æ–‡ä»¶å¤¹ä¸ºç©º</div>';
            return;
        }

        let html = '<ul>';

        // æ–‡ä»¶å¤¹ (ä¸æ˜¾ç¤ºåˆ é™¤æŒ‰é’®)
        dirs.forEach(dir => {
            html += `
                <li onclick="loadPath('${dir.path}')">
                    <div class="list-item">
                        <div class="item-left-group">
                            <span class="item-icon folder-icon">ğŸ“</span>
                            <div class="item-info">
                                <span class="item-name">${dir.name}</span>
                            </div>
                        </div>
                        <span style="color:#ccc">â€º</span>
                    </div>
                </li>
            `;
        });

        // æ–‡ä»¶ (æ ¹æ®é…ç½®æ˜¾ç¤ºåˆ é™¤æŒ‰é’®)
        files.forEach(file => {
            let displayName = file.name.replace(/\.(html|json)$/, '').replace(/_\d{13}$/, '').replace(/_/g, ' ');
            let fileUrl = `https://${config.user}.github.io/${config.repo}/${file.path}`;

            // ç”Ÿæˆåˆ é™¤æŒ‰é’® HTML
            let deleteBtnHtml = '';
            if (config.enableDelete) {
                // å°† path å’Œ sha ä¼ é€’ç»™åˆ é™¤å‡½æ•°
                deleteBtnHtml = `
                    <button class="delete-btn" onclick="deleteFile(event, '${file.path}', '${file.sha}')" title="åˆ é™¤æ–‡ä»¶">
                        ğŸ—‘ï¸
                    </button>
                `;
            }

            html += `
                <li>
                    <a href="${fileUrl}" target="_blank" class="list-item">
                        <div class="item-left-group">
                            ${deleteBtnHtml}
                            <span class="item-icon file-icon">ğŸ“„</span>
                            <div class="item-info">
                                <span class="item-name">${displayName}</span>
                                ${file.dateStr ? `<div class="item-meta">ğŸ“… ${file.dateStr}</div>` : ''}
                            </div>
                        </div>
                    </a>
                </li>
            `;
        });

        html += '</ul>';
        listContainer.innerHTML = html;
    }

    function renderBreadcrumb(path) {
        const container = document.getElementById('breadcrumb');
        let html = `<span class="breadcrumb-item" onclick="loadPath('${config.rootPath}')">ğŸ  é¦–é¡µ</span>`;

        if (path !== config.rootPath && path.startsWith(config.rootPath)) {
            const relativePath = path.substring(config.rootPath.length);
            const parts = relativePath.split('/').filter(p => p);
            let buildPath = config.rootPath;

            parts.forEach((part, index) => {
                buildPath += '/' + part;
                html += `<span class="breadcrumb-separator">/</span>`;
                if (index === parts.length - 1) {
                    html += `<span class="breadcrumb-current">${part}</span>`;
                } else {
                    html += `<span class="breadcrumb-item" onclick="loadPath('${buildPath}')">${part}</span>`;
                }
            });
        }
        container.innerHTML = html;
    }

    // --- è®¾ç½®é€»è¾‘ ---
    function openSettings() {
        document.getElementById('cfg-user').value = config.user;
        document.getElementById('cfg-repo').value = config.repo;
        document.getElementById('cfg-root').value = config.rootPath;
        document.getElementById('cfg-token').value = config.token || '';
        document.getElementById('cfg-del-enable').checked = config.enableDelete || false;
        document.getElementById('settings-modal').style.display = 'flex';
    }

    function closeSettings() {
        document.getElementById('settings-modal').style.display = 'none';
    }

    function saveSettings() {
        const newConfig = {
            user: document.getElementById('cfg-user').value.trim(),
            repo: document.getElementById('cfg-repo').value.trim(),
            rootPath: document.getElementById('cfg-root').value.trim().replace(/\/+$/, ''),
            token: document.getElementById('cfg-token').value.trim(),
            enableDelete: document.getElementById('cfg-del-enable').checked
        };
        // å‡çº§å­˜å‚¨ç‰ˆæœ¬å·åˆ° v5
        localStorage.setItem('gh_nav_config_v5', JSON.stringify(newConfig));
        closeSettings();
        location.reload();
    }

    document.getElementById('settings-modal').addEventListener('click', function(e) {
        if (e.target === this) closeSettings();
    });

    init();
</script>

</body>
</html>
