<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Danmu å­¦ä¹ ç¬”è®° - AI æ——èˆ°ç‰ˆ</title>

    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/danmu.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/danmu.png">

    <style>
        :root {
            --primary: #0969da;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --border: #d0d7de;
            --text-main: #1f2328;
            --text-muted: #656d76;

            /* é«˜äº®é¢œè‰²é…ç½® */
            --hl-blue: #0969da; 
            --hl-red: #cf222e; 
            --hl-yellow: #d97706; 

            /* ReadSense ç‰¹æœ‰æ ·å¼å˜é‡ */
            --rs-blue: #3498db;
            --rs-meta-bg: #f9f9f9;
            --rs-meta-text: #7f8c8d;
            --rs-title: #2c3e50;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }

        /* é”å®šæ»šåŠ¨æ ·å¼ */
        body.no-scroll {
            overflow: hidden;
            height: 100vh;
        }

        /* --- è§†å›¾æ ·å¼ --- */
        .view-container {
            max-width: 800px; margin: 20px auto; background: var(--card-bg);
            border: 1px solid var(--border); border-radius: 6px; padding: 20px;
            box-shadow: 0 3px 6px rgba(140, 149, 159, 0.03); display: block;
        }

        .reader-page {
            display: none; background: #ffffff; min-height: 100vh; width: 100%;
        }

        .reader-content-wrapper {
            max-width: 800px; margin: 0 auto; padding: 30px 20px 150px 20px; /* åº•éƒ¨ç•™ç™½ç»™å¼¹çª— */
            font-size: 18px; line-height: 1.8; color: #333; position: relative;
        }

        .reader-content-wrapper h1 {
            display: block !important; margin-top: 25px; margin-bottom: 25px;
            line-height: 1.3; color: var(--rs-title); border-bottom: 2px solid var(--rs-blue);
            padding-bottom: 10px; font-size: 2em;
        }

        .meta {
            font-size: 14px; color: var(--rs-meta-text); margin-bottom: 25px;
            background: var(--rs-meta-bg); padding: 10px; border-radius: 6px; line-height: 1.6;
        }
        .meta div { margin-bottom: 4px; }
        .meta a { color: var(--rs-blue); text-decoration: none; word-break: break-all; }

        .footer {
            margin-top: 40px; font-size: 12px; color: #bdc3c7; text-align: center; border-top: 1px solid #eee; padding-top: 20px;
        }

        /* å¤´éƒ¨ä¸åˆ—è¡¨æ ·å¼ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        header h1 { margin: 0; font-size: 18px; display: flex; align-items: center; gap: 8px; border-bottom: none !important; color: inherit !important; }
        .status-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; font-weight: normal; white-space: nowrap; }
        .status-ready { background: #dafbe1; color: #1f883d; }

        .nav-btn { 
            background: transparent; border: 1px solid var(--border); padding: 6px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 14px; 
            display: flex; align-items: center; gap: 5px; color: var(--text-main);
            white-space: nowrap; flex-shrink: 0;
        }

        ul { list-style: none; padding: 0; margin: 0; }
        li { border-bottom: 1px solid #eaecef; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; cursor: pointer; border-radius: 4px; }
        .item-icon { margin-right: 10px; font-size: 18px; }
        .item-name { font-weight: 600; font-size: 15px; overflow: hidden; text-overflow: ellipsis; }
        .breadcrumb { background: #f3f4f6; padding: 10px 15px; border-radius: 6px; margin-bottom: 20px; font-size: 14px; display: flex; align-items: center; flex-wrap: wrap; }
        .breadcrumb-item { cursor: pointer; color: var(--primary); font-weight: 500; }
        .breadcrumb-separator { margin: 0 8px; color: var(--text-muted); }
        .pinned-section { background: #e6f6ff; border: 1px solid #b6e3ff; border-radius: 6px; padding: 15px; margin-bottom: 20px; }
        .pinned-card { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }

        /* é«˜äº®æ ·å¼ */
        .hl-blue { color: var(--hl-blue); font-weight: 700; cursor: pointer; border-bottom: 2px solid rgba(9, 105, 218, 0.1); }
        .hl-red { color: var(--hl-red); font-weight: 700; cursor: pointer; border-bottom: 2px solid rgba(207, 34, 46, 0.1); }
        .hl-yellow { color: var(--hl-yellow); font-weight: 700; cursor: pointer; border-bottom: 2px solid rgba(217, 119, 6, 0.1); }

        /* è®¾ç½®å¼¹çª— */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1200; justify-content: center; align-items: center; }
        .modal { 
            background: white; padding: 20px; border-radius: 12px; 
            width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            box-sizing: border-box; 
        }
        .modal h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 18px; }

        .form-group { margin-bottom: 15px; } 
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold; } 

        input, textarea, select { 
            width: 100%; padding: 10px; box-sizing: border-box; 
            border: 1px solid #d0d7de; border-radius: 6px; font-family: inherit; 
            min-width: 0; font-size: 14px;
        }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(9,105,218,0.2); }

        .btn { padding: 8px 16px; cursor: pointer; border: none; border-radius: 6px; font-size: 14px; transition: opacity 0.2s; white-space: nowrap; font-weight: 500; } 
        .btn:active { opacity: 0.8; }
        .btn-secondary { background: #f3f4f6; color: #24292f; margin-right: 10px; } .btn-primary { background: var(--primary); color: white; } .btn-danger { background: #cf222e; color: white; padding: 4px 10px; font-size: 12px; margin-left: auto; }
        .loading, .error { text-align: center; padding: 50px 20px; color: var(--text-muted); font-size: 16px; } .error { color: #cf222e; }

        /* å¤š AI é…ç½®åˆ—è¡¨æ ·å¼ */
        .ai-config-item { background: #fff; border: 1px solid #e1e4e8; border-radius: 8px; padding: 15px; margin-bottom: 12px; position: relative; }
        .ai-config-header { display: flex; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; flex-wrap: wrap; gap: 5px; }
        .ai-tag { background: #e6f6ff; color: #0969da; font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 6px; flex-shrink: 0; }
        .ai-priority-1 .ai-tag { background: #dafbe1; color: #1f883d; }

        .ai-form-row { margin-bottom: 12px; }
        .ai-form-row label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; font-weight: 600; }
        .ai-form-row input { font-size: 13px; padding: 8px; background: #fcfcfc; }

        /* =========================================
           æŸ¥è¯å¡ç‰‡ä¸ AI å¡ç‰‡æ ·å¼
           ========================================= */
        .dict-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); z-index: 998;
        }
        .dict-overlay.open { display: block; }

        /* åŸºç¡€ Sheet æ ·å¼ */
        .sheet-card {
            position: fixed; 
            background: #fff;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.15);
            z-index: 999;
            padding: 20px;
            box-sizing: border-box;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex; flex-direction: column;
        }

        /* æŸ¥è¯å¡ç‰‡ï¼šç»´æŒæ‚¬æµ®é£æ ¼ */
        #dict-card {
            width: 90%; max-width: 500px;
            bottom: 20px; left: 50%; transform: translateX(-50%) translateY(120%);
            border-radius: 16px;
            max-height: 70vh;
        }
        #dict-card.open { transform: translateX(-50%) translateY(0); }

        /* AI å¡ç‰‡ï¼šå…¨å±å®½åº¦åº•éƒ¨æŠ½å±‰é£æ ¼ */
        #ai-card {
            width: 100%; max-width: 100%; /* å…¨å®½ */
            bottom: 0; left: 0;
            transform: translateY(100%); /* å‘ä¸‹éšè— */
            border-radius: 20px 20px 0 0; /* ä»…ä¸Šæ–¹åœ†è§’ */
            max-height: 75vh;
            padding-bottom: 30px; /* åº•éƒ¨ç•™ç™½é€‚é…å…¨é¢å±æ‰‹åŠ¿æ¡ */
        }
        #ai-card.open { transform: translateY(0); }

        .card-content-scroll { overflow-y: auto; flex: 1; }

        /* ã€æ–°å¢ã€‘AI åŸæ–‡å±•ç¤ºæ¡†æ ·å¼ */
        .ai-origin-box {
            background: #f1f8ff; /* æµ…è“èƒŒæ™¯ */
            border-left: 4px solid #0969da;
            padding: 8px 12px;
            margin-bottom: 15px; /* ä¸ä¸‹æ–¹è§£æéš”å¼€ */
            font-size: 14px;
            color: #444;
            border-radius: 4px;
            font-style: italic;
            max-height: 80px; /* é™åˆ¶é«˜åº¦ */
            overflow-y: auto; /* å…è®¸æ»šåŠ¨ */
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
            font-family: Georgia, serif; /* è¡¬çº¿ä½“æ›´æœ‰åŸæ–‡æ„Ÿ */
            line-height: 1.5;
        }

        .dc-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; flex-shrink: 0; }
        .dc-word { font-size: 24px; font-weight: 700; color: #000; line-height: 1.2; margin-right: 10px; }

        .dc-audio-btn {
            background: #eef2ff; color: #4f46e5; border: none;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; flex-shrink: 0;
            padding: 0; margin: 0; -webkit-appearance: none; appearance: none; outline: none;
        }
        .dc-audio-btn:active { background: #dbeafe; transform: scale(0.95); }
        .dc-audio-icon { width: 22px; height: 22px; fill: currentColor; display: block; }

        .dc-meta-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .dc-phonetic { font-family: "Lucida Sans Unicode", "Arial Unicode MS", sans-serif; color: #666; background: #f5f5f5; padding: 2px 6px; border-radius: 4px; font-size: 14px; }
        .dc-stars { display: flex; gap: 2px; }
        .dc-star { color: #e0e0e0; font-size: 14px; } .dc-star.filled { color: #fbbf24; }
        .dc-def-list { margin: 0; padding: 0; list-style: none; }
        .dc-def-item { font-size: 16px; color: #333; margin-bottom: 6px; line-height: 1.5; display: flex; gap: 8px; }
        .dc-pos { color: #0969da; font-weight: 600; font-style: italic; min-width: 25px; } .dc-meaning { flex: 1; }
        .dc-footer { margin-top: 15px; padding-top: 12px; border-top: 1px solid #eee; text-align: right; font-size: 12px; }
        .dc-link { color: #666; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; }
        .dc-loading { text-align: center; color: #999; padding: 20px; font-size: 14px; }
        .dc-error { text-align: center; color: #cf222e; padding: 10px; font-size: 14px; }

        /* =========================================
           AI æŒ‰é’®ç»„æ ·å¼
           ========================================= */
        /* 1. åˆ’è¯å‡ºç°çš„æ‚¬æµ®æŒ‰é’® */
        .ai-float-btn {
            position: absolute; display: none; z-index: 1000;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white; border: none; padding: 6px 14px; border-radius: 20px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            user-select: none; white-space: nowrap;
        }
        .ai-float-btn:active { transform: scale(0.95); }

        /* 2. ã€æ ¸å¿ƒã€‘å¸¸é©»å†å²æŒ‰é’® (æ ·å¼ä¸æµ®åŠ¨æŒ‰é’®å®Œå…¨ä¸€è‡´) */
        .ai-persistent-btn {
            position: fixed; 
            top: 80vh; right: 20px; /* å±å¹•é«˜åº¦ 80% å¤„ */
            z-index: 990;
            /* æ ·å¼å¤åˆ» ai-float-btn */
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white; border: none; padding: 6px 14px; border-radius: 20px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);

            display: none; /* é»˜è®¤éšè—ï¼Œæœ‰å†å²ä¸”åœ¨é˜…è¯»é¡µæ—¶æ˜¾ç¤º */
            transition: opacity 0.3s;
            user-select: none;
        }
        .ai-persistent-btn:active { transform: scale(0.95); }

        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .ai-content-body { font-size: 15px; line-height: 1.6; color: #24292f; }
        .md-bold { font-weight: 700; color: #1a1a1a; }
        .md-h { font-weight: 700; margin-top: 10px; margin-bottom: 5px; color: #0969da; display: block; }
        .md-list-item { display: block; position: relative; padding-left: 15px; margin-bottom: 4px; }
        .md-list-item::before { content: "â€¢"; position: absolute; left: 0; color: #a855f7; }
        .md-code { background: #f6f8fa; padding: 2px 4px; border-radius: 4px; font-family: monospace; font-size: 90%; color: #cf222e; }

    </style>
</head>
<body>

<div id="list-view" class="view-container">
    <header>
        <h1>ğŸ“š è‹±è¯­å­¦ä¹ ç¬”è®° <span id="dict-status" class="status-badge">è¯åº“åŠ è½½ä¸­...</span></h1>
        <button class="nav-btn" onclick="openSettings()"><span>âš™ï¸ è®¾ç½®</span></button>
    </header>
    <div id="breadcrumb" class="breadcrumb"></div>
    <div id="latest-container"></div>
    <div id="file-list"><div class="loading">æ­£åœ¨åŠ è½½ç›®å½•...</div></div>
</div>

<div id="reader-view" class="reader-page">
    <div id="reader-content" class="reader-content-wrapper"></div>

    <button id="ai-float-btn" class="ai-float-btn" onmousedown="handleAiBtnClick(event)" ontouchstart="handleAiBtnClick(event)">ğŸ¤– AI åˆ†æ</button>

    <button id="ai-persistent-btn" class="ai-persistent-btn" onclick="showLastAnalysis()">ğŸ¤– æœ€è¿‘åˆ†æ</button>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ”§ é…ç½®ä¸­å¿ƒ</h3>

        <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #e1e4e8;">
            <div style="font-weight:bold; color:#0969da; margin-bottom:10px; font-size:14px;">ğŸ“‚ ç¬”è®°æºè®¾ç½®</div>
            <div class="form-group"><label>GitHub ç”¨æˆ·å</label><input type="text" id="cfg-user"></div>
            <div class="form-group"><label>ä»“åº“åç§°</label><input type="text" id="cfg-repo"></div>
            <div class="form-group"><label>æ ¹ç›®å½•è·¯å¾„</label><input type="text" id="cfg-root"></div>
            <div class="form-group"><label>GitHub Token (PAT)</label><input type="password" id="cfg-token" placeholder="github_pat_..."><div style="font-size:12px; color:#666; margin-top:2px;">ğŸ”’ ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨</div></div>
        </div>

        <div style="background:#f3f0ff; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #dcd6f7;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <div style="font-weight:bold; color:#7c3aed; font-size:14px;">ğŸ¤– AI æ¥å£çŸ©é˜µ (è‡ªåŠ¨å¤‡é€‰)</div>
                <button class="btn btn-primary" style="padding:4px 10px; font-size:12px;" onclick="addAiConfigUI()">+ æ·»åŠ </button>
            </div>
            <div style="font-size:12px; color:#666; margin-bottom:15px; line-height:1.4;">ä¼˜å…ˆä½¿ç”¨ç¬¬ä¸€ä¸ªï¼Œå¤±è´¥åè‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€ä¸ªã€‚æ”¯æŒ OpenAI æ ¼å¼æ¥å£ã€‚</div>
            <div id="ai-config-list"></div>

            <div class="form-group" style="margin-top:20px;"><label>å…¨å±€ç³»ç»ŸæŒ‡ä»¤ (System Prompt)</label><textarea id="cfg-api-prompt" rows="3" style="font-size:13px;"></textarea></div>
        </div>

        <div style="text-align: right; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜å¹¶åˆ·æ–°</button>
        </div>
    </div>
</div>

<div id="dict-overlay" class="dict-overlay" onclick="closeAllCards()"></div>
<div id="dict-card" class="sheet-card">
    <div id="dc-content" class="card-content-scroll"></div>
</div>

<div id="ai-card" class="sheet-card" ondblclick="closeAllCards()">
    <div class="dc-header" style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
        <div class="dc-word" style="font-size:18px;">ğŸ¤– AI åˆ†æç»“æœ</div>
        <button class="btn btn-secondary" style="padding:4px 10px; font-size:12px;" onclick="closeAllCards()">å…³é—­</button>
    </div>
    <div id="ai-origin-text" class="ai-origin-box"></div>
    <div id="ai-content" class="card-content-scroll ai-content-body"></div>
</div>

<script>
    const DEFAULTS = { 
        user: 'moodHappy', 
        repo: 'moodHappy.gitHub.io-nce', 
        rootPath: 'Notes/danmu', 
        token: '',
        systemPrompt: 'ä½ æ˜¯æˆ‘çš„è‹±è¯­å­¦ä¹ åŠ©æ‰‹ã€‚è¯·ç®€è¦åˆ†æé€‰ä¸­çš„æ–‡æœ¬ï¼Œè§£é‡Šå…¶ä¸­çš„ç”Ÿè¯ã€éš¾ç‚¹è¯­æ³•ç»“æ„ï¼Œå¹¶ç¿»è¯‘æ•´å¥ã€‚å¦‚æœåŒ…å«ä¹ è¯­æˆ–æ–‡åŒ–æ¢—ï¼Œè¯·ä¸€å¹¶è¯´æ˜ã€‚è¯·ä½¿ç”¨ä¸­æ–‡å›ç­”ï¼Œæ ¼å¼æ¸…æ™°ã€‚',
        aiConfigs: [
            { name: 'Groq (é»˜è®¤)', host: 'https://api.groq.com/openai/v1/chat/completions', model: 'meta-llama/llama-4-maverick-17b-128e-instruct', key: '' }
        ]
    };

    const DICT_URLS = {
        one: 'https://raw.githubusercontent.com/moodHappy/HelloWorld/refs/heads/master/Notes/one.txt',
        two: 'https://raw.githubusercontent.com/moodHappy/HelloWorld/refs/heads/master/Notes/two.txt',
        supplement: 'https://raw.githubusercontent.com/moodHappy/HelloWorld/refs/heads/master/Notes/supplement.txt',
        excluded: 'https://raw.githubusercontent.com/moodHappy/HelloWorld/refs/heads/master/Notes/Excluded.txt'
    };

    let config = {}; let currentPath = ''; let dictMap = new Map(); let isDictLoaded = false;
    let currentSelection = ''; 

    // --- åˆå§‹åŒ–ä¸è·¯ç”±é€»è¾‘ ---
    window.addEventListener('popstate', (event) => {
        if (!new URLSearchParams(window.location.search).has('file')) {
            showListUI();
            closeAllCards();
        }
    });

    function getConfig() {
        const stored = localStorage.getItem('gh_nav_config_v7');
        if (stored) {
            let parsed = JSON.parse(stored);
            if (!parsed.aiConfigs && parsed.apiKey) {
                parsed.aiConfigs = [{
                    name: 'Old Config',
                    host: parsed.apiHost || DEFAULTS.aiConfigs[0].host,
                    model: parsed.apiModel || DEFAULTS.aiConfigs[0].model,
                    key: parsed.apiKey
                }];
            }
            return { ...DEFAULTS, ...parsed };
        }
        return DEFAULTS;
    }

    async function init() {
        config = getConfig();
        if (!currentPath) currentPath = config.rootPath;
        const targetFile = new URLSearchParams(window.location.search).get('file');
        loadDictionaries(); 
        if (targetFile) openReader(targetFile, false); else loadPath(currentPath);

        const readerEl = document.getElementById('reader-content');
        readerEl.addEventListener('click', handleReaderClick); 
        document.addEventListener('selectionchange', handleSelectionChange); 
        readerEl.addEventListener('touchend', () => setTimeout(handleSelectionChange, 100)); 

        checkHistoryBtn();
    }

    // --- è¯åº“åŠ è½½é€»è¾‘ ---
    async function loadDictionaries() {
        const statusEl = document.getElementById('dict-status');
        try {
            const [txtOne, txtTwo, txtSup, txtExc] = await Promise.all([
                fetch(DICT_URLS.one).then(r => r.text()), fetch(DICT_URLS.two).then(r => r.text()),
                fetch(DICT_URLS.supplement).then(r => r.text()), fetch(DICT_URLS.excluded).then(r => r.text())
            ]);
            const parse = (text) => text.split(/\r?\n/).map(w => w.trim().toLowerCase()).filter(w => w);
            const excludedSet = new Set(parse(txtExc));

            parse(txtOne).forEach(w => { if(!excludedSet.has(w)) dictMap.set(w, 'hl-blue'); });
            parse(txtTwo).forEach(w => { if(!excludedSet.has(w)) dictMap.set(w, 'hl-red'); });
            parse(txtSup).forEach(w => { if(!excludedSet.has(w)) dictMap.set(w, 'hl-yellow'); });

            isDictLoaded = true;
            statusEl.textContent = `âœ“ è¯åº“å°±ç»ª (${dictMap.size}è¯)`; statusEl.classList.add('status-ready');
            if(document.getElementById('reader-view').style.display === 'block') applyHighlights(document.getElementById('reader-content'));
        } catch (e) {
            statusEl.textContent = "âš ï¸ è¯åº“å¤±è´¥"; statusEl.style.background = "#ffebe9"; statusEl.style.color = "#cf222e";
        }
    }

    // --- GitHub API ---
    async function ghFetch(url) {
        const headers = {}; if (config.token) headers['Authorization'] = `token ${config.token}`;
        const response = await fetch(url, { headers });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    }

    // --- åˆ—è¡¨åŠ è½½é€»è¾‘ ---
    async function loadPath(path) {
        currentPath = path; renderBreadcrumb(path);
        const listContainer = document.getElementById('file-list');
        const latestContainer = document.getElementById('latest-container');
        listContainer.innerHTML = '<div class="loading">æ­£åœ¨è·å–åˆ—è¡¨...</div>';
        try {
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`);
            if (!Array.isArray(data)) return; 
            let dirs = [], files = []; processItems(data, dirs, files);
            dirs.sort((a, b) => b.name.localeCompare(a.name)); files.sort((a, b) => b.timestamp - a.timestamp);

            if (path === config.rootPath) {
                const yearDirs = dirs.filter(d => /^\d{4}$/.test(d.name));
                if (yearDirs.length > 0) {
                    latestContainer.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;margin-bottom:10px;">æ­£åœ¨æ£€æŸ¥æœ€æ–°ç¬”è®°...</div>';
                    fetchLatestInDir(yearDirs[0]).then(latest => {
                        if (latest) renderLatestCard(latest, yearDirs[0].name); else latestContainer.innerHTML = '';
                    });
                } else { latestContainer.innerHTML = ''; }
            } else { latestContainer.innerHTML = ''; }
            renderList(dirs, files);
        } catch (error) { listContainer.innerHTML = `<div class="error">${error.message}</div>`; }
    }

    function processItems(items, dirsArr, filesArr) {
        items.forEach(item => {
            if (item.name.toLowerCase() === 'index.html') return;
            if (item.type === 'dir') dirsArr.push(item);
            else if (item.name.endsWith('.html')) {
                const match = item.name.match(/_(\d{13})\.html$/);
                const ts = match ? parseInt(match[1]) : 0;
                filesArr.push({ ...item, timestamp: ts, dateStr: ts ? new Date(ts).toLocaleString('zh-CN',{hour12:false}) : '' });
            }
        });
    }

    async function fetchLatestInDir(dirItem) {
        const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${dirItem.path}`);
        if (!Array.isArray(data)) return null;
        let files = [], dirs = []; processItems(data, dirs, files);
        files.sort((a, b) => b.timestamp - a.timestamp); return files.length > 0 ? files[0] : null;
    }

    // --- UI æ¸²æŸ“å‡½æ•° ---
    function renderList(dirs, files) {
        const listContainer = document.getElementById('file-list');
        if (dirs.length === 0 && files.length === 0) { listContainer.innerHTML = '<div style="text-align:center;padding:30px;color:#999;">ç©ºç›®å½•</div>'; return; }
        let html = '<ul>';
        dirs.forEach(dir => html += `<li onclick="loadPath('${dir.path}')"><div class="list-item"><span class="item-icon folder-icon">ğŸ“</span><div class="item-info"><span class="item-name">${dir.name}</span></div><span style="color:#ccc">â€º</span></div></li>`);
        files.forEach(file => {
            let displayName = file.name.replace('.html', '').replace(/_\d{13}$/, '').replace(/_/g, ' ');
            html += `<li onclick="openReader('${file.path}')"><div class="list-item"><span class="item-icon file-icon">ğŸ“„</span><div class="item-info"><span class="item-name">${displayName}</span>${file.dateStr ? `<div class="item-meta">ğŸ“… ${file.dateStr}</div>` : ''}</div></div></li>`;
        });
        html += '</ul>'; listContainer.innerHTML = html;
    }

    function renderLatestCard(file, year) {
        const container = document.getElementById('latest-container');
        let displayName = file.name.replace('.html', '').replace(/_\d{13}$/, '').replace(/_/g, ' ');
        container.innerHTML = `<div class="pinned-section"><span class="pinned-label">ğŸ†• æœ€æ–°ç¬”è®° (${year})</span><div class="pinned-card" onclick="openReader('${file.path}')"><div style="display:flex;align-items:center;overflow:hidden;"><span class="pinned-icon">ğŸ“„</span><div style="overflow:hidden;"><div class="pinned-title" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${displayName}</div><div class="pinned-meta">ğŸ“… ${file.dateStr}</div></div></div><div style="color:#0969da;font-weight:bold;margin-left:10px;">é˜…è¯» &rarr;</div></div></div>`;
    }

    function renderBreadcrumb(path) {
        const container = document.getElementById('breadcrumb');
        let html = `<span class="breadcrumb-item" onclick="loadPath('${config.rootPath}')">ğŸ  é¦–é¡µ</span>`;
        if (path !== config.rootPath && path.startsWith(config.rootPath)) {
            const parts = path.substring(config.rootPath.length).split('/').filter(p=>p);
            let build = config.rootPath;
            parts.forEach((part, i) => {
                build += '/' + part; html += `<span class="breadcrumb-separator">/</span>`;
                if(i===parts.length-1) html += `<span class="breadcrumb-current">${part}</span>`; else html += `<span class="breadcrumb-item" onclick="loadPath('${build}')">${part}</span>`;
            });
        }
        container.innerHTML = html;
    }

    // --- è§†å›¾åˆ‡æ¢ ---
    function showListUI() {
        document.getElementById('list-view').style.display = 'block'; document.getElementById('reader-view').style.display = 'none';
        document.body.style.backgroundColor = 'var(--bg)'; 
        const url = new URL(window.location); url.searchParams.delete('file'); history.replaceState(null, '', url); window.scrollTo(0, 0);
    }
    function showReaderUI() {
        document.getElementById('list-view').style.display = 'none'; document.getElementById('reader-view').style.display = 'block';
        document.body.style.backgroundColor = '#ffffff'; window.scrollTo(0, 0);
        checkHistoryBtn(); 
    }

    // --- ç¬”è®°æ¸²æŸ“å™¨ ---
    async function openReader(filePath, updateHistory = true) {
        showReaderUI();
        const contentEl = document.getElementById('reader-content');
        if (updateHistory) { const url = new URL(window.location); url.searchParams.set('file', filePath); history.pushState({ file: filePath }, '', url); }
        contentEl.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ç¬”è®°å†…å®¹...</div>';

        try {
            const response = await fetch(`https://raw.githubusercontent.com/${config.user}/${config.repo}/main/${filePath}`);
            if (!response.ok) throw new Error("HTTP " + response.status);
            const htmlText = await response.text();

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');

            const h1 = doc.querySelector('h1');
            let timeText = ''; let linkHtml = ''; let nodesToRemove = [];
            const existingMeta = doc.querySelector('.meta');
            if (existingMeta) {
                timeText = existingMeta.textContent.match(/å½’æ¡£æ—¶é—´:([^\n]*)/)?.[1] || '';
                const linkTag = existingMeta.querySelector('a'); if (linkTag) linkHtml = linkTag.outerHTML;
                nodesToRemove.push(existingMeta);
            } else {
                let currentNode = h1 ? h1.nextElementSibling : doc.body.firstElementChild;
                while (currentNode) {
                    const text = currentNode.textContent;
                    if (text.includes('å½’æ¡£æ—¶é—´')) {
                        timeText = text.replace('å½’æ¡£æ—¶é—´:', '').replace('ğŸ“…', '').trim(); nodesToRemove.push(currentNode);
                    } else if (text.includes('åŸæ–‡é“¾æ¥') || currentNode.querySelector('a')) {
                        const linkTag = currentNode.querySelector('a');
                        if (linkTag) { linkHtml = linkTag.outerHTML; } else {
                            const urlMatch = text.match(/http[s]?:\/\/[^\s]+/);
                            if(urlMatch) linkHtml = `<a href="${urlMatch[0]}" target="_blank">${urlMatch[0]}</a>`;
                        }
                        nodesToRemove.push(currentNode);
                    }
                    if (nodesToRemove.length >= 2) break; currentNode = currentNode.nextElementSibling;
                }
            }
            nodesToRemove.forEach(n => n.remove());

            const metaDiv = document.createElement('div'); metaDiv.className = 'meta';
            if (timeText) { const dateRow = document.createElement('div'); dateRow.innerHTML = `ğŸ“… å½’æ¡£æ—¶é—´: ${timeText.trim()}`; metaDiv.appendChild(dateRow); }
            if (linkHtml) { const linkRow = document.createElement('div'); linkRow.innerHTML = `ğŸ”— åŸæ–‡é“¾æ¥: ${linkHtml}`; metaDiv.appendChild(linkRow); }
            if (h1 && h1.parentNode) h1.parentNode.insertBefore(metaDiv, h1.nextSibling); else doc.body.insertBefore(metaDiv, doc.body.firstChild);

            if (!doc.querySelector('.footer')) { const footer = document.createElement('div'); footer.className = 'footer'; footer.textContent = 'Generated by ReadSense UserScript'; doc.body.appendChild(footer); }

            contentEl.innerHTML = doc.body.innerHTML;
            if (isDictLoaded) applyHighlights(contentEl);

        } catch (e) { contentEl.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${e.message}<br><button class="btn btn-secondary" onclick="location.reload()" style="margin-top:20px;">é‡è¯•</button></div>`; }
    }

    function applyHighlights(rootElement) {
        if (dictMap.size === 0) return;
        const walker = document.createTreeWalker(rootElement, NodeFilter.SHOW_TEXT, null, false);
        const textNodes = []; let node;
        while(node = walker.nextNode()) {
            const parent = node.parentElement;
            if (parent.tagName !== 'SCRIPT' && parent.tagName !== 'STYLE' && !parent.closest('.meta') && !parent.closest('.footer')) textNodes.push(node);
        }
        const regex = /\b[a-zA-Z][a-zA-Z'-]*\b/g;
        textNodes.forEach(textNode => {
            const text = textNode.nodeValue; if (!text.trim()) return;
            const fragment = document.createDocumentFragment(); let lastIndex = 0; let match;
            while ((match = regex.exec(text)) !== null) {
                const word = match[0]; const lowerWord = word.toLowerCase();
                if (dictMap.has(lowerWord)) {
                    if (match.index > lastIndex) fragment.appendChild(document.createTextNode(text.substring(lastIndex, match.index)));
                    const span = document.createElement('span'); span.className = dictMap.get(lowerWord); span.textContent = word;
                    fragment.appendChild(span); lastIndex = regex.lastIndex;
                }
            }
            if (lastIndex > 0) {
                if (lastIndex < text.length) fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                textNode.parentNode.replaceChild(fragment, textNode);
            }
        });
    }

    /* =========================================
       äº¤äº’é€»è¾‘
       ========================================= */
    function handleSelectionChange() {
        const selection = window.getSelection();
        const aiBtn = document.getElementById('ai-float-btn');

        if (!selection || selection.rangeCount === 0 || selection.isCollapsed) {
            aiBtn.style.display = 'none';
            currentSelection = '';
            return;
        }

        const text = selection.toString().trim();
        if (text.length < 2) { 
            aiBtn.style.display = 'none';
            return;
        }

        currentSelection = text;
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect(); 
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

        aiBtn.style.display = 'block';

        let topPos = rect.bottom + scrollTop + 12;
        let leftPos = rect.right + scrollLeft - aiBtn.offsetWidth;

        if (leftPos < 10) leftPos = 10; 
        if ((leftPos + aiBtn.offsetWidth) > (window.innerWidth - 10)) leftPos = window.innerWidth - aiBtn.offsetWidth - 10;

        aiBtn.style.top = topPos + 'px';
        aiBtn.style.left = leftPos + 'px';
    }

    function handleAiBtnClick(e) {
        e.preventDefault(); e.stopPropagation();
        if (!config.aiConfigs || config.aiConfigs.length === 0 || !config.aiConfigs[0].key) {
            alert('è¯·å…ˆåœ¨â€œè®¾ç½®â€ä¸­é…ç½® AI æ¥å£ä¿¡æ¯');
            openSettings();
            return;
        }
        callAIMulti(currentSelection);
        document.getElementById('ai-float-btn').style.display = 'none';
        window.getSelection().removeAllRanges();
    }

    function handleReaderClick(e) {
        if(e.target.closest('.meta') || e.target.closest('.footer') || e.target.closest('a')) return;
        if (window.getSelection().toString().trim().length > 0) return;

        let word = '';
        if (e.target.tagName === 'SPAN' && (e.target.classList.contains('hl-blue') || e.target.classList.contains('hl-red') || e.target.classList.contains('hl-yellow'))) {
            word = e.target.textContent;
        } else {
            word = getWordAtPoint(e.clientX, e.clientY);
        }

        if (word && /^[a-zA-Z'-]+$/.test(word)) {
            showDictCard(word);
        }
    }

    function getWordAtPoint(x, y) {
        let range, textNode, offset;
        if (document.caretRangeFromPoint) {
            range = document.caretRangeFromPoint(x, y);
            if (!range) return null;
            textNode = range.startContainer; offset = range.startOffset;
        } else if (document.caretPositionFromPoint) {
            const pos = document.caretPositionFromPoint(x, y);
            if (!pos) return null;
            textNode = pos.offsetNode; offset = pos.offset;
        }
        if (!textNode || textNode.nodeType !== Node.TEXT_NODE) return null;
        const text = textNode.textContent;
        let start = offset; while (start > 0 && /[a-zA-Z'-]/.test(text.charAt(start - 1))) start--;
        let end = offset; while (end < text.length && /[a-zA-Z'-]/.test(text.charAt(end))) end++;
        if (start < end) return text.substring(start, end);
        return null;
    }

    function simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return 'ai_c_' + hash;
    }

    // --- å†å²å›æº¯åŠŸèƒ½ ---
    function checkHistoryBtn() {
        // å¦‚æœæœ‰å†å²è®°å½•ï¼Œå®ƒå§‹ç»ˆå¯è§ï¼Œä¸å—é€‰ä¸­å½±å“
        const lastHtml = localStorage.getItem('last_ai_result');
        const btn = document.getElementById('ai-persistent-btn');
        const isReader = document.getElementById('reader-view').style.display === 'block';
        if (lastHtml && isReader) {
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }
    }

    function showLastAnalysis() {
        const lastHtml = localStorage.getItem('last_ai_result');
        // ã€æ–°å¢ã€‘è¯»å–æœ€åä¸€æ¬¡é€‰ä¸­çš„æ–‡æœ¬
        const lastText = localStorage.getItem('last_selected_text') || '';
        
        if (lastHtml) {
            const overlay = document.getElementById('dict-overlay');
            const aiCard = document.getElementById('ai-card');
            const content = document.getElementById('ai-content');
            const originBox = document.getElementById('ai-origin-text');

            document.getElementById('dict-card').classList.remove('open');
            overlay.classList.add('open');
            aiCard.classList.add('open');
            // æ‰“å¼€ AI å¡ç‰‡æ—¶é”å®šæ»šåŠ¨
            document.body.classList.add('no-scroll');

            originBox.innerText = lastText;
            if(!lastText) originBox.style.display = 'none'; else originBox.style.display = 'block';
            content.innerHTML = lastHtml;
        }
    }

    function saveLastResult(html) {
        localStorage.setItem('last_ai_result', html);
        checkHistoryBtn();
    }

    async function callAIMulti(text) {
        const overlay = document.getElementById('dict-overlay');
        const aiCard = document.getElementById('ai-card');
        const content = document.getElementById('ai-content');
        const originBox = document.getElementById('ai-origin-text');

        document.getElementById('dict-card').classList.remove('open');
        overlay.classList.add('open');
        aiCard.classList.add('open');
        // æ‰“å¼€ AI å¡ç‰‡æ—¶é”å®šæ»šåŠ¨
        document.body.classList.add('no-scroll');

        // ã€æ–°å¢ã€‘æ˜¾ç¤ºåŸæ–‡å¹¶ä¿å­˜åˆ° localStorage
        originBox.innerText = text;
        originBox.style.display = 'block';
        localStorage.setItem('last_selected_text', text);

        content.innerHTML = '<div class="dc-loading">ğŸ§  æ­£åœ¨è¿æ¥ AI...</div>';

        const cacheKey = simpleHash(text);
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
            try {
                const entry = JSON.parse(cached);
                const now = Date.now();
                if (now - entry.ts < 604800000) {
                    const html = simpleMarkdownRender(entry.reply) + `<div style="margin-top:15px;font-size:11px;color:#999;border-top:1px solid #eee;padding-top:5px;">âš¡ æ¥è‡ªç¼“å­˜ç»“æœ (7å¤©å†…æœ‰æ•ˆ)</div>`;
                    content.innerHTML = html;
                    saveLastResult(html); 
                    return;
                } else { localStorage.removeItem(cacheKey); }
            } catch(e) { localStorage.removeItem(cacheKey); }
        }

        const activeConfigs = config.aiConfigs.filter(c => c.key && c.host);
        if (activeConfigs.length === 0) {
            content.innerHTML = `<div class="dc-error">âŒ æœªé…ç½®æœ‰æ•ˆçš„ AI å¯†é’¥</div>`;
            return;
        }

        let lastError = null;
        for (let i = 0; i < activeConfigs.length; i++) {
            const cfg = activeConfigs[i];
            content.innerHTML = `<div class="dc-loading">ğŸ”„ æ­£åœ¨å°è¯• [${i+1}/${activeConfigs.length}] ${cfg.name}...</div>`;

            try {
                const reply = await callSingleAI(cfg, text);
                try { localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), reply: reply })); } catch(e) {}
                const finalHtml = simpleMarkdownRender(reply);
                content.innerHTML = finalHtml;
                if (i > 0) content.innerHTML += `<div style="margin-top:15px; font-size:11px; color:#999; border-top:1px solid #eee; padding-top:5px;">âš ï¸ ä¼˜å…ˆæ¥å£å¤±è´¥ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢è‡³ ${cfg.name}</div>`;
                saveLastResult(content.innerHTML);
                return; 
            } catch (err) {
                console.error(`AI Config ${cfg.name} failed:`, err);
                lastError = err;
            }
        }
        content.innerHTML = `<div class="dc-error">âŒ æ‰€æœ‰ AI æ¥å£å‡å°è¯•å¤±è´¥ã€‚<br><small>æœ€åä¸€æ¬¡é”™è¯¯: ${lastError.message}</small></div>`;
    }

    async function callSingleAI(cfg, text) {
        const response = await fetch(cfg.host, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${cfg.key}` },
            body: JSON.stringify({
                model: cfg.model,
                messages: [ { role: "system", content: config.systemPrompt }, { role: "user", content: `è¯·åˆ†æè¿™æ®µæ–‡æœ¬ï¼š\n"${text}"` } ],
                stream: false 
            })
        });
        if (!response.ok) { const errText = await response.text(); throw new Error(`HTTP ${response.status}: ${errText}`); }
        const data = await response.json();
        return data.choices?.[0]?.message?.content || "æœªæ”¶åˆ°å›å¤";
    }

    function simpleMarkdownRender(text) {
        return text.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\*\*(.*?)\*\*/g, '<span class="md-bold">$1</span>').replace(/### (.*?)(\n|$)/g, '<span class="md-h">$1</span>').replace(/## (.*?)(\n|$)/g, '<span class="md-h" style="font-size:1.1em">$1</span>').replace(/`([^`]+)`/g, '<span class="md-code">$1</span>').replace(/- (.*?)(\n|$)/g, '<span class="md-list-item">$1</span>').replace(/\n/g, '<br>');
    }

    async function showDictCard(word) {
        const card = document.getElementById('dict-card');
        const overlay = document.getElementById('dict-overlay');
        const content = document.getElementById('dc-content');
        document.getElementById('ai-card').classList.remove('open');
        overlay.classList.add('open');
        card.classList.add('open');
        // æŸ¥è¯å¡ç‰‡ï¼ˆå°å¡ç‰‡ï¼‰å¯é€‰æ˜¯å¦é”å®šæ»šåŠ¨ï¼Œç›®å‰è¿™é‡Œä¸é”å®šï¼Œå¦‚æœéœ€è¦è¯·åŠ  document.body.classList.add('no-scroll');
        content.innerHTML = `<div class="dc-loading">ğŸ” æ­£åœ¨æŸ¥è¯¢ "${word}"...</div>`;
        try {
            const cleanWord = word.trim();
            const apiUrl = `https://dict.youdao.com/jsonapi?q=${encodeURIComponent(cleanWord)}`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;
            const response = await fetch(proxyUrl);
            const data = await response.json();
            renderCardContent(data, cleanWord);
        } catch (err) {
            content.innerHTML = `<div class="dc-error">æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ<br><small>${err.message}</small></div><div class="dc-footer"><a href="https://m.youdao.com/dict?le=eng&q=${word}" target="_blank" class="dc-link">ğŸ”— è·³è½¬æœ‰é“ç½‘é¡µç‰ˆ</a></div>`;
        }
    }

    function renderCardContent(data, word) {
        const content = document.getElementById('dc-content');
        const meta = data.meta || {}; const simple = data.simple || {}; const ec = data.ec || {}; const collins = data.collins || {};
        const displayWord = meta.input || simple.query || word;
        let phonetic = ""; if (simple.word && simple.word[0]) { phonetic = simple.word[0].usphone || simple.word[0].ukphone || ""; }
        const audioUrl = `https://dict.youdao.com/dictvoice?audio=${displayWord}&type=2`;
        let starLevel = 0; if (collins && collins.collins_entries && collins.collins_entries.length > 0) { starLevel = collins.collins_entries[0].star || 0; }
        let definitions = [];
        if (ec.word && ec.word[0] && ec.word[0].trs) { definitions = ec.word[0].trs.map(tr => tr.tr[0].l.i.join("ï¼Œ")); } 
        else if (simple.word && simple.word[0] && simple.word[0].means) { definitions = simple.word[0].means.map(m => m.mean); }
        let starsHtml = ''; if (starLevel > 0) { starsHtml = `<div class="dc-stars">`; for (let i = 1; i <= 5; i++) { starsHtml += `<span class="dc-star ${i <= starLevel ? 'filled' : ''}">â˜…</span>`; } starsHtml += `</div>`; }
        let defsHtml = `<ul class="dc-def-list">`;
        if (definitions.length > 0) { definitions.forEach(def => { const parts = def.split('.'); let pos = '', mean = def; if(parts.length > 1 && parts[0].length < 6) { pos = parts[0] + '.'; mean = def.substring(parts[0].length + 1); } defsHtml += `<li class="dc-def-item"><span class="dc-pos">${pos}</span><span class="dc-meaning">${mean}</span></li>`; }); } else { defsHtml += `<li class="dc-def-item">æš‚æ— è¯¦ç»†é‡Šä¹‰</li>`; }
        defsHtml += `</ul>`;
        content.innerHTML = `<div class="dc-header"><div class="dc-word">${displayWord}</div><button class="dc-audio-btn" onclick="new Audio('${audioUrl}').play()"><svg class="dc-audio-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></button></div><div class="dc-meta-row">${phonetic ? `<span class="dc-phonetic">[${phonetic}]</span>` : ''}${starsHtml}</div>${defsHtml}<div class="dc-footer"><a href="https://m.youdao.com/dict?le=eng&q=${displayWord}" target="_blank" class="dc-link">æŸ¥çœ‹å®Œæ•´é‡Šä¹‰ &rarr;</a></div>`;
    }

    function closeAllCards() {
        document.getElementById('dict-card').classList.remove('open');
        document.getElementById('ai-card').classList.remove('open');
        document.getElementById('dict-overlay').classList.remove('open');
        // å…³é—­æ—¶è§£é™¤æ»šåŠ¨é”å®š
        document.body.classList.remove('no-scroll');
    }

    let tempAiConfigs = [];
    function openSettings() { 
        document.getElementById('settings-modal').style.display = 'flex'; 
        document.getElementById('cfg-user').value = config.user; document.getElementById('cfg-repo').value = config.repo; document.getElementById('cfg-root').value = config.rootPath; document.getElementById('cfg-token').value = config.token || ''; document.getElementById('cfg-api-prompt').value = config.systemPrompt;
        tempAiConfigs = JSON.parse(JSON.stringify(config.aiConfigs || [])); renderAiConfigList();
    }
    function renderAiConfigList() {
        const container = document.getElementById('ai-config-list'); container.innerHTML = '';
        tempAiConfigs.forEach((cfg, index) => {
            const div = document.createElement('div'); div.className = `ai-config-item ${index === 0 ? 'ai-priority-1' : ''}`;
            const header = document.createElement('div'); header.className = 'ai-config-header';
            const tag = document.createElement('span'); tag.className = 'ai-tag'; tag.textContent = index === 0 ? 'ä¼˜å…ˆ' : `å¤‡é€‰ ${index}`;
            const nameSpan = document.createElement('span'); nameSpan.style.fontWeight = 'bold'; nameSpan.style.fontSize = '13px'; nameSpan.textContent = cfg.name || 'æœªå‘½åé…ç½®';
            const btnGroup = document.createElement('div'); btnGroup.style.marginLeft = 'auto'; btnGroup.style.display = 'flex'; btnGroup.style.gap = '5px';
            if (index > 0) { const upBtn = document.createElement('button'); upBtn.textContent = 'â¬†'; upBtn.className = 'btn btn-secondary'; upBtn.style.padding = '2px 6px'; upBtn.onclick = () => { moveAiConfig(index, -1); }; btnGroup.appendChild(upBtn); }
            if (index < tempAiConfigs.length - 1) { const downBtn = document.createElement('button'); downBtn.textContent = 'â¬‡'; downBtn.className = 'btn btn-secondary'; downBtn.style.padding = '2px 6px'; downBtn.onclick = () => { moveAiConfig(index, 1); }; btnGroup.appendChild(downBtn); }
            const delBtn = document.createElement('button'); delBtn.textContent = 'âœ–'; delBtn.className = 'btn btn-danger'; delBtn.onclick = () => { removeAiConfig(index); }; btnGroup.appendChild(delBtn);
            header.appendChild(tag); header.appendChild(nameSpan); header.appendChild(btnGroup); div.appendChild(header);
            const formDiv = document.createElement('div');
            formDiv.innerHTML = `<div class="ai-form-row"><label>é…ç½®åç§°</label><input type="text" value="${cfg.name}" onchange="updateTempConfig(${index}, 'name', this.value)"></div><div class="ai-form-row"><label>æ¨¡å‹ (Model)</label><input type="text" value="${cfg.model}" onchange="updateTempConfig(${index}, 'model', this.value)"></div><div class="ai-form-row"><label>API Host</label><input type="text" value="${cfg.host}" onchange="updateTempConfig(${index}, 'host', this.value)"></div><div class="ai-form-row"><label>API Key</label><input type="password" value="${cfg.key}" placeholder="sk-..." onchange="updateTempConfig(${index}, 'key', this.value)"></div>`;
            div.appendChild(formDiv); container.appendChild(div);
        });
    }
    function addAiConfigUI() { tempAiConfigs.push({ name: 'New AI', host: 'https://api.openai.com/v1/chat/completions', model: 'gpt-3.5-turbo', key: '' }); renderAiConfigList(); }
    function removeAiConfig(index) { if (confirm('ç¡®å®šåˆ é™¤æ­¤ AI é…ç½®å—ï¼Ÿ')) { tempAiConfigs.splice(index, 1); renderAiConfigList(); } }
    function moveAiConfig(index, direction) { const targetIndex = index + direction; if (targetIndex >= 0 && targetIndex < tempAiConfigs.length) { const temp = tempAiConfigs[index]; tempAiConfigs[index] = tempAiConfigs[targetIndex]; tempAiConfigs[targetIndex] = temp; renderAiConfigList(); } }
    function updateTempConfig(index, field, value) { tempAiConfigs[index][field] = value.trim(); if (field === 'name') renderAiConfigList(); }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function saveSettings() { const newConfig = { user: document.getElementById('cfg-user').value.trim(), repo: document.getElementById('cfg-repo').value.trim(), rootPath: document.getElementById('cfg-root').value.trim().replace(/\/+$/, ''), token: document.getElementById('cfg-token').value.trim(), systemPrompt: document.getElementById('cfg-api-prompt').value.trim() || DEFAULTS.systemPrompt, aiConfigs: tempAiConfigs }; localStorage.setItem('gh_nav_config_v7', JSON.stringify(newConfig)); closeSettings(); location.reload(); }
    document.getElementById('settings-modal').addEventListener('click', function(e) { if (e.target === this) closeSettings(); });
    init();
</script>
</body>
</html>
