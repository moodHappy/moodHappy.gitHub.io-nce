<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Danmu å­¦ä¹ ç¬”è®° - ReadSense é£æ ¼</title>

    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/danmu.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/danmu.png">

    <style>
        :root {
            --primary: #0969da;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --border: #d0d7de;
            --text-main: #1f2328;
            --text-muted: #656d76;

            /* é«˜äº®é¢œè‰²é…ç½® */
            --hl-blue: #0969da; 
            --hl-red: #cf222e; 
            --hl-yellow: #d97706; 

            /* ReadSense ç‰¹æœ‰æ ·å¼å˜é‡ */
            --rs-blue: #3498db;
            --rs-meta-bg: #f9f9f9;
            --rs-meta-text: #7f8c8d;
            --rs-title: #2c3e50;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }

        /* --- è§†å›¾1ï¼šåˆ—è¡¨å®¹å™¨ --- */
        .view-container {
            max-width: 800px; margin: 20px auto; background: var(--card-bg);
            border: 1px solid var(--border); border-radius: 6px; padding: 20px;
            box-shadow: 0 3px 6px rgba(140, 149, 159, 0.03); display: block;
        }

        /* --- è§†å›¾2ï¼šé˜…è¯»é¡µé¢ --- */
        .reader-page {
            display: none; background: #ffffff; min-height: 100vh; width: 100%;
        }

        .reader-content-wrapper {
            max-width: 800px; margin: 0 auto; padding: 30px 20px 150px 20px; /* åº•éƒ¨ç•™ç™½ç»™å¼¹çª— */
            font-size: 18px; line-height: 1.8; color: #333;
        }

        .reader-content-wrapper h1 {
            display: block !important; margin-top: 25px; margin-bottom: 25px;
            line-height: 1.3; color: var(--rs-title); border-bottom: 2px solid var(--rs-blue);
            padding-bottom: 10px; font-size: 2em;
        }

        .meta {
            font-size: 14px; color: var(--rs-meta-text); margin-bottom: 25px;
            background: var(--rs-meta-bg); padding: 10px; border-radius: 6px; line-height: 1.6;
        }
        .meta div { margin-bottom: 4px; }
        .meta a { color: var(--rs-blue); text-decoration: none; word-break: break-all; }

        .footer {
            margin-top: 40px; font-size: 12px; color: #bdc3c7; text-align: center; border-top: 1px solid #eee; padding-top: 20px;
        }

        /* å¤´éƒ¨ä¸åˆ—è¡¨æ ·å¼ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        header h1 { margin: 0; font-size: 18px; display: flex; align-items: center; gap: 8px; border-bottom: none !important; color: inherit !important; }
        .status-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; font-weight: normal; }
        .status-ready { background: #dafbe1; color: #1f883d; }
        .nav-btn { background: transparent; border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; color: var(--text-main); }
        
        ul { list-style: none; padding: 0; margin: 0; }
        li { border-bottom: 1px solid #eaecef; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; cursor: pointer; border-radius: 4px; }
        .item-icon { margin-right: 10px; font-size: 18px; }
        .item-name { font-weight: 600; font-size: 15px; overflow: hidden; text-overflow: ellipsis; }
        .breadcrumb { background: #f3f4f6; padding: 10px 15px; border-radius: 6px; margin-bottom: 20px; font-size: 14px; display: flex; align-items: center; flex-wrap: wrap; }
        .breadcrumb-item { cursor: pointer; color: var(--primary); font-weight: 500; }
        .breadcrumb-separator { margin: 0 8px; color: var(--text-muted); }
        .pinned-section { background: #e6f6ff; border: 1px solid #b6e3ff; border-radius: 6px; padding: 15px; margin-bottom: 20px; }
        .pinned-card { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }

        /* é«˜äº®æ ·å¼ */
        .hl-blue { color: var(--hl-blue); font-weight: 700; cursor: pointer; }
        .hl-red { color: var(--hl-red); font-weight: 700; cursor: pointer; }
        .hl-yellow { color: var(--hl-yellow); font-weight: 700; cursor: pointer; }

        /* è®¾ç½®å¼¹çª— */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 200; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold; } .form-group input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #d0d7de; border-radius: 4px; }
        .btn { padding: 8px 16px; cursor: pointer; border: none; border-radius: 4px; font-size: 14px; } .btn-secondary { background: #f3f4f6; color: #24292f; margin-right: 10px; } .btn-primary { background: var(--primary); color: white; }
        .loading, .error { text-align: center; padding: 50px 20px; color: var(--text-muted); font-size: 16px; } .error { color: #cf222e; }

        /* =========================================
           ã€ä¼˜åŒ–ã€‘æŸ¥è¯å¡ç‰‡ (Dict Card) æ ·å¼
           ========================================= */
        .dict-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); z-index: 998;
        }
        .dict-overlay.open { display: block; }

        .dict-card {
            position: fixed; 
            bottom: 20px; left: 50%; transform: translateX(-50%) translateY(120%);
            width: 90%; max-width: 380px; /* ç¨å¾®è°ƒçª„ä¸€ç‚¹ï¼Œæ›´åƒæ‰‹æœºå¡ç‰‡ */
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15); /* åŠ æ·±é˜´å½±ï¼Œå¢åŠ æµ®åŠ¨æ„Ÿ */
            z-index: 999;
            padding: 24px;
            box-sizing: border-box;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .dict-card.open { transform: translateX(-50%) translateY(0); }

        /* é¡¶éƒ¨å•è¯è¡Œ */
        .dc-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .dc-word { font-size: 26px; font-weight: 700; color: #000; line-height: 1.2; word-wrap: break-word; }
        
        /* --- ã€ä¿®å¤é‡ç‚¹ã€‘æ’­æ”¾æŒ‰é’®æ ·å¼ --- */
        .dc-audio-btn {
            background: #eff6ff; /* ææ·¡çš„è“è‰²èƒŒæ™¯ */
            color: #4f46e5;      /* è“è‰²å–‡å­ */
            border: none;
            width: 36px; height: 36px; /* å›ºå®šå°ºå¯¸ */
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; 
            
            /* å…³é”®ä¿®å¤ï¼šé˜²æ­¢Flexå¸ƒå±€æŒ¤å‹å˜å½¢ */
            flex-shrink: 0; 
            margin-left: 15px; /* ä¿æŒé—´è· */
        }
        .dc-audio-btn:active { background: #dbeafe; transform: scale(0.95); }
        .dc-audio-icon { width: 20px; height: 20px; fill: currentColor; display: block; }

        /* éŸ³æ ‡ä¸æ˜Ÿæ˜Ÿè¡Œ */
        .dc-meta-row { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        .dc-phonetic { font-family: "Lucida Sans Unicode", "Arial Unicode MS", sans-serif; color: #666; font-size: 15px; letter-spacing: 0.5px; }
        
        /* æ˜Ÿæ˜Ÿæ ·å¼ */
        .dc-stars { display: flex; gap: 1px; align-items: center; }
        .dc-star { color: #e5e7eb; font-size: 14px; } /* é»˜è®¤ç°è‰² */
        .dc-star.filled { color: #f59e0b; } /* æ¿€æ´»é‡‘é»„è‰² */

        /* é‡Šä¹‰åŒºåŸŸ */
        .dc-def-list { margin: 0; padding: 0; list-style: none; max-height: 220px; overflow-y: auto; }
        .dc-def-item { 
            font-size: 16px; color: #374151; margin-bottom: 8px; line-height: 1.5; 
            display: flex; gap: 8px;
        }
        .dc-pos { 
            color: #0969da; font-weight: 600; font-style: italic; 
            font-size: 15px; min-width: 30px; 
        } 
        .dc-meaning { flex: 1; }

        /* åº•éƒ¨é“¾æ¥ */
        .dc-footer { 
            margin-top: 20px; padding-top: 15px; border-top: 1px solid #f3f4f6; 
            text-align: right; font-size: 13px;
        }
        .dc-link { color: #6b7280; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; transition: color 0.2s; }
        .dc-link:hover { color: #0969da; }
        
        /* åŠ è½½ä¸é”™è¯¯çŠ¶æ€ */
        .dc-loading { text-align: center; color: #999; padding: 20px; font-size: 14px; }
        .dc-error { text-align: center; color: #cf222e; padding: 10px; font-size: 14px; }

    </style>
</head>
<body>

<div id="list-view" class="view-container">
    <header>
        <h1>ğŸ“š è‹±è¯­å­¦ä¹ ç¬”è®° <span id="dict-status" class="status-badge">è¯åº“åŠ è½½ä¸­...</span></h1>
        <button class="nav-btn" onclick="openSettings()"><span>âš™ï¸ è®¾ç½®</span></button>
    </header>
    <div id="breadcrumb" class="breadcrumb"></div>
    <div id="latest-container"></div>
    <div id="file-list"><div class="loading">æ­£åœ¨åŠ è½½ç›®å½•...</div></div>
</div>

<div id="reader-view" class="reader-page">
    <div id="reader-content" class="reader-content-wrapper"></div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal">
        <h3>ğŸ”§ é…ç½®</h3>
        <div class="form-group"><label>GitHub Token (PAT)</label><input type="password" id="cfg-token" placeholder="github_pat_..."><div style="font-size:12px; color:#666; margin-top:4px;">ğŸ”’ Token ä¿å­˜åœ¨æœ¬åœ°ã€‚</div></div>
        <div class="form-group"><label>GitHub ç”¨æˆ·å</label><input type="text" id="cfg-user"></div>
        <div class="form-group"><label>ä»“åº“åç§°</label><input type="text" id="cfg-repo"></div>
        <div class="form-group"><label>æ ¹ç›®å½•è·¯å¾„</label><input type="text" id="cfg-root"></div>
        <div style="text-align: right; margin-top: 20px;"><button class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜å¹¶åˆ·æ–°</button></div>
    </div>
</div>

<div id="dict-overlay" class="dict-overlay" onclick="closeDictCard()"></div>
<div id="dict-card" class="dict-card">
    <div id="dc-content"></div>
</div>

<script>
    const DEFAULTS = { user: 'moodHappy', repo: 'moodHappy.gitHub.io-nce', rootPath: 'Notes/danmu', token: '' };
    const DICT_URLS = {
        one: 'https://raw.githubusercontent.com/moodHappy/HelloWorld/refs/heads/master/Notes/one.txt',
        two: 'https://raw.githubusercontent.com/moodHappy/HelloWorld/refs/heads/master/Notes/two.txt',
        supplement: 'https://raw.githubusercontent.com/moodHappy/HelloWorld/refs/heads/master/Notes/supplement.txt',
        excluded: 'https://raw.githubusercontent.com/moodHappy/HelloWorld/refs/heads/master/Notes/Excluded.txt'
    };

    let config = {}; let currentPath = ''; let dictMap = new Map(); let isDictLoaded = false;

    // --- åˆå§‹åŒ– ---
    window.addEventListener('popstate', (event) => {
        if (!new URLSearchParams(window.location.search).has('file')) {
            showListUI();
            closeDictCard();
        }
    });

    function getConfig() {
        const stored = localStorage.getItem('gh_nav_config_v5');
        return stored ? { ...DEFAULTS, ...JSON.parse(stored) } : DEFAULTS;
    }

    async function init() {
        config = getConfig();
        if (!currentPath) currentPath = config.rootPath;
        const targetFile = new URLSearchParams(window.location.search).get('file');
        loadDictionaries(); 
        if (targetFile) openReader(targetFile, false); else loadPath(currentPath);
        
        document.getElementById('reader-content').addEventListener('click', handleReaderClick);
    }

    // --- è¯åº“åŠ è½½ ---
    async function loadDictionaries() {
        const statusEl = document.getElementById('dict-status');
        try {
            const [txtOne, txtTwo, txtSup, txtExc] = await Promise.all([
                fetch(DICT_URLS.one).then(r => r.text()), fetch(DICT_URLS.two).then(r => r.text()),
                fetch(DICT_URLS.supplement).then(r => r.text()), fetch(DICT_URLS.excluded).then(r => r.text())
            ]);
            const parse = (text) => text.split(/\r?\n/).map(w => w.trim().toLowerCase()).filter(w => w);
            const excludedSet = new Set(parse(txtExc));

            parse(txtOne).forEach(w => { if(!excludedSet.has(w)) dictMap.set(w, 'hl-blue'); });
            parse(txtTwo).forEach(w => { if(!excludedSet.has(w)) dictMap.set(w, 'hl-red'); });
            parse(txtSup).forEach(w => { if(!excludedSet.has(w)) dictMap.set(w, 'hl-yellow'); });

            isDictLoaded = true;
            statusEl.textContent = `âœ“ è¯åº“å°±ç»ª (${dictMap.size}è¯)`; statusEl.classList.add('status-ready');
            if(document.getElementById('reader-view').style.display === 'block') applyHighlights(document.getElementById('reader-content'));
        } catch (e) {
            statusEl.textContent = "âš ï¸ è¯åº“å¤±è´¥"; statusEl.style.background = "#ffebe9"; statusEl.style.color = "#cf222e";
        }
    }

    // --- GitHub API ---
    async function ghFetch(url) {
        const headers = {}; if (config.token) headers['Authorization'] = `token ${config.token}`;
        const response = await fetch(url, { headers });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    }

    // --- åˆ—è¡¨é€»è¾‘ ---
    async function loadPath(path) {
        currentPath = path; renderBreadcrumb(path);
        const listContainer = document.getElementById('file-list');
        const latestContainer = document.getElementById('latest-container');
        listContainer.innerHTML = '<div class="loading">æ­£åœ¨è·å–åˆ—è¡¨...</div>';
        try {
            const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`);
            if (!Array.isArray(data)) return; 
            let dirs = [], files = []; processItems(data, dirs, files);
            dirs.sort((a, b) => b.name.localeCompare(a.name)); files.sort((a, b) => b.timestamp - a.timestamp);

            if (path === config.rootPath) {
                const yearDirs = dirs.filter(d => /^\d{4}$/.test(d.name));
                if (yearDirs.length > 0) {
                    latestContainer.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;margin-bottom:10px;">æ­£åœ¨æ£€æŸ¥æœ€æ–°ç¬”è®°...</div>';
                    fetchLatestInDir(yearDirs[0]).then(latest => {
                        if (latest) renderLatestCard(latest, yearDirs[0].name); else latestContainer.innerHTML = '';
                    });
                } else { latestContainer.innerHTML = ''; }
            } else { latestContainer.innerHTML = ''; }
            renderList(dirs, files);
        } catch (error) { listContainer.innerHTML = `<div class="error">${error.message}</div>`; }
    }

    function processItems(items, dirsArr, filesArr) {
        items.forEach(item => {
            if (item.name.toLowerCase() === 'index.html') return;
            if (item.type === 'dir') dirsArr.push(item);
            else if (item.name.endsWith('.html')) {
                const match = item.name.match(/_(\d{13})\.html$/);
                const ts = match ? parseInt(match[1]) : 0;
                filesArr.push({ ...item, timestamp: ts, dateStr: ts ? new Date(ts).toLocaleString('zh-CN',{hour12:false}) : '' });
            }
        });
    }

    async function fetchLatestInDir(dirItem) {
        const data = await ghFetch(`https://api.github.com/repos/${config.user}/${config.repo}/contents/${dirItem.path}`);
        if (!Array.isArray(data)) return null;
        let files = [], dirs = []; processItems(data, dirs, files);
        files.sort((a, b) => b.timestamp - a.timestamp); return files.length > 0 ? files[0] : null;
    }

    function renderList(dirs, files) {
        const listContainer = document.getElementById('file-list');
        if (dirs.length === 0 && files.length === 0) { listContainer.innerHTML = '<div style="text-align:center;padding:30px;color:#999;">ç©ºç›®å½•</div>'; return; }
        let html = '<ul>';
        dirs.forEach(dir => html += `<li onclick="loadPath('${dir.path}')"><div class="list-item"><span class="item-icon folder-icon">ğŸ“</span><div class="item-info"><span class="item-name">${dir.name}</span></div><span style="color:#ccc">â€º</span></div></li>`);
        files.forEach(file => {
            let displayName = file.name.replace('.html', '').replace(/_\d{13}$/, '').replace(/_/g, ' ');
            html += `<li onclick="openReader('${file.path}')"><div class="list-item"><span class="item-icon file-icon">ğŸ“„</span><div class="item-info"><span class="item-name">${displayName}</span>${file.dateStr ? `<div class="item-meta">ğŸ“… ${file.dateStr}</div>` : ''}</div></div></li>`;
        });
        html += '</ul>'; listContainer.innerHTML = html;
    }

    function renderLatestCard(file, year) {
        const container = document.getElementById('latest-container');
        let displayName = file.name.replace('.html', '').replace(/_\d{13}$/, '').replace(/_/g, ' ');
        container.innerHTML = `<div class="pinned-section"><span class="pinned-label">ğŸ†• æœ€æ–°ç¬”è®° (${year})</span><div class="pinned-card" onclick="openReader('${file.path}')"><div style="display:flex;align-items:center;overflow:hidden;"><span class="pinned-icon">ğŸ“„</span><div style="overflow:hidden;"><div class="pinned-title" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${displayName}</div><div class="pinned-meta">ğŸ“… ${file.dateStr}</div></div></div><div style="color:#0969da;font-weight:bold;margin-left:10px;">é˜…è¯» &rarr;</div></div></div>`;
    }

    function renderBreadcrumb(path) {
        const container = document.getElementById('breadcrumb');
        let html = `<span class="breadcrumb-item" onclick="loadPath('${config.rootPath}')">ğŸ  é¦–é¡µ</span>`;
        if (path !== config.rootPath && path.startsWith(config.rootPath)) {
            const parts = path.substring(config.rootPath.length).split('/').filter(p=>p);
            let build = config.rootPath;
            parts.forEach((part, i) => {
                build += '/' + part; html += `<span class="breadcrumb-separator">/</span>`;
                if(i===parts.length-1) html += `<span class="breadcrumb-current">${part}</span>`; else html += `<span class="breadcrumb-item" onclick="loadPath('${build}')">${part}</span>`;
            });
        }
        container.innerHTML = html;
    }

    // --- è§†å›¾åˆ‡æ¢ ---
    function showListUI() {
        document.getElementById('list-view').style.display = 'block'; document.getElementById('reader-view').style.display = 'none';
        document.body.style.backgroundColor = 'var(--bg)'; 
        const url = new URL(window.location); url.searchParams.delete('file'); history.replaceState(null, '', url); window.scrollTo(0, 0);
    }
    function showReaderUI() {
        document.getElementById('list-view').style.display = 'none'; document.getElementById('reader-view').style.display = 'block';
        document.body.style.backgroundColor = '#ffffff'; window.scrollTo(0, 0);
    }

    // --- ç¬”è®°é˜…è¯»å™¨ ---
    async function openReader(filePath, updateHistory = true) {
        showReaderUI();
        const contentEl = document.getElementById('reader-content');
        if (updateHistory) { const url = new URL(window.location); url.searchParams.set('file', filePath); history.pushState({ file: filePath }, '', url); }
        contentEl.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ç¬”è®°å†…å®¹...</div>';

        try {
            const response = await fetch(`https://raw.githubusercontent.com/${config.user}/${config.repo}/main/${filePath}`);
            if (!response.ok) throw new Error("HTTP " + response.status);
            const htmlText = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');

            const h1 = doc.querySelector('h1');
            let timeText = ''; let linkHtml = ''; let nodesToRemove = [];
            const existingMeta = doc.querySelector('.meta');
            if (existingMeta) {
                timeText = existingMeta.textContent.match(/å½’æ¡£æ—¶é—´:([^\n]*)/)?.[1] || '';
                const linkTag = existingMeta.querySelector('a'); if (linkTag) linkHtml = linkTag.outerHTML;
                nodesToRemove.push(existingMeta);
            } else {
                let currentNode = h1 ? h1.nextElementSibling : doc.body.firstElementChild;
                while (currentNode) {
                    const text = currentNode.textContent;
                    if (text.includes('å½’æ¡£æ—¶é—´')) {
                        timeText = text.replace('å½’æ¡£æ—¶é—´:', '').replace('ğŸ“…', '').trim(); nodesToRemove.push(currentNode);
                    } else if (text.includes('åŸæ–‡é“¾æ¥') || currentNode.querySelector('a')) {
                        const linkTag = currentNode.querySelector('a');
                        if (linkTag) { linkHtml = linkTag.outerHTML; } else {
                            const urlMatch = text.match(/http[s]?:\/\/[^\s]+/);
                            if(urlMatch) linkHtml = `<a href="${urlMatch[0]}" target="_blank">${urlMatch[0]}</a>`;
                        }
                        nodesToRemove.push(currentNode);
                    }
                    if (nodesToRemove.length >= 2) break; currentNode = currentNode.nextElementSibling;
                }
            }
            nodesToRemove.forEach(n => n.remove());

            const metaDiv = document.createElement('div'); metaDiv.className = 'meta';
            if (timeText) { const dateRow = document.createElement('div'); dateRow.innerHTML = `ğŸ“… å½’æ¡£æ—¶é—´: ${timeText.trim()}`; metaDiv.appendChild(dateRow); }
            if (linkHtml) { const linkRow = document.createElement('div'); linkRow.innerHTML = `ğŸ”— åŸæ–‡é“¾æ¥: ${linkHtml}`; metaDiv.appendChild(linkRow); }
            if (h1 && h1.parentNode) h1.parentNode.insertBefore(metaDiv, h1.nextSibling); else doc.body.insertBefore(metaDiv, doc.body.firstChild);

            if (!doc.querySelector('.footer')) { const footer = document.createElement('div'); footer.className = 'footer'; footer.textContent = 'Generated by ReadSense UserScript'; doc.body.appendChild(footer); }

            contentEl.innerHTML = doc.body.innerHTML;
            if (isDictLoaded) applyHighlights(contentEl);

        } catch (e) { contentEl.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${e.message}<br><button class="btn btn-secondary" onclick="location.reload()" style="margin-top:20px;">é‡è¯•</button></div>`; }
    }

    function applyHighlights(rootElement) {
        if (dictMap.size === 0) return;
        const walker = document.createTreeWalker(rootElement, NodeFilter.SHOW_TEXT, null, false);
        const textNodes = []; let node;
        while(node = walker.nextNode()) {
            const parent = node.parentElement;
            if (parent.tagName !== 'SCRIPT' && parent.tagName !== 'STYLE' && !parent.closest('.meta') && !parent.closest('.footer')) textNodes.push(node);
        }
        const regex = /\b[a-zA-Z][a-zA-Z'-]*\b/g;
        textNodes.forEach(textNode => {
            const text = textNode.nodeValue; if (!text.trim()) return;
            const fragment = document.createDocumentFragment(); let lastIndex = 0; let match;
            while ((match = regex.exec(text)) !== null) {
                const word = match[0]; const lowerWord = word.toLowerCase();
                if (dictMap.has(lowerWord)) {
                    if (match.index > lastIndex) fragment.appendChild(document.createTextNode(text.substring(lastIndex, match.index)));
                    const span = document.createElement('span'); span.className = dictMap.get(lowerWord); span.textContent = word;
                    fragment.appendChild(span); lastIndex = regex.lastIndex;
                }
            }
            if (lastIndex > 0) {
                if (lastIndex < text.length) fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                textNode.parentNode.replaceChild(fragment, textNode);
            }
        });
    }

    // --- æŸ¥è¯äº¤äº’ ---
    function handleReaderClick(e) {
        if(e.target.closest('.meta') || e.target.closest('.footer') || e.target.closest('a')) return;

        let word = '';
        if (e.target.tagName === 'SPAN' && (e.target.classList.contains('hl-blue') || e.target.classList.contains('hl-red') || e.target.classList.contains('hl-yellow'))) {
            word = e.target.textContent;
        } else {
            word = getWordAtPoint(e.clientX, e.clientY);
        }

        if (word && /^[a-zA-Z'-]+$/.test(word)) {
            showDictCard(word);
        }
    }

    function getWordAtPoint(x, y) {
        let range, textNode, offset;
        if (document.caretRangeFromPoint) {
            range = document.caretRangeFromPoint(x, y);
            if (!range) return null;
            textNode = range.startContainer; offset = range.startOffset;
        } else if (document.caretPositionFromPoint) {
            const pos = document.caretPositionFromPoint(x, y);
            if (!pos) return null;
            textNode = pos.offsetNode; offset = pos.offset;
        }
        if (!textNode || textNode.nodeType !== Node.TEXT_NODE) return null;
        const text = textNode.textContent;
        let start = offset; while (start > 0 && /[a-zA-Z'-]/.test(text.charAt(start - 1))) start--;
        let end = offset; while (end < text.length && /[a-zA-Z'-]/.test(text.charAt(end))) end++;
        if (start < end) return text.substring(start, end);
        return null;
    }

    async function showDictCard(word) {
        const card = document.getElementById('dict-card');
        const overlay = document.getElementById('dict-overlay');
        const content = document.getElementById('dc-content');

        overlay.classList.add('open');
        card.classList.add('open');
        content.innerHTML = `<div class="dc-loading">ğŸ” æ­£åœ¨æŸ¥è¯¢ "${word}"...</div>`;

        try {
            const cleanWord = word.trim();
            const apiUrl = `https://dict.youdao.com/jsonapi?q=${encodeURIComponent(cleanWord)}`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;
            
            const response = await fetch(proxyUrl);
            const data = await response.json();

            renderCardContent(data, cleanWord);
        } catch (err) {
            content.innerHTML = `
                <div class="dc-error">æŸ¥è¯¢å¤±è´¥<br><small>${err.message}</small></div>
                <div class="dc-footer"><a href="https://m.youdao.com/dict?le=eng&q=${word}" target="_blank" class="dc-link">è·³è½¬æœ‰é“ç½‘é¡µç‰ˆ &rarr;</a></div>
            `;
        }
    }

    function renderCardContent(data, word) {
        const content = document.getElementById('dc-content');
        const meta = data.meta || {};
        const simple = data.simple || {};
        const ec = data.ec || {};
        const collins = data.collins || {};

        const displayWord = meta.input || simple.query || word;
        let phonetic = "";
        if (simple.word && simple.word[0]) {
            phonetic = simple.word[0].usphone || simple.word[0].ukphone || "";
        }
        const audioUrl = `https://dict.youdao.com/dictvoice?audio=${displayWord}&type=2`;

        let starLevel = 0;
        if (collins && collins.collins_entries && collins.collins_entries.length > 0) {
            starLevel = collins.collins_entries[0].star || 0;
        }

        let definitions = [];
        if (ec.word && ec.word[0] && ec.word[0].trs) {
            definitions = ec.word[0].trs.map(tr => tr.tr[0].l.i.join("ï¼Œ"));
        } else if (simple.word && simple.word[0] && simple.word[0].means) {
             definitions = simple.word[0].means.map(m => m.mean);
        }

        let starsHtml = '';
        if (starLevel > 0) {
            starsHtml = `<div class="dc-stars">`;
            for (let i = 1; i <= 5; i++) {
                starsHtml += `<span class="dc-star ${i <= starLevel ? 'filled' : ''}">â˜…</span>`;
            }
            starsHtml += `</div>`;
        }

        let defsHtml = `<ul class="dc-def-list">`;
        if (definitions.length > 0) {
            definitions.forEach(def => {
                const parts = def.split('.'); 
                let pos = '', mean = def;
                if(parts.length > 1 && parts[0].length < 6 && /^[a-z]+$/.test(parts[0])) {
                    pos = parts[0] + '.';
                    mean = def.substring(parts[0].length + 1);
                }
                defsHtml += `<li class="dc-def-item"><span class="dc-pos">${pos}</span><span class="dc-meaning">${mean}</span></li>`;
            });
        } else {
            defsHtml += `<li class="dc-def-item">æš‚æ— è¯¦ç»†é‡Šä¹‰</li>`;
        }
        defsHtml += `</ul>`;

        const html = `
            <div class="dc-header">
                <div class="dc-word">${displayWord}</div>
                <button class="dc-audio-btn" onclick="new Audio('${audioUrl}').play()">
                    <svg class="dc-audio-icon" viewBox="0 0 24 24"><path d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77zm-4 0h-2.5l-5 5H2v6h4.5l5 5v-16zm2 16h-2v-2h2v2zm0-4h-2V7h2v8z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
                </button>
            </div>
            <div class="dc-meta-row">
                ${phonetic ? `<span class="dc-phonetic">[${phonetic}]</span>` : ''}
                ${starsHtml}
            </div>
            ${defsHtml}
            <div class="dc-footer">
                <a href="https://m.youdao.com/dict?le=eng&q=${displayWord}" target="_blank" class="dc-link">æŸ¥çœ‹å®Œæ•´é‡Šä¹‰ &rarr;</a>
            </div>
        `;

        content.innerHTML = html;
    }

    function closeDictCard() {
        document.getElementById('dict-card').classList.remove('open');
        document.getElementById('dict-overlay').classList.remove('open');
    }

    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; document.getElementById('cfg-user').value = config.user; document.getElementById('cfg-repo').value = config.repo; document.getElementById('cfg-root').value = config.rootPath; document.getElementById('cfg-token').value = config.token || ''; }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function saveSettings() {
        const newConfig = { user: document.getElementById('cfg-user').value.trim(), repo: document.getElementById('cfg-repo').value.trim(), rootPath: document.getElementById('cfg-root').value.trim().replace(/\/+$/, ''), token: document.getElementById('cfg-token').value.trim() };
        localStorage.setItem('gh_nav_config_v5', JSON.stringify(newConfig)); closeSettings(); location.reload();
    }
    document.getElementById('settings-modal').addEventListener('click', function(e) { if (e.target === this) closeSettings(); });
    init();
</script>
</body>
</html>
