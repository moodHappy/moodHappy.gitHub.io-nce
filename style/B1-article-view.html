<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中转站</title>
    <style>
        /* Modern CSS Variables */
        :root {
            --primary-color: #667eea; /* A vibrant blue-purple */
            --primary-hover: #5a6fd8;
            --secondary-color: #764ba2; /* A deeper purple */
            --accent-color: #f093fb; /* A bright pink/purple */
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.1); /* Lighter, more transparent for glass effect */
            --card-border: rgba(255, 255, 255, 0.2);
            --text-primary: #f8f9fa; /* Light text for dark background */
            --text-secondary: #e0e0e0;
            --text-muted: #c0c0c0;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.8;
            color: var(--text-primary);
            background: var(--background-gradient);
            min-height: 100vh;
            padding-top: 90px;
            position: relative;
            overflow-x: hidden; /* Prevent horizontal scroll due to animations */
        }

        /* Animated background elements */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 200, 255, 0.2) 0%, transparent 50%);
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(1deg); }
            66% { transform: translateY(10px) rotate(-1deg); }
        }

        /* Speed Control Container - Modern Glass Effect */
        .speed-control-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.1); /* More transparent background */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px 30px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* 将按钮放在左侧 */
            gap: 20px; /* 增加按钮之间的间距 */
            box-shadow: var(--shadow-sm);
        }

        .speed-label {
            font-size: 1.1em;
            color: white; /* White text for contrast against blurred background */
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* Subtle text shadow */
            white-space: nowrap;
        }

        /* Home Button Style - Applied to "语速" button as well */
        .home-button {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-md);
            text-decoration: none; /* For anchor tag if used as button */
            display: inline-block;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            white-space: nowrap;
        }

        .home-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, var(--primary-hover) 0%, var(--accent-color) 100%);
        }

        .home-button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        /* Speed Slider Wrapper for vertical orientation and hiding */
        .speed-slider-wrapper {
            position: fixed;
            left: 20px; /* Position on the left side */
            top: 50%;
            transform: translateY(-50%);
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.15); /* Glass effect for the wrapper */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            gap: 10px;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s ease-in-out; /* Add transform for slide effect */
            opacity: 0;
            visibility: hidden;
            pointer-events: none; /* Don't block clicks when hidden */
            transform: translateY(-50%) translateX(-100%); /* Start off-screen to the left */
        }

        .speed-slider-wrapper.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto; /* Allow clicks when visible */
            transform: translateY(-50%) translateX(0); /* Slide in to original position */
        }

        .speed-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 8px; /* Width becomes height for vertical slider */
            height: 180px; /* Height becomes width for vertical slider */
            background: rgba(255, 255, 255, 0.3); /* Lighter, more transparent track */
            outline: none;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            writing-mode: vertical-lr; /* Makes the slider vertical */
            transform: rotate(180deg); /* Rotates the slider so min is at bottom, max at top */
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); /* White gradient thumb */
            border-radius: 50%;
            cursor: grab;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .speed-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            border-radius: 50%;
            cursor: grab;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .speed-slider:hover::-webkit-slider-thumb {
            transform: scale(1.1) rotate(-180deg); /* Counter-rotate to keep thumb upright */
            box-shadow: var(--shadow-lg);
        }

        .speed-slider:active::-webkit-slider-thumb {
            cursor: grabbing;
            transform: scale(0.95) rotate(-180deg); /* Counter-rotate to keep thumb upright */
        }

        .speed-value-display {
            font-weight: 700;
            color: white;
            min-width: 40px;
            text-align: center;
            font-size: 1.1em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Content Container */
        .content-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            padding-top: 0;
            min-height: 50vh; /* Ensure container has some height even with few items */
        }

        /* Article Sections - Modern Card Design */
        .article-section {
            background: var(--card-bg); /* Use card background variable */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
            overflow: hidden;
            transition: var(--transition);
            position: relative;
        }

        .article-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            opacity: 0;
            transition: var(--transition);
        }

        .article-section:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }

        .article-section:hover::before {
            opacity: 1;
        }

        .article-header {
            padding: 25px;
            color: var(--text-primary); /* Use primary text color for header */
            font-size: 1em; /* Adjusted to be smaller */
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* Lighter border for glass effect */
            display: block;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            white-space: nowrap; /* Prevent wrapping */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            max-width: 100%; /* Ensure it respects parent width */
        }

        .article-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); /* Lighter shimmer */
            transition: var(--transition);
        }

        .article-header:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(240, 147, 251, 0.1));
            color: var(--primary-color); /* Highlight color on hover */
        }

        .article-header:hover::before {
            left: 100%;
        }

        /* Added style for the pinned article header */
        .article-header.pinned-article {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
            color: white; /* Ensure text is white for contrast */
            font-size: 1.1em; /* Slightly larger for emphasis */
            border-bottom: none; /* No border for a cleaner look */
            box-shadow: var(--shadow-md); /* Add a subtle shadow */
            position: sticky; /* Make it sticky */
            top: 90px; /* Position it below the speed control container */
            z-index: 990; /* Ensure it stays above other articles but below speed control */
            padding: 20px 25px; /* Adjust padding */
            animation: pulse-pin 2s infinite ease-in-out; /* Subtle animation */
        }

        @keyframes pulse-pin {
            0% { transform: scale(1); box-shadow: var(--shadow-md); }
            50% { transform: scale(1.01); box-shadow: var(--shadow-lg); }
            100% { transform: scale(1); box-shadow: var(--shadow-md); }
        }

        .article-header.pinned-article:hover {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-hover) 100%);
            transform: scale(1.005); /* Slight scale on hover */
            box-shadow: var(--shadow-xl);
        }

        .article-content {
            padding: 40px; /* Always show padding when content is visible */
            font-size: 1.1em; /* Base font size for content */
            line-height: 1.8;
            color: var(--text-secondary); /* Secondary text color for content */
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .article-content a {
            text-decoration: none;
            color: var(--accent-color); /* Use accent color for links */
            font-weight: 500;
            transition: var(--transition);
        }

        .article-content a:hover {
            color: var(--primary-color); /* Primary color on link hover */
            text-decoration: underline;
        }

        /* Read Aloud Button - Modern Floating Design */
        .read-aloud-container {
            position: fixed;
            bottom: 35px; /* Adjusted to be closer to bottom */
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                       visibility 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                       transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
            visibility: visible;
        }

        .read-aloud-container.hidden {
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) translateY(20px);
        }

        .read-aloud-button {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .read-aloud-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: var(--transition);
        }

        .read-aloud-button:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: var(--shadow-xl);
        }

        .read-aloud-button:active {
            transform: translateY(-2px) scale(1.02);
        }

        .read-aloud-button.reading {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); /* Red for reading state */
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: var(--shadow-lg); }
            50% { box-shadow: var(--shadow-xl), 0 0 30px rgba(239, 68, 68, 0.4); }
        }

        .read-aloud-button.reading:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        /* Loading Animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            flex-direction: column;
            gap: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.1em;
            font-weight: 500;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* --- NEW: Pagination Styles --- */
        #pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0 40px 0;
        }
        .pagination {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            justify-content: center;
        }
        .pagination li a {
            display: block;
            padding: 10px 18px;
            text-decoration: none;
            color: var(--text-secondary);
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            transition: var(--transition);
            font-weight: 600;
        }
        .pagination li a:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            transform: translateY(-2px);
        }
        .pagination li.active a {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
            cursor: default;
        }
        .pagination li.disabled a {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--card-bg);
            color: var(--text-muted);
        }
        .pagination li.disabled a:hover {
            transform: none;
        }


        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            body {
                padding-top: 80px;
            }

            .speed-control-container {
                padding: 15px 20px;
                gap: 15px;
            }

            .speed-slider-wrapper {
                left: 10px;
                padding: 10px 8px;
            }

            .speed-slider {
                height: 150px;
            }

            .content-container {
                padding: 20px;
            }

            .article-header {
                font-size: 0.9em; /* Slightly smaller for mobile */
                padding: 20px;
            }
            .article-header.pinned-article {
                top: 80px; /* Adjust pinned header position for mobile */
                font-size: 1em;
                padding: 18px 20px;
            }

            .article-content {
                padding: 30px;
                font-size: 1em;
            }

            .read-aloud-button {
                padding: 14px 28px;
                font-size: 1em;
            }

            .home-button {
                padding: 8px 16px;
                font-size: 0.9em;
            }

            /* --- NEW: Mobile Pagination Styles --- */
            .pagination li a {
                padding: 8px 14px;
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            body {
                padding-top: 70px;
            }

            .speed-control-container {
                padding: 12px 15px;
                gap: 12px;
            }

            .speed-slider-wrapper {
                left: 5px;
                padding: 8px 5px;
            }

            .speed-slider {
                height: 100px;
            }

            .speed-label, .speed-value-display {
                font-size: 0.95em;
            }

            .content-container {
                padding: 15px;
            }

            .article-header {
                font-size: 0.85em; /* Even smaller for very small screens */
                padding: 18px;
            }
            .article-header.pinned-article {
                top: 70px; /* Adjust pinned header position for small mobile */
                font-size: 0.95em;
                padding: 15px 18px;
            }

            .article-content {
                padding: 25px;
                font-size: 0.95em;
            }

            .read-aloud-button {
                padding: 12px 24px;
                font-size: 0.9em;
            }

            .home-button {
                padding: 6px 12px;
                font-size: 0.85em;
            }

            /* --- NEW: Small Mobile Pagination Styles --- */
            .pagination li a {
                padding: 6px 12px;
                font-size: 0.85em;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles for accessibility */
        .article-header:focus,
        .read-aloud-button:focus,
        .speed-slider:focus,
        .home-button:focus {
            outline: 2px solid var(--accent-color); /* Highlight with accent color */
            outline-offset: 3px;
        }
    </style>
</head>
<body>
    <div class="speed-control-container">
        <a href="?" id="homeButton" class="home-button" aria-label="返回首页">首页</a>
        <button id="toggleSpeedSliderButton" class="home-button" aria-label="切换语速控制条">语速</button>
    </div>

    <div class="speed-slider-wrapper" id="speedSliderWrapper">
        <span class="speed-label"></span>
        <input type="range" id="speedRange" class="speed-slider" min="-50" max="50" value="-20" aria-label="调整语速">
        <span id="currentSpeedValue" class="speed-value-display">-20</span>
    </div>

    <div class="read-aloud-container" id="readAloudContainer">
        <button id="readAloudButton" class="read-aloud-button" aria-label="朗读或暂停朗读">朗读页面</button>
    </div>

    <div class="content-container" id="articles-container">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p class="loading-text">加载中...</p>
        </div>
    </div>

    <div id="pagination-container"></div>


    <script>
        // --- Configuration ---
        const ttsDomains = [
            'https://ms-ra-forwarder-for-ifreetime-beta-two.vercel.app/',
        ];
        let summaryVoice = 'en-US-EricNeural'; // Force using en-US-EricNeural
        const itemsPerPage = 10; // Number of articles per page
        // Define the pinned article URL
        const pinnedArticleUrl = 'https://moodhappy.github.io/moodHappy.gitHub.io-nce/style/Texttohtml.html';
        // Define the title for the pinned article
        const pinnedArticleTitle = '置顶文章';


        // Global variables for audio control
        let currentAudio = null;
        let isReading = false;
        let isPaused = false;
        let currentTextToSpeak = ''; // Stores the text of the *currently playing* article
        let currentSpeed = -20;
        let currentPosition = 0;
        let currentArticleIndex = -1; // To track which article is being read
        let allArticles = []; // To store all parsed articles

        // --- Summary Functions ---
        function playSummaryTTS(textToSpeak, fromCurrentPosition = false) {
            if (!textToSpeak || textToSpeak.trim() === '') {
                console.warn('Text to speak is empty.');
                return;
            }

            if (currentAudio && !currentAudio.paused && !currentAudio.ended) { // Check if audio is actively playing
                currentAudio.pause();
                currentAudio = null;
            }

            currentTextToSpeak = textToSpeak;

            const trimmedText = textToSpeak.trim();
            let finaltextToSpeak = trimmedText;
            // Removed HTML tags from the final text sent to TTS
            finaltextToSpeak = finaltextToSpeak.replace(/<[^>]*>/g, '');

            if (trimmedText.length >= 3 && trimmedText.substring(0, 3).toUpperCase() === 'URL') {
                finaltextToSpeak = trimmedText.substring(3);
                console.log('Detected "URL" at the beginning, reading from:', finaltextToSpeak);
            }

            const queryString = new URLSearchParams({
                text: finaltextToSpeak,
                voiceName: summaryVoice,
                speed: currentSpeed,
            }).toString();

            currentAudio = new Audio();
            let played = false;

            for (const url of ttsDomains) {
                const ttsUrl = `${url}api/aiyue?${queryString}`;
                console.log('Attempting to play TTS from:', ttsUrl);

                currentAudio.src = ttsUrl;

                if (fromCurrentPosition && currentPosition > 0) {
                    currentAudio.currentTime = currentPosition;
                } else {
                    currentPosition = 0;
                }

                currentAudio.play()
                    .then(() => {
                        console.log('TTS started playing successfully from:', ttsUrl);
                        played = true;
                        isReading = true;
                        isPaused = false;
                        updateButtonState();
                    })
                    .catch(e => {
                        console.error('Error playing TTS from ' + ttsUrl + ':', e);
                        // Try next domain if available, or handle error
                    });

                if (played) break;
            }

            if (currentAudio) {
                currentAudio.addEventListener('ended', function() {
                    isReading = false;
                    isPaused = false;
                    currentPosition = 0;
                    currentArticleIndex = -1; // Reset article index when done
                    updateButtonState();
                });

                currentAudio.addEventListener('error', function(e) {
                    console.error('Audio playback error:', e);
                    isReading = false;
                    isPaused = false;
                    currentPosition = 0;
                    currentArticleIndex = -1; // Reset article index on error
                    updateButtonState();
                    // Optionally show an error message to the user
                });

                currentAudio.addEventListener('timeupdate', function() {
                    if (!currentAudio.paused) {
                        currentPosition = currentAudio.currentTime;
                    }
                });
            }
        }

        function pauseTTS() {
            if (currentAudio && !currentAudio.paused) {
                currentPosition = currentAudio.currentTime;
                currentAudio.pause();
                isPaused = true;
                isReading = false;
                updateButtonState();
            }
        }

        function resumeTTS() {
            if (currentAudio && isPaused) {
                currentAudio.play()
                    .then(() => {
                        isReading = true;
                        isPaused = false;
                        updateButtonState();
                    })
                    .catch(e => {
                        console.error('Error resuming TTS:', e);
                        // If resume fails, restart the specific article from beginning
                        if (currentArticleIndex !== -1 && allArticles[currentArticleIndex]) {
                            // Fetch the innerText of the article content div directly
                            const articleContentDiv = document.getElementById(`article-content-${currentArticleIndex}`);
                            if (articleContentDiv) {
                                playSummaryTTS(articleContentDiv.innerText);
                            }
                        } else {
                            // If no specific article, try to get the first one if available
                            if (allArticles.length > 0) {
                                const articleContentDiv = document.getElementById(`article-content-0`);
                                if (articleContentDiv) {
                                    playSummaryTTS(articleContentDiv.innerText);
                                }
                            }
                        }
                    });
            } else if (!currentAudio || currentAudio.ended) {
                // If no audio or audio ended, start reading from the current active article or first one
                currentPosition = 0;
                let articleToReadIndex = currentArticleIndex !== -1 ? currentArticleIndex : 0;

                if (allArticles[articleToReadIndex]) {
                    const articleContentDiv = document.getElementById(`article-content-${articleToReadIndex}`);
                    if (articleContentDiv) {
                        currentArticleIndex = articleToReadIndex; // Ensure it's set
                        playSummaryTTS(articleContentDiv.innerText);
                    }
                } else {
                    console.warn("No articles found to read or active article not found.");
                }
            }
        }

        function restartTTSWithNewSpeed() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            currentPosition = 0; // Always restart from the beginning when speed changes

            // If an article was being read, restart that specific article
            if (currentArticleIndex !== -1 && allArticles[currentArticleIndex] && (isReading || isPaused)) {
                const articleContentDiv = document.getElementById(`article-content-${currentArticleIndex}`);
                if (articleContentDiv) {
                    playSummaryTTS(articleContentDiv.innerText);
                }
            } else {
                // If no specific article was being read, reset state
                isReading = false;
                isPaused = false;
                updateButtonState();
            }
        }

        function updateButtonState() {
            const readAloudButton = document.getElementById('readAloudButton');
            if (isReading) {
                readAloudButton.textContent = '暂停朗读';
                readAloudButton.classList.add('reading');
                readAloudButton.setAttribute('aria-label', '暂停朗读');
            } else if (isPaused) {
                readAloudButton.textContent = '继续朗读';
                readAloudButton.classList.remove('reading');
                readAloudButton.setAttribute('aria-label', '继续朗读');
            } else {
                readAloudButton.textContent = '朗读页面';
                readAloudButton.classList.remove('reading');
                readAloudButton.setAttribute('aria-label', '朗读页面');
            }
        }

        function generateRandomHash() {
            return (Math.random().toString(36).substring(2, 10) + Date.now().toString(36)).toUpperCase();
        }

        function updateUrlWithHash() {
            const currentUrl = new URL(window.location.href);
            const newHash = generateRandomHash();
            // Only add hash if not already present or if we are on the main page (no articleId)
            if (!currentUrl.searchParams.has('hash') || !currentUrl.searchParams.has('articleId')) {
                currentUrl.searchParams.set('hash', newHash);
            }
            window.history.replaceState({}, '', currentUrl.toString());
            console.log("URL updated with new hash:", currentUrl.toString());
        }

        // --- NEW: Function to render pagination controls ---
        function renderPagination(totalPages, currentPage) {
            const paginationContainer = document.getElementById('pagination-container');
            paginationContainer.innerHTML = ''; // Clear old pagination

            if (totalPages <= 1) return; // Don't render if only one page

            const ul = document.createElement('ul');
            ul.classList.add('pagination');

            // Previous button
            const prevLi = document.createElement('li');
            const prevA = document.createElement('a');
            prevA.href = `?page=${currentPage - 1}`;
            prevA.textContent = '« 上一页';
            if (currentPage === 1) {
                prevLi.classList.add('disabled');
                prevA.removeAttribute('href');
            }
            prevLi.appendChild(prevA);
            ul.appendChild(prevLi);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `?page=${i}`;
                a.textContent = i;
                if (i === currentPage) {
                    li.classList.add('active');
                    a.removeAttribute('href');
                }
                li.appendChild(a);
                ul.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            const nextA = document.createElement('a');
            nextA.href = `?page=${currentPage + 1}`;
            nextA.textContent = '下一页 »';
            if (currentPage === totalPages) {
                nextLi.classList.add('disabled');
                nextA.removeAttribute('href');
            }
            nextLi.appendChild(nextA);
            ul.appendChild(nextLi);

            paginationContainer.appendChild(ul);
        }

        // --- MODIFIED: Function to split content by "URL" and render articles ---
        function renderArticles(fullContent, articleIdToDisplay = null, currentPage = 1) {
            const articlesContainer = document.getElementById('articles-container');
            articlesContainer.innerHTML = ''; // Clear existing content
            document.getElementById('pagination-container').innerHTML = ''; // Clear pagination

            // Normalize line endings and trim the whole content
            fullContent = fullContent.replace(/\r\n/g, '\n').trim();

            const rawParts = fullContent.split(/(URL)/i);
            const processedArticles = [];
            let currentContent = '';

            for (let i = 0; i < rawParts.length; i++) {
                const part = rawParts[i];

                if (part.toUpperCase() === 'URL') {
                    if (currentContent.trim() !== '') {
                        processedArticles.push(currentContent.trim());
                    }
                    currentContent = 'URL';
                } else {
                    currentContent += part;
                }
            }

            if (currentContent.trim() !== '') {
                processedArticles.push(currentContent.trim());
            }

            allArticles = processedArticles.filter(article => {
                const textOnly = article.replace(/<\/?[^>]+(>|$)/g, '').trim();
                return textOnly !== '';
            });

            if (allArticles.length === 0) {
                articlesContainer.innerHTML = '<div class="article-section"><div class="article-content" style="text-align: center; color: var(--text-muted); padding: 40px;">没有内容可显示。</div></div>';
                document.title = '无内容 - 中转站';
                return;
            }

            // Always add the pinned article at the top
            const pinnedArticleSection = document.createElement('div');
            pinnedArticleSection.classList.add('article-section');
            const pinnedArticleHeaderLink = document.createElement('a');
            pinnedArticleHeaderLink.classList.add('article-header', 'pinned-article');
            // Set the text content to '置顶文章'
            pinnedArticleHeaderLink.textContent = pinnedArticleTitle;
            pinnedArticleHeaderLink.href = pinnedArticleUrl;
            pinnedArticleHeaderLink.target = '_blank'; // Open in new tab
            pinnedArticleHeaderLink.rel = 'noopener noreferrer'; // Security best practice
            pinnedArticleSection.appendChild(pinnedArticleHeaderLink);
            articlesContainer.appendChild(pinnedArticleSection);


            // Determine which articles to render
            if (articleIdToDisplay !== null && !isNaN(articleIdToDisplay) && allArticles[articleIdToDisplay]) {
                // SINGLE ARTICLE VIEW (no pagination)
                const articleText = allArticles[articleIdToDisplay];
                currentArticleIndex = articleIdToDisplay; // Set the current reading index

                const articleSection = document.createElement('div');
                articleSection.classList.add('article-section');

                const articleContent = document.createElement('div');
                articleContent.classList.add('article-content');
                articleContent.id = `article-content-${articleIdToDisplay}`; // Unique ID
                articleContent.innerHTML = articleText;

                articleSection.appendChild(articleContent);
                articlesContainer.appendChild(articleSection);

                // Set main document title to the displayed article's title
                let cleanedArticleText = articleText.replace(/<\/?[^>]+(>|$)/g, "").trim();
                let mainTitleDisplay = cleanedArticleText;
                if (mainTitleDisplay.length >= 3 && mainTitleDisplay.substring(0, 3).toUpperCase() === 'URL') {
                    mainTitleDisplay = mainTitleDisplay.substring(3).trim();
                }
                const firstSentenceMatch = mainTitleDisplay.match(/^.*?[.?!。？！\n]/);
                if (firstSentenceMatch && firstSentenceMatch[0].trim() !== '') {
                    let mainTitle = firstSentenceMatch[0].trim();
                    if (mainTitle.length > 70) {
                        mainTitle = mainTitle.substring(0, 67) + '...';
                    }
                    document.title = mainTitle;
                } else if (mainTitleDisplay.length > 0) {
                    let mainTitle = mainTitleDisplay.substring(0, Math.min(mainTitleDisplay.length, 70)).trim();
                    if (mainTitleDisplay.length > 70) {
                         mainTitle += '...';
                    }
                    document.title = mainTitle;
                } else {
                    document.title = `文章 ${articleIdToDisplay + 1} - 中转站`;
                }

            } else { // PAGINATED LIST VIEW
                document.title = `新闻列表 (第 ${currentPage} 页) - 中转站`;

                const totalPages = Math.ceil(allArticles.length / itemsPerPage);
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedArticles = allArticles.slice(startIndex, endIndex);

                paginatedArticles.forEach((articleText, index) => {
                    const originalIndex = startIndex + index; // Get the index from the original allArticles array

                    let cleanedTextForTitle = articleText.replace(/<\/?[^>]+(>|$)/g, "").trim();

                    let displayTitleText = cleanedTextForTitle;
                    if (displayTitleText.length >= 3 && displayTitleText.substring(0, 3).toUpperCase() === 'URL') {
                        displayTitleText = displayTitleText.substring(3).trim();
                    }

                    const firstSentenceMatch = displayTitleText.match(/^.*?[.?!。？！\n]/);
                    let articleTitle = `文章 ${originalIndex + 1}`; // Default title using original index

                    if (firstSentenceMatch && firstSentenceMatch[0].trim() !== '') {
                        articleTitle = firstSentenceMatch[0].trim();
                        if (articleTitle.length > 70) {
                            articleTitle = articleTitle.substring(0, 67) + '...';
                        }
                    } else if (displayTitleText.length > 0) {
                        articleTitle = displayTitleText.substring(0, Math.min(displayTitleText.length, 70)).trim();
                        if (displayTitleText.length > 70) {
                             articleTitle += '...';
                        }
                    }

                    const articleSection = document.createElement('div');
                    articleSection.classList.add('article-section');

                    const articleHeaderLink = document.createElement('a');
                    articleHeaderLink.classList.add('article-header');
                    articleHeaderLink.textContent = articleTitle;
                    articleHeaderLink.href = `?articleId=${originalIndex}`; // Link to the specific article using original index
                    articleHeaderLink.dataset.articleIndex = originalIndex; // Store original index

                    articleSection.appendChild(articleHeaderLink);
                    articlesContainer.appendChild(articleSection);
                });

                // Render pagination controls
                renderPagination(totalPages, currentPage);
            }
            cleanAllTitles();
        }

        // --- Function to clean titles ---
        function cleanAllTitles() {
            const elementsWithTitles = document.querySelectorAll('.article-header, title');

            elementsWithTitles.forEach(element => {
                let originalText = element.textContent;

                if (originalText.startsWith('Title: "') && originalText.endsWith('"')) {
                    let newText = originalText.substring(8, originalText.length - 1);
                    element.textContent = newText;
                }
                if (element.tagName.toLowerCase() === 'title') {
                    // This specifically updates the browser tab title
                    document.title = element.textContent;
                }
            });
        }


        document.addEventListener('DOMContentLoaded', function() {
            const articlesContainer = document.getElementById('articles-container');
            const readAloudButton = document.getElementById('readAloudButton');
            const speedRange = document.getElementById('speedRange');
            const currentSpeedValueDisplay = document.getElementById('currentSpeedValue');
            const readAloudContainer = document.getElementById('readAloudContainer');
            const speedSliderWrapper = document.getElementById('speedSliderWrapper');
            const homeButton = document.getElementById('homeButton');
            const toggleSpeedSliderButton = document.getElementById('toggleSpeedSliderButton'); // 获取新增的语速按钮
            const contentUrl = 'https://raw.githubusercontent.com/moodHappy/HelloWorld/refs/heads/master/Notes/B1_copy.md';

            // Don't add hash on initial load to keep URL clean for pagination
            // updateUrlWithHash(); 

            currentSpeedValueDisplay.textContent = speedRange.value;
            currentSpeed = parseInt(speedRange.value);

            speedRange.addEventListener('input', function() {
                currentSpeedValueDisplay.textContent = this.value;
            });

            speedRange.addEventListener('change', function() {
                currentSpeed = parseInt(this.value);
                restartTTSWithNewSpeed();
            });

            let lastScrollTop = 0;
            window.addEventListener('scroll', function() {
                let st = window.pageYOffset || document.documentElement.scrollTop;
                if (st > lastScrollTop) {
                    readAloudContainer.classList.add('hidden');
                } else {
                    readAloudContainer.classList.remove('hidden');
                }
                lastScrollTop = st <= 0 ? 0 : st;
            }, false);

            // Home button functionality
            homeButton.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent default link behavior
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.delete('articleId'); // Remove articleId
                currentUrl.searchParams.set('page', '1'); // Go to page 1
                window.location.href = currentUrl.pathname + currentUrl.search;
            });

            // Toggle Speed Slider button functionality
            toggleSpeedSliderButton.addEventListener('click', function() {
                speedSliderWrapper.classList.toggle('visible'); // 切换可见性
                if (speedSliderWrapper.classList.contains('visible')) {
                    speedRange.focus(); // 聚焦滑动条
                }
            });

            const loadContent = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const articleIdFromUrl = urlParams.get('articleId');
                const pageFromUrl = urlParams.get('page');

                let initialArticleId = null;
                if (articleIdFromUrl !== null) {
                    const parsedId = parseInt(articleIdFromUrl, 10);
                    if (!isNaN(parsedId)) {
                        initialArticleId = parsedId;
                    }
                }

                let currentPage = 1;
                if (pageFromUrl !== null) {
                    const parsedPage = parseInt(pageFromUrl, 10);
                    if (!isNaN(parsedPage) && parsedPage > 0) {
                        currentPage = parsedPage;
                    }
                }

                fetch(contentUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(data => {
                        // Pass current page to renderArticles
                        renderArticles(data, initialArticleId, currentPage);
                        // If an article is being displayed directly, scroll to top
                        if (initialArticleId !== null) {
                            window.scrollTo(0, 0);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching content:', error);
                        articlesContainer.innerHTML = '<div class="article-section"><div class="article-content" style="text-align: center; color: var(--text-muted); padding: 40px;">无法加载内容。请检查网络或链接。</div></div>';
                        document.title = '加载失败 - 中转站';
                    });
            };

            loadContent(); // Initial content load

            readAloudButton.addEventListener('click', function() {
                if (isReading) {
                    pauseTTS();
                } else if (isPaused) {
                    resumeTTS();
                } else {
                    // Determine which article to read
                    let articleToRead = null;
                    // If a specific article is currently being viewed, read that one
                    if (currentArticleIndex !== -1 && document.getElementById(`article-content-${currentArticleIndex}`)) {
                        articleToRead = document.getElementById(`article-content-${currentArticleIndex}`);
                    } else {
                        // If on the main listing page, read the pinned article's title
                        const pinnedArticleLink = document.querySelector('.article-header.pinned-article');
                        if (pinnedArticleLink) {
                            // Read the *text content* of the pinned article header, not its href
                            playSummaryTTS(pinnedArticleLink.textContent);
                            return; // Stop here as the pinned link is read
                        }
                        // If no pinned article or pinned article already read, read the first regular article
                        if (allArticles.length > 0) {
                            currentArticleIndex = 0;
                            articleToRead = document.getElementById(`article-content-0`);
                            // If on the main page and clicking read, navigate to the first article
                            if (window.location.search.indexOf('articleId=') === -1) {
                                const newUrl = new URL(window.location.href);
                                newUrl.searchParams.set('articleId', currentArticleIndex);
                                newUrl.searchParams.delete('page'); // remove page param when viewing single article
                                window.location.href = newUrl.toString();
                                return; // Exit to prevent immediate TTS before re-render
                            }
                        }
                    }

                    if (articleToRead) {
                        playSummaryTTS(articleToRead.innerText);
                    } else {
                        console.warn("No articles found to read on button click.");
                    }
                }
            });

            // Handle browser back/forward buttons to reload content based on URL
            window.addEventListener('popstate', function(event) {
                // When popstate occurs, reload content based on the new URL
                loadContent();
                // Stop TTS on navigation change
                if (currentAudio && (isReading || isPaused)) {
                    pauseTTS();
                }
            });
        });
    </script>
</body>
</html>
