<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中转站 - AI 增强版</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif SC', 'Inter', serif;
            line-height: 1.75;
            color: #2c2c2c;
            background: linear-gradient(135deg, #f8f4f0 0%, #e8e4e0 25%, #f2ede8 50%, #ebe6e1 75%, #f5f1ec 100%);
            background-attachment: fixed;
            padding-top: 90px;
            position: relative;
            overflow-x: hidden;
        }

        /* 背景纹理 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(198, 167, 130, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(158, 125, 95, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(178, 145, 118, 0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* --- 顶部控制栏 --- */
        .speed-control-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, rgba(248, 244, 240, 0.95) 0%, rgba(242, 237, 232, 0.95) 50%, rgba(235, 230, 225, 0.95) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 20px 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center; /* 居中 */
            gap: 25px;
            border-bottom: 1px solid rgba(198, 167, 130, 0.15);
        }

        /* 设置按钮样式 */
        .settings-toggle {
            position: absolute;
            right: 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: #6b5b4f;
            transition: transform 0.3s ease, color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-toggle:hover {
            color: #8b7355;
            transform: rotate(90deg);
        }

        .settings-toggle svg {
            width: 28px;
            height: 28px;
        }

        .speed-label {
            font-size: 1.15em;
            font-weight: 500;
            color: #6b5b4f;
            white-space: nowrap;
            font-family: 'Inter', sans-serif;
        }

        .speed-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            background: linear-gradient(90deg, #d4c4b0 0%, #c6a782 50%, #9e7d5f 100%);
            border-radius: 25px;
            cursor: pointer;
            width: 220px;
            max-width: 50%;
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #a68b6b;
            border-radius: 50%;
            cursor: grab;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .speed-value-display {
            font-weight: 600;
            color: #8b7355;
            min-width: 35px;
            text-align: center;
        }

        /* --- 朗读按钮 --- */
        .read-aloud-container {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .read-aloud-container.hidden {
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) translateY(20px);
        }

        .read-aloud-button {
            background: linear-gradient(135deg, #8b7355 0%, #a68b6b 100%);
            color: #f8f4f0;
            padding: 16px 32px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(139, 115, 85, 0.3);
            font-family: 'Noto Serif SC', serif;
            letter-spacing: 1px;
            transition: transform 0.2s;
        }

        .read-aloud-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(139, 115, 85, 0.4);
        }

        .read-aloud-button.reading {
            background: linear-gradient(135deg, #a0522d 0%, #cd853f 100%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 8px 24px rgba(160, 82, 45, 0.3); }
            50% { box-shadow: 0 12px 32px rgba(160, 82, 45, 0.5); }
        }

        /* --- 内容区域 --- */
        .content-container {
            max-width: 850px;
            margin: 0 auto;
            padding: 40px 30px;
            position: relative;
        }

        .content-container::before {
            content: '';
            position: absolute;
            top: 20px; left: 15px; right: 15px; bottom: 20px;
            background: rgba(248, 244, 240, 0.85);
            border-radius: 25px;
            z-index: -1;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.05);
        }

        .text-placeholder {
            min-height: 400px;
            padding: 50px 45px;
            font-size: 1.45em;
            line-height: 1.8;
            color: #2c2c2c;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Noto Serif SC', serif;
        }

        /* --- AI 按钮样式 --- */
        .ai-analyze-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(139, 115, 85, 0.1);
            border: 1px solid rgba(139, 115, 85, 0.2);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            margin-left: 4px;
            margin-right: 4px;
            cursor: pointer;
            vertical-align: middle;
            transition: all 0.2s ease;
            color: #8b7355;
            font-size: 12px;
            position: relative;
            top: -2px;
        }

        .ai-analyze-btn:hover {
            background-color: #8b7355;
            color: white;
            transform: scale(1.1);
        }

        .ai-analyze-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* --- 模态框通用样式 --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 44, 44, 0.4);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-card {
            background: #fcfbf9;
            width: 90%;
            max-width: 600px;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 30px;
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(139, 115, 85, 0.2);
        }

        .modal-overlay.active .modal-card {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 1.3em;
            color: #6b5b4f;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }

        .modal-close:hover { color: #555; }

        /* --- 设置面板样式 --- */
        .settings-group { margin-bottom: 20px; }
        .settings-label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; font-size: 0.95em; }
        .settings-input, .settings-select, .settings-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            background: #fff;
            transition: border-color 0.2s;
        }
        .settings-input:focus, .settings-textarea:focus {
            outline: none;
            border-color: #8b7355;
            box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
        }
        .settings-textarea { min-height: 80px; resize: vertical; }
        .save-btn {
            width: 100%;
            padding: 12px;
            background: #8b7355;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
        }
        .save-btn:hover { background: #6b5b4f; }

        /* --- AI 结果样式 --- */
        .ai-result-content {
            font-family: 'Noto Serif SC', serif;
            line-height: 1.8;
            color: #333;
            font-size: 1.05em;
        }
        .ai-result-content p { margin-bottom: 1em; }
        .ai-result-content strong { color: #8b7355; }
        .ai-loading { text-align: center; color: #8b7355; padding: 20px; }
        .original-sentence {
            background: rgba(139, 115, 85, 0.08);
            padding: 10px 15px;
            border-left: 3px solid #8b7355;
            margin-bottom: 20px;
            font-style: italic;
            color: #555;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .speed-control-container { padding: 15px 20px; justify-content: space-between; }
            .speed-slider { width: 120px; }
            .settings-toggle { position: static; }
            .content-container { padding: 25px 20px; }
            .text-placeholder { padding: 35px 25px; font-size: 1.25em; }
        }
    </style>
</head>
<body>
    <div class="speed-control-container">
        <div style="display:flex; align-items:center; gap:15px;">
            <span class="speed-label">语速</span>
            <input type="range" id="speedRange" class="speed-slider" min="-50" max="50" value="-20">
            <span id="currentSpeedValue" class="speed-value-display">-20</span>
        </div>
        
        <button id="settingsBtn" class="settings-toggle" title="AI 配置">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
            </svg>
        </button>
    </div>

    <div class="read-aloud-container" id="readAloudContainer">
        <button id="readAloudButton" class="read-aloud-button">朗读页面</button>
    </div>

    <div class="content-container">
        <div id="dynamic-content" class="text-placeholder">
            加载中...
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h3 class="modal-title">AI 配置</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="settings-group">
                <label class="settings-label">GROQ API Key</label>
                <input type="password" id="apiKeyInput" class="settings-input" placeholder="gsk_...">
            </div>
            <div class="settings-group">
                <label class="settings-label">选择模型</label>
                <select id="modelSelect" class="settings-select">
                    <option value="meta-llama/llama-4-maverick-17b-128e-instruct">Llama 4 Maverick (17b)</option>
                    <option value="llama-3.3-70b-versatile">Llama 3.3 Versatile (70b)</option>
                </select>
            </div>
            <div class="settings-group">
                <label class="settings-label">系统指令 (System Prompt)</label>
                <textarea id="systemPromptInput" class="settings-textarea" placeholder="例如：翻译这句话并解释其中的语法难点。"></textarea>
            </div>
            <button id="saveSettingsBtn" class="save-btn">保存设置</button>
        </div>
    </div>

    <div id="aiResultModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h3 class="modal-title">AI 分析</h3>
                <button class="modal-close" onclick="closeModal('aiResultModal')">&times;</button>
            </div>
            <div class="original-sentence" id="aiOriginalSentence"></div>
            <div id="aiResultContent" class="ai-result-content">
                </div>
        </div>
    </div>

    <script>
        // --- 全局变量与 TTS 配置 ---
        const ttsDomains = ['https://ms-ra-forwarder-for-ifreetime-2.vercel.app/'];
        let summaryVoice = 'en-US-EricNeural';
        let currentAudio = null;
        let isReading = false;
        let isPaused = false;
        let currentTextToSpeak = '';
        let currentSpeed = -20;
        let currentPosition = 0;

        // --- AI 配置默认值 ---
        const DEFAULT_PROMPT = "Explain the grammar and meaning of the following sentence in simple Chinese.";
        const API_URL = "https://api.groq.com/openai/v1/chat/completions";

        // --- TTS 功能 ---
        function playSummaryTTS(textToSpeak, fromCurrentPosition = false) {
            if (!textToSpeak || textToSpeak.trim() === '') return;

            if (currentAudio && currentAudio.played) {
                currentAudio.pause();
                currentAudio = null;
            }

            currentTextToSpeak = textToSpeak;
            const trimmedText = textToSpeak.trim();
            let finaltextToSpeak = trimmedText;
            
            // 简单处理 URL 开头的文本
            if (trimmedText.length >= 3 && trimmedText.substring(0, 3).toUpperCase() === 'URL') {
                finaltextToSpeak = trimmedText.substring(3);
            }

            const queryString = new URLSearchParams({
                text: finaltextToSpeak,
                voiceName: summaryVoice,
                speed: currentSpeed,
            }).toString();

            currentAudio = new Audio();
            let played = false;

            for (const url of ttsDomains) {
                const ttsUrl = `${url}api/aiyue?${queryString}`;
                currentAudio.src = ttsUrl;

                if (fromCurrentPosition && currentPosition > 0) {
                    currentAudio.currentTime = currentPosition;
                } else {
                    currentPosition = 0;
                }

                currentAudio.play()
                    .then(() => {
                        played = true;
                        isReading = true;
                        isPaused = false;
                        updateButtonState();
                    })
                    .catch(e => console.error('TTS Play Error:', e));
                if (played) break;
            }

            if (currentAudio) {
                currentAudio.addEventListener('ended', () => {
                    isReading = false;
                    isPaused = false;
                    currentPosition = 0;
                    updateButtonState();
                });
                currentAudio.addEventListener('timeupdate', () => {
                    if (!currentAudio.paused) currentPosition = currentAudio.currentTime;
                });
            }
        }

        function pauseTTS() {
            if (currentAudio && !currentAudio.paused) {
                currentPosition = currentAudio.currentTime;
                currentAudio.pause();
                isPaused = true;
                isReading = false;
                updateButtonState();
            }
        }

        function resumeTTS() {
            if (currentAudio && isPaused) {
                currentAudio.play().then(() => {
                    isReading = true;
                    isPaused = false;
                    updateButtonState();
                });
            } else {
                startReadingPage();
            }
        }

        function restartTTSWithNewSpeed() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            if (isReading || isPaused) {
                startReadingPage(currentPosition > 0);
            }
        }

        // 专门用于获取纯净文本（去除 AI 按钮文本）
        function getCleanTextForTTS() {
            const contentDiv = document.getElementById('dynamic-content');
            // 克隆节点以避免修改页面显示
            const clone = contentDiv.cloneNode(true);
            // 移除所有 AI 按钮
            const buttons = clone.querySelectorAll('.ai-analyze-btn');
            buttons.forEach(btn => btn.remove());
            return clone.innerText;
        }

        function startReadingPage(resume = false) {
            const textToRead = getCleanTextForTTS();
            playSummaryTTS(textToRead, resume);
        }

        function updateButtonState() {
            const btn = document.getElementById('readAloudButton');
            if (isReading) {
                btn.textContent = '暂停朗读';
                btn.classList.add('reading');
            } else if (isPaused) {
                btn.textContent = '继续朗读';
                btn.classList.remove('reading');
            } else {
                btn.textContent = '朗读页面';
                btn.classList.remove('reading');
            }
        }

        // --- 内容处理与 AI 按钮注入 ---
        function injectAIButtons() {
            const container = document.getElementById('dynamic-content');
            // 使用 TreeWalker 遍历所有文本节点
            const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
            
            const nodesToReplace = [];
            
            while(walker.nextNode()) {
                const node = walker.currentNode;
                // 简单的判断：如果文本包含点号 . (这里假设英文内容为主，如果是中文可以加 || node.nodeValue.includes('。'))
                if (node.nodeValue && node.nodeValue.includes('.')) {
                    nodesToReplace.push(node);
                }
            }

            nodesToReplace.forEach(node => {
                const text = node.nodeValue;
                // 按 . 分割，保留 .
                const parts = text.split(/(\.)/);
                
                if (parts.length > 1) {
                    const fragment = document.createDocumentFragment();
                    let bufferSentence = ""; // 用于构建当前句子

                    for (let i = 0; i < parts.length; i++) {
                        const part = parts[i];
                        
                        // 插入文本
                        fragment.appendChild(document.createTextNode(part));
                        
                        // 如果是分隔符 '.'，且前面有内容，则插入按钮
                        if (part === '.') {
                            // 此时 bufferSentence 存储的是点号之前的内容
                            // 但我们需要向上回溯完整的句子比较困难，这里简化处理：
                            // 实际上 split 后，parts[i-1] 就是点号前的那段文本。
                            // 但为了获取完整句子（可能跨越了节点），这里采用简单策略：
                            // 将当前段落作为上下文，或者只取点号前最近的一段文本。
                            // 优化策略：在点击时动态获取该按钮前的文本。
                            
                            const btn = document.createElement('span');
                            btn.className = 'ai-analyze-btn';
                            btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 15h-2v-2h2zm0-4h-2V7h2z"/></svg>`; // Info icon
                            btn.title = "AI 分析";
                            
                            // 绑定点击事件
                            // 为了获取准确的上下文，我们保存这个按钮的引用
                            btn.onclick = (e) => handleAIAnalyzeClick(e.target);
                            
                            fragment.appendChild(btn);
                        }
                    }
                    node.parentNode.replaceChild(fragment, node);
                }
            });
        }

        // --- AI 交互逻辑 ---
        async function handleAIAnalyzeClick(target) {
            // 找到按钮元素（防止点击到 SVG 内部）
            const btn = target.closest('.ai-analyze-btn');
            if (!btn) return;

            // 1. 获取上下文（句子）
            // 简单的逻辑：获取该按钮之前的所有文本，直到遇到上一个点号或块级元素开始
            const sentence = extractSentenceBefore(btn);
            
            if (!sentence || sentence.length < 2) {
                alert("无法提取有效句子。");
                return;
            }

            // 2. 打开模态框显示加载中
            document.getElementById('aiOriginalSentence').textContent = sentence;
            const resultContainer = document.getElementById('aiResultContent');
            resultContainer.innerHTML = '<div class="ai-loading">正在思考中...</div>';
            openModal('aiResultModal');

            // 3. 调用 API
            try {
                const apiKey = localStorage.getItem('groq_api_key');
                if (!apiKey) {
                    resultContainer.innerHTML = '<p style="color:red; text-align:center;">请先点击右上角设置按钮配置 API Key。</p>';
                    return;
                }

                const model = localStorage.getItem('groq_model') || 'meta-llama/llama-4-maverick-17b-128e-instruct';
                const systemPrompt = localStorage.getItem('groq_prompt') || DEFAULT_PROMPT;

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `Analyze this sentence: "${sentence}"` }
                        ],
                        temperature: 0.7,
                        max_tokens: 1024
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || 'API 请求失败');
                }

                const data = await response.json();
                const content = data.choices[0]?.message?.content || "无内容返回";
                
                // 简单的 Markdown 转 HTML (换行处理)
                resultContainer.innerHTML = content.replace(/\n/g, '<br>');

            } catch (error) {
                resultContainer.innerHTML = `<p style="color:red;">发生错误: ${error.message}</p>`;
            }
        }

        // 提取按钮前的句子
        function extractSentenceBefore(btnNode) {
            let text = "";
            let currentNode = btnNode.previousSibling;
            
            // 向前遍历直到遇到另一个按钮或块级元素边界
            while (currentNode) {
                if (currentNode.nodeType === Node.TEXT_NODE) {
                    text = currentNode.nodeValue + text;
                    // 如果文本里包含了点号，说明跨越了上一句，截取最后一句
                    if (text.lastIndexOf('.') !== -1 && text.lastIndexOf('.') < text.length - 1) {
                         text = text.substring(text.lastIndexOf('.') + 1);
                         break;
                    }
                } else if (currentNode.classList && currentNode.classList.contains('ai-analyze-btn')) {
                    break; // 遇到上一个按钮停止
                } else {
                    // 如果是其他元素（如 span, b 等），提取其文本
                    text = currentNode.innerText + text;
                }
                currentNode = currentNode.previousSibling;
            }
            
            // 如果是在段落中间，可能还需要向前查找（这里简化处理，只看当前节点树）
            // 如果上面的循环没找到完整句子，可能需要向上层父级查找（逻辑较复杂，暂时只处理当前层级）
            
            return text.trim();
        }


        // --- UI 交互与设置 ---
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // 设置保存
        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            const key = document.getElementById('apiKeyInput').value.trim();
            const model = document.getElementById('modelSelect').value;
            const prompt = document.getElementById('systemPromptInput').value;

            if (key) localStorage.setItem('groq_api_key', key);
            localStorage.setItem('groq_model', model);
            localStorage.setItem('groq_prompt', prompt);

            closeModal('settingsModal');
            alert('设置已保存');
        });

        // 设置加载
        function loadSettings() {
            const key = localStorage.getItem('groq_api_key');
            const model = localStorage.getItem('groq_model');
            const prompt = localStorage.getItem('groq_prompt');

            if (key) document.getElementById('apiKeyInput').value = key;
            if (model) document.getElementById('modelSelect').value = model;
            if (prompt) document.getElementById('systemPromptInput').value = prompt;
            else document.getElementById('systemPromptInput').value = DEFAULT_PROMPT;
        }

        document.getElementById('settingsBtn').addEventListener('click', () => {
            loadSettings();
            openModal('settingsModal');
        });

        // 点击遮罩关闭
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeModal(overlay.id);
            });
        });


        // --- 初始化与加载 ---
        document.addEventListener('DOMContentLoaded', function() {
            const dynamicContentDiv = document.getElementById('dynamic-content');
            const readAloudButton = document.getElementById('readAloudButton');
            const speedRange = document.getElementById('speedRange');
            const currentSpeedValueDisplay = document.getElementById('currentSpeedValue');
            const readAloudContainer = document.getElementById('readAloudContainer');
            const contentUrl = 'https://raw.githubusercontent.com/moodHappy/HelloWorld/refs/heads/master/Notes/B1.md';

            // URL Hash Logic
            function generateRandomHash() {
                return (Math.random().toString(36).substring(2, 10) + Date.now().toString(36)).toUpperCase();
            }
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('hash', generateRandomHash());
            window.history.replaceState({}, '', currentUrl.toString());

            // Speed Control
            currentSpeedValueDisplay.textContent = speedRange.value;
            currentSpeed = parseInt(speedRange.value);
            speedRange.addEventListener('input', function() { currentSpeedValueDisplay.textContent = this.value; });
            speedRange.addEventListener('change', function() {
                currentSpeed = parseInt(this.value);
                restartTTSWithNewSpeed();
            });

            // Scroll Logic
            let lastScrollTop = 0;
            window.addEventListener('scroll', function() {
                let st = window.pageYOffset || document.documentElement.scrollTop;
                if (st > lastScrollTop) readAloudContainer.classList.add('hidden');
                else readAloudContainer.classList.remove('hidden');
                lastScrollTop = st <= 0 ? 0 : st;
            }, false);

            // Fetch Content
            fetch(contentUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.text();
                })
                .then(data => {
                    dynamicContentDiv.innerHTML = data;
                    
                    // 1. 设置标题
                    let cleanedText = data.replace(/<\/?[^>]+(>|$)/g, "").trim();
                    if (cleanedText.startsWith('URL')) cleanedText = cleanedText.substring(3).trim();
                    const firstSentenceMatch = cleanedText.match(/^.*?[.?!。？！\n]/);
                    document.title = firstSentenceMatch ? firstSentenceMatch[0].substring(0, 60) : "中转站";

                    // 2. 注入 AI 按钮 (关键修改)
                    injectAIButtons();

                })
                .catch(error => {
                    console.error('Error:', error);
                    dynamicContentDiv.innerText = '无法加载内容。请检查网络。';
                });

            // Read Button Logic
            readAloudButton.addEventListener('click', function() {
                if (isReading) pauseTTS();
                else if (isPaused) resumeTTS();
                else startReadingPage();
            });
        });
    </script>
</body>
</html>
