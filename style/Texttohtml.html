<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GitHub 同步助手 (AI 阅读版)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&family=Inter:wght@400;500;600&display=swap');

        :root {
            /* 核心色板 - 莫兰迪色系 */
            --primary-brown: #8b7355;
            --primary-light: rgba(139, 115, 85, 0.1);
            --text-main: #333333;
            --text-sub: #666666;
            --bg-page: #f9f9f9;
            --border-color: #e0e0e0;
            --dashed-line: 1px dashed #d0c4b4; /* 核心分割线颜色 */
            
            /* 标签颜色 */
            --badge-green-bg: #e6f4ea;
            --badge-green-text: #1e8e3e;
            --badge-orange-bg: #ffe0b2;
            --badge-orange-text: #e65100;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Serif SC', 'Inter', serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            padding: 20px;
            padding-top: 80px; /* 为导航栏留空 */
        }

        /* --- 导航栏 (复用逻辑) --- */
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .nav-brand { font-weight: 700; color: var(--primary-brown); font-size: 1.1em; }
        .nav-actions { display: flex; gap: 15px; align-items: center; }

        /* 按钮样式 */
        .icon-btn { 
            background: none; border: none; cursor: pointer; color: #666; 
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn svg { width: 22px; height: 22px; stroke: currentColor; stroke-width: 2; }
        
        /* 朗读按钮 */
        .read-btn {
            background: var(--primary-brown); color: white; border: none;
            padding: 6px 16px; border-radius: 20px; font-size: 0.9em;
            display: flex; align-items: center; gap: 5px; cursor: pointer;
        }
        .read-btn.reading { background: white; color: var(--primary-brown); border: 1px solid var(--primary-brown); }

        /* --- 主内容区 --- */
        .content-container { max-width: 800px; margin: 0 auto; }
        .text-placeholder { 
            font-size: 1.2em; line-height: 1.8; color: #222; min-height: 60vh; 
            white-space: pre-wrap;
        }

        /* --- AI 分析按钮 (魔法棒) --- */
        .ai-analyze-btn {
            display: inline-flex; vertical-align: middle;
            background: rgba(139, 115, 85, 0.1); 
            border-radius: 50%; width: 22px; height: 22px;
            align-items: center; justify-content: center;
            margin: 0 2px; cursor: pointer; color: var(--primary-brown);
            transition: all 0.2s;
        }
        .ai-analyze-btn:hover { background: var(--primary-brown); color: white; transform: scale(1.1); }
        .ai-analyze-btn svg { width: 12px; height: 12px; fill: currentColor; }
        .ai-analyze-btn.last-clicked {
            background-color: #d32f2f !important; color: white !important;
            box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2);
        }

        /* --- 弹窗基础结构 (Bottom Sheet 风格) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; align-items: flex-end; /* 底部对齐 */
            justify-content: center;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        
        .modal-card {
            background: #fff; width: 100%; max-width: 600px;
            height: 85vh; /* 占据大半屏 */
            border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* 弹窗头部 (固定) */
        .modal-header {
            padding: 20px 20px 10px;
            border-bottom: 1px solid #eee;
            background: #fff; border-radius: 20px 20px 0 0;
            flex-shrink: 0;
        }
        
        /* 顶部标题栏 */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-title { font-weight: 700; font-size: 1.1em; color: #333; display: flex; align-items: center; gap: 6px; }
        
        /* 原句展示框 (美化版) */
        .original-sentence {
            background: #f8f6f4;
            border-left: 4px solid var(--primary-brown);
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            color: #444; font-style: italic; font-size: 0.95em;
            line-height: 1.5;
            max-height: 100px; overflow-y: auto;
        }

        /* 弹窗滚动区域 */
        .modal-body {
            flex: 1; overflow-y: auto; padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        /* --- [核心] AI 分析结果美化 (Result Styling) --- */
        .ai-result { font-family: 'Inter', sans-serif; font-size: 15px; line-height: 1.7; color: #333; }

        /* 1. 标题带分割线 */
        .ai-result h1, .ai-result h2 {
            font-size: 1.1em; font-weight: 700; color: var(--primary-brown);
            margin-top: 25px; margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: var(--dashed-line); /* 虚线分割 */
        }
        .ai-result h1:first-child, .ai-result h2:first-child { margin-top: 0; }
        
        /* 2. 列表样式 */
        .ai-result ul, .ai-result ol { padding-left: 0; list-style: none; margin-bottom: 15px; }
        .ai-result li { margin-bottom: 10px; padding-left: 5px; }

        /* 3. 标签化 Badge (关键) */
        /* 针对 **释义**: 这种结构，将 strong 渲染为标签 */
        .ai-result li strong:first-child {
            display: inline-block;
            font-weight: 600; font-size: 0.85em;
            padding: 2px 8px; border-radius: 6px;
            margin-right: 6px; transform: translateY(-1px);
        }

        /* 绿色系标签 (释义/含义) */
        .ai-result li:nth-child(odd) strong:first-child {
            background-color: var(--badge-green-bg); color: var(--badge-green-text);
        }
        /* 橙色系标签 (例句/其他) */
        .ai-result li:nth-child(even) strong:first-child {
            background-color: var(--badge-orange-bg); color: var(--badge-orange-text);
        }

        /* 普通段落 */
        .ai-result p { margin-bottom: 10px; text-align: justify; }

        /* 三级标题 (单词本身) */
        .ai-result h3 { font-size: 1em; color: #2c3e50; margin: 15px 0 8px; font-weight: 700; }

        /* 加载状态 */
        .loading-state { text-align: center; color: #999; padding: 40px; }
        
        /* 动画 */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- 设置弹窗样式 (简化) --- */
        .settings-group { margin-bottom: 15px; }
        .settings-group label { display: block; margin-bottom: 5px; color: #666; font-size: 0.9em; }
        .settings-input, .settings-select, textarea {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 1em; background: #fff;
        }
        .btn-full { width: 100%; padding: 12px; background: var(--primary-brown); color: white; border: none; border-radius: 8px; font-size: 1em; font-weight: 500; margin-top: 10px; }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-brand">阅读助手</div>
        <div class="nav-actions">
            <button class="read-btn" id="readBtn" onclick="toggleRead()">
                <svg viewBox="0 0 24 24" fill="none"><path d="M11 5L6 9H2V15H6L11 19V5Z" fill="currentColor"/><path d="M19.07 4.93L17.66 6.34C18.78 7.46 19.5 9.01 19.5 10.74C19.5 12.47 18.78 14.02 17.66 15.14L19.07 16.55C20.57 15.05 21.5 12.99 21.5 10.74C21.5 8.49 20.57 6.43 19.07 4.93Z" fill="currentColor"/></svg>
                <span>朗读</span>
            </button>
            <button class="icon-btn" onclick="openModal('settingsModal')">
                <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="3" stroke="currentColor"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z" stroke="currentColor"/></svg>
            </button>
        </div>
    </nav>

    <div class="content-container">
        <div id="dynamic-content" class="text-placeholder">加载内容中...</div>
    </div>

    <div id="aiResultModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <div class="header-bar">
                    <div class="header-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:#8b7355"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 6v6l4 2"/></svg>
                        深度分析
                    </div>
                </div>
                <div id="aiOriginalSentence" class="original-sentence"></div>
            </div>
            <div id="aiResultContent" class="modal-body ai-result"></div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-card" style="height: auto; max-height: 80vh;">
            <div class="modal-header">
                <div class="header-bar">
                    <div class="header-title">设置</div>
                    <button class="icon-btn" onclick="closeModal('settingsModal')">✕</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <label>Github Token</label>
                    <input type="password" id="ghTokenInput" class="settings-input" placeholder="ghp_...">
                </div>
                <div class="settings-group">
                    <label>Groq API Key</label>
                    <input type="password" id="apiKeyInput" class="settings-input" placeholder="gsk_...">
                </div>
                <div class="settings-group">
                    <label>分析指令</label>
                    <textarea id="systemPromptInput" rows="4" class="settings-textarea"></textarea>
                </div>
                <button onclick="saveSettings()" class="btn-full">保存设置</button>
                <div style="text-align:center; margin-top:15px; color:#999; font-size:0.9em;" onclick="clearCache()">清空缓存</div>
            </div>
        </div>
    </div>

    <script>
        // --- 核心逻辑 ---
        const GH_CONFIG = { owner: 'moodHappy', repo: 'HelloWorld', path: 'Notes/B1.md' };
        const CACHE_PREFIX = 'ai_reader_v2_';
        
        // 默认指令 (适配新的 Badge 样式，要求 Markdown 列表结构清晰)
        const DEFAULT_PROMPT = `Analyze the sentence. Output in Markdown:
1. **难度等级**: [Level]
2. **中文翻译**: [Translation]
3. **关键短语**:
   - **Phrase 1**: [English Phrase]
     - **释义**: [Chinese Meaning]
     - **例句**: [English Example]
     - **例句翻译**: [Chinese Example Translation]`;

        let currentAudio = null;
        let isReading = false;

        // --- 初始化 ---
        window.onload = () => {
            document.getElementById('apiKeyInput').value = localStorage.getItem('groq_key') || '';
            document.getElementById('ghTokenInput').value = localStorage.getItem('gh_token') || '';
            document.getElementById('systemPromptInput').value = localStorage.getItem('sys_prompt') || DEFAULT_PROMPT;
            loadGitHubContent();
            
            // 弹窗点击外部关闭
            document.querySelectorAll('.modal-overlay').forEach(el => {
                el.onclick = (e) => { if(e.target === el) closeModal(el.id); };
            });
            // 弹窗内部双击关闭
            document.querySelectorAll('.modal-card').forEach(card => {
                card.ondblclick = (e) => {
                    if(!['INPUT','TEXTAREA'].includes(e.target.tagName)) closeModal(card.parentElement.id);
                };
            });
        };

        // --- GitHub 加载 ---
        async function loadGitHubContent() {
            const div = document.getElementById('dynamic-content');
            const token = localStorage.getItem('gh_token');
            const url = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.path}`;
            
            try {
                // 如果有 Token 用 API (防缓存)，没有则用 Raw (公开库)
                let text = "";
                if(token) {
                    const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await res.json();
                    text = decodeURIComponent(escape(atob(data.content)));
                } else {
                    const res = await fetch(`https://raw.githubusercontent.com/${GH_CONFIG.owner}/${GH_CONFIG.repo}/master/${GH_CONFIG.path}`);
                    text = await res.text();
                }
                
                div.innerHTML = text.replace(/\n/g, '<br>');
                injectAnalysisButtons(div);
            } catch(e) {
                div.innerHTML = "加载失败，请检查设置中的 GitHub Token 或网络连接。<br><br>" + e.message;
            }
        }

        // --- 注入魔法棒按钮 ---
        function injectAnalysisButtons(container) {
            const w = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
            const nodes = []; while(w.nextNode()) nodes.push(w.currentNode);
            
            nodes.forEach(n => {
                if(n.nodeValue.includes('.')) {
                    const fragment = document.createDocumentFragment();
                    n.nodeValue.split(/(\.)/).forEach(part => {
                        fragment.appendChild(document.createTextNode(part));
                        if(part === '.') {
                            const btn = document.createElement('span');
                            btn.className = 'ai-analyze-btn';
                            // 魔法棒 Icon
                            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M14.5 13.5L16.75 16.25L21 12L16.75 7.75L14.5 10.5V13.5ZM12.5 5.5L10.25 2.75L6 7L10.25 11.25L12.5 8.5V5.5ZM7 14L2 19L7 24L12 19L7 14Z"/></svg>';
                            btn.onclick = (e) => analyzeSentence(e.target);
                            fragment.appendChild(btn);
                        }
                    });
                    n.parentNode.replaceChild(fragment, n);
                }
            });
            
            // 恢复上次点击状态
            const lastIdx = localStorage.getItem('last_click_idx');
            if(lastIdx) {
                const btns = document.querySelectorAll('.ai-analyze-btn');
                if(btns[lastIdx]) btns[lastIdx].classList.add('last-clicked');
            }
        }

        // --- 提取句子 ---
        function getSentence(btn) {
            let text = "", node = btn.previousSibling;
            while(node) {
                if(node.nodeType === 3) {
                    text = node.nodeValue + text;
                    if(text.lastIndexOf('.') > -1 && text.lastIndexOf('.') < text.length-1) {
                        text = text.substring(text.lastIndexOf('.')+1);
                        break;
                    }
                } else if(node.classList?.contains('ai-analyze-btn')) break;
                else text = node.innerText + text;
                node = node.previousSibling;
            }
            return text.trim();
        }

        // --- 分析核心 ---
        async function analyzeSentence(target) {
            const btn = target.closest('.ai-analyze-btn');
            const allBtns = document.querySelectorAll('.ai-analyze-btn');
            allBtns.forEach(b => b.classList.remove('last-clicked'));
            btn.classList.add('last-clicked');
            localStorage.setItem('last_click_idx', Array.from(allBtns).indexOf(btn));

            const sentence = getSentence(btn);
            if(!sentence) return;

            // UI 更新
            document.getElementById('aiOriginalSentence').innerText = sentence;
            const contentBox = document.getElementById('aiResultContent');
            contentBox.innerHTML = '<div class="loading-state">✨ AI 正在思考中...</div>';
            openModal('aiResultModal');

            // 缓存与请求
            const sysPrompt = localStorage.getItem('sys_prompt') || DEFAULT_PROMPT;
            const cacheKey = CACHE_PREFIX + hashCode(sentence + sysPrompt);
            const cached = localStorage.getItem(cacheKey);

            if(cached) {
                contentBox.innerHTML = marked.parse(cached);
                return;
            }

            try {
                const apiKey = localStorage.getItem('groq_key');
                if(!apiKey) throw new Error("请先设置 Groq API Key");

                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: sysPrompt },
                            { role: "user", content: sentence }
                        ],
                        temperature: 0.3
                    })
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                
                const md = data.choices[0].message.content;
                localStorage.setItem(cacheKey, md);
                contentBox.innerHTML = marked.parse(md);

            } catch(e) {
                contentBox.innerHTML = `<div style="color:red; text-align:center;">错误: ${e.message}</div>`;
            }
        }

        // --- 辅助功能 ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function saveSettings() {
            localStorage.setItem('gh_token', document.getElementById('ghTokenInput').value);
            localStorage.setItem('groq_key', document.getElementById('apiKeyInput').value);
            localStorage.setItem('sys_prompt', document.getElementById('systemPromptInput').value);
            closeModal('settingsModal');
            alert("设置已保存");
            loadGitHubContent(); // 重新加载以应用新Token
        }

        function clearCache() {
            Object.keys(localStorage).forEach(k => k.startsWith(CACHE_PREFIX) && localStorage.removeItem(k));
            alert("缓存已清空");
        }

        function hashCode(s) {
            let h = 0;
            for(let i=0; i<s.length; i++) h = Math.imul(31, h) + s.charCodeAt(i) | 0;
            return h;
        }

        // 朗读 (简化版，直接调浏览器 TTS 兜底)
        function toggleRead() {
            if(isReading) {
                window.speechSynthesis.cancel();
                isReading = false;
                document.getElementById('readBtn').classList.remove('reading');
                document.getElementById('readBtn').querySelector('span').innerText = "朗读";
            } else {
                const text = document.getElementById('dynamic-content').innerText;
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US';
                u.onend = () => toggleRead();
                window.speechSynthesis.speak(u);
                isReading = true;
                document.getElementById('readBtn').classList.add('reading');
                document.getElementById('readBtn').querySelector('span').innerText = "停止";
            }
        }
    </script>
</body>
</html>