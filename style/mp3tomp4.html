<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3 è½¬ MP4 åœ¨çº¿è½¬æ¢å™¨ (çº¯å‰ç«¯)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { background-color: #f8f9fa; padding-top: 50px; }
        .container { max-width: 600px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #log { font-family: monospace; font-size: 0.9em; height: 150px; overflow-y: scroll; background: #222; color: #0f0; padding: 10px; border-radius: 5px; margin-top: 20px; display: none; }
        video { width: 100%; margin-top: 20px; border-radius: 5px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">ğŸµ MP3 è½¬ MP4 è½¬æ¢å™¨</h2>
    <p class="text-muted text-center">åœ¨æµè§ˆå™¨æœ¬åœ°è¿è¡Œï¼Œæ–‡ä»¶ä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚</p>
    
    <div class="mb-3">
        <label for="imageUpload" class="form-label">1. ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡ (JPG/PNG)</label>
        <input class="form-control" type="file" id="imageUpload" accept="image/*">
    </div>

    <div class="mb-3">
        <label for="audioUpload" class="form-label">2. ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ (MP3)</label>
        <input class="form-control" type="file" id="audioUpload" accept="audio/mp3">
    </div>

    <button id="convertBtn" class="btn btn-primary w-100" disabled>å¼€å§‹è½¬æ¢</button>

    <div id="status" class="mt-3 text-center text-primary fw-bold"></div>
    <div id="log"></div>

    <video id="outputVideo" controls></video>
    <a id="downloadLink" class="btn btn-success w-100 mt-3" style="display:none">ä¸‹è½½ MP4 è§†é¢‘</a>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    
    // åˆå§‹åŒ– ffmpeg å®ä¾‹ï¼Œå¼€å¯æ—¥å¿—
    const ffmpeg = createFFmpeg({ log: true });

    const imageInput = document.getElementById('imageUpload');
    const audioInput = document.getElementById('audioUpload');
    const convertBtn = document.getElementById('convertBtn');
    const statusText = document.getElementById('status');
    const logArea = document.getElementById('log');
    const videoPlayer = document.getElementById('outputVideo');
    const downloadLink = document.getElementById('downloadLink');

    // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†ä¸¤ä¸ªæ–‡ä»¶
    function checkInputs() {
        convertBtn.disabled = !(imageInput.files[0] && audioInput.files[0]);
    }
    imageInput.addEventListener('change', checkInputs);
    audioInput.addEventListener('change', checkInputs);

    // åŠ è½½ FFmpeg
    const loadFFmpeg = async () => {
        statusText.innerText = "æ­£åœ¨åŠ è½½æ ¸å¿ƒç»„ä»¶ (é¦–æ¬¡åŠ è½½å¯èƒ½è¾ƒæ…¢)...";
        if (!ffmpeg.isLoaded()) {
            await ffmpeg.load();
        }
        statusText.innerText = "";
    };

    // é¡µé¢åŠ è½½æ—¶é¢„åŠ è½½
    loadFFmpeg();

    convertBtn.addEventListener('click', async () => {
        const imageFile = imageInput.files[0];
        const audioFile = audioInput.files[0];

        if (!imageFile || !audioFile) return;

        // UI æ›´æ–°
        convertBtn.disabled = true;
        logArea.style.display = 'block';
        videoPlayer.style.display = 'none';
        downloadLink.style.display = 'none';
        statusText.innerText = "æ­£åœ¨è½¬æ¢ä¸­ï¼Œè¯·å‹¿å…³é—­é¡µé¢...";
        logArea.innerHTML = ''; // æ¸…ç©ºæ—¥å¿—

        // å°† FFmpeg æ—¥å¿—è¾“å‡ºåˆ°é¡µé¢
        ffmpeg.setLogger(({ type, message }) => {
            logArea.innerHTML += `<div>[${type}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        });

        try {
            // 1. å°†æ–‡ä»¶å†™å…¥ FFmpeg è™šæ‹Ÿå†…å­˜
            // å¯¹æ–‡ä»¶åè¿›è¡Œé‡å‘½åä»¥é¿å…ç‰¹æ®Šå­—ç¬¦å¯¼è‡´é”™è¯¯
            const imgName = 'image.png';
            const audioName = 'audio.mp3';

            ffmpeg.FS('writeFile', imgName, await fetchFile(imageFile));
            ffmpeg.FS('writeFile', audioName, await fetchFile(audioFile));

            // 2. è¿è¡Œ FFmpeg å‘½ä»¤
            // -loop 1: å›¾ç‰‡æ— é™å¾ªç¯
            // -i: è¾“å…¥æ–‡ä»¶
            // -c:v libx264: è§†é¢‘ç¼–ç  H.264
            // -tune stillimage: é’ˆå¯¹é™æ­¢å›¾åƒä¼˜åŒ–
            // -c:a aac: éŸ³é¢‘ç¼–ç  AAC
            // -b:a 192k: éŸ³é¢‘æ¯”ç‰¹ç‡
            // -pix_fmt yuv420p: ç¡®ä¿å…¼å®¹æ€§
            // -shortest: è¾“å‡ºé•¿åº¦ä»¥æœ€çŸ­çš„è¾“å…¥ï¼ˆéŸ³é¢‘ï¼‰ä¸ºå‡†
            await ffmpeg.run(
                '-loop', '1',
                '-i', imgName,
                '-i', audioName,
                '-c:v', 'libx264',
                '-tune', 'stillimage',
                '-c:a', 'aac',
                '-b:a', '192k',
                '-pix_fmt', 'yuv420p',
                '-shortest',
                'output.mp4'
            );

            // 3. è¯»å–ç»“æœ
            const data = ffmpeg.FS('readFile', 'output.mp4');

            // 4. åˆ›å»º Blob URL ä¾›ä¸‹è½½å’Œé¢„è§ˆ
            const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
            const videoUrl = URL.createObjectURL(videoBlob);

            videoPlayer.src = videoUrl;
            videoPlayer.style.display = 'block';
            
            downloadLink.href = videoUrl;
            downloadLink.download = `${audioFile.name.split('.')[0]}.mp4`;
            downloadLink.style.display = 'block';
            downloadLink.innerText = `ä¸‹è½½ ${audioFile.name.split('.')[0]}.mp4`;

            statusText.innerText = "âœ… è½¬æ¢å®Œæˆï¼";

        } catch (error) {
            console.error(error);
            statusText.innerText = "âŒ è½¬æ¢å‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ã€‚";
        } finally {
            convertBtn.disabled = false;
        }
    });
</script>

</body>
</html>
