<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3 è½¬ MP4 åœ¨çº¿è½¬æ¢å™¨ (ç§»åŠ¨ç«¯ä¿®å¤ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 600px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #log { font-family: monospace; font-size: 0.8em; height: 120px; overflow-y: scroll; background: #222; color: #0f0; padding: 10px; border-radius: 5px; margin-top: 20px; display: none; }
        video { width: 100%; margin-top: 20px; border-radius: 5px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h3 class="text-center mb-4">ğŸµ MP3 è½¬ MP4</h3>
    
    <div class="mb-3">
        <label for="imageUpload" class="form-label">1. é€‰æ‹©å›¾ç‰‡ (èƒŒæ™¯)</label>
        <input class="form-control" type="file" id="imageUpload" accept="image/*">
    </div>

    <div class="mb-3">
        <label for="audioUpload" class="form-label">2. é€‰æ‹©éŸ³é¢‘ (MP3)</label>
        <input class="form-control" type="file" id="audioUpload" accept=".mp3,audio/*">
    </div>

    <button id="convertBtn" class="btn btn-primary w-100 p-3" disabled>å¼€å§‹è½¬æ¢</button>

    <div id="status" class="mt-3 text-center text-primary fw-bold"></div>
    <div id="log"></div>

    <video id="outputVideo" controls playsinline></video>
    <a id="downloadLink" class="btn btn-success w-100 mt-3 p-3" style="display:none">ä¿å­˜è§†é¢‘</a>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    const imageInput = document.getElementById('imageUpload');
    const audioInput = document.getElementById('audioUpload');
    const convertBtn = document.getElementById('convertBtn');
    const statusText = document.getElementById('status');
    const logArea = document.getElementById('log');
    const videoPlayer = document.getElementById('outputVideo');
    const downloadLink = document.getElementById('downloadLink');

    function checkInputs() {
        convertBtn.disabled = !(imageInput.files[0] && audioInput.files[0]);
    }
    imageInput.addEventListener('change', checkInputs);
    audioInput.addEventListener('change', checkInputs);

    const loadFFmpeg = async () => {
        statusText.innerText = "æ­£åœ¨å‡†å¤‡æ ¸å¿ƒç»„ä»¶...";
        try {
            if (!ffmpeg.isLoaded()) {
                await ffmpeg.load();
            }
            statusText.innerText = "";
        } catch (e) {
            statusText.innerText = "âš ï¸ æ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒ WebAssembly æˆ–éœ€è¦ HTTPS ç¯å¢ƒã€‚";
            console.error(e);
        }
    };

    loadFFmpeg();

    convertBtn.addEventListener('click', async () => {
        const imageFile = imageInput.files[0];
        const audioFile = audioInput.files[0];

        if (!imageFile || !audioFile) return;

        convertBtn.disabled = true;
        convertBtn.innerText = "æ­£åœ¨å¤„ç†ä¸­...";
        logArea.style.display = 'block';
        videoPlayer.style.display = 'none';
        downloadLink.style.display = 'none';
        statusText.innerText = "æ­£åœ¨åˆæˆè§†é¢‘ (æ‰‹æœºç«¯å¯èƒ½ä¼šæ¯”è¾ƒæ…¢ï¼Œè¯·è€å¿ƒç­‰å¾…)...";
        logArea.innerHTML = '';

        ffmpeg.setLogger(({ type, message }) => {
            logArea.innerHTML += `<div>[${type}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        });

        try {
            const imgName = 'image.png';
            const audioName = 'audio.mp3';

            ffmpeg.FS('writeFile', imgName, await fetchFile(imageFile));
            ffmpeg.FS('writeFile', audioName, await fetchFile(audioFile));

            // é’ˆå¯¹ç§»åŠ¨ç«¯ä¼˜åŒ–å‚æ•°ï¼Œé™ä½ CPU å ç”¨
            await ffmpeg.run(
                '-loop', '1',
                '-i', imgName,
                '-i', audioName,
                '-c:v', 'libx264',
                '-preset', 'ultrafast', // ä½¿ç”¨æé€Ÿæ¨¡å¼ï¼Œç‰ºç‰²ä¸€ç‚¹å‹ç¼©ç‡æ¢å–é€Ÿåº¦
                '-tune', 'stillimage',
                '-c:a', 'copy', // éŸ³é¢‘ç›´æ¥å¤åˆ¶ï¼Œä¸é‡æ–°ç¼–ç ï¼Œå¤§å¤§åŠ å¿«é€Ÿåº¦ï¼
                '-pix_fmt', 'yuv420p',
                '-shortest',
                'output.mp4'
            );

            const data = ffmpeg.FS('readFile', 'output.mp4');
            const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
            const videoUrl = URL.createObjectURL(videoBlob);

            videoPlayer.src = videoUrl;
            videoPlayer.style.display = 'block';
            
            downloadLink.href = videoUrl;
            downloadLink.download = `video_${Date.now()}.mp4`; // éšæœºæ–‡ä»¶åé¿å…é‡å
            downloadLink.style.display = 'block';
            downloadLink.innerText = "ç‚¹å‡»ä¿å­˜è§†é¢‘";

            statusText.innerText = "âœ… æˆåŠŸï¼";
            convertBtn.innerText = "å¼€å§‹è½¬æ¢";

        } catch (error) {
            console.error(error);
            statusText.innerText = "âŒ å¤±è´¥ï¼šæ‰‹æœºæµè§ˆå™¨å†…å­˜ä¸è¶³æˆ–å®‰å…¨é™åˆ¶ã€‚";
            alert("è½¬æ¢å¤±è´¥ã€‚æ³¨æ„ï¼šæ­¤åŠŸèƒ½å¯¹æ‰‹æœºæ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œä¸”å¿…é¡»åœ¨ HTTPS æˆ– localhost ç¯å¢ƒä¸‹è¿è¡Œã€‚");
        } finally {
            convertBtn.disabled = false;
        }
    });
</script>

</body>
</html>
