<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Phrases Archive (ç®¡ç†ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="icon" type="image/png" href="https://ä½ çš„å›¾ç‰‡åœ°å€.png">
    
    <link rel="apple-touch-icon" href="https://ä½ çš„å›¾ç‰‡åœ°å€.png">



    <style>
        :root { 
            --bg-body: #f0f2f5; 
            --bg-card: #ffffff; 
            --text-primary: #1a1a1a; 
            --text-secondary: #65676b; 
            --accent-color: #2563eb; 
            --danger-color: #ef4444;
            --border-color: #e4e6eb; 
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05); 
            --shadow-hover: 0 12px 24px rgba(0, 0, 0, 0.12); 
        }
        @media (prefers-color-scheme: dark) { 
            :root { 
                --bg-body: #18191a; 
                --bg-card: #242526; 
                --text-primary: #e4e6eb; 
                --text-secondary: #b0b3b8; 
                --accent-color: #60a5fa; 
                --border-color: #3e4042; 
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2); 
                --shadow-hover: 0 12px 24px rgba(0, 0, 0, 0.4); 
            } 
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-primary); margin: 0; padding: 40px 20px; }
        .container { max-width: 1000px; margin: 0 auto; position: relative; }
        
        /* é¡¶éƒ¨å¸ƒå±€ */
        header { text-align: center; margin-bottom: 30px; position: relative; }
        h1 { font-family: 'Merriweather', serif; margin-bottom: 10px; }
        .subtitle { color: var(--text-secondary); font-size: 0.95rem; }

        /* è®¾ç½®æŒ‰é’® */
        .settings-btn {
            position: absolute; top: 0; right: 0;
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 50%; width: 40px; height: 40px;
            cursor: pointer; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; box-shadow: var(--shadow-sm);
        }
        .settings-btn:hover { transform: rotate(45deg); border-color: var(--accent-color); color: var(--accent-color); }

        /* === æ¨¡æ€æ¡† (Settings Modal) === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 100;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
        }
        .modal {
            background: var(--bg-card); padding: 30px; border-radius: 16px;
            width: 90%; max-width: 400px;
            box-shadow: var(--shadow-hover); border: 1px solid var(--border-color);
        }
        .modal h2 { margin-top: 0; font-size: 1.2rem; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-secondary); }
        .form-group input {
            width: 100%; padding: 10px; border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-body); color: var(--text-primary);
            box-sizing: border-box; /* é˜²æ­¢paddingæ’‘ç ´å®½åº¦ */
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; }
        .btn-cancel { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); }
        .btn-save { background: var(--accent-color); color: white; }

        /* === æœç´¢æ¡† === */
        .search-section { margin-bottom: 20px; }
        .search-box {
            display: flex; gap: 10px; background: var(--bg-card); padding: 10px;
            border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);
        }
        .search-input { flex-grow: 1; border: none; background: transparent; font-size: 16px; color: var(--text-primary); outline: none; padding: 5px 10px; }
        .search-btn { background-color: var(--accent-color); color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .search-btn:disabled { background-color: var(--text-secondary); opacity: 0.7; cursor: not-allowed; }

        /* === å¯¼èˆª === */
        .controls { background: var(--bg-card); padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); margin-bottom: 30px; }
        .controls-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        select { padding: 8px 16px; font-size: 16px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-primary); }
        .months-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; }
        .month-btn { padding: 8px 0; background: transparent; border: 1px solid transparent; border-radius: 8px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; }
        .month-btn:hover { background: var(--bg-body); color: var(--text-primary); }
        .month-btn.active { background: var(--accent-color); color: white; }

        /* === å¡ç‰‡ === */
        #notes-container { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media(min-width: 768px) { #notes-container { grid-template-columns: repeat(2, 1fr); } }

        .note-card { 
            background: var(--bg-card); border-radius: 12px; padding: 24px; 
            border: 1px solid var(--border-color); transition: all 0.3s ease; 
            display: flex; flex-direction: column; position: relative;
        }
        .note-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); border-color: var(--accent-color); }

        .note-header-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 15px; margin-bottom: 12px; }
        .note-word { font-family: 'Merriweather', serif; font-size: 1.4rem; font-weight: 700; color: #000000; word-break: break-word; margin: 0; flex-grow: 1; }
        @media (prefers-color-scheme: dark) { .note-word { color: #ffffff; } }

        /* åˆ é™¤æŒ‰é’® (ä»…å½“é…ç½®äº†Tokenæ—¶æ˜¾ç¤º) */
        .delete-btn {
            background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary);
            border-radius: 8px; padding: 4px 8px; font-size: 0.8rem; cursor: pointer;
            position: absolute; bottom: 20px; right: 20px; opacity: 0; transition: all 0.2s;
            display: none; /* é»˜è®¤éšè— */
        }
        .delete-btn:hover { background: rgba(239, 68, 68, 0.1); color: var(--danger-color); border-color: var(--danger-color); }
        .note-card:hover .delete-btn { opacity: 1; } /* é¼ æ ‡æ‚¬åœå¡ç‰‡æ—¶æ˜¾ç¤º */

        /* TTS æŒ‰é’® */
        .tts-btn {
            background: transparent; border: none; padding: 4px; cursor: pointer; color: var(--text-secondary);
            transition: color 0.3s, transform 0.2s; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
        }
        .tts-icon { width: 26px; height: 26px; fill: currentColor; }
        .tts-waves { opacity: 0.4; transform-origin: center left; transition: opacity 0.3s; }
        .tts-btn:hover { color: var(--accent-color); transform: scale(1.1); }
        .tts-btn.playing { color: var(--accent-color); transform: scale(1.1); cursor: default; }
        @keyframes wave-animation {
            0%   { opacity: 0.2; transform: scale(0.8) translateX(0); }
            50%  { opacity: 1.0; transform: scale(1.1) translateX(1px); }
            100% { opacity: 0.2; transform: scale(0.8) translateX(0); }
        }
        .tts-btn.playing .tts-wave-1 { animation: wave-animation 1.2s infinite ease-in-out; }
        .tts-btn.playing .tts-wave-2 { animation: wave-animation 1.2s infinite ease-in-out 0.2s; }

        .note-meaning { font-size: 1rem; line-height: 1.6; white-space: pre-wrap; margin-bottom: 35px; flex-grow: 1; }
        .note-source { padding-top: 15px; border-top: 1px solid var(--border-color); font-size: 0.85rem; display: block; }
        .note-source a { color: var(--text-secondary); text-decoration: none; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .note-source a:hover { color: var(--accent-color); text-decoration: underline; }
        
        .note-meta { margin-top: 10px; display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); }
        .badge-source { background: var(--bg-body); padding: 2px 8px; border-radius: 4px; font-size: 0.7em; margin-right: 5px; }
        .status-msg { text-align: center; padding: 50px; color: var(--text-secondary); grid-column: 1 / -1; }
        .spinner { width: 30px; height: 30px; border: 3px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s infinite linear; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { color: #ef4444; background: rgba(239,68,68,0.05); padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h2>âš™ï¸ GitHub é…ç½®</h2>
            <div class="form-group">
                <label>GitHub ç”¨æˆ·å (User)</label>
                <input type="text" id="gh-user" value="moodHappy">
            </div>
            <div class="form-group">
                <label>ä»“åº“å (Repo)</label>
                <input type="text" id="gh-repo" value="HelloWorld">
            </div>
            <div class="form-group">
                <label>æ–‡ä»¶è·¯å¾„ (Path)</label>
                <input type="text" id="gh-path" value="Notes/Notes/">
            </div>
            <div class="form-group">
                <label>Personal Access Token (å¿…å¡«)</label>
                <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxx" autocomplete="off">
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeSettings()">å–æ¶ˆ</button>
                <button class="btn btn-save" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <button class="settings-btn" onclick="openSettings()" title="è®¾ç½® GitHub Token">âš™ï¸</button>
            <h1>English Phrases Archive</h1>
            <div class="subtitle">Vocabulary & Context | 2025 - 2054</div>
        </header>

        <div class="search-section">
            <div class="search-box">
                <input type="text" id="search-input" class="search-input" placeholder="å…¨åº“æœç´¢ (Search all phrases)..." onkeypress="handleEnter(event)">
                <button id="search-btn" class="search-btn" onclick="performGlobalSearch()">æœ ç´¢</button>
            </div>
        </div>

        <div class="controls">
            <div class="controls-header">
                <span style="font-weight:600;">ğŸ“… æµè§ˆå½’æ¡£</span>
                <select id="year-select" disabled><option>æ­£åœ¨åŒæ­¥ GitHub...</option></select>
            </div>
            <div class="months-grid" id="month-container"></div>
        </div>

        <div id="notes-container">
            <div class="status-msg"><div class="spinner"></div>æ­£åœ¨è·å–æœ€æ–°ç‰ˆæœ¬...</div>
        </div>
    </div>

    <script>
        // ============================================
        // 1. TTS é…ç½®
        // ============================================
        const TTS_CONFIG = {
            useAlternative: false,
            voices: [ "en-US-AdamNeural", "en-US-AriaNeural", "en-US-AnaNeural", "en-US-AndrewNeural", "en-US-AvaNeural", "en-US-BrianNeural", "en-US-ChristopherNeural", "en-US-CoraNeural", "en-US-DavisNeural", "en-US-ElizabethNeural", "en-US-EricNeural", "en-US-GuyNeural", "en-US-JennyNeural", "en-US-MichelleNeural", "en-US-RogerNeural", "en-US-SteffanNeural", "en-US-TonyNeural" ],
            voice: "en-US-JennyNeural"
        };
        TTS_CONFIG.voice = TTS_CONFIG.voices[Math.floor(Math.random() * TTS_CONFIG.voices.length)];

        function playPhrase(btnElement, text) {
            if (!text || btnElement.classList.contains('playing')) return;
            document.querySelectorAll('.tts-btn').forEach(b => b.classList.remove('playing'));
            const old = document.getElementById('audio-player-instance');
            if (old) { old.pause(); old.remove(); }

            const safeText = encodeURIComponent(text);
            const safeVoice = encodeURIComponent(TTS_CONFIG.voice);
            const baseUrl = TTS_CONFIG.useAlternative 
                ? "https://ms-ra-forwarder-for-ifreetime-beta-two.vercel.app/api/aiyue"
                : "https://libre-tts-nu.vercel.app/api/tts";
            
            const audio = new Audio(`${baseUrl}?t=${safeText}&v=${safeVoice}&r=0&p=0`);
            audio.id = 'audio-player-instance';
            document.body.appendChild(audio);
            btnElement.classList.add('playing');

            const resetUI = () => { btnElement.classList.remove('playing'); audio.remove(); };
            audio.onended = resetUI; audio.onpause = resetUI;
            audio.onerror = () => { console.error("TTS Error"); resetUI(); btnElement.style.color = '#ef4444'; };
            audio.play().catch(e => { console.error("Play failed", e); resetUI(); });
        }

        // ============================================
        // 2. GitHub é…ç½®ç®¡ç† (æ–°å¢æ¨¡å—)
        // ============================================
        // ä» LocalStorage åŠ è½½é…ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
        let USER_CONFIG = {
            user: localStorage.getItem('gh_user') || 'moodHappy',
            repo: localStorage.getItem('gh_repo') || 'HelloWorld',
            path: localStorage.getItem('gh_path') || 'Notes/Notes/',
            token: localStorage.getItem('gh_token') || ''
        };

        function openSettings() {
            document.getElementById('gh-user').value = USER_CONFIG.user;
            document.getElementById('gh-repo').value = USER_CONFIG.repo;
            document.getElementById('gh-path').value = USER_CONFIG.path;
            document.getElementById('gh-token').value = USER_CONFIG.token;
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            const user = document.getElementById('gh-user').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            let path = document.getElementById('gh-path').value.trim();
            if(path && !path.endsWith('/')) path += '/'; // ç¡®ä¿è·¯å¾„ä»¥ / ç»“å°¾
            const token = document.getElementById('gh-token').value.trim();

            localStorage.setItem('gh_user', user);
            localStorage.setItem('gh_repo', repo);
            localStorage.setItem('gh_path', path);
            localStorage.setItem('gh_token', token);

            USER_CONFIG = { user, repo, path, token };
            closeSettings();
            alert('é…ç½®å·²ä¿å­˜ï¼Œå³å°†åˆ·æ–°åº”ç”¨...');
            
            // é‡æ–°åˆå§‹åŒ–
            LATEST_SHA = 'master'; 
            startApp();
        }

        // ============================================
        // 3. æ ¸å¿ƒåº”ç”¨é€»è¾‘
        // ============================================
        const GITHUB_BRANCH = 'master'; 
        const CONFIG_FILE_PATH = 'Notes/Phrases_note.js'; 

        const yearSelect = document.getElementById('year-select');
        const monthContainer = document.getElementById('month-container');
        const notesContainer = document.getElementById('notes-container');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');

        let LATEST_SHA = 'master'; 
        let GLOBAL_CONFIG = null;
        let CURRENT_VIEW_YEAR = null;
        let CURRENT_VIEW_MONTH = null; 

        async function startApp() {
            try {
                // ä½¿ç”¨é…ç½®ä¸­çš„ User/Repo
                const response = await fetch(`https://api.github.com/repos/${USER_CONFIG.user}/${USER_CONFIG.repo}/commits/${GITHUB_BRANCH}`);
                if (response.ok) {
                    const data = await response.json();
                    LATEST_SHA = data.sha;
                    console.log('SHA:', LATEST_SHA);
                }
            } catch (e) { console.warn('Cache mode'); }
            loadRemoteConfig();
        }

        function loadRemoteConfig() {
            // åŠ¨æ€åŠ è½½ JS é…ç½®æ–‡ä»¶
            const configUrl = `https://cdn.jsdelivr.net/gh/${USER_CONFIG.user}/${USER_CONFIG.repo}@${LATEST_SHA}/${CONFIG_FILE_PATH}`;
            fetch(configUrl)
                .then(res => res.ok ? res.text() : Promise.reject(res.status))
                .then(scriptContent => {
                    const blob = new Blob([scriptContent], { type: 'application/javascript' });
                    const url = URL.createObjectURL(blob);
                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => { initApp(); URL.revokeObjectURL(url); };
                    document.head.appendChild(script);
                })
                .catch(err => notesContainer.innerHTML = `<div class="status-msg error-msg">âš ï¸ é…ç½®åŠ è½½å¤±è´¥<br><small>${configUrl}</small></div>`);
        }

        function initApp() {
            let config = (typeof NotesConfig !== 'undefined') ? NotesConfig : ((typeof NewsConfig !== 'undefined') ? NewsConfig : null);
            if (!config) return;
            GLOBAL_CONFIG = config;
            
            // å¼ºåˆ¶è¦†ç›– Config ä¸­çš„ BaseUrlï¼Œä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„ Path + SHA
            config.repoBaseUrl = `https://cdn.jsdelivr.net/gh/${USER_CONFIG.user}/${USER_CONFIG.repo}@${LATEST_SHA}/${USER_CONFIG.path}`;

            yearSelect.disabled = false; yearSelect.innerHTML = '';
            const start = config.startYear || 2025; const total = config.totalYears || 30;
            for (let y = start; y < start + total; y++) {
                const opt = document.createElement('option'); opt.value = y; opt.text = `${y}å¹´`; yearSelect.appendChild(opt);
            }
            
            const today = new Date();
            let defaultYear = (today.getFullYear() >= start && today.getFullYear() < start + total) ? today.getFullYear() : start;
            yearSelect.value = defaultYear;
            yearSelect.addEventListener('change', (e) => loadMonthsForYear(parseInt(e.target.value), config));
            loadMonthsForYear(defaultYear, config);

            const targetMonth = (defaultYear === today.getFullYear()) ? (today.getMonth() + 1) : 12;
            setTimeout(() => {
                const btn = document.querySelector(`button[data-month="${targetMonth}"]`);
                if(btn) btn.click(); else { const allBtns = document.querySelectorAll('.month-btn'); if(allBtns.length > 0) allBtns[allBtns.length-1].click(); }
            }, 100);
        }

        function loadMonthsForYear(year, config) {
            monthContainer.innerHTML = '';
            for (let m = 1; m <= 12; m++) {
                const btn = document.createElement('button');
                btn.className = 'month-btn'; btn.innerText = `${m}æœˆ`; btn.dataset.month = m;
                btn.onclick = () => {
                    searchInput.value = '';
                    document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    fetchNotes(year, m, config);
                };
                monthContainer.appendChild(btn);
            }
        }

        function fetchNotes(year, month, config) {
            CURRENT_VIEW_YEAR = year;
            CURRENT_VIEW_MONTH = month;
            
            const targetUrl = config.getUrl(year, month);
            notesContainer.innerHTML = `<div class="status-msg"><div class="spinner"></div>è¯»å–ä¸­: ${year}-${month}</div>`;
            fetch(targetUrl).then(res => {
                if (res.status === 404) throw new Error('æœ¬æœˆæš‚æ— æ•°æ®'); if (!res.ok) throw new Error('ç½‘ç»œé”™è¯¯'); return res.json();
            }).then(data => renderNotes(data)).catch(err => {
                notesContainer.innerHTML = (err.message === 'æœ¬æœˆæš‚æ— æ•°æ®') ? `<div class="status-msg">ğŸ“­ æœ¬æœˆæ²¡æœ‰ç¬”è®°æ•°æ®</div>` : `<div class="status-msg error-msg">åŠ è½½å¤±è´¥<br><small>${err.message}</small></div>`;
            });
        }

        function handleEnter(e) { if(e.key === 'Enter') performGlobalSearch(); }

        async function performGlobalSearch() {
            const query = searchInput.value.trim().toLowerCase();
            if(!query) { alert("è¯·è¾“å…¥å…³é”®è¯"); return; }
            if(!GLOBAL_CONFIG) return;

            // æœç´¢æ—¶ä¸ä¿ç•™å½“å‰å¹´æœˆä¸Šä¸‹æ–‡ï¼Œç¦æ­¢åˆ é™¤æ“ä½œï¼ˆå› ä¸ºåˆ é™¤éœ€è¦å®šä½å…·ä½“æ–‡ä»¶ï¼‰
            CURRENT_VIEW_YEAR = null; 
            CURRENT_VIEW_MONTH = null;

            searchBtn.disabled = true; searchBtn.innerText = "æœç´¢ä¸­...";
            document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
            notesContainer.innerHTML = `<div class="status-msg"><div class="spinner"></div>æœç´¢ä¸­: "${query}"...</div>`;

            const results = []; const fetchPromises = []; const today = new Date(); const startYear = GLOBAL_CONFIG.startYear;
            for (let y = startYear; y <= today.getFullYear(); y++) {
                let maxM = (y === today.getFullYear()) ? (today.getMonth() + 1) : 12;
                for (let m = 1; m <= maxM; m++) {
                    fetchPromises.push(fetch(GLOBAL_CONFIG.getUrl(y, m)).then(res => res.ok ? res.json() : []).then(data => {
                        if(Array.isArray(data)) {
                            const matches = data.filter(item => (item.text||'').toLowerCase().includes(query) || (item.note||'').toLowerCase().includes(query));
                            matches.forEach(item => item._sourceDate = `${y}å¹´${m}æœˆ`); results.push(...matches);
                        }
                    }).catch(()=>{}));
                }
            }
            await Promise.all(fetchPromises);
            if(results.length > 0) renderNotes(results, true); else notesContainer.innerHTML = `<div class="status-msg">ğŸ” æœªæ‰¾åˆ° "${query}"</div>`;
            searchBtn.disabled = false; searchBtn.innerText = "æœ ç´¢";
        }

        // ===============================================
        // 4. åˆ é™¤é€»è¾‘ (GitHub API)
        // ===============================================
        async function deleteNote(id) {
            if (!confirm("âš ï¸ ç¡®å®šè¦ä» GitHub æ°¸ä¹…åˆ é™¤è¿™æ¡çŸ­è¯­å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;
            if (!USER_CONFIG.token) { alert("è¯·å…ˆç‚¹å‡»å³ä¸Šè§’ âš™ï¸ è®¾ç½® GitHub Token"); openSettings(); return; }
            if (!CURRENT_VIEW_YEAR || !CURRENT_VIEW_MONTH) { alert("åªèƒ½åœ¨æµè§ˆç‰¹å®šæœˆä»½åˆ—è¡¨æ—¶åˆ é™¤ï¼Œä¸æ”¯æŒåœ¨æœç´¢ç»“æœä¸­ç›´æ¥åˆ é™¤ã€‚"); return; }

            const fileName = GLOBAL_CONFIG.getFileName(CURRENT_VIEW_YEAR, CURRENT_VIEW_MONTH);
            // æ³¨æ„ï¼šAPI è·¯å¾„ä¸åŒ…å« Notes/Notes/ å‰ç¼€ï¼Œè€Œæ˜¯åŸºäº Repo æ ¹ç›®å½•
            // ç”¨æˆ·é…ç½®çš„ path é€šå¸¸æ˜¯ Notes/Notes/ï¼Œæ‰€ä»¥ API è·¯å¾„ = path + filename
            const apiUrl = `https://api.github.com/repos/${USER_CONFIG.user}/${USER_CONFIG.repo}/contents/${USER_CONFIG.path}${fileName}`;
            
            // æ˜¾ç¤º Loading é®ç½©
            const btn = document.activeElement;
            if(btn) { btn.innerText = "åˆ é™¤ä¸­..."; btn.disabled = true; }

            try {
                // 1. è·å–å½“å‰æ–‡ä»¶å†…å®¹ (éœ€è¦ SHA æ¥æ›´æ–°)
                const getRes = await fetch(apiUrl, {
                    headers: { 'Authorization': `token ${USER_CONFIG.token}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                
                if(!getRes.ok) throw new Error("æ— æ³•è¯»å–æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ Token æƒé™");
                const fileData = await getRes.json();
                
                // Base64 è§£ç  (å¤„ç†ä¸­æ–‡)
                const content = decodeURIComponent(escape(atob(fileData.content)));
                let json = JSON.parse(content);

                // 2. è¿‡æ»¤æ‰è¦åˆ é™¤çš„ ID
                const newJson = json.filter(item => item.id !== id);

                if (newJson.length === json.length) { throw new Error("æœªæ‰¾åˆ°å¯¹åº” IDï¼Œæ–‡ä»¶å¯èƒ½å·²è¢«ä¿®æ”¹"); }

                // 3. é‡æ–°ç¼–ç å¹¶ä¸Šä¼ 
                // ä½¿ç”¨ unescape + encodeURIComponent å¤„ç† UTF-8 å­—ç¬¦è½¬ Base64
                const newContent = btoa(unescape(encodeURIComponent(JSON.stringify(newJson, null, 2))));
                
                const putRes = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${USER_CONFIG.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Delete phrase ID: ${id} via Web`,
                        content: newContent,
                        sha: fileData.sha // å¿…é¡»å¸¦ä¸Š SHA
                    })
                });

                if(!putRes.ok) throw new Error("æ›´æ–° GitHub å¤±è´¥");

                alert("âœ… åˆ é™¤æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚");
                // åˆ·æ–°å½“å‰åˆ—è¡¨
                // æ›´æ–° SHA ä¿è¯è¯»åˆ°æœ€æ–°çš„
                startApp(); // ç®€å•ç²—æš´é‡æ–°èµ°ä¸€éæµç¨‹ï¼Œæˆ–è€…åªè°ƒç”¨ fetchNotes
                
            } catch (err) {
                alert(`âŒ é”™è¯¯: ${err.message}`);
                if(btn) { btn.innerText = "ğŸ—‘ï¸ åˆ é™¤"; btn.disabled = false; }
            }
        }

        // ===============================================
        // 5. æ¸²æŸ“å¡ç‰‡
        // ===============================================
        function renderNotes(items, isSearchResult = false) {
            notesContainer.innerHTML = '';
            items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            if (isSearchResult) {
                const info = document.createElement('div'); info.className = 'status-msg'; info.style.padding = '10px'; info.style.fontSize = '0.9em';
                info.innerHTML = `âœ… æ‰¾åˆ° ${items.length} ä¸ªç»“æœ`; notesContainer.appendChild(info);
            }

            const hasToken = !!USER_CONFIG.token && !isSearchResult; // åªæœ‰é…äº† Token ä¸”éæœç´¢ç»“æœé¡µæ‰æ˜¾ç¤ºåˆ é™¤

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'note-card';
                const sourceText = item.pageTitle || 'Source Link';
                const timeStr = item.time ? item.time.split(' ')[0] : '---';
                const rawText = item.text ? item.text.trim() : "";
                const safeTextForJS = rawText.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const highlightUrl = `${item.url}#:~:text=${encodeURIComponent(rawText)}`;
                const sourceBadge = item._sourceDate ? `<span class="badge-source">ğŸ“‚ ${item._sourceDate}</span>` : '';

                const svgIcon = `<svg class="tts-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path class="tts-body" d="M3 9v6h4l5 5V4L7 9H3z"/><path class="tts-waves tts-wave-1" d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/><path class="tts-waves tts-wave-2" d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;

                // åˆ é™¤æŒ‰é’® HTML (å¦‚æœé…ç½®äº†Token)
                const deleteBtnHtml = hasToken 
                    ? `<button class="delete-btn" onclick="deleteNote('${item.id}')">ğŸ—‘ï¸ åˆ é™¤</button>` 
                    : '';

                card.innerHTML = `
                    <div class="note-header-row">
                        <div class="note-word">${item.text}</div>
                        <button class="tts-btn" onclick="playPhrase(this, '${safeTextForJS}')" title="æ’­æ”¾è¯»éŸ³">${svgIcon}</button>
                    </div>
                    <div class="note-meaning">${item.note}</div>
                    <div class="note-source">
                        <a href="${highlightUrl}" target="_blank" title="ç‚¹å‡»è·³è½¬å¹¶é«˜äº®ï¼š${rawText}">${sourceText}</a>
                    </div>
                    <div class="note-meta">
                        <div>${sourceBadge}<span>ğŸ•’ ${timeStr}</span></div>
                        <span style="opacity:0.5">ID: ${(item.id || '').slice(-4)}</span>
                    </div>
                    ${deleteBtnHtml}
                `;
                notesContainer.appendChild(card);
            });
            
            // å¦‚æœé…äº†Tokenä½†æ²¡çœ‹åˆ°åˆ é™¤æŒ‰é’®ï¼ˆæ¯”å¦‚é¦–æ¬¡åŠ è½½ï¼‰ï¼Œå¼ºåˆ¶æ˜¾ç¤º
            if(hasToken) {
                const style = document.createElement('style');
                style.innerHTML = `.delete-btn { display: block !important; }`;
                document.head.appendChild(style);
            }
        }

        // å¯åŠ¨
        startApp();

        // è¾…åŠ©ï¼šç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) closeSettings();
        });
    </script>
</body>
</html>