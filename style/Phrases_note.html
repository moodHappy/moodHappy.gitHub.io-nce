<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Phrases Archive (å®æ—¶ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-body: #f0f2f5; 
            --bg-card: #ffffff; 
            --text-primary: #1a1a1a; 
            --text-secondary: #65676b; 
            --accent-color: #2563eb; 
            --border-color: #e4e6eb; 
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05); 
            --shadow-hover: 0 12px 24px rgba(0, 0, 0, 0.12); 
        }
        @media (prefers-color-scheme: dark) { 
            :root { 
                --bg-body: #18191a; 
                --bg-card: #242526; 
                --text-primary: #e4e6eb; 
                --text-secondary: #b0b3b8; 
                --accent-color: #60a5fa; 
                --border-color: #3e4042; 
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2); 
                --shadow-hover: 0 12px 24px rgba(0, 0, 0, 0.4); 
            } 
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-primary); margin: 0; padding: 40px 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 40px; }
        h1 { font-family: 'Merriweather', serif; margin-bottom: 10px; }
        .subtitle { color: var(--text-secondary); font-size: 0.95rem; }

        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .controls { background: var(--bg-card); padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); margin-bottom: 30px; }
        .controls-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        select { padding: 8px 16px; font-size: 16px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-primary); }
        .months-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; }
        .month-btn { padding: 8px 0; background: transparent; border: 1px solid transparent; border-radius: 8px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; }
        .month-btn:hover { background: var(--bg-body); color: var(--text-primary); }
        .month-btn.active { background: var(--accent-color); color: white; box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3); }

        /* å†…å®¹åŒºåŸŸ */
        #notes-container { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media(min-width: 768px) { #notes-container { grid-template-columns: repeat(2, 1fr); } }

        /* å¡ç‰‡æ ·å¼ */
        .note-card { 
            background: var(--bg-card); border-radius: 12px; padding: 24px; 
            border: 1px solid var(--border-color); transition: all 0.3s ease; 
            display: flex; flex-direction: column; 
        }
        .note-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); border-color: var(--accent-color); }

        .note-word { font-family: 'Merriweather', serif; font-size: 1.4rem; font-weight: 700; color: var(--accent-color); margin-bottom: 12px; word-break: break-word; }
        .note-meaning { font-size: 1rem; line-height: 1.6; white-space: pre-wrap; margin-bottom: 20px; flex-grow: 1; }
        
        /* æ¥æºé“¾æ¥æ ·å¼ */
        .note-source { 
            padding-top: 15px; 
            border-top: 1px solid var(--border-color); 
            font-size: 0.85rem; 
            display: block; 
        }
        .note-source a { 
            color: var(--text-secondary); 
            text-decoration: none; 
            display: -webkit-box; 
            -webkit-line-clamp: 1; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
            transition: color 0.2s;
        }
        /* é¼ æ ‡æ‚¬åœæ—¶æç¤ºè¿™æ˜¯ä¸€ä¸ªå®šä½é“¾æ¥ */
        .note-source a:hover { color: var(--accent-color); text-decoration: underline; cursor: context-menu; }
        
        .note-meta { margin-top: 10px; display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); }
        
        .status-msg { text-align: center; padding: 50px; color: var(--text-secondary); grid-column: 1 / -1; }
        .spinner { width: 30px; height: 30px; border: 3px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s infinite linear; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { color: #ef4444; background: rgba(239,68,68,0.05); padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>English Phrases Archive</h1>
            <div class="subtitle">Vocabulary & Context | 2025 - 2054</div>
        </header>

        <div class="controls">
            <div class="controls-header">
                <span style="font-weight:600;">ğŸ“… é€‰æ‹©å¹´ä»½</span>
                <select id="year-select" disabled>
                    <option>æ­£åœ¨åŒæ­¥ GitHub...</option>
                </select>
            </div>
            <div class="months-grid" id="month-container"></div>
        </div>

        <div id="notes-container">
            <div class="status-msg">
                <div class="spinner"></div>
                æ­£åœ¨è·å–æœ€æ–°ç‰ˆæœ¬...
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // æ ¸å¿ƒé…ç½®åŒºåŸŸ
        // ============================================
        const GITHUB_USER = 'moodHappy';
        const GITHUB_REPO = 'HelloWorld';
        const GITHUB_BRANCH = 'master'; 
        
        // ä½ çš„ JS é…ç½®æ–‡ä»¶è·¯å¾„
        const CONFIG_FILE_PATH = 'Notes/Phrases_note.js'; 

        const yearSelect = document.getElementById('year-select');
        const monthContainer = document.getElementById('month-container');
        const notesContainer = document.getElementById('notes-container');

        let LATEST_SHA = 'master'; 

        // 1. è·å–æœ€æ–° Commit SHA
        async function startApp() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/commits/${GITHUB_BRANCH}`);
                if (response.ok) {
                    const data = await response.json();
                    LATEST_SHA = data.sha;
                    console.log('æœ€æ–°ç‰ˆæœ¬é”å®š:', LATEST_SHA);
                }
            } catch (e) { console.warn('API è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æ¨¡å¼'); }
            loadRemoteConfig();
        }

        // 2. åŠ è½½ JS é…ç½®æ–‡ä»¶
        function loadRemoteConfig() {
            const configUrl = `https://cdn.jsdelivr.net/gh/${GITHUB_USER}/${GITHUB_REPO}@${LATEST_SHA}/${CONFIG_FILE_PATH}`;

            fetch(configUrl)
                .then(res => {
                    if(!res.ok) throw new Error(`é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ (Status: ${res.status})`);
                    return res.text();
                })
                .then(scriptContent => {
                    const blob = new Blob([scriptContent], { type: 'application/javascript' });
                    const url = URL.createObjectURL(blob);
                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => { 
                        initApp(); 
                        URL.revokeObjectURL(url); 
                    };
                    document.head.appendChild(script);
                })
                .catch(err => {
                    notesContainer.innerHTML = `<div class="status-msg error-msg">âš ï¸ æ— æ³•åŠ è½½é…ç½®æ–‡ä»¶<br><small>${configUrl}</small><br><br>${err.message}</div>`;
                });
        }

        // 3. åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            let config = null;
            if (typeof NotesConfig !== 'undefined') config = NotesConfig;
            else if (typeof NewsConfig !== 'undefined') config = NewsConfig;

            if (!config) {
                notesContainer.innerHTML = `<div class="status-msg error-msg">é”™è¯¯ï¼šJS æ–‡ä»¶ä¸­æœªæ‰¾åˆ° NotesConfig å¯¹è±¡</div>`;
                return;
            }

            // æ›´æ–° BaseUrl
            const originalBase = config.repoBaseUrl;
            const pathPart = originalBase.includes('/master/') ? originalBase.split('/master/')[1] : 'Notes/Notes/';
            config.repoBaseUrl = `https://cdn.jsdelivr.net/gh/${GITHUB_USER}/${GITHUB_REPO}@${LATEST_SHA}/${pathPart}`;

            yearSelect.disabled = false;
            yearSelect.innerHTML = '';
            const start = config.startYear || 2025;
            const total = config.totalYears || 30;
            
            for (let y = start; y < start + total; y++) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.text = `${y}å¹´`;
                yearSelect.appendChild(opt);
            }
            
            const today = new Date();
            let defaultYear = (today.getFullYear() >= start && today.getFullYear() < start + total) ? today.getFullYear() : start;
            yearSelect.value = defaultYear;
            
            yearSelect.addEventListener('change', (e) => loadMonthsForYear(parseInt(e.target.value), config));
            loadMonthsForYear(defaultYear, config);

            const targetMonth = (defaultYear === today.getFullYear()) ? (today.getMonth() + 1) : 12;
            setTimeout(() => {
                const btn = document.querySelector(`button[data-month="${targetMonth}"]`);
                if(btn) btn.click();
                else {
                    const allBtns = document.querySelectorAll('.month-btn');
                    if(allBtns.length > 0) allBtns[allBtns.length-1].click();
                }
            }, 100);
        }

        function loadMonthsForYear(year, config) {
            monthContainer.innerHTML = '';
            for (let m = 1; m <= 12; m++) {
                const btn = document.createElement('button');
                btn.className = 'month-btn';
                btn.innerText = `${m}æœˆ`;
                btn.dataset.month = m;
                btn.onclick = () => {
                    document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    fetchNotes(year, m, config);
                };
                monthContainer.appendChild(btn);
            }
        }

        // 4. è·å– JSON æ•°æ®
        function fetchNotes(year, month, config) {
            const targetUrl = config.getUrl(year, month);
            notesContainer.innerHTML = `<div class="status-msg"><div class="spinner"></div>æ­£åœ¨è¯»å–: ${year}-${month}</div>`;

            fetch(targetUrl)
                .then(res => {
                    if (res.status === 404) throw new Error('æœ¬æœˆæš‚æ— æ•°æ®');
                    if (!res.ok) throw new Error(`ç½‘ç»œé”™è¯¯ (${res.status})`);
                    return res.json();
                })
                .then(data => {
                    renderNotes(data);
                })
                .catch(err => {
                    let msg = err.message;
                    if(msg === 'æœ¬æœˆæš‚æ— æ•°æ®') {
                        notesContainer.innerHTML = `<div class="status-msg">ğŸ“­ æœ¬æœˆæ²¡æœ‰ç¬”è®°æ•°æ®</div>`;
                    } else {
                        notesContainer.innerHTML = `
                            <div class="status-msg error-msg">
                                <strong>åŠ è½½å¤±è´¥</strong><br><small>${msg}</small>
                                <br><span style="font-size:0.8em; opacity:0.7">${targetUrl}</span>
                            </div>`;
                    }
                });
        }

        // ===============================================
        // 5. æ¸²æŸ“å¡ç‰‡ (å…³é”®ä¿®æ”¹ï¼šæ·»åŠ é«˜äº®å®šä½åŠŸèƒ½)
        // ===============================================
        function renderNotes(items) {
            notesContainer.innerHTML = '';
            items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            if (items.length === 0) {
                notesContainer.innerHTML = '<div class="status-msg">æ•°æ®ä¸ºç©º</div>';
                return;
            }

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'note-card';
                
                const sourceText = item.pageTitle || 'Source Link';
                const timeStr = item.time ? item.time.split(' ')[0] : '---';
                
                // --- ç‹‚é‡æƒ³æ³•å®ç°åŒºåŸŸ ---
                // 1. è·å–å•è¯æ–‡æœ¬ï¼Œå»é™¤é¦–å°¾ç©ºæ ¼
                const rawText = item.text ? item.text.trim() : "";
                
                // 2. å°†æ–‡æœ¬ç¼–ç ï¼ˆå¤„ç†ç©ºæ ¼ä¸º%20ï¼Œç‰¹æ®Šç¬¦å·ç­‰ï¼‰
                const encodedText = encodeURIComponent(rawText);
                
                // 3. æ„é€ å¸¦æœ‰é«˜äº®ç‰‡æ®µé”šç‚¹çš„ URL
                // æ ¼å¼ï¼šåŸå§‹URL + #:~:text=ç¼–ç åçš„å•è¯
                // æµè§ˆå™¨ä¼šè¯†åˆ«è¿™ä¸ªåç¼€ï¼Œè‡ªåŠ¨æ»šåŠ¨å¹¶é«˜äº®
                const highlightUrl = `${item.url}#:~:text=${encodedText}`;

                card.innerHTML = `
                    <div class="note-word">${item.text}</div>
                    <div class="note-meaning">${item.note}</div>
                    
                    <div class="note-source">
                        <a href="${highlightUrl}" target="_blank" title="ç‚¹å‡»è·³è½¬å¹¶é«˜äº®å•è¯ï¼š${rawText}">
                            ${sourceText}
                        </a>
                    </div>
                    
                    <div class="note-meta">
                        <span>ğŸ•’ ${timeStr}</span>
                        <span style="opacity:0.5">ID: ${(item.id || '').slice(-4)}</span>
                    </div>
                `;
                notesContainer.appendChild(card);
            });
        }

        startApp();
    </script>
</body>
</html>
