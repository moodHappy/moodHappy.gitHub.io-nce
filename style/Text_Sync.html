<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>GitHub 文本同步器</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea { width: 100%; height: 150px; font-size: 16px; }
    button { margin-top: 10px; padding: 8px 16px; margin-right: 10px; }
    #status { margin-top: 10px; color: #333; }
  </style>
</head>
<body>
  <h2>📤 GitHub 文本同步器</h2>
  <textarea id="inputContent" placeholder="加载中或输入内容..."></textarea><br>
  <button onclick="submitContent()">提交</button>
  <button onclick="deleteContent()">删除</button>
  <div id="status">⏳ 正在加载 GitHub 内容...</div>

  <script>
    const GITHUB_USERNAME = "moodHappy";
    const GITHUB_REPO = "HelloWorld";
    const GITHUB_TOKEN = "";
    const WORD_FILE_PATH_GITHUB = "Notes/transfer.txt";

    const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${WORD_FILE_PATH_GITHUB}`;
    const headers = {
      Authorization: `Bearer ${GITHUB_TOKEN}`,
      "Content-Type": "application/json"
    };

    async function getCurrentFileShaAndContent() {
      const res = await fetch(apiUrl, { headers });
      if (res.status === 404) return { sha: null, content: "" };
      const data = await res.json();
      const decoded = decodeURIComponent(escape(atob(data.content)));
      return { sha: data.sha, content: decoded };
    }

    async function submitContent() {
      const textarea = document.getElementById("inputContent");
      const content = textarea.value.trim();
      if (!content) return alert("请输入内容再提交！");

      document.getElementById("status").textContent = "🔄 正在提交到 GitHub...";

      const { sha } = await getCurrentFileShaAndContent();
      const encodedContent = btoa(unescape(encodeURIComponent(content)));

      const res = await fetch(apiUrl, {
        method: "PUT",
        headers,
        body: JSON.stringify({
          message: "更新 transfer.txt",
          content: encodedContent,
          committer: { name: "AutoCommit", email: "bot@example.com" },
          ...(sha ? { sha } : {})
        })
      });

      if (res.ok) {
        document.getElementById("status").textContent = "✅ 提交成功，内容已同步。";
      } else {
        const err = await res.json();
        document.getElementById("status").textContent = "❌ 提交失败：" + (err.message || res.statusText);
      }
    }

    async function deleteContent() {
      document.getElementById("status").textContent = "🗑️ 正在清空 GitHub 文件...";
      const { sha } = await getCurrentFileShaAndContent();
      if (!sha) {
        document.getElementById("status").textContent = "✅ 文件已为空，无需删除。";
        return;
      }

      const res = await fetch(apiUrl, {
        method: "PUT",
        headers,
        body: JSON.stringify({
          message: "清空 transfer.txt",
          content: btoa(""),
          sha,
          committer: { name: "AutoCommit", email: "bot@example.com" }
        })
      });

      if (res.ok) {
        document.getElementById("inputContent").value = "";
        document.getElementById("status").textContent = "✅ 删除成功，GitHub 内容已清空。";
      } else {
        const err = await res.json();
        document.getElementById("status").textContent = "❌ 删除失败：" + (err.message || res.statusText);
      }
    }

    // 页面加载时自动获取 GitHub 内容
    window.onload = async () => {
      const textarea = document.getElementById("inputContent");
      const status = document.getElementById("status");

      try {
        const { content } = await getCurrentFileShaAndContent();
        textarea.value = content;
        status.textContent = "✅ 已加载 GitHub 内容。";
      } catch (err) {
        status.textContent = "⚠️ 无法加载 GitHub 内容：" + err.message;
      }
    };
  </script>
</body>
</html>