<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GitHub åŒæ­¥åŠ©æ‰‹ & AI é˜…è¯»</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* CSS Variables for theming and typography */
    :root {
      --bg-color: #f9f9f9;
      --text-color: #222;
      --textarea-bg-color: #fff;
      --textarea-border-color: #ccc;
      --article-bg-color: #fff;
      --article-border-color: #ccc;
      --status-color: #444;
      --button-primary-bg: #4CAF50;
      --button-secondary-bg: #2196F3;
      --button-danger-bg: #f44336;
      --button-generate-bg: #800080;
      --button-read-bg: #e6b800;
      --modal-bg: rgba(0,0,0,0.5);
      --modal-content-bg: #fff;
      --input-border-color: #aaa;
      --settings-icon-color: #333;
      --highlight-color: #800080; /* é­”æœ¯æ£’é«˜äº®è‰² */

      --primary-font: 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      --font-size: 17px;
      --line-height: 1.6;
    }

    /* Dark Theme */
    body.theme-dark {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --textarea-bg-color: #1e1e1e;
      --textarea-border-color: #444;
      --article-bg-color: #1e1e1e;
      --article-border-color: #444;
      --status-color: #aaa;
      --modal-content-bg: #2d2d2d;
      --input-border-color: #555;
      --settings-icon-color: #ccc;
      --highlight-color: #bb86fc;
    }

    /* Sepia Theme */
    body.theme-sepia {
      --bg-color: #f4f0e8;
      --text-color: #5b4636;
      --textarea-bg-color: #fdfaf3;
      --textarea-border-color: #dcd3c3;
      --article-bg-color: #fdfaf3;
      --article-border-color: #dcd3c3;
      --status-color: #5b4636;
      --modal-content-bg: #fdfaf3;
      --input-border-color: #c9bca8;
      --settings-icon-color: #5b4636;
      --highlight-color: #8b7355;
    }

    body {
      font-family: var(--primary-font);
      background: var(--bg-color);
      color: var(--text-color);
      padding: 1em;
      transition: background-color 0.3s, color 0.3s;
    }

    textarea, article.immersive-content {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      padding: 12px;
      font-size: var(--font-size);
      line-height: var(--line-height);
      background-color: var(--article-bg-color);
      border: 1px solid var(--article-border-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    textarea {
      min-height: 150px;
      resize: vertical;
      overflow: hidden;
      background-color: var(--textarea-bg-color);
      border-color: var(--textarea-border-color);
    }

    /* Button Container Styles */
    .button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }

    button {
      padding: 10px 16px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      color: white;
      cursor: pointer;
      background-color: var(--button-primary-bg);
      min-height: 44px;
      min-width: 44px;
      flex: 1 1 auto;
      transition: background-color 0.3s;
    }

    button:disabled { background-color: #999; cursor: not-allowed; }
    button.copy { background-color: var(--button-secondary-bg); }
    button.delete { background-color: var(--button-danger-bg); }
    button.generate { background-color: var(--button-generate-bg); }
    button.read { background-color: var(--button-read-bg); }

    @media (max-width: 600px) {
        .button-container { flex-wrap: wrap; justify-content: space-between; }
        button { flex: 1 1 calc(20% - 8px); }
    }

    #status { margin-top: 10px; color: var(--status-color); font-size: 14px; }
    #settings-icon { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: var(--settings-icon-color); }

    /* Modal Styles */
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--modal-bg); display: none; justify-content: center; align-items: center; z-index: 999;
    }
    .modal-content {
      background: var(--modal-content-bg); color: var(--text-color); padding: 20px;
      border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
      position: relative;
    }
    .modal-content h3 { margin-top: 0; }
    .modal-content input, .modal-content select, .modal-content textarea {
      width: 100%; padding: 10px; margin-top: 10px; font-size: 16px; border-radius: 5px;
      border: 1px solid var(--input-border-color); background-color: var(--textarea-bg-color);
      color: var(--text-color); box-sizing: border-box;
    }
    .modal-content select[multiple] { height: 100px; }
    .modal-content label { display: block; margin-top: 15px; font-size: 14px; color: var(--status-color); }

    article.immersive-content { line-height: var(--line-height); font-size: var(--font-size); }
    article.immersive-content p { margin-bottom: 1em; white-space: pre-wrap; }

    .ai-inputs { display: none; }
    .modal-buttons { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; padding-top: 10px; border-top: 1px solid var(--textarea-border-color); }
    .modal-buttons button { flex: 1 1 auto; margin-top: 0; }
    
    #storyThemeModal .modal-buttons-container { display: flex; gap: 10px; margin-top: 10px; }
    #storyThemeModal .modal-buttons-container button { flex: 1; }
    #storyThemeModal .modal-buttons-container button.generate-topics-btn { background-color: #800080; }

    #randomTopicsList { margin-top: 20px; padding: 0; list-style: none; }
    #randomTopicsList li {
        padding: 10px; border: 1px solid var(--textarea-border-color); border-radius: 5px;
        margin-bottom: 8px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s;
    }
    #randomTopicsList li:hover { background-color: var(--textarea-border-color); }

    .select-container { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .select-container select { flex: 1 1 30%; }

    /* Style Management */
    #customStyleList { padding: 0; list-style: none; max-height: 150px; overflow-y: auto; border: 1px solid var(--textarea-border-color); border-radius: 5px; margin-top: 10px; }
    #customStyleList li { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid var(--textarea-border-color); }
    #customStyleList li:last-child { border-bottom: none; }
    #customStyleList .delete-style-btn { background: var(--button-danger-bg); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; }
    .style-input-container { display: flex; gap: 10px; margin-top: 10px; }
    .style-input-container input { flex: 1; }
    .style-input-container button { flex: none; width: 100px; margin-top: 0; }

    /* --- é­”æœ¯æ£’ & AI åˆ†æ æ ·å¼ --- */
    .ai-analyze-btn {
        display: inline-flex; align-items: center; justify-content: center;
        background-color: transparent; 
        border: 1px solid var(--input-border-color);
        border-radius: 50%; width: 22px; height: 22px; margin: 0 4px; cursor: pointer;
        color: var(--status-color); position: relative; top: -1px; transition: all 0.2s;
        opacity: 0.6;
    }
    .ai-analyze-btn:hover { background-color: var(--highlight-color); color: white; transform: scale(1.1); opacity: 1; border-color: var(--highlight-color); }
    
    /* çº¢è‰²é«˜äº®æ ·å¼ - æ ‡è®°ä¸Šæ¬¡ç‚¹å‡»ä½ç½® */
    .ai-analyze-btn.last-clicked {
        background-color: var(--button-danger-bg) !important;
        color: white !important;
        border-color: var(--button-danger-bg) !important;
        opacity: 1;
        transform: scale(1.15);
    }
    .ai-analyze-btn svg { width: 12px; height: 12px; fill: currentColor; }

    /* åˆ†æç»“æœå¼¹çª—ç‰¹å®šæ ·å¼ */
    .original-sentence-box {
        background: rgba(0,0,0,0.05); padding: 10px; border-radius: 6px; 
        border-left: 4px solid var(--highlight-color); 
        color: var(--text-color); font-style: italic; font-size: 0.9em; margin-bottom: 15px;
    }
    .ai-result-content { line-height: 1.7; font-size: 1em; }
    .ai-result-content h1, .ai-result-content h2, .ai-result-content h3 { color: var(--highlight-color); margin-top: 15px; margin-bottom: 8px; font-size: 1.1em; border-bottom: 1px dashed var(--input-border-color); }
    .ai-result-content ul { padding-left: 20px; }
    .ai-loading { text-align: center; padding: 20px; color: var(--status-color); }
    .spinner { width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--highlight-color); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .cache-info { text-align: center; font-size: 12px; color: #999; margin-top: 10px; }
    .cache-info a { color: var(--highlight-color); cursor: pointer; text-decoration: none; }

  </style>
</head>
<body>
  <div id="settings-icon" title="è®¾ç½®" onclick="openSettingsModal()">âš™ï¸</div>
  <h2>ğŸ“¤ GitHub åŒæ­¥åŠ©æ‰‹</h2>

  <div class="button-container">
    <button onclick="submitContent()">æäº¤</button>
    <button class="delete" onclick="deleteContent()">åˆ é™¤</button>
    <button class="copy" onclick="copyContent()">å¤åˆ¶</button>
    <button class="generate" onclick="openThemeModal()">ç”Ÿæˆ</button>
    <button class="read" onclick="readContent()">æœ—è¯»</button>
  </div>

  <textarea id="inputContent" placeholder="è¯·è¾“å…¥è‹±æ–‡æ–‡æœ¬ï¼ˆæ”¯æŒå¤šæ®µï¼Œæ¯æ®µç”¨ç©ºè¡Œåˆ†éš”ï¼‰..."></textarea>
  <article id="renderedContent" class="immersive-content" style="display:none;"></article>

  <div id="status">â³ æ­£åœ¨åˆå§‹åŒ–...</div>

  <div id="tokenModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ” è¯·è¾“å…¥ GitHub Tokenï¼š</h3>
      <input type="password" id="tokenInput" placeholder="ghp_xxx æˆ– github_pat_xxx" />
      <button style="margin-top:10px;" onclick="saveToken()">ä¿å­˜ Token</button>
    </div>
  </div>

  <div id="storyThemeModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ“š è¯·é€‰æ‹©æˆ–è¾“å…¥åˆ›ä½œä¸»é¢˜ï¼š</h3>
      <div class="select-container">
        <select id="themeCategorySelect"></select>
        <select id="difficultySelect"></select>
        <select id="styleSelect" multiple></select>
      </div>
      <input type="text" id="themeInput" placeholder="æˆ–æ‰‹åŠ¨è¾“å…¥..." />
      <div class="modal-buttons-container">
          <button class="generate-topics-btn" onclick="generateRandomTopics(event)">ç”Ÿæˆé¢˜ç›®</button>
          <button class="confirm-btn" onclick="confirmGenerate(event)">ç¡®å®š</button>
          <button onclick="closeThemeModal()">å–æ¶ˆ</button>
      </div>
      <p style="margin-top: 20px;">ğŸ’¡ ç‚¹å‡»ä¸‹é¢åˆ—è¡¨ä¸­çš„é¢˜ç›®æ¥ç”Ÿæˆå¾®å°è¯´ï¼š</p>
      <ul id="randomTopicsList"></ul>
    </div>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h3>âš™ï¸ ä¸ªæ€§åŒ–è®¾ç½®</h3>

      <label for="theme-select">ç•Œé¢ä¸»é¢˜</label>
      <select id="theme-select">
        <option value="">é»˜è®¤ (äº®è‰²)</option>
        <option value="theme-dark">æŠ¤çœ¼ (æš—è‰²)</option>
        <option value="theme-sepia">çº¸å¼  (ç±³è‰²)</option>
      </select>

      <label for="font-family-select">é˜…è¯»å­—ä½“</label>
      <select id="font-family-select">
        <option value="'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif">æ— è¡¬çº¿ä½“ (é»˜è®¤)</option>
        <option value="'Georgia', 'Noto Serif SC', 'Songti SC', serif">è¡¬çº¿ä½“</option>
        <option value="'Courier New', 'SFMono-Regular', 'Consolas', monospace">ç­‰å®½å­—ä½“</option>
      </select>

      <label for="font-size-select">å†…å®¹å­—å·</label>
      <select id="font-size-select">
          <option value="15px">å°</option>
          <option value="17px">ä¸­ (é»˜è®¤)</option>
          <option value="19px">å¤§</option>
          <option value="21px">ç‰¹å¤§</option>
      </select>

      <label for="line-height-select">æ®µè½è¡Œé«˜</label>
      <select id="line-height-select">
          <option value="1.4">ç´§å‡‘</option>
          <option value="1.6">é€‚ä¸­ (é»˜è®¤)</option>
          <option value="1.8">å®½æ¾</option>
      </select>

      <hr style="border: 0; border-top: 1px solid var(--textarea-border-color); margin: 20px 0;">

      <label for="ai-provider-select">AI æ¨¡å‹æœåŠ¡å•†</label>
      <select id="ai-provider-select">
        <option value="kimi">Kimi</option>
        <option value="zhipu">æ™ºè°± (Zhipu)</option>
        <option value="custom">è‡ªå®šä¹‰</option>
      </select>

      <div id="ai-kimi-inputs" class="ai-inputs">
        <label for="ai-kimi-api-key">Kimi API Key</label>
        <input type="password" id="ai-kimi-api-key" placeholder="sk-xxx" />
        <label for="ai-kimi-model-name">Kimi æ¨¡å‹åç§°</label>
        <input type="text" id="ai-kimi-model-name" placeholder="moonshot-v1-8k" />
      </div>

      <div id="ai-zhipu-inputs" class="ai-inputs">
        <label for="ai-zhipu-api-key">æ™ºè°± API Key</label>
        <input type="password" id="ai-zhipu-api-key" placeholder="sk-xxx" />
        <label for="ai-zhipu-model-name">æ™ºè°± æ¨¡å‹åç§°</label>
        <input type="text" id="ai-zhipu-model-name" placeholder="glm-4" />
      </div>

      <div id="ai-custom-inputs" class="ai-inputs">
        <label for="ai-api-url">è‡ªå®šä¹‰ API URL</label>
        <input type="text" id="ai-api-url" placeholder="ä¾‹å¦‚ï¼šhttps://api.example.com/v1/chat/completions" />
        <label for="ai-custom-api-key">è‡ªå®šä¹‰ API Key</label>
        <input type="password" id="ai-custom-api-key" placeholder="sk-xxx" />
        <label for="ai-custom-model-name">è‡ªå®šä¹‰ æ¨¡å‹åç§°</label>
        <input type="text" id="ai-custom-model-name" placeholder="ä¾‹å¦‚ï¼šgpt-3.5-turbo" />
      </div>

      <label for="analysis-prompt-input">AI åˆ†ææŒ‡ä»¤ (System Prompt)</label>
      <textarea id="analysis-prompt-input" rows="3" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä½è¯­è¨€ä¸“å®¶ï¼Œè¯·åˆ†æå¥å­çš„è¯­æ³•ç»“æ„..."></textarea>

      <hr style="border: 0; border-top: 1px solid var(--textarea-border-color); margin: 20px 0;">

      <h4>æœ—è¯»è®¾ç½®</h4>
      <label for="tts-urls">TTS API URLs (å¤šä¸ªç”¨é€—å·åˆ†éš”)</label>
      <input type="text" id="tts-urls" placeholder="ä¾‹å¦‚: https://your-tts-api.com/api/aiyue" />

      <label for="tts-voice-name">TTS è¯­éŸ³åç§°</label>
      <input type="text" id="tts-voice-name" placeholder="ä¾‹å¦‚: en-US-EricNeural" />

      <div class="cache-info">
          <span id="cacheSizeDisplay">åˆ†æç¼“å­˜: 0</span> | <a onclick="clearAICache()">æ¸…ç©ºç¼“å­˜</a>
      </div>

      <div class="modal-buttons">
          <button class="delete" onclick="resetToken()">é‡è®¾ Token</button>
          <button onclick="saveAndApplySettings()">ä¿å­˜å¹¶å…³é—­</button>
      </div>
    </div>
  </div>

  <div id="styleManagementModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ¨ ç®¡ç†åˆ›ä½œé£æ ¼</h3>
      <div class="style-input-container">
        <input type="text" id="addStyleInput" placeholder="è¾“å…¥æ–°é£æ ¼åç§°..." />
        <button onclick="addCustomStyle()">æ·»åŠ </button>
      </div>
      <ul id="customStyleList"></ul>
      <button style="margin-top: 20px;" onclick="closeStyleManagementModal()">å®Œæˆ</button>
    </div>
  </div>

  <div id="aiResultModal" class="modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0;">ğŸª„ AI æ·±åº¦åˆ†æ</h3>
        <button onclick="closeModal('aiResultModal')" style="background:transparent; color:var(--text-color); border:none; font-size:20px; padding:0; min-width:auto; min-height:auto;">âœ•</button>
      </div>
      <div class="original-sentence-box" id="aiOriginalSentence"></div>
      <div id="aiResultContent"></div>
      <p style="text-align:center; font-size:12px; color:#999; margin-top:20px;">åŒå‡»ä»»æ„å¤„å…³é—­å¼¹çª—</p>
    </div>
  </div>


  <script>
    const GITHUB_USERNAME = "moodHappy";
    const GITHUB_REPO = "HelloWorld";
    const WORD_FILE_PATH_GITHUB = "Notes/transfer.txt";
    const SETTINGS_KEY = "github_sync_assistant_settings";
    const CUSTOM_STYLES_KEY = "github_sync_assistant_custom_styles";
    const LAST_CLICKED_KEY = 'ai_reader_last_clicked_index';
    const CACHE_PREFIX = 'ai_analyze_cache_v1_';

    const DEFAULT_KIMI_API_URL = "https://api.moonshot.cn/v1/chat/completions";
    const DEFAULT_KIMI_MODEL = "moonshot-v1-8k";

    const DEFAULT_ZHIPU_API_URL = "https://open.bigmodel.cn/api/paas/v4/chat/completions";
    const DEFAULT_ZHIPU_MODEL = "glm-4";

    const DEFAULT_ANALYSIS_PROMPT = "ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­è‹±æ–‡çš„è¯­è¨€ä¸“å®¶ã€‚è¯·åˆ†ææˆ‘æä¾›çš„å¥å­ï¼š\n1. åˆ¤æ–­éš¾åº¦ç­‰çº§ (A1-C2)ã€‚\n2. è¯¦ç»†è§£é‡Šæ ¸å¿ƒè¯­æ³•ç»“æ„ã€‚\n3. æä¾›å‡†ç¡®ã€ä¼˜ç¾çš„ä¸­æ–‡ç¿»è¯‘ã€‚\nè¯·ä½¿ç”¨ Markdown æ ¼å¼è¾“å‡ºã€‚";

    // Default TTS settings
    const DEFAULT_TTS_URLS = 'https://ms-ra-forwarder-for-ifreetime-2.vercel.app/';
    const DEFAULT_TTS_VOICE = 'en-US-EricNeural';

    let GITHUB_TOKEN = localStorage.getItem("github_token") || null;
    const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${WORD_FILE_PATH_GITHUB}`;

    const textarea = document.getElementById("inputContent");
    const renderedDiv = document.getElementById("renderedContent");
    const statusDiv = document.getElementById("status");
    const tokenModal = document.getElementById("tokenModal");
    const settingsModal = document.getElementById("settingsModal");
    const storyThemeModal = document.getElementById("storyThemeModal");
    const themeInput = document.getElementById("themeInput");
    const randomTopicsList = document.getElementById("randomTopicsList");
    const generateTopicsBtn = document.querySelector('.generate-topics-btn');
    const rootElement = document.documentElement;

    // AI Settings Elements
    const aiProviderSelect = document.getElementById('ai-provider-select');
    const aiKimiInputsDiv = document.getElementById('ai-kimi-inputs');
    const aiZhipuInputsDiv = document.getElementById('ai-zhipu-inputs');
    const aiCustomInputsDiv = document.getElementById('ai-custom-inputs');
    const aiKimiApiKeyInput = document.getElementById('ai-kimi-api-key');
    const aiKimiModelNameInput = document.getElementById('ai-kimi-model-name');
    const aiZhipuApiKeyInput = document.getElementById('ai-zhipu-api-key');
    const aiZhipuModelNameInput = document.getElementById('ai-zhipu-model-name');
    const aiApiUrlInput = document.getElementById('ai-api-url');
    const aiCustomApiKeyInput = document.getElementById('ai-custom-api-key');
    const aiCustomModelNameInput = document.getElementById('ai-custom-model-name');
    const analysisPromptInput = document.getElementById('analysis-prompt-input');

    // TTS Settings Elements
    const ttsUrlsInput = document.getElementById('tts-urls');
    const ttsVoiceNameInput = document.getElementById('tts-voice-name');

    // Theme & Difficulty Elements
    const themeCategorySelect = document.getElementById('themeCategorySelect');
    const difficultySelect = document.getElementById('difficultySelect');
    const styleSelect = document.getElementById('styleSelect');

    // Style Management Elements
    const styleManagementModal = document.getElementById('styleManagementModal');
    const addStyleInput = document.getElementById('addStyleInput');
    const customStyleList = document.getElementById('customStyleList');

    // --- THEME & STYLE LIBRARY ---
    const THEME_LIBRARY = {
        'æ—¥å¸¸ç”Ÿæ´»ç±»': [], 'æ‚¬ç–‘ä¸æ¨ç†ç±»': [], 'ç§‘å¹»ä¸å¥‡å¹»ç±»': [], 'å†å²ä¸ç°å®ä¸»ä¹‰ç±»': [],
        'å“²ç†ä¸å¯“è¨€ç±»': [], 'çˆ±æƒ…ä¸æƒ…æ„Ÿç±»': [], 'å¿ƒç†ä¸æƒ…ç»ªç±»': [], 'å¹½é»˜ä¸è®½åˆºç±»': [], 'å¥‡é‡ä¸å†’é™©ç±»': [],
    };
    const DIFFICULTY_LEVELS = ['A1 (å…¥é—¨)', 'A2 (åˆçº§)', 'B1 (ä¸­çº§)', 'B2 (ä¸­é«˜çº§)', 'C1 (é«˜çº§)', 'C2 (ç²¾é€š)'];
    const BUILT_IN_STYLES = ['å£è¯­é£æ ¼','ç®€æ´é£æ ¼','å™äº‹é£æ ¼','ä¹¦é¢é£æ ¼','æ–°é—»é£æ ¼','å¹½é»˜é£æ ¼','è®½åˆºé£æ ¼','é»‘é•œé£æ ¼','æ–‡å­¦é£æ ¼','å“²ç†é£æ ¼','å•†ä¸šé£æ ¼','å­¦æœ¯é£æ ¼'];

    // --- Settings Management ---
    const defaultSettings = {
        theme: '',
        fontFamily: "'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif",
        fontSize: '17px',
        lineHeight: '1.6',
        aiProvider: 'kimi',
        aiKimiApiKey: '',
        aiKimiModelName: DEFAULT_KIMI_MODEL,
        aiZhipuApiKey: '',
        aiZhipuModelName: DEFAULT_ZHIPU_MODEL,
        aiApiUrl: '',
        aiCustomApiKey: '',
        aiCustomModelName: '',
        ttsUrls: DEFAULT_TTS_URLS,
        ttsVoiceName: DEFAULT_TTS_VOICE,
        analysisPrompt: DEFAULT_ANALYSIS_PROMPT
    };

    function applySettings(settings) {
        document.body.className = settings.theme || '';
        rootElement.style.setProperty('--primary-font', settings.fontFamily);
        rootElement.style.setProperty('--font-size', settings.fontSize);
        rootElement.style.setProperty('--line-height', settings.lineHeight);
        aiProviderSelect.value = settings.aiProvider;
        updateAIInputsVisibility(settings.aiProvider);
    }

    function loadSettings() {
        const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY));
        const currentSettings = { ...defaultSettings, ...savedSettings };
        applySettings(currentSettings);

        aiKimiApiKeyInput.value = currentSettings.aiKimiApiKey;
        aiKimiModelNameInput.value = currentSettings.aiKimiModelName;
        aiZhipuApiKeyInput.value = currentSettings.aiZhipuApiKey;
        aiZhipuModelNameInput.value = currentSettings.aiZhipuModelName;
        aiApiUrlInput.value = currentSettings.aiApiUrl;
        aiCustomApiKeyInput.value = currentSettings.aiCustomApiKey;
        aiCustomModelNameInput.value = currentSettings.aiCustomModelName;
        ttsUrlsInput.value = currentSettings.ttsUrls;
        ttsVoiceNameInput.value = currentSettings.ttsVoiceName;
        analysisPromptInput.value = currentSettings.analysisPrompt || DEFAULT_ANALYSIS_PROMPT;
        
        updateCacheDisplay();
    }

    function updateAIInputsVisibility(provider) {
        aiKimiInputsDiv.style.display = provider === 'kimi' ? 'block' : 'none';
        aiZhipuInputsDiv.style.display = provider === 'zhipu' ? 'block' : 'none';
        aiCustomInputsDiv.style.display = provider === 'custom' ? 'block' : 'none';
    }

    aiProviderSelect.addEventListener('change', (event) => updateAIInputsVisibility(event.target.value));

    function openSettingsModal() {
        loadSettings(); // Reload to ensure inputs are fresh
        settingsModal.style.display = "flex";
    }

    function closeSettingsModal() { settingsModal.style.display = "none"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }

    function saveAndApplySettings() {
        const newSettings = {
            theme: document.getElementById('theme-select').value,
            fontFamily: document.getElementById('font-family-select').value,
            fontSize: document.getElementById('font-size-select').value,
            lineHeight: document.getElementById('line-height-select').value,
            aiProvider: aiProviderSelect.value,
            aiKimiApiKey: aiKimiApiKeyInput.value,
            aiKimiModelName: aiKimiModelNameInput.value,
            aiZhipuApiKey: aiZhipuApiKeyInput.value,
            aiZhipuModelName: aiZhipuModelNameInput.value,
            aiApiUrl: aiApiUrlInput.value,
            aiCustomApiKey: aiCustomApiKeyInput.value,
            aiCustomModelName: aiCustomModelNameInput.value,
            ttsUrls: ttsUrlsInput.value,
            ttsVoiceName: ttsVoiceNameInput.value,
            analysisPrompt: analysisPromptInput.value
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(newSettings));
        applySettings(newSettings);
        closeSettingsModal();
        statusDiv.textContent = "âš™ï¸ è®¾ç½®å·²ä¿å­˜ã€‚";
    }

    // --- Cache Management ---
    function generateCacheKey(text, prompt) {
        let str = text + "|" + prompt;
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = ((hash << 5) - hash) + str.charCodeAt(i) | 0;
        return CACHE_PREFIX + Math.abs(hash);
    }
    function getFromCache(key) {
        const item = JSON.parse(localStorage.getItem(key));
        if (!item) return null;
        if (Date.now() - item.timestamp > 86400000) { // 24 hours
            localStorage.removeItem(key);
            return null;
        }
        return item.content;
    }
    function saveToCache(key, content) {
        try {
            localStorage.setItem(key, JSON.stringify({ content, timestamp: Date.now() }));
            updateCacheDisplay();
        } catch(e) { clearAICache(); }
    }
    function updateCacheDisplay() {
        let count = 0;
        for(let i=0; i<localStorage.length; i++) if(localStorage.key(i).startsWith(CACHE_PREFIX)) count++;
        const el = document.getElementById('cacheSizeDisplay');
        if(el) el.innerText = `åˆ†æç¼“å­˜: ${count}`;
    }
    function clearAICache() {
        Object.keys(localStorage).forEach(k => k.startsWith(CACHE_PREFIX) && localStorage.removeItem(k));
        updateCacheDisplay();
        statusDiv.textContent = "ğŸ—‘ï¸ ç¼“å­˜å·²æ¸…ç©ºã€‚";
    }

    // --- Token & GitHub Logic ---
    function ensureToken() { if (!GITHUB_TOKEN) tokenModal.style.display = "flex"; }
    function saveToken() {
      const token = document.getElementById("tokenInput").value.trim();
      if (!token.startsWith("ghp_") && !token.startsWith("github_pat_")) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ GitHub Tokenï¼"); return; }
      localStorage.setItem("github_token", token);
      GITHUB_TOKEN = token;
      tokenModal.style.display = "none";
      statusDiv.textContent = "â³ æ­£åœ¨åŠ è½½ GitHub å†…å®¹...";
      loadContent();
    }
    function resetToken() {
      if (confirm("ç¡®å®šè¦æ¸…é™¤ Token å—ï¼Ÿ")) {
        localStorage.removeItem("github_token"); GITHUB_TOKEN = null;
        closeSettingsModal(); ensureToken();
      }
    }
    function getHeaders() { return { Authorization: `Bearer ${GITHUB_TOKEN}`, Accept: "application/vnd.github.v3+json" }; }
    
    async function getCurrentFileShaAndContent() {
      try {
        const res = await fetch(apiUrl, { headers: getHeaders() });
        if (res.status === 404) return { sha: null, content: "" };
        if (!res.ok) throw new Error(`GitHub çŠ¶æ€ç  ${res.status}`);
        const data = await res.json();
        const decoded = decodeURIComponent(escape(atob(data.content)));
        return { sha: data.sha, content: decoded };
      } catch (err) {
        statusDiv.textContent = `âŒ è¯»å–å¤±è´¥: ${err.message}`; return { sha: null, content: "" };
      }
    }

    async function submitContent() {
      const content = textarea.value.trim();
      if (!content) return alert("è¯·è¾“å…¥å†…å®¹å†æäº¤ï¼");
      statusDiv.textContent = "ğŸ”„ æ­£åœ¨æäº¤åˆ° GitHub...";
      const { sha } = await getCurrentFileShaAndContent();
      const encodedContent = btoa(unescape(encodeURIComponent(content)));
      const res = await fetch(apiUrl, {
        method: "PUT", headers: { ...getHeaders(), "Content-Type": "application/json" },
        body: JSON.stringify({ message: `Update ${WORD_FILE_PATH_GITHUB}`, content: encodedContent, committer: { name: "GitHub Sync Assistant", email: "bot@example.com" }, ...(sha ? { sha } : {}) })
      });
      if (res.ok) { renderMode(content); statusDiv.textContent = "âœ… æäº¤æˆåŠŸã€‚"; }
      else { statusDiv.textContent = "âŒ æäº¤å¤±è´¥ï¼š" + (await res.json()).message; }
    }

    async function deleteContent() {
      if (!confirm("ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ")) return;
      const { sha } = await getCurrentFileShaAndContent();
      if (!sha) { textarea.value = ""; editMode(); return; }
      const res = await fetch(apiUrl, {
        method: "PUT", headers: { ...getHeaders(), "Content-Type": "application/json" },
        body: JSON.stringify({ message: `Empty ${WORD_FILE_PATH_GITHUB}`, content: btoa(""), sha, committer: { name: "GitHub Sync Assistant", email: "bot@example.com" } })
      });
      if (res.ok) { textarea.value = ""; editMode(); statusDiv.textContent = "âœ… å†…å®¹å·²æ¸…ç©ºã€‚"; }
    }

    // --- AI Logic (Generic) ---
    function getAIConfig() {
      const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || defaultSettings;
      let aiApiUrl, aiApiKey, aiModelName;
      switch (savedSettings.aiProvider) {
        case 'kimi': aiApiUrl = DEFAULT_KIMI_API_URL; aiApiKey = savedSettings.aiKimiApiKey; aiModelName = savedSettings.aiKimiModelName || DEFAULT_KIMI_MODEL; break;
        case 'zhipu': aiApiUrl = DEFAULT_ZHIPU_API_URL; aiApiKey = savedSettings.aiZhipuApiKey; aiModelName = savedSettings.aiZhipuModelName || DEFAULT_ZHIPU_MODEL; break;
        case 'custom': aiApiUrl = savedSettings.aiApiUrl; aiApiKey = savedSettings.aiCustomApiKey; aiModelName = savedSettings.aiCustomModelName; break;
      }
      return { aiApiUrl, aiApiKey, aiModelName };
    }

    async function callAI(userPrompt, systemPromptOverride = null) {
      const { aiApiUrl, aiApiKey, aiModelName } = getAIConfig();
      if (!aiApiKey) throw new Error("âŒ è¯·åœ¨è®¾ç½®ä¸­è¾“å…¥ AI çš„ API Keyï¼");
      
      const systemContent = systemPromptOverride || "You are a helpful assistant.";

      const response = await fetch(aiApiUrl, {
        method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${aiApiKey}` },
        body: JSON.stringify({
          model: aiModelName,
          messages: [{ role: "system", content: systemContent }, { role: "user", content: userPrompt }],
          temperature: 0.7
        })
      });
      if (!response.ok) throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
      const data = await response.json();
      return data.choices[0].message.content.trim();
    }

    // --- Generation Features ---
    function openThemeModal() {
      storyThemeModal.style.display = "flex"; themeInput.value = ""; randomTopicsList.innerHTML = "";
      populateThemeSelectors(); populateStyleSelector();
    }
    function closeThemeModal() { storyThemeModal.style.display = "none"; }
    
    function populateThemeSelectors() {
        themeCategorySelect.innerHTML = '<option value="" disabled selected>é€‰æ‹©åˆ†ç±»</option>';
        for (const cat in THEME_LIBRARY) { let o = document.createElement('option'); o.value=cat; o.text=cat; themeCategorySelect.add(o); }
        difficultySelect.innerHTML = '';
        DIFFICULTY_LEVELS.forEach(l => { let o = document.createElement('option'); o.value=l.split(' ')[0]; o.text=l; if(l.startsWith('B1')) o.selected=true; difficultySelect.add(o); });
        themeCategorySelect.onchange = () => themeInput.value = '';
    }

    function populateStyleSelector() {
        styleSelect.innerHTML = '';
        const allStyles = [...BUILT_IN_STYLES, ...(JSON.parse(localStorage.getItem(CUSTOM_STYLES_KEY)) || [])];
        styleSelect.add(new Option('ç®¡ç†é£æ ¼...', 'manage'));
        allStyles.forEach(s => styleSelect.add(new Option(s, s)));
        styleSelect.onchange = (e) => {
            if(e.target.value === 'manage') { e.target.selectedOptions[0].selected = false; openStyleManagementModal(); }
        };
    }

    // Style Management
    function openStyleManagementModal() { populateCustomStyleList(); styleManagementModal.style.display = "flex"; storyThemeModal.style.display = "none"; }
    function closeStyleManagementModal() { styleManagementModal.style.display = "none"; populateStyleSelector(); }
    function populateCustomStyleList() {
        const styles = JSON.parse(localStorage.getItem(CUSTOM_STYLES_KEY)) || [];
        customStyleList.innerHTML = styles.length ? '' : '<li style="color:#999">æš‚æ— è‡ªå®šä¹‰é£æ ¼</li>';
        styles.forEach(s => {
            let li = document.createElement('li'); li.innerHTML = `${s} <button class="delete-style-btn" onclick="deleteCustomStyle('${s}')">åˆ é™¤</button>`;
            customStyleList.appendChild(li);
        });
    }
    window.addCustomStyle = () => {
        const val = addStyleInput.value.trim();
        const styles = JSON.parse(localStorage.getItem(CUSTOM_STYLES_KEY)) || [];
        if(val && !styles.includes(val) && !BUILT_IN_STYLES.includes(val)) {
            styles.push(val); localStorage.setItem(CUSTOM_STYLES_KEY, JSON.stringify(styles));
            addStyleInput.value = ""; populateCustomStyleList();
        }
    };
    window.deleteCustomStyle = (val) => {
        let styles = JSON.parse(localStorage.getItem(CUSTOM_STYLES_KEY)) || [];
        localStorage.setItem(CUSTOM_STYLES_KEY, JSON.stringify(styles.filter(s => s !== val)));
        populateCustomStyleList();
    };

    async function generateRandomTopics(e) {
        if(e) e.preventDefault();
        const theme = themeInput.value.trim() || themeCategorySelect.value;
        if (!theme) return statusDiv.textContent = "ğŸ¤” è¯·å…ˆé€‰æ‹©åˆ†ç±»æˆ–è¾“å…¥ä¸»é¢˜";
        
        generateTopicsBtn.innerText = "ç”Ÿæˆä¸­..."; generateTopicsBtn.disabled = true;
        try {
            const txt = await callAI(`Based on theme "${theme}", generate 5 creative short story titles in Simplified Chinese. Return only the titles, one per line.`);
            randomTopicsList.innerHTML = "";
            txt.split('\n').filter(t=>t.trim()).forEach(t => {
                let li = document.createElement('li');
                li.textContent = t.replace(/^\d+\.\s*/, '').replace(/["ã€Šã€‹]/g, '');
                li.onclick = () => startGeneration(li.textContent);
                randomTopicsList.appendChild(li);
            });
            statusDiv.textContent = "âœ… é¢˜ç›®å·²ç”Ÿæˆ";
        } catch(err) { statusDiv.textContent = "âŒ å¤±è´¥: " + err.message; }
        finally { generateTopicsBtn.innerText = "ç”Ÿæˆé¢˜ç›®"; generateTopicsBtn.disabled = false; }
    }

    function confirmGenerate(e) {
        if(e) e.preventDefault();
        let t = themeInput.value.trim() || themeCategorySelect.value;
        if(t && t !== 'é€‰æ‹©åˆ†ç±»') startGeneration(t);
        else statusDiv.textContent = "ğŸ¤” è¯·è¾“å…¥é¢˜ç›®æˆ–é€‰æ‹©åˆ†ç±»";
    }

    async function startGeneration(topic) {
        const diff = difficultySelect.value || 'B1';
        const styles = Array.from(styleSelect.selectedOptions).map(o=>o.value).filter(v=>v!=='manage');
        const styleStr = styles.length ? ` in a ${styles.join(' and ')} style.` : '.';
        const prompt = `Write a short story in English, about 100 words, **CEFR Level ${diff}**, based on the Chinese title or theme: "${topic}"${styleStr}`;
        
        statusDiv.textContent = `âœï¸ æ­£åœ¨åˆ›ä½œ (${diff})...`;
        closeThemeModal(); editMode();
        try {
            const txt = await callAI(prompt);
            textarea.value = txt;
            statusDiv.textContent = "âœ… åˆ›ä½œæˆåŠŸï¼Œæ­£åœ¨æäº¤...";
            await submitContent();
        } catch(e) { statusDiv.textContent = `âŒ å¤±è´¥: ${e.message}`; }
    }

    // --- Content Rendering & Magic Wand Injection ---
    function renderMode(text) {
      renderedDiv.innerHTML = "";
      // æ™®é€šæ¸²æŸ“
      const paragraphs = text.split(/\n{2,}/);
      for (const para of paragraphs) {
        if (para.trim()) {
          const p = document.createElement("p");
          p.textContent = para.trim();
          renderedDiv.appendChild(p);
        }
      }
      renderedDiv.style.display = "block";
      textarea.style.display = "none";
      // æ³¨å…¥é­”æœ¯æ£’
      injectAIButtons();
    }

    function editMode() { textarea.style.display = "block"; renderedDiv.style.display = "none"; }
    function copyContent() { navigator.clipboard.writeText(renderedDiv.style.display!=="none"?renderedDiv.innerText:textarea.value); statusDiv.textContent = "ğŸ“‹ å·²å¤åˆ¶"; }

    async function loadContent() {
      statusDiv.textContent = "â³ åŠ è½½ä¸­...";
      const { content } = await getCurrentFileShaAndContent();
      if (content.trim()) { textarea.value = content; renderMode(content); statusDiv.textContent = "âœ… å·²åŠ è½½"; }
      else { textarea.value = ""; editMode(); statusDiv.textContent = "âœ… æ–‡ä»¶ä¸ºç©º"; }
    }

    // --- Magic Wand & Analysis Logic (ç§»æ¤éƒ¨åˆ†) ---
    function injectAIButtons() {
        // æ¸…é™¤æ—§æŒ‰é’®ï¼ˆå¦‚æœæœ‰ï¼‰
        renderedDiv.querySelectorAll('.ai-analyze-btn').forEach(b => b.remove());

        const w = document.createTreeWalker(renderedDiv, NodeFilter.SHOW_TEXT);
        const nodes = []; while(w.nextNode()) nodes.push(w.currentNode);
        
        nodes.forEach(n => {
            if (n.nodeValue.includes('.')) {
                const f = document.createDocumentFragment();
                const parts = n.nodeValue.split(/(\.)/);
                parts.forEach(p => {
                    f.appendChild(document.createTextNode(p));
                    // åœ¨å¥å·åä¸”ä¸æ˜¯ç©ºå­—ç¬¦ä¸²æ—¶æ’å…¥æŒ‰é’®
                    if(p === '.') {
                        const b = document.createElement('span');
                        b.className = 'ai-analyze-btn';
                        // é­”æœ¯æ£’ SVG
                        b.innerHTML = '<svg viewBox="0 0 24 24"><path d="M7.5 5.6L10 7 8.6 4.5 10 2 7.5 3.4 5 2 6.4 4.5 5 7 7.5 5.6zm12 9.8L17 12l1.4 2.5L21 12l-2.5 3.4L21 19l-2.5-1.4L17 19l1.4-2.5L15.9 12l3.6 3.4zm-9 3.8L12 16l1.4 2.5L14.9 16l-1.4 3.2L14.9 22l-1.4-1.3L12 22l1.4-3.2L10.5 22l0-2.8zM19 2l-5 9-2-4-2 4-5-9 9 19 5-19z" style="fill:none;stroke:currentColor;stroke-width:2"/></svg>';
                        b.title = "AI åˆ†ææ­¤å¥";
                        b.onclick = (e) => handleAIAnalyzeClick(e.target);
                        f.appendChild(b);
                    }
                });
                n.parentNode.replaceChild(f, n);
            }
        });

        // æ¢å¤ä¸Šæ¬¡ç‚¹å‡»çš„é«˜äº®
        const lastIdx = localStorage.getItem(LAST_CLICKED_KEY);
        if (lastIdx !== null) {
            const allBtns = renderedDiv.querySelectorAll('.ai-analyze-btn');
            if (allBtns[lastIdx]) allBtns[lastIdx].classList.add('last-clicked');
        }
    }

    function extractSentenceBefore(node) {
        let t = "", c = node.previousSibling;
        while(c) {
            // å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹
            if(c.nodeType === 3) { 
                t = c.nodeValue + t; 
                // å¦‚æœé‡åˆ°å¥å·ï¼Œæˆªå–å¥å·åçš„éƒ¨åˆ†å¹¶åœæ­¢
                if(t.lastIndexOf('.') > -1 && t.lastIndexOf('.') < t.length-1) { 
                    t = t.substring(t.lastIndexOf('.')+1); 
                    break; 
                } 
            }
            // å¦‚æœé‡åˆ°å¦ä¸€ä¸ªåˆ†ææŒ‰é’®ï¼Œåœæ­¢
            else if(c.classList?.contains('ai-analyze-btn')) break;
            // å…¶ä»–å…ƒç´ ï¼ˆå¦‚b, iæ ‡ç­¾ï¼‰ç›´æ¥å–innerText
            else t = c.innerText + t;
            
            c = c.previousSibling;
        }
        return t.trim();
    }

    async function handleAIAnalyzeClick(target) {
        const btn = target.closest('.ai-analyze-btn');
        if (!btn) return;

        // UI Updates
        document.querySelectorAll('.ai-analyze-btn').forEach(b => b.classList.remove('last-clicked'));
        btn.classList.add('last-clicked');
        const allBtns = Array.from(document.querySelectorAll('.ai-analyze-btn'));
        localStorage.setItem(LAST_CLICKED_KEY, allBtns.indexOf(btn));

        const sentence = extractSentenceBefore(btn);
        if (!sentence || sentence.length < 2) return alert("æœªèƒ½è¯†åˆ«åˆ°æœ‰æ•ˆå¥å­");

        const modal = document.getElementById('aiResultModal');
        const box = document.getElementById('aiResultContent');
        const sentenceBox = document.getElementById('aiOriginalSentence');
        
        sentenceBox.innerText = sentence;
        box.innerHTML = '<div class="ai-loading"><div class="spinner"></div><p>æ­£åœ¨åˆ†æè¯­æ³•ä¸ç»“æ„...</p></div>';
        modal.style.display = 'flex';

        // Cache & API Logic
        const settings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || defaultSettings;
        const sysPrompt = settings.analysisPrompt || DEFAULT_ANALYSIS_PROMPT;
        const cacheKey = generateCacheKey(sentence, sysPrompt);
        
        const cached = getFromCache(cacheKey);
        if (cached) {
            box.innerHTML = `<div class="ai-result-content">${marked.parse(cached)}</div>`;
            return;
        }

        try {
            const content = await callAI(`Analyze this sentence: "${sentence}"`, sysPrompt);
            saveToCache(cacheKey, content);
            box.innerHTML = `<div class="ai-result-content">${marked.parse(content)}</div>`;
        } catch (e) {
            box.innerHTML = `<p style="color:var(--button-danger-bg)">åˆ†æå¤±è´¥: ${e.message}</p>`;
        }
    }

    // Double click to close modal
    document.getElementById('aiResultModal').addEventListener('dblclick', function(e) {
        if(e.target === this || e.target.classList.contains('modal-content')) {
            this.style.display = 'none';
        }
    });

    // --- TTS Logic ---
    let currentAudio = null, isReading = false, isPaused = false;
    
    function playSummaryTTS(text) {
        const settings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || defaultSettings;
        const urls = settings.ttsUrls.split(',').map(u => u.trim()).filter(u=>u);
        if(!urls.length) return alert("è¯·å…ˆé…ç½® TTS URL");
        
        if(currentAudio) currentAudio.pause();
        const q = new URLSearchParams({ text: text.trim(), voiceName: settings.ttsVoiceName, speed: -20 });

        function tryPlay(list) {
            if(!list.length) { isReading=false; updateTTSBtn(); return statusDiv.textContent="âŒ TTSè¿æ¥å¤±è´¥"; }
            const url = list.shift();
            const fullUrl = `${url.endsWith('/')?url:url+'/'}api/aiyue?${q}`;
            currentAudio = new Audio(fullUrl);
            currentAudio.play().then(() => {
                isReading=true; isPaused=false; updateTTSBtn(); statusDiv.textContent="ğŸ”Š æ­£åœ¨æœ—è¯»...";
                currentAudio.onended = () => { isReading=false; updateTTSBtn(); statusDiv.textContent="âœ… æœ—è¯»ç»“æŸ"; };
            }).catch(() => tryPlay(list));
        }
        tryPlay([...urls]);
    }

    function updateTTSBtn() {
        const btn = document.querySelector('.read');
        btn.textContent = isReading ? 'åœæ­¢' : 'æœ—è¯»';
    }

    function readContent() {
        if(isReading) { if(currentAudio) currentAudio.pause(); isReading=false; updateTTSBtn(); statusDiv.textContent="â¹ å·²åœæ­¢"; }
        else { playSummaryTTS(renderedDiv.style.display!=='none' ? renderedDiv.innerText : textarea.value); }
    }

    // --- Events & Init ---
    window.onclick = (e) => {
        if(e.target.classList.contains('modal')) e.target.style.display = "none";
    };
    window.onload = () => {
        loadSettings(); ensureToken();
        if(GITHUB_TOKEN) loadContent();
        else statusDiv.textContent = "ğŸ‘‹ æ¬¢è¿ï¼è¯·å…ˆè®¾ç½® GitHub Tokenã€‚";
    };
  </script>
</body>
</html>