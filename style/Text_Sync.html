<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>GitHub åŒæ­¥åŠ©æ‰‹ (è‡ªå®šä¹‰æ–‡ä»¶å¤¹ç‰ˆ)</title>

  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/sync_text.png">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/moodHappy/moodHappy.gitHub.io-nce/refs/heads/main/icon/sync_text.png">

  <style>
    /* CSS å˜é‡å®šä¹‰ */
    :root {
      --bg-color: #f9f9f9;
      --text-color: #222;
      --textarea-bg-color: #fff;
      --textarea-border-color: #ccc;
      --article-bg-color: #fff;
      --article-border-color: #ccc;
      --status-color: #444;
      --button-primary-bg: #4CAF50;
      --button-secondary-bg: #2196F3;
      --button-danger-bg: #f44336;
      --button-read-bg: #e6b800;
      --button-push-bg: #FF9800;
      --modal-bg: rgba(0,0,0,0.5);
      --modal-content-bg: #fff;
      --input-border-color: #aaa;
      --settings-icon-color: #333;
      --primary-font: 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      --font-size: 17px;
      --line-height: 1.6;
    }

    /* æš—è‰²ä¸»é¢˜ */
    body.theme-dark {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --textarea-bg-color: #1e1e1e;
      --textarea-border-color: #444;
      --article-bg-color: #1e1e1e;
      --article-border-color: #444;
      --status-color: #aaa;
      --modal-content-bg: #2d2d2d;
      --input-border-color: #555;
      --settings-icon-color: #ccc;
    }

    /* ç±³è‰²ä¸»é¢˜ */
    body.theme-sepia {
      --bg-color: #f4f0e8;
      --text-color: #5b4636;
      --textarea-bg-color: #fdfaf3;
      --textarea-border-color: #dcd3c3;
      --article-bg-color: #fdfaf3;
      --article-border-color: #dcd3c3;
      --status-color: #5b4636;
      --modal-content-bg: #fdfaf3;
      --input-border-color: #c9bca8;
      --settings-icon-color: #5b4636;
    }

    body {
      font-family: var(--primary-font);
      background: var(--bg-color);
      color: var(--text-color);
      padding: 1em;
      transition: background-color 0.3s, color 0.3s;
    }

    textarea, article.immersive-content {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      padding: 12px;
      font-size: var(--font-size);
      line-height: var(--line-height);
      background-color: var(--article-bg-color);
      border: 1px solid var(--article-border-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    textarea { min-height: 150px; resize: vertical; background-color: var(--textarea-bg-color); border-color: var(--textarea-border-color); }

    .button-row { display: flex; flex-wrap: nowrap; gap: 10px; margin-bottom: 10px; width: 100%; }

    button {
      padding: 10px 0; font-size: 16px; border-radius: 6px; border: none; color: white;
      cursor: pointer; background-color: var(--button-primary-bg); min-height: 44px;
      flex: 1; transition: background-color 0.3s; white-space: nowrap;
    }

    button:disabled { background-color: #999; cursor: not-allowed; }
    button.copy { background-color: var(--button-secondary-bg); }
    button.delete { background-color: var(--button-danger-bg); }
    button.read { background-color: var(--button-read-bg); }
    button.push { background-color: var(--button-push-bg); }
    button.secondary { background-color: #777; }

    #status { margin-top: 10px; color: var(--status-color); font-size: 14px; }

    #settings-icon { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: var(--settings-icon-color); }

    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--modal-bg); display: none; justify-content: center; align-items: center;
      z-index: 999; backdrop-filter: blur(2px);
    }

    .modal-content {
      background: var(--modal-content-bg); color: var(--text-color); padding: 20px;
      border-radius: 12px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .modal-content h3 { margin-top: 0; }
    .modal-content label { display: block; margin-top: 15px; font-size: 14px; color: var(--status-color); }
    .modal-content input, .modal-content select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid var(--input-border-color); background: var(--textarea-bg-color); color: var(--text-color); box-sizing: border-box; }
    .modal-buttons { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; padding-top: 10px; border-top: 1px solid var(--textarea-border-color); }
    
    .checkbox-row { display: flex; align-items: center; margin-top: 10px; }
    .checkbox-row input { width: auto; margin-right: 8px; margin-top: 0; }

    article.immersive-content p { margin-bottom: 1em; white-space: pre-wrap; }

    @media (max-width: 600px) {
        .modal { align-items: flex-end; }
        .modal-content { width: 100%; max-width: 100%; margin: 0; border-radius: 20px 20px 0 0; }
        .button-row { gap: 8px; }
    }
  </style>
</head>
<body>
  <div id="settings-icon" title="è®¾ç½®" onclick="openSettingsModal()">âš™ï¸</div>
  <h2>ğŸ“¤ GitHub åŒæ­¥åŠ©æ‰‹</h2>

  <div class="button-row">
    <button onclick="submitContent()">æäº¤</button>
    <button class="push" onclick="openPushModal()">æ¨é€</button>
    <button class="delete" onclick="deleteContent()">åˆ é™¤</button>
  </div>

  <div class="button-row">
    <button class="copy" onclick="copyContent()">å¤åˆ¶</button>
    <button class="read" onclick="readContent()">æœ—è¯»</button>
    <button onclick="editMode()" style="background-color:#607d8b;">ç¼–è¾‘æ¨¡å¼</button>
  </div>

  <textarea id="inputContent" placeholder="è¯·è¾“å…¥å†…å®¹ï¼ˆé¦–æ®µå°†è‡ªåŠ¨ä½œä¸ºæ¨é€æ ‡é¢˜ï¼‰..."></textarea>
  <article id="renderedContent" class="immersive-content" style="display:none;"></article>

  <div id="status">â³ æ­£åœ¨åˆå§‹åŒ–...</div>

  <div id="tokenModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ” è¯·è¾“å…¥ GitHub Tokenï¼š</h3>
      <input type="password" id="tokenInput" placeholder="ghp_xxx æˆ– github_pat_xxx" />
      <button style="margin-top:10px; width:100%;" onclick="saveToken()">ä¿å­˜ Token</button>
    </div>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h3>âš™ï¸ ä¸ªæ€§åŒ–è®¾ç½®</h3>
      <label>ç•Œé¢ä¸»é¢˜</label>
      <select id="theme-select">
        <option value="">é»˜è®¤ (äº®è‰²)</option>
        <option value="theme-dark">æŠ¤çœ¼ (æš—è‰²)</option>
        <option value="theme-sepia">çº¸å¼  (ç±³è‰²)</option>
      </select>
      <label>å†…å®¹å­—å·</label>
      <select id="font-size-select">
          <option value="15px">å°</option>
          <option value="17px">ä¸­</option>
          <option value="19px">å¤§</option>
          <option value="21px">ç‰¹å¤§</option>
      </select>
      <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
      <label>TTS API URL</label>
      <input type="text" id="tts-urls" placeholder="https://..." />
      <label>TTS è¯­éŸ³åç§°</label>
      <input type="text" id="tts-voice-name" placeholder="en-US-EricNeural" />
      <div class="modal-buttons">
          <button class="delete" onclick="resetToken()">é‡ç½® Token</button>
          <button onclick="saveAndApplySettings()">å®Œæˆ</button>
      </div>
    </div>
  </div>

  <div id="pushModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ“‚ é€‰æ‹©æ¨é€ä½ç½®</h3>
      <label>é€‰æ‹©å†å²æ–‡ä»¶å¤¹</label>
      <select id="folderSelect" onchange="document.getElementById('newFolderInput').value = ''">
          </select>
      
      <label>æˆ–è¾“å…¥æ–°æ–‡ä»¶å¤¹è·¯å¾„ (ä¾‹: Notes/Daily)</label>
      <input type="text" id="newFolderInput" placeholder="è¾“å…¥è·¯å¾„..." />

      <div class="checkbox-row">
          <input type="checkbox" id="setDefaultFolder" checked>
          <label for="setDefaultFolder" style="display:inline; margin:0;">è®¾ä¸ºé»˜è®¤è·¯å¾„</label>
      </div>

      <div class="modal-buttons">
          <button class="secondary" onclick="document.getElementById('pushModal').style.display='none'">å–æ¶ˆ</button>
          <button class="push" onclick="confirmPush()">ç¡®è®¤æ¨é€</button>
      </div>
    </div>
  </div>

  <script>
    const GITHUB_USERNAME = "moodHappy";
    const GITHUB_REPO = "HelloWorld";
    const WORD_FILE_PATH_GITHUB = "Notes/transfer.txt";
    const SETTINGS_KEY = "github_sync_pure_v2";
    
    // é»˜è®¤æ¨é€é…ç½®ï¼ˆæ‰€æœ‰è€…å’Œä»“åº“å›ºå®šï¼Œè·¯å¾„å˜ä¸ºåŠ¨æ€ï¼‰
    const PUSH_OWNER = 'moodHappy';
    const PUSH_REPO = 'moodHappy.gitHub.io-nce';
    const DEFAULT_PATH = 'Notes/danmu/Prose';

    // æ–‡ä»¶å¤¹å†å²è®°å½• Key
    const FOLDER_HISTORY_KEY = "github_push_folders";
    const DEFAULT_FOLDER_KEY = "github_push_default_folder";

    let GITHUB_TOKEN = localStorage.getItem("github_token") || null;
    const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${WORD_FILE_PATH_GITHUB}`;

    const textarea = document.getElementById("inputContent");
    const renderedDiv = document.getElementById("renderedContent");
    const statusDiv = document.getElementById("status");
    const tokenModal = document.getElementById("tokenModal");
    const settingsModal = document.getElementById("settingsModal");
    const pushModal = document.getElementById("pushModal");

    const defaultSettings = {
        theme: '', fontSize: '17px', 
        ttsUrls: 'https://ms-ra-forwarder-for-ifreetime-2.vercel.app/',
        ttsVoiceName: 'en-US-EricNeural'
    };

    // --- è®¾ç½®ç›¸å…³é€»è¾‘ ---
    function applySettings(s) {
        document.body.className = s.theme || '';
        document.documentElement.style.setProperty('--font-size', s.fontSize);
    }

    function loadSettings() {
        const s = { ...defaultSettings, ...JSON.parse(localStorage.getItem(SETTINGS_KEY)) };
        applySettings(s);
        document.getElementById('tts-urls').value = s.ttsUrls;
        document.getElementById('tts-voice-name').value = s.ttsVoiceName;
        document.getElementById('font-size-select').value = s.fontSize;
        document.getElementById('theme-select').value = s.theme;
    }

    function openSettingsModal() { settingsModal.style.display = "flex"; }

    function saveAndApplySettings() {
        const s = {
            theme: document.getElementById('theme-select').value,
            fontSize: document.getElementById('font-size-select').value,
            ttsUrls: document.getElementById('tts-urls').value,
            ttsVoiceName: document.getElementById('tts-voice-name').value
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
        applySettings(s);
        settingsModal.style.display = "none";
    }

    // --- è®¤è¯ç›¸å…³é€»è¾‘ ---
    function saveToken() {
        const t = document.getElementById("tokenInput").value.trim();
        if (t) { localStorage.setItem("github_token", t); GITHUB_TOKEN = t; tokenModal.style.display = "none"; loadContent(); }
    }

    function resetToken() { localStorage.removeItem("github_token"); location.reload(); }

    function getHeaders() { return { Authorization: `Bearer ${GITHUB_TOKEN}`, Accept: "application/vnd.github.v3+json" }; }
    function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }

    // --- åŒæ­¥ï¼ˆæäº¤/è¯»å–/åˆ é™¤ï¼‰é€»è¾‘ ---
    async function fetchFile() {
        const res = await fetch(apiUrl, { headers: getHeaders() });
        if (res.status === 404) return { sha: null, content: "" };
        const data = await res.json();
        return { sha: data.sha, content: decodeURIComponent(escape(atob(data.content))) };
    }

    async function submitContent() {
        const val = textarea.value.trim();
        if (!val) return;
        statusDiv.textContent = "ğŸ”„ æ­£åœ¨åŒæ­¥...";
        const { sha } = await fetchFile();
        const res = await fetch(apiUrl, {
            method: "PUT",
            headers: { ...getHeaders(), "Content-Type": "application/json" },
            body: JSON.stringify({ message: "Sync", content: utf8_to_b64(val), ...(sha ? { sha } : {}) })
        });
        if (res.ok) { renderMode(val); statusDiv.textContent = "âœ… åŒæ­¥æˆåŠŸ"; }
    }

    async function deleteContent() {
        if (!confirm("ç¡®å®šæ¸…ç©ºäº‘ç«¯å—ï¼Ÿ")) return;
        const { sha } = await fetchFile();
        if (!sha) return;
        await fetch(apiUrl, {
            method: "PUT", headers: { ...getHeaders(), "Content-Type": "application/json" },
            body: JSON.stringify({ message: "Empty", content: btoa(""), sha })
        });
        textarea.value = ""; editMode(); statusDiv.textContent = "ğŸ—‘ï¸ å·²æ¸…ç©º";
    }

    // --- æ¨é€é€»è¾‘ (æ–°ç‰ˆ: æ–‡ä»¶å¤¹é€‰æ‹©) ---
    
    function openPushModal() {
        const text = renderedDiv.style.display !== 'none' ? renderedDiv.innerText : textarea.value.trim();
        if (!text) return alert("å†…å®¹ä¸ºç©ºï¼Œæ— æ³•æ¨é€");

        // åŠ è½½å†å²æ–‡ä»¶å¤¹
        let folders = JSON.parse(localStorage.getItem(FOLDER_HISTORY_KEY)) || [DEFAULT_PATH];
        const defaultFolder = localStorage.getItem(DEFAULT_FOLDER_KEY) || DEFAULT_PATH;

        // ç¡®ä¿é»˜è®¤æ–‡ä»¶å¤¹åœ¨åˆ—è¡¨ä¸­
        if (!folders.includes(defaultFolder)) folders.push(defaultFolder);
        
        const select = document.getElementById('folderSelect');
        select.innerHTML = '';
        folders.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f;
            opt.text = f;
            if (f === defaultFolder) opt.selected = true;
            select.appendChild(opt);
        });

        document.getElementById('newFolderInput').value = '';
        pushModal.style.display = "flex";
    }

    async function confirmPush() {
        // è·å–ç›®æ ‡è·¯å¾„
        const select = document.getElementById('folderSelect');
        const input = document.getElementById('newFolderInput');
        let targetPath = input.value.trim() || select.value;
        
        // å»é™¤è·¯å¾„ä¸¤ç«¯çš„æ–œæ 
        targetPath = targetPath.replace(/^\/+|\/+$/g, '');

        if (!targetPath) return alert("è¯·é€‰æ‹©æˆ–è¾“å…¥ä¸€ä¸ªæ–‡ä»¶å¤¹è·¯å¾„");

        // ä¿å­˜å†å²å’Œé»˜è®¤è®¾ç½®
        let folders = JSON.parse(localStorage.getItem(FOLDER_HISTORY_KEY)) || [DEFAULT_PATH];
        if (!folders.includes(targetPath)) {
            folders.push(targetPath);
            localStorage.setItem(FOLDER_HISTORY_KEY, JSON.stringify(folders));
        }

        if (document.getElementById('setDefaultFolder').checked) {
            localStorage.setItem(DEFAULT_FOLDER_KEY, targetPath);
        }

        // å…³é—­å¼¹çª—å¹¶æ‰§è¡Œæ¨é€
        pushModal.style.display = "none";
        await executePush(targetPath);
    }

    async function executePush(targetPath) {
        const text = renderedDiv.style.display !== 'none' ? renderedDiv.innerText : textarea.value.trim();
        const btn = document.querySelector('button.push'); // æ³¨æ„ï¼šè¿™é‡Œçš„æŒ‰é’®æ˜¯ä¸»ç•Œé¢çš„æŒ‰é’®ï¼Œæ–‡å­—å˜æ›´ä»…åšæç¤º
        const oldText = btn.textContent;
        btn.textContent = "â³ æ¨é€ä¸­...";
        btn.disabled = true;

        try {
            // æå–ç¬¬ä¸€æ®µå†…å®¹ä½œä¸ºæ ‡é¢˜
            const paragraphs = text.split(/\n{2,}/);
            const rawTitle = paragraphs[0].trim().replace(/\n/g, ' '); 
            const displayTitle = rawTitle;
            // ç®€å•è¿‡æ»¤æ–‡ä»¶åéæ³•å­—ç¬¦
            let safeFilename = rawTitle.replace(/[\\/:*?"<>|#\s]/g, '_').substring(0, 50);

            const now = new Date();
            const timeStr = now.toLocaleString();
            const bodyHtml = paragraphs.map(p => `<p>${p}</p>`).join('\n');

            const fileContent = `---
title: "${displayTitle.replace(/"/g, "'")}"
date: "${timeStr}"
---
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${displayTitle}</title>
    <style>
        body { font-family: 'PingFang SC', serif; max-width: 750px; margin: 0 auto; padding: 40px 20px; line-height: 2.1; font-size: 20px; background: #fdfaf3; color: #333; }
        h1 { border-bottom: 2px solid #eee; padding-bottom: 15px; font-size: 1.6em; color: #5a4a3f; }
        .meta { color: #999; font-size: 14px; margin-bottom: 30px; }
        p { margin-bottom: 1.5em; }
    </style>
</head>
<body>
    <h1>${displayTitle}</h1>
    <div class="meta">å‘å¸ƒæ—¶é—´ï¼š${timeStr}</div>
    <div class="content">${bodyHtml}</div>
</body>
</html>`;

            const filename = `${safeFilename}_${Date.now()}.html`;
            // æ„å»ºæ–°çš„æ¨é€ URL
            const pushUrl = `https://api.github.com/repos/${PUSH_OWNER}/${PUSH_REPO}/contents/${targetPath}/${filename}`;

            const res = await fetch(pushUrl, {
                method: 'PUT',
                headers: { ...getHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Push to ${targetPath}: ${safeFilename}`, content: utf8_to_b64(fileContent) })
            });

            if(res.ok) {
                alert(`ğŸ‰ æ¨é€æˆåŠŸï¼\nğŸ“‚ è·¯å¾„ï¼š${targetPath}\nğŸ“„ æ ‡é¢˜ï¼š${displayTitle}`);
            } else {
                const errData = await res.json();
                throw new Error(errData.message || "GitHub API é”™è¯¯");
            }
        } catch (e) {
            alert("âŒ æ¨é€å¤±è´¥: " + e.message);
        } finally {
            btn.textContent = "æ¨é€"; btn.disabled = false;
        }
    }

    // --- ç•Œé¢æ¨¡å¼ä¸è¾…åŠ©åŠŸèƒ½ ---
    function renderMode(text) {
        renderedDiv.innerHTML = text.split(/\n{2,}/).map(p => `<p>${p.trim()}</p>`).join("");
        renderedDiv.style.display = "block"; textarea.style.display = "none";
    }

    function editMode() { textarea.style.display = "block"; renderedDiv.style.display = "none"; }

    async function loadContent() {
        statusDiv.textContent = "â³ åŠ è½½ä¸­...";
        const { content } = await fetchFile();
        if (content) { textarea.value = content; renderMode(content); statusDiv.textContent = "âœ… å·²åŠ è½½äº‘ç«¯å†…å®¹"; }
        else { editMode(); statusDiv.textContent = "â„¹ï¸ äº‘ç«¯æš‚æ— å†…å®¹"; }
    }

    function copyContent() {
        const text = renderedDiv.style.display !== 'none' ? renderedDiv.innerText : textarea.value;
        navigator.clipboard.writeText(text).then(() => {
            const old = statusDiv.textContent;
            statusDiv.textContent = "ğŸ“‹ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿";
            setTimeout(() => statusDiv.textContent = old, 2000);
        });
    }

    function readContent() {
        const text = renderedDiv.style.display !== 'none' ? renderedDiv.innerText : textarea.value;
        if (!text) return;
        const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || defaultSettings;
        const api = `${s.ttsUrls.replace(/\/$/, '')}/api/aiyue?text=${encodeURIComponent(text)}&voiceName=${s.ttsVoiceName}&speed=-20`;
        statusDiv.textContent = "ğŸ”Š æ­£åœ¨æœ—è¯»...";
        new Audio(api).play().catch(() => alert("TTS æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®ã€‚"));
    }

    window.onload = () => {
        loadSettings();
        if (!GITHUB_TOKEN) tokenModal.style.display = "flex";
        else loadContent();
    };
  </script>
</body>
</html>
