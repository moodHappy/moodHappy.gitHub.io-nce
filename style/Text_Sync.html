<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>GitHub åŒæ­¥åŠ©æ‰‹ (AI é˜…è¯»ç‰ˆ)</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* --- ç°ä»£æç®€é£æ ¼ CSS --- */
    :root {
      /* æ ¸å¿ƒé…è‰²ï¼šæ›´æŸ”å’Œã€ç°ä»£ */
      --bg-color: #f4f6f8;             /* æµ…ç°è“èƒŒæ™¯ */
      --card-bg: #ffffff;              /* å¡ç‰‡çº¯ç™½ */
      --text-main: #333333;
      --text-sub: #666666;
      --border-color: #e1e4e8;
      
      /* äº¤äº’è‰² */
      --primary-color: #2da44e;        /* GitHub Green */
      --danger-color: #cf222e;         /* GitHub Red */
      --action-blue: #0969da;          /* GitHub Blue */
      --action-purple: #8250df;        /* GitHub Purple */
      --action-yellow: #bf8700;        /* Gold */

      /* é˜´å½±ä¸åœ†è§’ */
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 20px;

      /* å­—ä½“ */
      --primary-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      --font-size: 16px;
      --line-height: 1.6;
      
      /* æ¨¡æ€æ¡† */
      --modal-mask: rgba(0, 0, 0, 0.4);
      --input-bg: #f6f8fa;
    }

    /* Dark Theme */
    body.theme-dark {
      --bg-color: #0d1117;
      --card-bg: #161b22;
      --text-main: #c9d1d9;
      --text-sub: #8b949e;
      --border-color: #30363d;
      --input-bg: #0d1117;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.5);
      --modal-mask: rgba(0, 0, 0, 0.7);
    }

    /* Sepia Theme */
    body.theme-sepia {
      --bg-color: #f4ecd8;
      --card-bg: #fdf6e3;
      --text-main: #5b4636;
      --text-sub: #8f7e6d;
      --border-color: #d3cbb9;
      --input-bg: #eee4cd;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: var(--primary-font);
      background: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      padding: 20px; /* å¢åŠ é¡µé¢è¾¹è· */
      transition: background 0.3s, color 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* å®¹å™¨é™åˆ¶å®½åº¦ï¼Œå¢å¼ºå¤§å±ä½“éªŒ */
    .app-container {
        width: 100%;
        max-width: 800px;
    }

    /* --- 1. å¤´éƒ¨æ ·å¼ä¼˜åŒ– (æ°´å¹³å¯¹é½) --- */
    header.main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
    }

    header h2 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .settings-btn {
        background: transparent;
        border: none;
        color: var(--text-sub);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .settings-btn:hover {
        background-color: rgba(0,0,0,0.05);
        color: var(--text-main);
        transform: rotate(30deg);
    }

    /* --- 2. æŒ‰é’®æ ä¼˜åŒ– (çº¯å›¾æ ‡) --- */
    .button-container {
        display: flex;
        justify-content: space-between; /* ä¸¤ç«¯å¯¹é½æˆ–æ”¹ä¸º center/flex-start */
        gap: 15px;
        margin-bottom: 20px;
        padding: 5px 0;
    }

    .icon-action-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 50px;
        border-radius: var(--radius-md);
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: white;
        background-color: var(--text-sub); /* é»˜è®¤ */
        box-shadow: var(--shadow-sm);
        transition: transform 0.1s, box-shadow 0.2s, opacity 0.2s;
        position: relative;
    }

    .icon-action-btn:active { transform: scale(0.96); }
    .icon-action-btn:hover { opacity: 0.9; box-shadow: var(--shadow-md); }

    /* å„åŠŸèƒ½æŒ‰é’®é¢œè‰² */
    .btn-submit   { background-color: var(--primary-color); }
    .btn-delete   { background-color: var(--danger-color); }
    .btn-copy     { background-color: var(--action-blue); }
    .btn-generate { background-color: var(--action-purple); }
    .btn-read     { background-color: var(--action-yellow); }

    /* Tooltip ç®€å•å®ç° */
    .icon-action-btn::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        white-space: nowrap;
        z-index: 10;
    }
    .icon-action-btn:hover::after { opacity: 1; bottom: -35px; }

    /* --- 3. ç¼–è¾‘ä¸é˜…è¯»åŒºåŸŸ --- */
    textarea, article.immersive-content {
      width: 100%;
      box-sizing: border-box;
      border-radius: var(--radius-md);
      padding: 20px;
      font-size: var(--font-size);
      line-height: var(--line-height);
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-main);
      box-shadow: var(--shadow-sm);
      transition: all 0.3s;
      outline: none;
    }

    textarea:focus { border-color: var(--action-blue); }

    textarea {
      min-height: 250px; /* å¢åŠ é»˜è®¤é«˜åº¦ */
      resize: vertical;
      font-family: inherit;
    }
    
    article.immersive-content { min-height: 250px; }

    #status {
      margin-top: 15px;
      color: var(--text-sub);
      font-size: 0.9rem;
      text-align: center;
      background: rgba(0,0,0,0.03);
      padding: 8px;
      border-radius: var(--radius-sm);
    }

    /* --- 4. æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– --- */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: var(--modal-mask);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
      backdrop-filter: blur(4px); /* æ¯›ç»ç’ƒæ•ˆæœ */
    }
    
    .modal-content {
      background: var(--card-bg);
      color: var(--text-main);
      padding: 25px;
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 480px;
      max-height: 85vh; 
      overflow-y: auto; 
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    .modal-content h3, .modal-content h4 {
        margin-top: 0;
        margin-bottom: 15px;
        font-weight: 600;
        color: var(--text-main);
    }

    .modal-content input, 
    .modal-content select, 
    .modal-content textarea {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      font-size: 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      background-color: var(--input-bg);
      color: var(--text-main);
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus {
        border-color: var(--action-blue);
    }

    .modal-content label {
      display: block;
      margin-top: 15px;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-sub);
    }

    /* æ¨¡æ€æ¡†å†…çš„æŒ‰é’® */
    .modal-buttons, .modal-buttons-container {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .modal-content button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-weight: 600;
        background-color: #eee;
        color: #333;
        transition: filter 0.2s;
    }
    
    .modal-content button:hover { filter: brightness(0.95); }
    .modal-content button.confirm-btn, .modal-content button:not(.delete):not(.read):not(.generate):not(.copy) { /* é»˜è®¤ä¸»è¦æŒ‰é’® */
        background-color: var(--primary-color);
        color: white;
    }
    .modal-content button.delete { background-color: var(--danger-color); color: white;}
    .modal-content button.generate-topics-btn { background-color: var(--action-purple); color: white; }

    /* AI åˆ†æç›¸å…³ç‰¹å®šæ ·å¼ */
    .modal-sticky-header {
        padding: 20px 25px 15px;
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        margin: -25px -25px 0 -25px; /* æŠµæ¶ˆ padding */
    }
    .modal-scroll-body { padding-top: 20px; }

    /* åˆ—è¡¨æ ·å¼ */
    #randomTopicsList, #customStyleList {
        padding: 0;
        list-style: none;
        margin-top: 15px;
    }
    #randomTopicsList li, #customStyleList li {
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        margin-bottom: 8px;
        cursor: pointer;
        background-color: var(--input-bg);
        transition: all 0.2s;
    }
    #randomTopicsList li:hover {
        border-color: var(--action-blue);
        background-color: var(--card-bg);
    }

    /* --- AI åˆ†æå°æŒ‰é’® --- */
    .ai-analyze-btn {
        display: inline-flex; align-items: center; justify-content: center;
        background-color: rgba(139, 115, 85, 0.1); 
        border: 1px solid rgba(139, 115, 85, 0.2);
        border-radius: 50%; width: 18px; height: 18px; margin: 0 4px; cursor: pointer;
        color: var(--text-sub); vertical-align: middle; transition: all 0.2s;
    }
    .ai-analyze-btn:hover { background-color: var(--action-yellow); color: white; transform: scale(1.2); border-color: transparent;}
    .ai-analyze-btn svg { width: 10px; height: 10px; fill: currentColor; }
    .ai-analyze-btn.last-clicked {
        background-color: var(--danger-color) !important;
        color: white !important;
        border-color: transparent !important;
    }

    /* åŸå¥å±•ç¤ºæ¡† */
    .ai-original-sentence {
        font-style: italic; 
        background: var(--input-bg); 
        padding: 12px; 
        border-left: 3px solid var(--action-blue); 
        border-radius: 4px;
        font-size: 0.95em;
        color: var(--text-sub);
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 600px) {
        body { padding: 10px; }
        .button-container {
            gap: 8px;
        }
        .icon-action-btn {
            height: 44px; /* iOS æœ€å°è§¦æ§åŒºåŸŸ */
            font-size: 1rem;
        }
        /* ç§»åŠ¨ç«¯ä¸æ˜¾ç¤º tooltip */
        .icon-action-btn::after { display: none; }
        
        /* åº•éƒ¨æŠ½å±‰æ¨¡å¼ */
        .modal { align-items: flex-end; }
        .modal-content {
            width: 100%; margin: 0; border-radius: 20px 20px 0 0; max-height: 85vh;
        }
    }
  </style>
</head>
<body>

  <div class="app-container">
    
    <header class="main-header">
        <h2><i class="fab fa-github"></i> Sync Assistant</h2>
        <button class="settings-btn" onclick="openSettingsModal()" title="è®¾ç½®">
            <i class="fa-solid fa-gear"></i>
        </button>
    </header>

    <div class="button-container">
        <button class="icon-action-btn btn-submit" onclick="submitContent()" data-tooltip="æäº¤ä¿å­˜">
            <i class="fa-solid fa-cloud-arrow-up"></i>
        </button>
        <button class="icon-action-btn btn-delete" onclick="deleteContent()" data-tooltip="æ¸…ç©ºå†…å®¹">
            <i class="fa-solid fa-trash-can"></i>
        </button>
        <button class="icon-action-btn btn-copy" onclick="copyContent()" data-tooltip="å¤åˆ¶æ–‡æœ¬">
            <i class="fa-solid fa-copy"></i>
        </button>
        <button class="icon-action-btn btn-generate" onclick="openThemeModal()" data-tooltip="AI ç”Ÿæˆ">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
        </button>
        <button class="icon-action-btn btn-read read" onclick="readContent()" data-tooltip="æœ—è¯»å…¨æ–‡">
            <i class="fa-solid fa-volume-high"></i>
        </button>
    </div>

    <textarea id="inputContent" placeholder="è¯·è¾“å…¥è‹±æ–‡æ–‡æœ¬ï¼ˆæ”¯æŒå¤šæ®µï¼Œæ¯æ®µç”¨ç©ºè¡Œåˆ†éš”ï¼‰..."></textarea>
    <article id="renderedContent" class="immersive-content" style="display:none;"></article>

    <div id="status">â³ æ­£åœ¨åˆå§‹åŒ–...</div>
  </div>

  <div id="tokenModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ” èº«ä»½éªŒè¯</h3>
      <label>è¯·è¾“å…¥ä½ çš„ GitHub Tokenï¼š</label>
      <input type="password" id="tokenInput" placeholder="ghp_xxx æˆ– github_pat_xxx" />
      <div class="modal-buttons">
          <button onclick="saveToken()">ä¿å­˜ Token</button>
      </div>
    </div>
  </div>

  <div id="storyThemeModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ“š çµæ„Ÿç”Ÿæˆå™¨</h3>
      <label>é€‰æ‹©æˆ–è¾“å…¥ä¸»é¢˜ï¼š</label>
      <div class="select-container" style="display:flex; gap:10px; flex-wrap:wrap;">
        <select id="themeCategorySelect" style="flex:1;"></select>
        <select id="difficultySelect" style="flex:1;"></select>
      </div>
      <select id="styleSelect" multiple style="height:80px;"></select>
      
      <input type="text" id="themeInput" placeholder="æˆ–æ‰‹åŠ¨è¾“å…¥ä¸»é¢˜..." />
      
      <div class="modal-buttons-container">
          <button class="generate-topics-btn" onclick="generateRandomTopics(event)"><i class="fa-solid fa-lightbulb"></i> ç”Ÿæˆé¢˜ç›®</button>
          <button class="confirm-btn" onclick="confirmGenerate(event)">å¼€å§‹åˆ›ä½œ</button>
          <button onclick="closeThemeModal()" style="background:#ddd; color:#333;">å–æ¶ˆ</button>
      </div>
      <p style="margin-top: 15px; font-size:0.85rem; color:var(--text-sub);">ğŸ’¡ ç‚¹å‡»ä¸‹é¢åˆ—è¡¨ä¸­çš„é¢˜ç›®ç›´æ¥ç”Ÿæˆï¼š</p>
      <ul id="randomTopicsList"></ul>
    </div>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h3>âš™ï¸ ä¸ªæ€§åŒ–è®¾ç½®</h3>

      <label for="theme-select">ç•Œé¢ä¸»é¢˜</label>
      <select id="theme-select">
        <option value="">é»˜è®¤ (äº®è‰²)</option>
        <option value="theme-dark">æ·±é‚ƒ (æš—è‰²)</option>
        <option value="theme-sepia">æŠ¤çœ¼ (ç¾Šçš®çº¸)</option>
      </select>

      <label for="font-family-select">é˜…è¯»å­—ä½“</label>
      <select id="font-family-select">
        <option value="'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif">æ— è¡¬çº¿ä½“ (é»˜è®¤)</option>
        <option value="'Georgia', 'Noto Serif SC', 'Songti SC', serif">è¡¬çº¿ä½“</option>
        <option value="'Courier New', 'SFMono-Regular', 'Consolas', monospace">ç­‰å®½å­—ä½“</option>
      </select>

      <label for="font-size-select">å†…å®¹å­—å·</label>
      <select id="font-size-select">
          <option value="15px">å°</option>
          <option value="17px">ä¸­ (é»˜è®¤)</option>
          <option value="19px">å¤§</option>
          <option value="21px">ç‰¹å¤§</option>
      </select>

      <label for="line-height-select">æ®µè½è¡Œé«˜</label>
      <select id="line-height-select">
          <option value="1.4">ç´§å‡‘</option>
          <option value="1.6">é€‚ä¸­ (é»˜è®¤)</option>
          <option value="1.8">å®½æ¾</option>
      </select>

      <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 20px 0;">

      <label for="ai-provider-select">AI æ¨¡å‹æœåŠ¡å•†</label>
      <select id="ai-provider-select">
        <option value="kimi">Kimi</option>
        <option value="zhipu">æ™ºè°± (Zhipu)</option>
        <option value="custom">è‡ªå®šä¹‰</option>
      </select>

      <div id="ai-kimi-inputs" class="ai-inputs" style="display:none;">
        <label for="ai-kimi-api-key">Kimi API Key</label>
        <input type="password" id="ai-kimi-api-key" placeholder="sk-xxx" />
        <label for="ai-kimi-model-name">Kimi æ¨¡å‹åç§°</label>
        <input type="text" id="ai-kimi-model-name" placeholder="moonshot-v1-8k" />
      </div>

      <div id="ai-zhipu-inputs" class="ai-inputs" style="display:none;">
        <label for="ai-zhipu-api-key">æ™ºè°± API Key</label>
        <input type="password" id="ai-zhipu-api-key" placeholder="sk-xxx" />
        <label for="ai-zhipu-model-name">æ™ºè°± æ¨¡å‹åç§°</label>
        <input type="text" id="ai-zhipu-model-name" placeholder="glm-4" />
      </div>

      <div id="ai-custom-inputs" class="ai-inputs" style="display:none;">
        <label for="ai-api-url">è‡ªå®šä¹‰ API URL</label>
        <input type="text" id="ai-api-url" placeholder="ä¾‹å¦‚ï¼šhttps://api.example.com/v1/chat/completions" />
        <label for="ai-custom-api-key">è‡ªå®šä¹‰ API Key</label>
        <input type="password" id="ai-custom-api-key" placeholder="sk-xxx" />
        <label for="ai-custom-model-name">è‡ªå®šä¹‰ æ¨¡å‹åç§°</label>
        <input type="text" id="ai-custom-model-name" placeholder="ä¾‹å¦‚ï¼šgpt-3.5-turbo" />
      </div>

      <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 20px 0;">

      <h4>AI åˆ†æè®¾ç½®</h4>
      <label for="analysis-prompt-input">åˆ†ææŒ‡ä»¤ (System Prompt)</label>
      <textarea id="analysis-prompt-input" rows="3" placeholder="è‡ªå®šä¹‰åˆ†ææŒ‡ä»¤..."></textarea>
      
      <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 20px 0;">

      <h4>æœ—è¯»è®¾ç½®</h4>
      <label for="tts-urls">TTS API URLs</label>
      <input type="text" id="tts-urls" placeholder="ä¾‹å¦‚: https://your-tts-api.com/api/aiyue" />

      <label for="tts-voice-name">TTS è¯­éŸ³åç§°</label>
      <input type="text" id="tts-voice-name" placeholder="ä¾‹å¦‚: en-US-EricNeural" />

      <div class="modal-buttons">
          <button class="delete" onclick="resetToken()">é‡è®¾ Token</button>
          <button class="confirm-btn" onclick="saveAndApplySettings()">ä¿å­˜è®¾ç½®</button>
      </div>
    </div>
  </div>

  <div id="styleManagementModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ¨ é£æ ¼ç®¡ç†</h3>
      <div class="style-input-container" style="display:flex; gap:10px;">
        <input type="text" id="addStyleInput" placeholder="è¾“å…¥æ–°é£æ ¼åç§°..." />
        <button onclick="addCustomStyle()" style="width:80px; margin-top:8px;">æ·»åŠ </button>
      </div>
      <ul id="customStyleList"></ul>
      <button style="margin-top: 20px; width:100%; background:#eee; color:#333;" onclick="closeStyleManagementModal()">è¿”å›</button>
    </div>
  </div>

  <div id="aiResultModal" class="modal">
      <div class="modal-content">
          <div class="modal-sticky-header">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <h3 style="margin:0;">ğŸ§  AI æ·±åº¦åˆ†æ</h3>
                  </div>
              <div class="ai-original-sentence" id="aiOriginalSentence"></div>
          </div>
          <div id="aiResultContent" class="modal-scroll-body ai-result-content"></div>
      </div>
  </div>

  <script>
    const GITHUB_USERNAME = "moodHappy";
    const GITHUB_REPO = "HelloWorld";
    const WORD_FILE_PATH_GITHUB = "Notes/transfer.txt";
    const SETTINGS_KEY = "github_sync_assistant_settings";
    const CUSTOM_STYLES_KEY = "github_sync_assistant_custom_styles";

    const DEFAULT_KIMI_API_URL = "https://api.moonshot.cn/v1/chat/completions";
    const DEFAULT_KIMI_MODEL = "moonshot-v1-8k";

    const DEFAULT_ZHIPU_API_URL = "https://open.bigmodel.cn/api/paas/v4/chat/completions";
    const DEFAULT_ZHIPU_MODEL = "glm-4";

    // Default TTS settings
    const DEFAULT_TTS_URLS = 'https://ms-ra-forwarder-for-ifreetime-2.vercel.app/';
    const DEFAULT_TTS_VOICE = 'en-US-EricNeural';

    // Analysis Settings
    const DEFAULT_ANALYSIS_PROMPT = `ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­è‹±æ–‡çš„è¯­è¨€ä¸“å®¶ã€‚è¯·åˆ†ææˆ‘æä¾›çš„å¥å­ï¼š
1. åˆ¤æ–­éš¾åº¦ç­‰çº§ (A1-C2)ã€‚
2. æä¾›å‡†ç¡®ã€ä¼˜ç¾çš„ä¸­æ–‡ç¿»è¯‘ã€‚
3. å¥ä¸­å…³é”®çŸ­è¯­åŠä¾‹å¥ã€ä¾‹å¥ç¿»è¯‘ã€‚
è¯·ä½¿ç”¨ Markdown æ ¼å¼è¾“å‡ºã€‚`;
    const CACHE_PREFIX = 'ai_reader_cache_v1_';
    const LAST_CLICKED_KEY = 'ai_reader_last_clicked_index';

    let GITHUB_TOKEN = localStorage.getItem("github_token") || null;
    const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${WORD_FILE_PATH_GITHUB}`;

    const textarea = document.getElementById("inputContent");
    const renderedDiv = document.getElementById("renderedContent");
    const statusDiv = document.getElementById("status");
    const tokenModal = document.getElementById("tokenModal");
    const settingsModal = document.getElementById("settingsModal");
    const storyThemeModal = document.getElementById("storyThemeModal");
    const themeInput = document.getElementById("themeInput");
    const randomTopicsList = document.getElementById("randomTopicsList");
    const generateTopicsBtn = document.querySelector('.generate-topics-btn');
    const rootElement = document.documentElement;

    // AI Settings Elements
    const aiProviderSelect = document.getElementById('ai-provider-select');
    const aiKimiInputsDiv = document.getElementById('ai-kimi-inputs');
    const aiZhipuInputsDiv = document.getElementById('ai-zhipu-inputs');
    const aiCustomInputsDiv = document.getElementById('ai-custom-inputs');
    const aiKimiApiKeyInput = document.getElementById('ai-kimi-api-key');
    const aiKimiModelNameInput = document.getElementById('ai-kimi-model-name');
    const aiZhipuApiKeyInput = document.getElementById('ai-zhipu-api-key');
    const aiZhipuModelNameInput = document.getElementById('ai-zhipu-model-name');
    const aiApiUrlInput = document.getElementById('ai-api-url');
    const aiCustomApiKeyInput = document.getElementById('ai-custom-api-key');
    const aiCustomModelNameInput = document.getElementById('ai-custom-model-name');
    
    // Analysis Elements
    const analysisPromptInput = document.getElementById('analysis-prompt-input');
    const aiResultModal = document.getElementById('aiResultModal');

    // TTS Settings Elements
    const ttsUrlsInput = document.getElementById('tts-urls');
    const ttsVoiceNameInput = document.getElementById('tts-voice-name');

    // Theme & Difficulty Elements
    const themeCategorySelect = document.getElementById('themeCategorySelect');
    const difficultySelect = document.getElementById('difficultySelect');
    const styleSelect = document.getElementById('styleSelect');

    // Style Management Elements
    const styleManagementModal = document.getElementById('styleManagementModal');
    const addStyleInput = document.getElementById('addStyleInput');
    const customStyleList = document.getElementById('customStyleList');


    // --- THEME & STYLE LIBRARY ---
    const THEME_LIBRARY = {
        'æ—¥å¸¸ç”Ÿæ´»ç±»': [], 
        'æ‚¬ç–‘ä¸æ¨ç†ç±»': [],
        'ç§‘å¹»ä¸å¥‡å¹»ç±»': [],
        'å†å²ä¸ç°å®ä¸»ä¹‰ç±»': [],
        'å“²ç†ä¸å¯“è¨€ç±»': [],
        'çˆ±æƒ…ä¸æƒ…æ„Ÿç±»': [],
        'å¿ƒç†ä¸æƒ…ç»ªç±»': [],
        'å¹½é»˜ä¸è®½åˆºç±»': [],
        'å¥‡é‡ä¸å†’é™©ç±»': [],
    };

    const DIFFICULTY_LEVELS = [
        'A1 (å…¥é—¨)', 
        'A2 (åˆçº§)', 
        'B1 (ä¸­çº§)', 
        'B2 (ä¸­é«˜çº§)', 
        'C1 (é«˜çº§)', 
        'C2 (ç²¾é€š)'
    ];

    const BUILT_IN_STYLES = [
        'å£è¯­é£æ ¼',
        'ç®€æ´é£æ ¼',
        'å™äº‹é£æ ¼',
        'ä¹¦é¢é£æ ¼',
        'æ–°é—»é£æ ¼',
        'å¹½é»˜é£æ ¼',
        'è®½åˆºé£æ ¼', 
        'é»‘é•œé£æ ¼',
        'æ–‡å­¦é£æ ¼',
        'å“²ç†é£æ ¼',
        'å•†ä¸šé£æ ¼',
        'å­¦æœ¯é£æ ¼'
    ];

    // --- Settings Management ---
    const defaultSettings = {
        theme: '',
        fontFamily: "'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif",
        fontSize: '17px',
        lineHeight: '1.6',
        aiProvider: 'kimi',
        aiKimiApiKey: '',
        aiKimiModelName: DEFAULT_KIMI_MODEL,
        aiZhipuApiKey: '',
        aiZhipuModelName: DEFAULT_ZHIPU_MODEL,
        aiApiUrl: '',
        aiCustomApiKey: '',
        aiCustomModelName: '',
        analysisPrompt: DEFAULT_ANALYSIS_PROMPT,
        ttsUrls: DEFAULT_TTS_URLS,
        ttsVoiceName: DEFAULT_TTS_VOICE,
    };

    function applySettings(settings) {
        document.body.className = settings.theme || '';
        rootElement.style.setProperty('--primary-font', settings.fontFamily);
        rootElement.style.setProperty('--font-size', settings.fontSize);
        rootElement.style.setProperty('--line-height', settings.lineHeight);

        aiProviderSelect.value = settings.aiProvider;
        updateAIInputsVisibility(settings.aiProvider);
    }

    function loadSettings() {
        const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY));
        const currentSettings = { ...defaultSettings, ...savedSettings };
        applySettings(currentSettings);

        // Load AI values into inputs
        aiKimiApiKeyInput.value = currentSettings.aiKimiApiKey;
        aiKimiModelNameInput.value = currentSettings.aiKimiModelName;
        aiZhipuApiKeyInput.value = currentSettings.aiZhipuApiKey;
        aiZhipuModelNameInput.value = currentSettings.aiZhipuModelName;
        aiApiUrlInput.value = currentSettings.aiApiUrl;
        aiCustomApiKeyInput.value = currentSettings.aiCustomApiKey;
        aiCustomModelNameInput.value = currentSettings.aiCustomModelName;

        // Load Analysis Prompt
        analysisPromptInput.value = currentSettings.analysisPrompt || DEFAULT_ANALYSIS_PROMPT;

        // Load TTS values into inputs
        ttsUrlsInput.value = currentSettings.ttsUrls;
        ttsVoiceNameInput.value = currentSettings.ttsVoiceName;
    }

    function updateAIInputsVisibility(provider) {
        aiKimiInputsDiv.style.display = provider === 'kimi' ? 'block' : 'none';
        aiZhipuInputsDiv.style.display = provider === 'zhipu' ? 'block' : 'none';
        aiCustomInputsDiv.style.display = provider === 'custom' ? 'block' : 'none';
    }

    aiProviderSelect.addEventListener('change', (event) => {
        updateAIInputsVisibility(event.target.value);
    });

    function openSettingsModal() {
        const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || defaultSettings;
        document.getElementById('theme-select').value = savedSettings.theme;
        document.getElementById('font-family-select').value = savedSettings.fontFamily;
        document.getElementById('font-size-select').value = savedSettings.fontSize;
        document.getElementById('line-height-select').value = savedSettings.lineHeight;

        // Load AI settings into modal
        aiProviderSelect.value = savedSettings.aiProvider;
        aiKimiApiKeyInput.value = savedSettings.aiKimiApiKey;
        aiKimiModelNameInput.value = savedSettings.aiKimiModelName;
        aiZhipuApiKeyInput.value = savedSettings.aiZhipuApiKey;
        aiZhipuModelNameInput.value = savedSettings.aiZhipuModelName;
        aiApiUrlInput.value = savedSettings.aiApiUrl;
        aiCustomApiKeyInput.value = savedSettings.aiCustomApiKey;
        aiCustomModelNameInput.value = savedSettings.aiCustomModelName;
        
        analysisPromptInput.value = savedSettings.analysisPrompt || DEFAULT_ANALYSIS_PROMPT;

        // Load TTS settings into modal
        ttsUrlsInput.value = savedSettings.ttsUrls;
        ttsVoiceNameInput.value = savedSettings.ttsVoiceName;

        updateAIInputsVisibility(savedSettings.aiProvider);

        settingsModal.style.display = "flex";
    }

    function closeSettingsModal() {
        settingsModal.style.display = "none";
    }

    function saveAndApplySettings() {
        const newSettings = {
            theme: document.getElementById('theme-select').value,
            fontFamily: document.getElementById('font-family-select').value,
            fontSize: document.getElementById('font-size-select').value,
            lineHeight: document.getElementById('line-height-select').value,
            aiProvider: aiProviderSelect.value,
            aiKimiApiKey: aiKimiApiKeyInput.value,
            aiKimiModelName: aiKimiModelNameInput.value,
            aiZhipuApiKey: aiZhipuApiKeyInput.value,
            aiZhipuModelName: aiZhipuModelNameInput.value,
            aiApiUrl: aiApiUrlInput.value,
            aiCustomApiKey: aiCustomApiKeyInput.value,
            aiCustomModelName: aiCustomModelNameInput.value,
            analysisPrompt: analysisPromptInput.value,
            ttsUrls: ttsUrlsInput.value,
            ttsVoiceName: ttsVoiceNameInput.value,
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(newSettings));
        applySettings(newSettings);
        closeSettingsModal();
        statusDiv.textContent = "âš™ï¸ è®¾ç½®å·²ä¿å­˜ã€‚";
        // æ¸…é™¤ç¼“å­˜ä»¥åº”ç”¨å¯èƒ½çš„Promptæ›´æ”¹
        if(confirm("è®¾ç½®å·²æ›´æ–°ã€‚æ˜¯å¦æ¸…ç©ºä¹‹å‰çš„åˆ†æç»“æœç¼“å­˜ï¼Ÿ")) {
             Object.keys(localStorage).forEach(k => k.startsWith(CACHE_PREFIX) && localStorage.removeItem(k));
        }
    }

    // --- GitHub Token Management ---
    function ensureToken() {
      if (!GITHUB_TOKEN) {
        tokenModal.style.display = "flex";
      }
    }

    function saveToken() {
      const token = document.getElementById("tokenInput").value.trim();
      if (!token.startsWith("ghp_") && !token.startsWith("github_pat_")) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ GitHub Tokenï¼");
        return;
      }
      localStorage.setItem("github_token", token);
      GITHUB_TOKEN = token;
      tokenModal.style.display = "none";
      statusDiv.textContent = "â³ æ­£åœ¨åŠ è½½ GitHub å†…å®¹...";
      loadContent();
    }

    function resetToken() {
      if (confirm("ç¡®å®šè¦æ¸…é™¤å·²ä¿å­˜çš„ GitHub Token å¹¶é‡æ–°è¾“å…¥å—ï¼Ÿ")) {
        localStorage.removeItem("github_token");
        GITHUB_TOKEN = null;
        closeSettingsModal();
        ensureToken();
      }
    }

    // --- Core GitHub API Functions ---
    function getHeaders() {
      return {
        Authorization: `Bearer ${GITHUB_TOKEN}`,
        Accept: "application/vnd.github.v3+json"
      };
    }

    async function getCurrentFileShaAndContent() {
      try {
        const res = await fetch(apiUrl, { headers: getHeaders() });
        if (res.status === 404) {
             statusDiv.textContent = "â„¹ï¸ ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæäº¤æ—¶å°†è‡ªåŠ¨åˆ›å»ºã€‚";
             return { sha: null, content: "" };
        }
        if (!res.ok) throw new Error(`GitHub çŠ¶æ€ç  ${res.status}`);
        const data = await res.json();
        const decoded = decodeURIComponent(escape(atob(data.content)));
        return { sha: data.sha, content: decoded };
      } catch (err) {
        console.warn("è¯»å–å¤±è´¥ï¼š", err.message);
        statusDiv.textContent = `âŒ è¯»å–å¤±è´¥: ${err.message}. è¯·æ£€æŸ¥ Token æˆ–ç½‘ç»œã€‚`;
        return { sha: null, content: "" };
      }
    }

    async function submitContent() {
      const content = textarea.value.trim();
      if (!content) return alert("è¯·è¾“å…¥å†…å®¹å†æäº¤ï¼");
      statusDiv.textContent = "ğŸ”„ æ­£åœ¨æäº¤åˆ° GitHub...";

      const { sha } = await getCurrentFileShaAndContent();
      const encodedContent = btoa(unescape(encodeURIComponent(content)));

      const res = await fetch(apiUrl, {
        method: "PUT",
        headers: { ...getHeaders(), "Content-Type": "application/json" },
        body: JSON.stringify({
          message: `Update ${WORD_FILE_PATH_GITHUB}`,
          content: encodedContent,
          committer: { name: "GitHub Sync Assistant", email: "bot@example.com" },
          ...(sha ? { sha } : {})
        })
      });

      if (res.ok) {
        renderMode(content);
        statusDiv.textContent = "âœ… æäº¤æˆåŠŸï¼Œæ®µè½å·²æ¸²æŸ“ã€‚";
      } else {
        statusDiv.textContent = "âŒ æäº¤å¤±è´¥ï¼š" + (await res.json()).message;
      }
    }

    async function deleteContent() {
      if (!confirm("ç¡®å®šè¦æ¸…ç©º GitHub ä¸Šçš„æ–‡ä»¶å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚")) return;

      statusDiv.textContent = "ğŸ—‘ï¸ æ­£åœ¨æ¸…ç©º GitHub æ–‡ä»¶...";
      const { sha } = await getCurrentFileShaAndContent();
      if (!sha) {
        textarea.value = "";
        editMode();
        statusDiv.textContent = "âœ… æ–‡ä»¶æœ¬å°±ä¸ºç©ºæˆ–ä¸å­˜åœ¨ã€‚";
        return;
      }

      const res = await fetch(apiUrl, {
        method: "PUT",
        headers: { ...getHeaders(), "Content-Type": "application/json" },
        body: JSON.stringify({
          message: `Empty ${WORD_FILE_PATH_GITHUB}`,
          content: btoa(""),
          sha,
          committer: { name: "GitHub Sync Assistant", email: "bot@example.com" }
        })
      });

      if (res.ok) {
        textarea.value = "";
        editMode();
        statusDiv.textContent = "âœ… GitHub å†…å®¹å·²æ¸…ç©ºã€‚";
      } else {
        statusDiv.textContent = "âŒ åˆ é™¤å¤±è´¥ï¼š" + (await res.json()).message;
      }
    }

    // --- AI Generation Functions & API ---
    function getAIConfig() {
      const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || defaultSettings;
      let aiApiUrl, aiApiKey, aiModelName;

      switch (savedSettings.aiProvider) {
        case 'kimi':
            aiApiUrl = DEFAULT_KIMI_API_URL;
            aiApiKey = savedSettings.aiKimiApiKey;
            aiModelName = savedSettings.aiKimiModelName || DEFAULT_KIMI_MODEL;
            break;
        case 'zhipu':
            aiApiUrl = DEFAULT_ZHIPU_API_URL;
            aiApiKey = savedSettings.aiZhipuApiKey;
            aiModelName = savedSettings.aiZhipuModelName || DEFAULT_ZHIPU_MODEL;
            break;
        case 'custom':
            aiApiUrl = savedSettings.aiApiUrl;
            aiApiKey = savedSettings.aiCustomApiKey;
            aiModelName = savedSettings.aiCustomModelName;
            break;
      }
      return { aiApiUrl, aiApiKey, aiModelName };
    }

    async function callAI(prompt, systemPrompt = "You are a helpful assistant.") {
      const { aiApiUrl, aiApiKey, aiModelName } = getAIConfig();
      if (!aiApiKey) {
          throw new Error("âŒ è¯·åœ¨è®¾ç½®ä¸­è¾“å…¥ AI çš„ API Keyï¼");
      }
      if (!aiApiUrl || !aiModelName) {
          throw new Error("âŒ è¯·åœ¨è®¾ç½®ä¸­è¡¥å…¨è‡ªå®šä¹‰ AI çš„æ‰€æœ‰ä¿¡æ¯ï¼");
      }

      const response = await fetch(aiApiUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${aiApiKey}`
        },
        body: JSON.stringify({
          model: aiModelName,
          messages: [
            { role: "system", content: systemPrompt },
            { role: "user", content: prompt }
          ],
          temperature: 0.7
        })
      });

      if (!response.ok) {
        throw new Error(`API è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status} - ${await response.text()}`);
      }

      const data = await response.json();
      return data.choices[0].message.content.trim();
    }

    function openThemeModal() {
      storyThemeModal.style.display = "flex";
      themeInput.value = "";
      randomTopicsList.innerHTML = "";
      populateThemeSelectors();
      populateStyleSelector();
    }

    function closeThemeModal() {
        storyThemeModal.style.display = "none";
    }

    // --- Populate Theme Selectors ---
    function populateThemeSelectors() {
        themeCategorySelect.innerHTML = '';
        difficultySelect.innerHTML = '';

        const defaultCategoryOption = document.createElement('option');
        defaultCategoryOption.textContent = 'é€‰æ‹©åˆ†ç±»';
        defaultCategoryOption.value = '';
        defaultCategoryOption.disabled = true;
        defaultCategoryOption.selected = true;
        themeCategorySelect.appendChild(defaultCategoryOption);

        for (const category in THEME_LIBRARY) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            themeCategorySelect.appendChild(option);
        }

        DIFFICULTY_LEVELS.forEach(level => {
            const option = document.createElement('option');
            option.value = level.split(' ')[0]; 
            option.textContent = level;
            if (level.startsWith('B1')) { 
                option.selected = true;
            }
            difficultySelect.appendChild(option);
        });

        themeCategorySelect.onchange = (event) => {
            themeInput.value = '';
        };
    }

    // --- Style Management Functions ---
    function getCustomStyles() {
      try {
        return JSON.parse(localStorage.getItem(CUSTOM_STYLES_KEY)) || [];
      } catch (e) {
        console.error("Failed to parse custom styles from localStorage:", e);
        return [];
      }
    }

    function saveCustomStyles(styles) {
      localStorage.setItem(CUSTOM_STYLES_KEY, JSON.stringify(styles));
    }

    function addCustomStyle() {
      const newStyle = addStyleInput.value.trim();
      if (newStyle === "") return;

      const customStyles = getCustomStyles();
      if (!customStyles.includes(newStyle) && !BUILT_IN_STYLES.includes(newStyle)) {
        customStyles.push(newStyle);
        saveCustomStyles(customStyles);
        addStyleInput.value = "";
        populateCustomStyleList();
        statusDiv.textContent = "âœ… æ–°é£æ ¼å·²æ·»åŠ ï¼";
      } else {
        statusDiv.textContent = "ğŸ¤” é£æ ¼å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤æ·»åŠ ã€‚";
      }
    }

    function deleteCustomStyle(styleToDelete) {
      const customStyles = getCustomStyles();
      const newStyles = customStyles.filter(style => style !== styleToDelete);
      saveCustomStyles(newStyles);
      populateCustomStyleList();
      statusDiv.textContent = "ğŸ—‘ï¸ é£æ ¼å·²åˆ é™¤ã€‚";
    }

    function populateCustomStyleList() {
      const customStyles = getCustomStyles();
      customStyleList.innerHTML = "";
      if (customStyles.length === 0) {
        const li = document.createElement('li');
        li.textContent = "å°šæ— è‡ªå®šä¹‰é£æ ¼";
        li.style.color = 'var(--text-sub)';
        customStyleList.appendChild(li);
        return;
      }
      customStyles.forEach(style => {
        const li = document.createElement('li');
        li.textContent = style;
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'åˆ é™¤';
        deleteBtn.className = 'delete-style-btn';
        deleteBtn.style.cssText = "float:right; padding:2px 8px; font-size:12px; width:auto; background:var(--danger-color); color:white;";
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteCustomStyle(style);
        }
        li.appendChild(deleteBtn);
        customStyleList.appendChild(li);
      });
    }

    function openStyleManagementModal() {
        populateCustomStyleList();
        styleManagementModal.style.display = "flex";
        storyThemeModal.style.display = "none";
    }

    function closeStyleManagementModal() {
        styleManagementModal.style.display = "none";
        populateStyleSelector();
    }

    function populateStyleSelector() {
        styleSelect.innerHTML = '';
        const allStyles = [...BUILT_IN_STYLES, ...getCustomStyles()];

        const manageOption = document.createElement('option');
        manageOption.textContent = 'âš™ï¸ ç®¡ç†é£æ ¼...';
        manageOption.value = 'manage';
        styleSelect.appendChild(manageOption);

        allStyles.forEach(style => {
            const option = document.createElement('option');
            option.value = style;
            option.textContent = style;
            styleSelect.appendChild(option);
        });

        styleSelect.onchange = (event) => {
            const selectedOption = event.target.selectedOptions[0];
            if (selectedOption && selectedOption.value === 'manage') {
                event.preventDefault();
                event.stopPropagation();
                openStyleManagementModal();
                selectedOption.selected = false;
            }
        };
    }

    // --- Generate Random Topics ---
    async function generateRandomTopics(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }

        const theme = themeInput.value.trim() || themeCategorySelect.value;
        if (theme === "" || theme === 'é€‰æ‹©åˆ†ç±»') {
            statusDiv.textContent = "ğŸ¤” è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»æˆ–æ‰‹åŠ¨è¾“å…¥ï¼Œç„¶åç‚¹å‡»'ç”Ÿæˆé¢˜ç›®'ã€‚";
            return;
        }

        generateTopicsBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
        generateTopicsBtn.disabled = true;
        randomTopicsList.innerHTML = "";
        statusDiv.textContent = `âœ¨ æ­£åœ¨æ ¹æ®â€œ${theme}â€ç”Ÿæˆå¾®å°è¯´é¢˜ç›®...`;

        try {
            const prompt = `Based on the theme "${theme}", generate a list of 10 creative and unique short story titles in simplified Chinese. Separate each title with a newline character.`;
            const topicsText = await callAI(prompt);
            const topics = topicsText.split('\n').filter(t => t.trim() !== '');

            topics.forEach(topic => {
                const li = document.createElement('li');
                li.textContent = topic.replace(/^\d+\.\s*/, ''); 
                li.onclick = () => {
                    startGeneration(li.textContent);
                };
                randomTopicsList.appendChild(li);
            });
            statusDiv.textContent = "âœ… é¢˜ç›®åˆ—è¡¨ç”ŸæˆæˆåŠŸï¼ç‚¹å‡»ä¸€ä¸ªé¢˜ç›®æ¥ç”Ÿæˆå¾®å°è¯´ã€‚";
        } catch (error) {
            statusDiv.textContent = `âŒ ç”Ÿæˆé¢˜ç›®å¤±è´¥: ${error.message}`;
            console.error("ç”Ÿæˆé¢˜ç›®å¤±è´¥:", error);
        } finally {
            generateTopicsBtn.innerHTML = '<i class="fa-solid fa-lightbulb"></i> ç”Ÿæˆé¢˜ç›®';
            generateTopicsBtn.disabled = false;
        }
    }

    function confirmGenerate(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }

        let topic = themeInput.value.trim();
        if (topic === "") {
            const selectedCategory = themeCategorySelect.value;
            if (selectedCategory && selectedCategory !== 'é€‰æ‹©åˆ†ç±»') {
                topic = selectedCategory;
            }
        }

        if (topic === "") {
            statusDiv.textContent = "ğŸ¤” è¯·åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ä¸€ä¸ªé¢˜ç›®ï¼Œæˆ–è€…é€‰æ‹©ä¸€ä¸ªåˆ†ç±»ã€‚";
            return;
        }

        startGeneration(topic);
    }

    async function startGeneration(topic) {
      const difficulty = difficultySelect.value || 'B1';
      const selectedStyles = Array.from(styleSelect.selectedOptions)
                                 .map(option => option.value)
                                 .filter(value => value !== 'manage');
      const stylePrompt = selectedStyles.length > 0
          ? ` in a ${selectedStyles.join(' and ')} style.`
          : '.';

      const prompt = `Write a short story in English, about 100 words, **CEFR Level ${difficulty}**, based on the Chinese title or theme: "${topic}"${stylePrompt}`;

      statusDiv.textContent = `âœï¸ æ­£åœ¨æ ¹æ®â€œ${topic}â€åˆ›ä½œè‹±æ–‡å¾®å°è¯´ (Level ${difficulty})...`;
      editMode();
      closeThemeModal();

      try {
          const storyContent = await callAI(prompt);
          textarea.value = storyContent;
          statusDiv.textContent = "âœ… å¾®å°è¯´åˆ›ä½œæˆåŠŸï¼æ­£åœ¨è‡ªåŠ¨æäº¤åˆ° GitHub...";
          await submitContent();
      } catch (error) {
          statusDiv.textContent = `âŒ åˆ›ä½œå¤±è´¥: ${error.message}`;
          console.error("åˆ›ä½œå¤±è´¥:", error);
      }
    }

    // --- UI & Content Handling ---
    function copyContent() {
      const content = renderedDiv.style.display !== "none" ? renderedDiv.innerText : textarea.value;
      if (!content) {
        statusDiv.textContent = "ğŸ¤·â€â™€ï¸ å†…å®¹ä¸ºç©ºï¼Œæ— éœ€å¤åˆ¶ã€‚";
        return;
      }
      navigator.clipboard.writeText(content);
      statusDiv.textContent = "ğŸ“‹ å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚";
    }

    function renderMode(text) {
      renderedDiv.innerHTML = "";
      const paragraphs = text.split(/\n{2,}/);
      for (const para of paragraphs) {
        if (para.trim()) {
          const p = document.createElement("p");
          p.textContent = para.trim();
          renderedDiv.appendChild(p);
        }
      }
      renderedDiv.style.display = "block";
      textarea.style.display = "none";
      // æ¸²æŸ“åæ³¨å…¥ AI æŒ‰é’®
      injectAIButtons();
    }

    function editMode() {
      textarea.style.display = "block";
      renderedDiv.style.display = "none";
    }

    async function loadContent() {
      statusDiv.textContent = "â³ æ­£åœ¨åŠ è½½ GitHub å†…å®¹...";
      const { content } = await getCurrentFileShaAndContent();
      if (content.trim()) {
        textarea.value = content;
        renderMode(content);
        statusDiv.textContent = "âœ… GitHub å†…å®¹å·²åŠ è½½å¹¶æ¸²æŸ“ã€‚";
      } else {
        textarea.value = "";
        editMode();
        statusDiv.textContent = "âœ… GitHub å†…å®¹ä¸ºç©ºï¼Œè¯·ç¼–è¾‘ã€‚";
      }
    }

    // --- AI Sentence Analysis Logic (å¤ç”¨æ¨¡å—) ---
    function generateCacheKey(text, prompt) {
        let str = text + "|" + prompt;
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = ((hash << 5) - hash) + str.charCodeAt(i) | 0;
        return CACHE_PREFIX + Math.abs(hash);
    }

    function getFromCache(key) {
        const item = JSON.parse(localStorage.getItem(key));
        return (!item || Date.now() - item.timestamp > 86400000) ? null : item.content;
    }

    function saveToCache(key, content) {
        try { localStorage.setItem(key, JSON.stringify({ content, timestamp: Date.now() })); } 
        catch(e) { /* Ignore quota limits */ }
    }

    function injectAIButtons() {
        // 1. æ¸…ç†æ—§æŒ‰é’® (è™½ç„¶ renderMode ä¼šæ¸…ç©º innerHTMLï¼Œä½†ä¿ç•™æ­¤é€»è¾‘æ›´å¥å£®)
        renderedDiv.querySelectorAll('.ai-analyze-btn').forEach(b => b.remove());

        // 2. éå†æ–‡æœ¬èŠ‚ç‚¹
        const w = document.createTreeWalker(renderedDiv, NodeFilter.SHOW_TEXT);
        const nodes = []; while(w.nextNode()) nodes.push(w.currentNode);

        nodes.forEach(n => {
            if (n.nodeValue.includes('.')) {
                const f = document.createDocumentFragment();
                // 3. æŒ‰å¥å·åˆ†å‰²å¹¶æ’å…¥æŒ‰é’®
                n.nodeValue.split(/(\.)/).forEach(p => {
                    f.appendChild(document.createTextNode(p));
                    if(p === '.') {
                        const b = document.createElement('span');
                        b.className = 'ai-analyze-btn';
                        b.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 15h-2v-2h2zm0-4h-2V7h2z"/></svg>';
                        b.onclick = (e) => handleAIAnalyzeClick(e.target);
                        f.appendChild(b);
                    }
                });
                n.parentNode.replaceChild(f, n);
            }
        });
        
        // æ¢å¤é«˜äº®çŠ¶æ€
        const lastClickedIndex = localStorage.getItem(LAST_CLICKED_KEY);
        if (lastClickedIndex !== null) {
            const allBtns = renderedDiv.querySelectorAll('.ai-analyze-btn');
            const idx = parseInt(lastClickedIndex);
            if (allBtns[idx]) {
                allBtns[idx].classList.add('last-clicked');
            }
        }
    }

    function extractSentenceBefore(node) {
        let t = "", c = node.previousSibling;
        while(c) {
            if(c.nodeType === 3) { // Text node
                t = c.nodeValue + t; 
                if(t.lastIndexOf('.') > -1 && t.lastIndexOf('.') < t.length-1) { 
                    t = t.substring(t.lastIndexOf('.')+1); 
                    break; 
                } 
            }
            else if(c.classList?.contains('ai-analyze-btn')) break;
            else t = c.innerText + t;
            c = c.previousSibling;
        }
        return t.trim();
    }

    async function handleAIAnalyzeClick(target) {
        const btn = target.closest('.ai-analyze-btn');
        if (!btn) return;

        // UI Feedback
        const allBtns = document.querySelectorAll('.ai-analyze-btn');
        allBtns.forEach(b => b.classList.remove('last-clicked'));
        btn.classList.add('last-clicked');
        
        const btnIndex = Array.from(allBtns).indexOf(btn);
        if (btnIndex !== -1) localStorage.setItem(LAST_CLICKED_KEY, btnIndex);

        const sentence = extractSentenceBefore(btn);
        if (!sentence || sentence.length < 2) return;

        // Modal Setup
        const resultBox = document.getElementById('aiResultContent');
        const sentenceBox = document.getElementById('aiOriginalSentence');
        sentenceBox.innerText = sentence;
        resultBox.innerHTML = '<div class="ai-loading"><p>ğŸ§  æ­£åœ¨åˆ†æå¥å­ç»“æ„ä¸å«ä¹‰...</p></div>';
        aiResultModal.style.display = 'flex';

        // Check Cache
        const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || defaultSettings;
        const sysPrompt = savedSettings.analysisPrompt || DEFAULT_ANALYSIS_PROMPT;
        const cacheKey = generateCacheKey(sentence, sysPrompt);
        const cached = getFromCache(cacheKey);

        if (cached) {
            resultBox.innerHTML = marked.parse(cached);
            return;
        }

        // Call AI
        try {
            const content = await callAI(`Analyze this sentence:\n"${sentence}"`, sysPrompt);
            saveToCache(cacheKey, content);
            resultBox.innerHTML = marked.parse(content);
        } catch (e) {
            resultBox.innerHTML = `<p style="color:var(--danger-color);">é”™è¯¯: ${e.message}</p>`;
        }
    }

    function closeAiResultModal() {
        aiResultModal.style.display = 'none';
    }

    // Double click to close AI Modal
    document.querySelector('#aiResultModal .modal-content').addEventListener('dblclick', (e) => {
        if(['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName) || window.getSelection().toString().length > 0) return;
        closeAiResultModal();
    });

    // --- Text-to-Speech Functionality ---
    let currentAudio = null;
    let isReading = false;
    let isPaused = false;
    let currentTextToSpeak = '';
    let currentPosition = 0;
    const currentSpeed = -20; 

    function playSummaryTTS(textToSpeak, fromCurrentPosition = false) {
      if (!textToSpeak || textToSpeak.trim() === '') {
          return;
      }

      const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || defaultSettings;
      const ttsUrls = savedSettings.ttsUrls.split(',').map(url => url.trim()).filter(url => url !== '');
      const ttsVoiceName = savedSettings.ttsVoiceName;

      if (ttsUrls.length === 0 || !ttsVoiceName) {
        statusDiv.textContent = "âŒ è¯·åœ¨è®¾ç½®ä¸­é…ç½® TTS API URL å’Œè¯­éŸ³åç§°ã€‚";
        return;
      }

      if (currentAudio && !currentAudio.paused) {
          currentAudio.pause();
      }

      currentTextToSpeak = textToSpeak;
      const finaltextToSpeak = textToSpeak.trim();

      const queryString = new URLSearchParams({
          text: finaltextToSpeak,
          voiceName: ttsVoiceName,
          speed: currentSpeed,
      }).toString();

      function tryPlay(urls) {
        if (urls.length === 0) {
            statusDiv.textContent = "âŒ æ‰€æœ‰ TTS æœåŠ¡éƒ½æ— æ³•è¿æ¥ã€‚";
            isReading = false;
            isPaused = false;
            updateButtonState();
            return;
        }

        const url = urls.shift();
        const ttsUrl = `${url.endsWith('/') ? url : url + '/'}api/aiyue?${queryString}`;

        currentAudio = new Audio(ttsUrl);

        if (fromCurrentPosition && currentPosition > 0) {
            currentAudio.currentTime = currentPosition;
        } else {
            currentPosition = 0;
        }

        currentAudio.play()
            .then(() => {
                isReading = true;
                isPaused = false;
                updateButtonState();
                statusDiv.textContent = 'ğŸ”Š æ­£åœ¨æœ—è¯»...';

                currentAudio.addEventListener('ended', function() {
                    isReading = false;
                    isPaused = false;
                    currentPosition = 0;
                    updateButtonState();
                    statusDiv.textContent = 'âœ… æœ—è¯»å·²å®Œæˆã€‚';
                }, { once: true });

                currentAudio.addEventListener('error', function() {
                    isReading = false;
                    isPaused = false;
                    currentPosition = 0;
                    updateButtonState();
                    tryPlay(urls); // Try next
                }, { once: true });

                currentAudio.addEventListener('timeupdate', function() {
                    if (!currentAudio.paused) {
                        currentPosition = currentAudio.currentTime;
                    }
                });
            })
            .catch(e => {
                tryPlay(urls);
            });
      }

      tryPlay([...ttsUrls]);
    }

    function pauseTTS() {
        if (currentAudio && !currentAudio.paused) {
            currentPosition = currentAudio.currentTime;
            currentAudio.pause();
            isPaused = true;
            isReading = false;
            updateButtonState();
            statusDiv.textContent = 'â¸ï¸ æœ—è¯»å·²æš‚åœã€‚';
        }
    }

    function resumeTTS() {
        if (currentAudio && isPaused) {
            currentAudio.play()
                .then(() => {
                    isReading = true;
                    isPaused = false;
                    updateButtonState();
                    statusDiv.textContent = 'ğŸ”Š æ­£åœ¨æœ—è¯»...';
                })
                .catch(e => {
                    currentPosition = 0;
                    playSummaryTTS(currentTextToSpeak);
                });
        } else if (!currentAudio || currentAudio.ended) {
            readContent();
        }
    }

    function updateButtonState() {
        const readAloudButton = document.querySelector('.read');
        // ç”±äºè¿™é‡Œæˆ‘ä»¬ç”¨çš„æ˜¯ i æ ‡ç­¾ï¼Œéœ€è¦æ§åˆ¶ class æˆ– tooltip
        const icon = readAloudButton.querySelector('i');
        
        if (isReading) {
            readAloudButton.setAttribute('data-tooltip', 'æš‚åœæœ—è¯»');
            icon.className = 'fa-solid fa-pause';
        } else if (isPaused) {
            readAloudButton.setAttribute('data-tooltip', 'ç»§ç»­æœ—è¯»');
            icon.className = 'fa-solid fa-play';
        } else {
            readAloudButton.setAttribute('data-tooltip', 'æœ—è¯»å…¨æ–‡');
            icon.className = 'fa-solid fa-volume-high';
        }
    }

    function readContent() {
        // [ä¿®æ”¹] ä¸ºäº†æœ—è¯»çº¯å‡€æ–‡æœ¬ï¼Œéœ€è¦å…‹éš†èŠ‚ç‚¹å¹¶ç§»é™¤åˆ†ææŒ‰é’®
        const clone = renderedDiv.cloneNode(true);
        clone.querySelectorAll('.ai-analyze-btn').forEach(b => b.remove());
        const textToRead = clone.innerText.trim();

        if (!textToRead) {
            statusDiv.textContent = "ğŸ¤·â€â™€ï¸ æ²¡æœ‰å†…å®¹å¯ä»¥æœ—è¯»ã€‚";
            return;
        }

        if (isReading) {
            pauseTTS();
        } else if (isPaused) {
            resumeTTS();
        } else {
            currentPosition = 0;
            playSummaryTTS(textToRead);
        }
    }

    // --- Enhanced Mobile Support ---
    themeInput.addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        confirmGenerate(event);
      }
    });

    addStyleInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            addCustomStyle();
        }
    });

    window.addEventListener('click', function(event) {
      if (event.target === storyThemeModal) closeThemeModal();
      if (event.target === settingsModal) closeSettingsModal();
      if (event.target === styleManagementModal) closeStyleManagementModal();
      if (event.target === aiResultModal) closeAiResultModal();
    });

    // --- Initial Load ---
    window.onload = () => {
      loadSettings();
      ensureToken();
      if (GITHUB_TOKEN) {
        loadContent();
      } else {
        statusDiv.textContent = "ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ï¼è¯·è¾“å…¥ GitHub Token ä»¥å¼€å§‹ã€‚";
      }
    };
  </script>
</body>
</html>
