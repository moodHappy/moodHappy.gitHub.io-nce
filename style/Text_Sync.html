<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI é˜…è¯» & GitHub åŒæ­¥åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap');

        /* --- æ ¸å¿ƒå˜é‡ (èåˆç‰ˆ) --- */
        :root {
            --bg-gradient: linear-gradient(135deg, #f8f4f0 0%, #e8e4e0 25%, #f2ede8 50%, #ebe6e1 75%, #f5f1ec 100%);
            --nav-bg: rgba(252, 251, 249, 0.92);
            --primary-color: #8b7355;
            --primary-hover: #6b5b4f;
            --text-main: #2c2c2c;
            --accent-color: #a0522d;
            --modal-overlay-bg: rgba(44, 44, 44, 0.4);
            
            /* AI åˆ†ææŒ‰é’®é¢œè‰² */
            --btn-icon-color: #8b7355;
            --btn-bg-hover: #8b7355;
            --btn-highlight: #d32f2f; /* çº¢è‰²é«˜äº® */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Serif SC', 'Inter', serif;
            line-height: 1.75;
            color: var(--text-main);
            background: var(--bg-gradient);
            background-attachment: fixed;
            padding-top: 80px;
            position: relative;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* èƒŒæ™¯çº¹ç† */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(198, 167, 130, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(158, 125, 95, 0.06) 0%, transparent 50%);
            pointer-events: none; z-index: -1;
        }

        /* --- å¯¼èˆªæ  --- */
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: 64px;
            background: var(--nav-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(139, 115, 85, 0.1);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; z-index: 1000;
            box-shadow: 0 2px 12px rgba(0,0,0,0.03);
        }

        .nav-brand { font-weight: 600; font-size: 1.15em; color: #5a4a3f; user-select: none; display:flex; align-items:center; gap:10px; }
        .nav-actions { display: flex; align-items: center; gap: 8px; }

        /* --- æŒ‰é’®é€šç”¨ --- */
        .icon-btn {
            background: transparent; border: none; cursor: pointer; color: #6b5b4f;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            transition: all 0.2s;
        }
        .icon-btn:hover { background: rgba(139, 115, 85, 0.12); color: var(--primary-color); transform: scale(1.05); }
        .icon-btn:active { transform: scale(0.95); }
        .icon-btn svg { width: 22px; height: 22px; stroke-width: 2px; }

        .read-btn-top {
            height: 40px; background: var(--primary-color); color: #fff; border: none;
            padding: 0 20px; border-radius: 20px; font-family: 'Noto Serif SC', serif;
            font-size: 0.95em; display: flex; align-items: center; justify-content: center;
            gap: 6px; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(139, 115, 85, 0.25); flex-shrink: 0;
        }
        .read-btn-top:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 6px 16px rgba(139, 115, 85, 0.3); }
        .read-btn-top:active { transform: translateY(0); }
        .read-btn-top.reading { background: #fff; color: var(--accent-color); border: 1px solid var(--accent-color); box-shadow: none; }
        .read-btn-top svg { width: 18px; height: 18px; fill: currentColor; }
        
        /* æœ—è¯»æ³¢å½¢åŠ¨ç”» */
        .sound-wave { display: flex; gap: 2px; align-items: center; height: 12px; }
        .bar { width: 2px; background: currentColor; animation: wave 0.8s infinite ease-in-out; }
        .bar:nth-child(1) { animation-delay: 0s; height: 6px; }
        .bar:nth-child(2) { animation-delay: 0.1s; height: 12px; }
        .bar:nth-child(3) { animation-delay: 0.2s; height: 8px; }
        @keyframes wave { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1); } }

        /* --- æ“ä½œæ  (Submit/Edit/Copy) --- */
        .action-bar {
            max-width: 800px; margin: 0 auto 10px; padding: 0 20px;
            display: flex; gap: 10px; flex-wrap: wrap;
        }
        .action-btn {
            padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(139, 115, 85, 0.2);
            background: rgba(255,255,255,0.6); color: #5a4a3f; cursor: pointer; font-size: 0.9em;
            transition: all 0.2s; font-family: 'Inter', sans-serif;
        }
        .action-btn:hover { background: #fff; border-color: var(--primary-color); color: var(--primary-color); }
        .action-btn.primary { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .action-btn.primary:hover { background: var(--primary-hover); }
        .action-btn.danger { color: #d32f2f; border-color: rgba(211, 47, 47, 0.2); }
        .action-btn.danger:hover { background: #ffebee; border-color: #d32f2f; }

        /* --- æ­£æ–‡åŒºåŸŸ --- */
        .content-container { max-width: 800px; margin: 0 auto; padding: 0 20px 40px; }
        
        /* ç¼–è¾‘æ¨¡å¼è¾“å…¥æ¡† */
        #inputContent {
            width: 100%; min-height: 600px; padding: 20px; 
            font-family: 'Noto Serif SC', serif; font-size: 1.1em; line-height: 1.8;
            border: 1px dashed rgba(139, 115, 85, 0.3); border-radius: 12px;
            background: rgba(255,255,255,0.5); color: #333; resize: vertical; outline: none;
            transition: all 0.3s;
        }
        #inputContent:focus { background: #fff; border-color: var(--primary-color); box-shadow: 0 4px 20px rgba(139, 115, 85, 0.1); }

        /* é˜…è¯»æ¨¡å¼å®¹å™¨ */
        #renderedContent {
            min-height: 500px; padding: 10px 5px; font-size: 1.15em; line-height: 1.8; color: #2c2c2c;
            white-space: pre-wrap; display: none; /* é»˜è®¤éšè—ï¼Œç”±JSæ§åˆ¶ */
        }

        /* --- AI åˆ†ææŒ‰é’® (ä¿ç•™ Info å›¾æ ‡æ ·å¼) --- */
        .ai-analyze-btn {
            display: inline-flex; align-items: center; justify-content: center;
            background-color: rgba(139, 115, 85, 0.08); 
            border: 1px solid rgba(139, 115, 85, 0.15);
            border-radius: 50%; width: 22px; height: 22px; margin: 0 3px 0 5px; cursor: pointer;
            color: var(--btn-icon-color); position: relative; top: -1px; transition: all 0.2s;
            vertical-align: middle;
        }
        .ai-analyze-btn:hover { background-color: var(--btn-bg-hover); color: white; transform: scale(1.1); }
        .ai-analyze-btn.last-clicked {
            background-color: var(--btn-highlight) !important;
            color: white !important;
            border-color: var(--btn-highlight) !important;
            transform: scale(1.15); box-shadow: 0 0 8px rgba(211, 47, 47, 0.4);
        }
        .ai-analyze-btn svg { width: 12px; height: 12px; fill: currentColor; }

        /* --- æ¨¡æ€æ¡† (Original Style) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-overlay-bg); backdrop-filter: blur(4px);
            z-index: 2000; display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.25s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-card {
            background: #fcfbf9; width: 92%; max-width: 600px;
            border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.25);
            max-height: 85vh; display: flex; flex-direction: column;
            border: 1px solid rgba(139, 115, 85, 0.1); transform: scale(0.95);
            transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.active .modal-card { transform: scale(1); }
        
        .modal-sticky-header {
            flex-shrink: 0; background: #fcfbf9; padding: 20px 24px 15px;
            border-bottom: 1px solid rgba(139, 115, 85, 0.1); border-radius: 16px 16px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 1.2em; color: #5a4a3f; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        
        .modal-scroll-body { 
            flex: 1; overflow-y: auto; padding: 24px; background: #fff; 
            border-radius: 0 0 16px 16px; -webkit-overflow-scrolling: touch; 
        }

        /* --- AI åˆ†æå†…å®¹æ ·å¼ --- */
        .original-sentence-box { 
            background: #f4f0ec; padding: 16px 20px; border-radius: 10px; 
            border-left: 4px solid var(--primary-color); 
            color: #4a4a4a; font-style: italic; font-size: 1em; line-height: 1.6; margin-bottom: 20px;
        }
        .ai-result-content { line-height: 1.8; color: #333; font-size: 1.05em; }
        .ai-result-content h1, .ai-result-content h2, .ai-result-content h3 { 
            color: #5a4a3f; margin: 1em 0 0.5em; font-size: 1.2em; 
            border-bottom: 1px dashed #e0d5ca; padding-bottom: 5px; 
        }
        .ai-result-content ul { padding-left: 20px; }
        .ai-result-content strong { color: var(--accent-color); background: rgba(160, 82, 45, 0.08); padding: 0 4px; border-radius: 4px; }

        /* --- è¡¨å•å…ƒç´ æ ·å¼ --- */
        .settings-input, .settings-select, .settings-textarea {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd;
            border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 0.95em; background: #fff;
            transition: border 0.2s;
        }
        .settings-input:focus, .settings-textarea:focus { border-color: var(--primary-color); outline: none; }
        
        .save-btn { 
            width: 100%; padding: 12px; background: var(--primary-color); color: white; 
            border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; 
            transition: background 0.2s;
        }
        .save-btn:hover { background: var(--primary-hover); }

        .spinner { width: 30px; height: 30px; border: 3px solid rgba(139,115,85,0.3); border-top-color: #8b7355; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- è¾…åŠ©åŠŸèƒ½ --- */
        .status-bar { font-size: 0.85em; color: #888; text-align: center; margin-top: 10px; }
        .ai-inputs { display: none; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 600px) {
            .navbar { padding: 0 16px; height: 56px; }
            .read-btn-top span { display: none; }
            .action-bar { padding: 0 15px; gap: 8px; }
            .action-btn { flex: 1; text-align: center; padding: 8px 5px; font-size: 0.85em; }
            
            /* åº•éƒ¨å¼¹çª—åŠ¨ç”» */
            .modal-overlay { align-items: flex-end; }
            .modal-card {
                width: 100% !important; max-width: 100%; margin: 0;
                border-radius: 24px 24px 0 0; max-height: 85vh;
                transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            }
            .modal-overlay.active .modal-card { transform: translateY(0); scale: 1; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-brand">
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 1-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
            <span>GitHub Reader</span>
        </div>
        <div class="nav-actions">
            <button id="readAloudButton" class="read-btn-top" title="æœ—è¯»å…¨æ–‡" onclick="readContent()">
                <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <div class="sound-wave" id="waveIcon" style="display:none;"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
                <span id="readBtnText">æœ—è¯»</span>
            </button>
            <button class="icon-btn" onclick="openModal('generateModal')" title="ç”Ÿæˆå¾®å°è¯´">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path><polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon></svg>
            </button>
            <button class="icon-btn" onclick="openSettingsModal()" title="è®¾ç½®">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"></path></svg>
            </button>
        </div>
    </nav>

    <div class="action-bar">
        <button class="action-btn primary" onclick="submitContent()">ğŸ“¤ æäº¤åŒæ­¥</button>
        <button class="action-btn" onclick="toggleEditMode()">âœï¸ ç¼–è¾‘/é˜…è¯»</button>
        <button class="action-btn" onclick="copyContent()">ğŸ“‹ å¤åˆ¶</button>
        <button class="action-btn danger" onclick="deleteContent()">ğŸ—‘ï¸ æ¸…ç©º</button>
    </div>

    <div class="content-container">
        <textarea id="inputContent" placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹ï¼Œæˆ–é…ç½® GitHub Token åŒæ­¥..."></textarea>
        <article id="renderedContent"></article>
        <div id="status" class="status-bar">â³ æ­£åœ¨åˆå§‹åŒ–...</div>
    </div>

    <div id="aiResultModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-sticky-header">
                <div class="modal-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    <span>AI æ·±åº¦åˆ†æ</span>
                </div>
                <button class="icon-btn" onclick="closeModal('aiResultModal')">âœ•</button>
            </div>
            <div class="original-sentence-box" id="aiOriginalSentence"></div>
            <div id="aiResultContent" class="modal-scroll-body"></div>
            <div style="text-align:center; padding:10px; color:#999; font-size:0.8em;">åŒå‡»å¼¹çª—ä»»æ„åŒºåŸŸå…³é—­</div>
        </div>
    </div>

    <div id="tokenModal" class="modal-overlay">
        <div class="modal-card" style="max-width:400px;">
            <div class="modal-sticky-header">
                <div class="modal-title">ğŸ” GitHub Token</div>
            </div>
            <div class="modal-scroll-body">
                <p style="margin-bottom:10px; color:#666;">è¯·è¾“å…¥ GitHub Token ä»¥å¯ç”¨åŒæ­¥åŠŸèƒ½ï¼š</p>
                <input type="password" id="tokenInput" class="settings-input" placeholder="ghp_..." />
                <button class="save-btn" onclick="saveToken()">ä¿å­˜å¹¶å¼€å§‹</button>
            </div>
        </div>
    </div>

    <div id="generateModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-sticky-header">
                <div class="modal-title">âœ¨ åˆ›ä½œå¾®å°è¯´</div>
                <button class="icon-btn" onclick="closeModal('generateModal')">âœ•</button>
            </div>
            <div class="modal-scroll-body">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="themeCategorySelect" class="settings-select"></select>
                    <select id="difficultySelect" class="settings-select" style="width:100px; flex-shrink:0;"></select>
                </div>
                <input type="text" id="themeInput" class="settings-input" placeholder="è¾“å…¥ä¸»é¢˜ï¼Œæˆ–é€‰æ‹©åˆ†ç±»..." />
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="action-btn" style="flex:1" onclick="generateRandomTopics()">ğŸ² ç”Ÿæˆé¢˜ç›®</button>
                    <button class="save-btn" style="flex:1" onclick="confirmGenerate()">å¼€å§‹åˆ›ä½œ</button>
                </div>
                <ul id="randomTopicsList" style="list-style:none; margin-top:15px; padding:0;"></ul>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-sticky-header">
                <div class="modal-title">âš™ï¸ è®¾ç½®</div>
                <button class="icon-btn" onclick="closeModal('settingsModal')">âœ•</button>
            </div>
            <div class="modal-scroll-body">
                <label style="font-weight:600; color:#5a4a3f;">AI æœåŠ¡å•†</label>
                <select id="ai-provider-select" class="settings-select">
                    <option value="kimi">Kimi (Moonshot)</option>
                    <option value="zhipu">æ™ºè°± (ZhipuAI)</option>
                    <option value="custom">è‡ªå®šä¹‰ API</option>
                </select>

                <div id="ai-kimi-inputs" class="ai-inputs">
                    <input type="password" id="ai-kimi-api-key" class="settings-input" placeholder="Kimi API Key (sk-...)" />
                    <input type="text" id="ai-kimi-model-name" class="settings-input" placeholder="Model (moonshot-v1-8k)" />
                </div>
                <div id="ai-zhipu-inputs" class="ai-inputs">
                    <input type="password" id="ai-zhipu-api-key" class="settings-input" placeholder="Zhipu API Key" />
                    <input type="text" id="ai-zhipu-model-name" class="settings-input" placeholder="Model (glm-4)" />
                </div>
                <div id="ai-custom-inputs" class="ai-inputs">
                    <input type="text" id="ai-api-url" class="settings-input" placeholder="API URL" />
                    <input type="password" id="ai-custom-api-key" class="settings-input" placeholder="API Key" />
                    <input type="text" id="ai-custom-model-name" class="settings-input" placeholder="Model Name" />
                </div>

                <label style="font-weight:600; color:#5a4a3f; margin-top:10px; display:block;">AI åˆ†ææŒ‡ä»¤ (System Prompt)</label>
                <textarea id="analysis-prompt-input" class="settings-textarea" rows="4"></textarea>

                <label style="font-weight:600; color:#5a4a3f; margin-top:10px; display:block;">TTS è¯­éŸ³æœåŠ¡</label>
                <input type="text" id="tts-urls" class="settings-input" placeholder="TTS API URL" />
                <input type="text" id="tts-voice-name" class="settings-input" placeholder="Voice Name (e.g. en-US-EricNeural)" />

                <button class="save-btn" onclick="saveAndApplySettings()">ä¿å­˜è®¾ç½®</button>
                <div style="margin-top:15px; text-align:center; font-size:0.9em;">
                    <span id="cacheSizeDisplay">ç¼“å­˜: 0</span> | <a href="#" onclick="clearAICache()" style="color:#a0522d; text-decoration:none;">æ¸…ç©ºç¼“å­˜</a> | <a href="#" onclick="resetToken()" style="color:#d32f2f; text-decoration:none;">é‡ç½® Token</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const GITHUB_USERNAME = "moodHappy";
        const GITHUB_REPO = "HelloWorld";
        const WORD_FILE_PATH_GITHUB = "Notes/transfer.txt";
        const SETTINGS_KEY = "github_reader_settings";
        const LAST_CLICKED_KEY = "ai_reader_last_click";
        const CACHE_PREFIX = "ai_cache_v2_";
        
        // é»˜è®¤æŒ‡ä»¤ (æ›´æ–°å)
        const DEFAULT_ANALYSIS_PROMPT = `ä½ æ˜¯ä¸€ä½ç²¾é€šä¸­è‹±æ–‡çš„è¯­è¨€ä¸“å®¶ã€‚è¯·åˆ†ææˆ‘æä¾›çš„å¥å­ï¼š
1. åˆ¤æ–­éš¾åº¦ç­‰çº§ (A1-C2)ã€‚
2. æä¾›å‡†ç¡®ã€ä¼˜ç¾çš„ä¸­æ–‡ç¿»è¯‘ã€‚
3. å¥ä¸­å…³é”®çŸ­è¯­åŠä¾‹å¥ã€ä¾‹å¥ç¿»è¯‘ã€‚
è¯·ä½¿ç”¨ Markdown æ ¼å¼è¾“å‡ºã€‚`;

        const DEFAULT_SETTINGS = {
            aiProvider: 'kimi',
            aiKimiApiKey: '', aiKimiModelName: 'moonshot-v1-8k',
            aiZhipuApiKey: '', aiZhipuModelName: 'glm-4',
            aiApiUrl: '', aiCustomApiKey: '', aiCustomModelName: '',
            ttsUrls: 'https://ms-ra-forwarder-for-ifreetime-2.vercel.app/',
            ttsVoiceName: 'en-US-EricNeural',
            analysisPrompt: DEFAULT_ANALYSIS_PROMPT
        };

        let GITHUB_TOKEN = localStorage.getItem("github_token");
        const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${WORD_FILE_PATH_GITHUB}`;

        // DOM å…ƒç´ 
        const els = {
            input: document.getElementById('inputContent'),
            rendered: document.getElementById('renderedContent'),
            status: document.getElementById('status'),
            readBtn: document.getElementById('readAloudButton'),
            readBtnText: document.getElementById('readBtnText'),
            playIcon: document.getElementById('playIcon'),
            waveIcon: document.getElementById('waveIcon'),
            providerSelect: document.getElementById('ai-provider-select')
        };

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            if(!GITHUB_TOKEN) openModal('tokenModal');
            else loadContent();

            // åŒå‡»å…³é—­åˆ†æå¼¹çª—é€»è¾‘
            const aiModal = document.getElementById('aiResultModal');
            aiModal.addEventListener('dblclick', (e) => {
                // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåˆ™å…³é—­
                if(window.getSelection().toString().length === 0) {
                    closeModal('aiResultModal');
                }
            });
            
            // ç‚¹å‡»é®ç½©å…³é—­ (é™¤äº† Token å¼¹çª—)
            document.querySelectorAll('.modal-overlay').forEach(m => {
                m.addEventListener('click', (e) => {
                    if(e.target === m && m.id !== 'tokenModal') closeModal(m.id);
                });
            });

            els.providerSelect.addEventListener('change', () => updateAIInputs(els.providerSelect.value));
        });

        // --- æ¨¡æ€æ¡†æ“ä½œ ---
        function openModal(id) { 
            if(id==='generateModal') populateGenSelectors();
            document.getElementById(id).classList.add('active'); 
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        // --- è®¾ç½®ç®¡ç† ---
        function loadSettings() {
            const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || DEFAULT_SETTINGS;
            document.getElementById('analysis-prompt-input').value = s.analysisPrompt || DEFAULT_ANALYSIS_PROMPT;
            document.getElementById('tts-urls').value = s.ttsUrls;
            document.getElementById('tts-voice-name').value = s.ttsVoiceName;
            
            els.providerSelect.value = s.aiProvider;
            document.getElementById('ai-kimi-api-key').value = s.aiKimiApiKey || '';
            document.getElementById('ai-kimi-model-name').value = s.aiKimiModelName || '';
            document.getElementById('ai-zhipu-api-key').value = s.aiZhipuApiKey || '';
            document.getElementById('ai-zhipu-model-name').value = s.aiZhipuModelName || '';
            document.getElementById('ai-api-url').value = s.aiApiUrl || '';
            document.getElementById('ai-custom-api-key').value = s.aiCustomApiKey || '';
            document.getElementById('ai-custom-model-name').value = s.aiCustomModelName || '';
            
            updateAIInputs(s.aiProvider);
            updateCacheDisplay();
        }

        function saveAndApplySettings() {
            const s = {
                aiProvider: els.providerSelect.value,
                aiKimiApiKey: document.getElementById('ai-kimi-api-key').value,
                aiKimiModelName: document.getElementById('ai-kimi-model-name').value,
                aiZhipuApiKey: document.getElementById('ai-zhipu-api-key').value,
                aiZhipuModelName: document.getElementById('ai-zhipu-model-name').value,
                aiApiUrl: document.getElementById('ai-api-url').value,
                aiCustomApiKey: document.getElementById('ai-custom-api-key').value,
                aiCustomModelName: document.getElementById('ai-custom-model-name').value,
                ttsUrls: document.getElementById('tts-urls').value,
                ttsVoiceName: document.getElementById('tts-voice-name').value,
                analysisPrompt: document.getElementById('analysis-prompt-input').value
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
            closeModal('settingsModal');
            els.status.innerText = "âš™ï¸ è®¾ç½®å·²ä¿å­˜";
        }

        function updateAIInputs(provider) {
            document.querySelectorAll('.ai-inputs').forEach(el => el.style.display = 'none');
            if(provider === 'kimi') document.getElementById('ai-kimi-inputs').style.display = 'block';
            else if(provider === 'zhipu') document.getElementById('ai-zhipu-inputs').style.display = 'block';
            else if(provider === 'custom') document.getElementById('ai-custom-inputs').style.display = 'block';
        }

        // --- GitHub é€»è¾‘ ---
        function saveToken() {
            const t = document.getElementById('tokenInput').value.trim();
            if(!t) return alert("Token ä¸èƒ½ä¸ºç©º");
            localStorage.setItem("github_token", t);
            GITHUB_TOKEN = t;
            closeModal('tokenModal');
            loadContent();
        }
        function resetToken() {
            if(confirm('ç¡®å®šé‡ç½® Token å—ï¼Ÿ')) {
                localStorage.removeItem("github_token");
                location.reload();
            }
        }

        async function ghRequest(method, body = null) {
            const headers = { Authorization: `Bearer ${GITHUB_TOKEN}`, Accept: "application/vnd.github.v3+json" };
            const opts = { method, headers };
            if(body) opts.body = JSON.stringify(body);
            const res = await fetch(apiUrl, opts);
            if(res.status === 404 && method === 'GET') return { content: "" }; 
            if(!res.ok) throw new Error(`GitHub Error: ${res.status}`);
            return res.json();
        }

        async function loadContent() {
            els.status.innerText = "ğŸ”„ åŒæ­¥ä¸­...";
            try {
                const data = await ghRequest('GET');
                if(data.content) {
                    const text = decodeURIComponent(escape(atob(data.content)));
                    els.input.value = text;
                    renderMode(text);
                    els.status.innerText = "âœ… åŒæ­¥å®Œæˆ";
                } else {
                    toggleEditMode(true); // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿›å…¥ç¼–è¾‘æ¨¡å¼
                    els.status.innerText = "â„¹ï¸ æ–‡ä»¶ä¸ºç©ºï¼Œè¯·å¼€å§‹ç¼–è¾‘";
                }
            } catch(e) {
                els.status.innerText = "âŒ " + e.message;
            }
        }

        async function submitContent() {
            const text = els.input.value;
            if(!text) return alert("å†…å®¹ä¸ºç©º");
            els.status.innerText = "ğŸ”„ æäº¤ä¸­...";
            try {
                const current = await ghRequest('GET');
                const body = {
                    message: "Update via AI Reader",
                    content: btoa(unescape(encodeURIComponent(text))),
                    committer: { name: "AI Reader", email: "bot@reader.com" }
                };
                if(current.sha) body.sha = current.sha;
                await ghRequest('PUT', body);
                renderMode(text);
                els.status.innerText = "âœ… æäº¤æˆåŠŸ";
            } catch(e) { els.status.innerText = "âŒ " + e.message; }
        }

        async function deleteContent() {
            if(!confirm("ç¡®å®šæ¸…ç©ºè¿œç«¯æ–‡ä»¶å—ï¼Ÿ")) return;
            try {
                const current = await ghRequest('GET');
                if(!current.sha) return els.input.value = "";
                await ghRequest('PUT', {
                    message: "Delete content",
                    content: "",
                    sha: current.sha
                });
                els.input.value = "";
                renderMode("");
                els.status.innerText = "ğŸ—‘ï¸ å·²æ¸…ç©º";
            } catch(e) { alert(e.message); }
        }

        // --- è§†å›¾æ§åˆ¶ ---
        function renderMode(text) {
            els.input.style.display = 'none';
            els.rendered.style.display = 'block';
            els.rendered.innerHTML = '';
            
            // åˆ†æ®µæ¸²æŸ“
            text.split(/\n{2,}/).forEach(para => {
                if(para.trim()) {
                    const p = document.createElement('p');
                    p.innerText = para.trim();
                    els.rendered.appendChild(p);
                }
            });
            
            // æ³¨å…¥ AI æŒ‰é’® (åŸç‰ˆé€»è¾‘)
            injectAIButtons();
        }

        function toggleEditMode(forceEdit = false) {
            if(forceEdit || els.input.style.display === 'none') {
                els.input.style.display = 'block';
                els.rendered.style.display = 'none';
            } else {
                renderMode(els.input.value);
            }
        }
        function copyContent() {
            navigator.clipboard.writeText(els.input.value);
            els.status.innerText = "ğŸ“‹ å·²å¤åˆ¶";
        }

        // --- AI åˆ†æé€»è¾‘ (æ ¸å¿ƒå¤ç”¨) ---
        function injectAIButtons() {
            els.rendered.querySelectorAll('.ai-analyze-btn').forEach(b=>b.remove());
            const walker = document.createTreeWalker(els.rendered, NodeFilter.SHOW_TEXT);
            const nodes = []; while(walker.nextNode()) nodes.push(walker.currentNode);
            
            nodes.forEach(node => {
                if(node.nodeValue.includes('.')) {
                    const frag = document.createDocumentFragment();
                    const parts = node.nodeValue.split(/(\.)/);
                    parts.forEach(part => {
                        frag.appendChild(document.createTextNode(part));
                        if(part === '.') {
                            const btn = document.createElement('span');
                            btn.className = 'ai-analyze-btn';
                            // ä¿æŒåŸå§‹ Info Icon æ ·å¼
                            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 15h-2v-2h2zm0-4h-2V7h2z"/></svg>';
                            btn.onclick = (e) => handleAIAnalyze(e.target);
                            frag.appendChild(btn);
                        }
                    });
                    node.parentNode.replaceChild(frag, node);
                }
            });

            // æ¢å¤é«˜äº®
            const lastIdx = localStorage.getItem(LAST_CLICKED_KEY);
            if(lastIdx) {
                const btns = els.rendered.querySelectorAll('.ai-analyze-btn');
                if(btns[lastIdx]) btns[lastIdx].classList.add('last-clicked');
            }
        }

        function extractSentence(btn) {
            let text = "";
            let curr = btn.previousSibling;
            while(curr) {
                if(curr.nodeType === 3) {
                    text = curr.nodeValue + text;
                    if(text.lastIndexOf('.') > -1 && text.lastIndexOf('.') < text.length-1) {
                        text = text.substring(text.lastIndexOf('.')+1);
                        break;
                    }
                } else if(curr.classList?.contains('ai-analyze-btn')) {
                    break;
                } else {
                    text = curr.innerText + text;
                }
                curr = curr.previousSibling;
            }
            return text.trim();
        }

        async function handleAIAnalyze(target) {
            const btn = target.closest('.ai-analyze-btn');
            if(!btn) return;
            
            // é«˜äº®é€»è¾‘
            document.querySelectorAll('.ai-analyze-btn').forEach(b=>b.classList.remove('last-clicked'));
            btn.classList.add('last-clicked');
            const allBtns = Array.from(document.querySelectorAll('.ai-analyze-btn'));
            localStorage.setItem(LAST_CLICKED_KEY, allBtns.indexOf(btn));

            const sentence = extractSentence(btn);
            if(!sentence || sentence.length < 2) return;

            const modal = document.getElementById('aiResultModal');
            const box = document.getElementById('aiResultContent');
            document.getElementById('aiOriginalSentence').innerText = sentence;
            
            openModal('aiResultModal');
            box.innerHTML = '<div class="spinner"></div><p style="text-align:center">æ­£åœ¨åˆ†æ...</p>';

            // ç¼“å­˜æ£€æŸ¥
            const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || DEFAULT_SETTINGS;
            const prompt = s.analysisPrompt || DEFAULT_ANALYSIS_PROMPT;
            const cacheKey = CACHE_PREFIX + hashCode(sentence + prompt);
            const cached = getCache(cacheKey);

            if(cached) {
                box.innerHTML = `<div class="ai-result-content">${marked.parse(cached)}</div>`;
                return;
            }

            try {
                const res = await callAI(s, [{role:"system", content: prompt}, {role:"user", content: `Analyze: "${sentence}"`}]);
                setCache(cacheKey, res);
                box.innerHTML = `<div class="ai-result-content">${marked.parse(res)}</div>`;
            } catch(e) {
                box.innerHTML = `<p style="color:#d32f2f">Error: ${e.message}</p>`;
            }
        }

        // --- é€šç”¨ AI è°ƒç”¨ ---
        async function callAI(settings, messages) {
            let url, key, model;
            if(settings.aiProvider === 'kimi') {
                url = "https://api.moonshot.cn/v1/chat/completions";
                key = settings.aiKimiApiKey; model = settings.aiKimiModelName;
            } else if(settings.aiProvider === 'zhipu') {
                url = "https://open.bigmodel.cn/api/paas/v4/chat/completions";
                key = settings.aiZhipuApiKey; model = settings.aiZhipuModelName;
            } else {
                url = settings.aiApiUrl;
                key = settings.aiCustomApiKey; model = settings.aiCustomModelName;
            }

            if(!key) throw new Error("API Key æœªé…ç½®");

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({ model, messages, temperature: 0.7 })
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.error?.message || "API Error");
            return data.choices[0].message.content;
        }

        // --- ç”ŸæˆåŠŸèƒ½ ---
        const THEMES = ['æ—¥å¸¸ç”Ÿæ´»','æ‚¬ç–‘æ¨ç†','ç§‘å¹»å¥‡å¹»','å“²ç†å¯“è¨€','çˆ±æƒ…æƒ…æ„Ÿ','å¹½é»˜è®½åˆº'];
        function populateGenSelectors() {
            const sel = document.getElementById('themeCategorySelect');
            sel.innerHTML = '<option value="">é€‰æ‹©åˆ†ç±»</option>';
            THEMES.forEach(t => sel.add(new Option(t,t)));
            
            const diff = document.getElementById('difficultySelect');
            diff.innerHTML = '';
            ['A1','A2','B1','B2','C1'].forEach(l => diff.add(new Option(l,l)));
            diff.value = 'B1';
        }

        async function generateRandomTopics() {
            const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || DEFAULT_SETTINGS;
            const cat = document.getElementById('themeCategorySelect').value || "Random";
            const list = document.getElementById('randomTopicsList');
            list.innerHTML = '<li style="text-align:center; color:#999;">ç”Ÿæˆä¸­...</li>';
            
            try {
                const res = await callAI(s, [{role:"user", content: `Generate 5 creative short story titles in Simplified Chinese based on category "${cat}". Just list them.`}]);
                list.innerHTML = '';
                res.split('\n').forEach(line => {
                    const title = line.replace(/^\d+\.\s*/, '').replace(/["ã€Šã€‹]/g, '').trim();
                    if(title) {
                        const li = document.createElement('li');
                        li.innerText = title;
                        li.style.cssText = "padding:8px; border-bottom:1px solid #eee; cursor:pointer;";
                        li.onclick = () => startGen(title);
                        list.appendChild(li);
                    }
                });
            } catch(e) { list.innerHTML = `<li>Error: ${e.message}</li>`; }
        }

        function confirmGenerate() {
            const t = document.getElementById('themeInput').value || document.getElementById('themeCategorySelect').value;
            if(t) startGen(t);
        }

        async function startGen(topic) {
            closeModal('generateModal');
            els.status.innerText = `âœï¸ æ­£åœ¨åˆ›ä½œ: ${topic}...`;
            const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || DEFAULT_SETTINGS;
            const diff = document.getElementById('difficultySelect').value;
            
            try {
                const prompt = `Write a short story in English (Level ${diff}) about "${topic}". About 100-150 words.`;
                const text = await callAI(s, [{role:"user", content: prompt}]);
                els.input.value = text;
                renderMode(text);
                submitContent(); // è‡ªåŠ¨ä¿å­˜
            } catch(e) { els.status.innerText = "âŒ " + e.message; }
        }

        // --- TTS ---
        let audioCtx = null;
        function readContent() {
            const btn = els.readBtn;
            if(btn.classList.contains('reading')) {
                if(audioCtx) { audioCtx.pause(); audioCtx = null; }
                btn.classList.remove('reading');
                els.playIcon.style.display = 'block';
                els.waveIcon.style.display = 'none';
                els.readBtnText.innerText = "æœ—è¯»";
            } else {
                const text = els.rendered.style.display === 'none' ? els.input.value : els.rendered.innerText;
                if(!text) return;
                
                const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || DEFAULT_SETTINGS;
                const urls = s.ttsUrls.split(',');
                const q = new URLSearchParams({ text: text.trim(), voiceName: s.ttsVoiceName, speed: -20 });
                
                // ç®€å•è½®è¯¢æ’­æ”¾
                const play = (idx) => {
                    if(idx >= urls.length) return alert("TTS è¿æ¥å¤±è´¥");
                    const u = urls[idx].trim().replace(/\/$/,'');
                    audioCtx = new Audio(`${u}/api/aiyue?${q}`);
                    audioCtx.play().then(() => {
                        btn.classList.add('reading');
                        els.playIcon.style.display = 'none';
                        els.waveIcon.style.display = 'flex';
                        els.readBtnText.innerText = "åœæ­¢";
                        audioCtx.onended = () => readContent(); // è‡ªåŠ¨é‡ç½®çŠ¶æ€
                    }).catch(() => play(idx+1));
                };
                play(0);
            }
        }

        // --- ç¼“å­˜å·¥å…· ---
        function hashCode(str) {
            let h = 0; for(let i=0; i<str.length; i++) h = Math.imul(31, h) + str.charCodeAt(i) | 0;
            return h;
        }
        function setCache(k, v) { localStorage.setItem(k, JSON.stringify({t:Date.now(), v})); updateCacheDisplay(); }
        function getCache(k) {
            const d = JSON.parse(localStorage.getItem(k));
            if(!d || Date.now()-d.t > 86400000) { localStorage.removeItem(k); return null; }
            return d.v;
        }
        function clearAICache() {
            Object.keys(localStorage).forEach(k=>k.startsWith(CACHE_PREFIX) && localStorage.removeItem(k));
            updateCacheDisplay();
        }
        function updateCacheDisplay() {
            let c=0; Object.keys(localStorage).forEach(k=>k.startsWith(CACHE_PREFIX) && c++);
            document.getElementById('cacheSizeDisplay').innerText = `ç¼“å­˜: ${c}`;
        }

    </script>
</body>
</html>
