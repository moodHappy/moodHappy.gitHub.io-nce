<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GitHub åŒæ­¥åŠ©æ‰‹</title>
  <style>
    /* CSS Variables for theming and typography */
    :root {
      --bg-color: #f9f9f9;
      --text-color: #222;
      --textarea-bg-color: #fff;
      --textarea-border-color: #ccc;
      --article-bg-color: #fff;
      --article-border-color: #ccc;
      --status-color: #444;
      --button-primary-bg: #4CAF50;
      --button-secondary-bg: #2196F3;
      --button-danger-bg: #f44336;
      --button-generate-bg: #800080;
      --modal-bg: rgba(0,0,0,0.5);
      --modal-content-bg: #fff;
      --input-border-color: #aaa;
      --settings-icon-color: #333;

      --primary-font: 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      --font-size: 17px;
      --line-height: 1.6;
    }

    /* Dark Theme */
    body.theme-dark {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --textarea-bg-color: #1e1e1e;
      --textarea-border-color: #444;
      --article-bg-color: #1e1e1e;
      --article-border-color: #444;
      --status-color: #aaa;
      --modal-content-bg: #2d2d2d;
      --input-border-color: #555;
      --settings-icon-color: #ccc;
    }

    /* Sepia Theme */
    body.theme-sepia {
      --bg-color: #f4f0e8;
      --text-color: #5b4636;
      --textarea-bg-color: #fdfaf3;
      --textarea-border-color: #dcd3c3;
      --article-bg-color: #fdfaf3;
      --article-border-color: #dcd3c3;
      --status-color: #5b4636;
      --modal-content-bg: #fdfaf3;
      --input-border-color: #c9bca8;
      --settings-icon-color: #5b4636;
    }

    body {
      font-family: var(--primary-font);
      background: var(--bg-color);
      color: var(--text-color);
      padding: 1em;
      transition: background-color 0.3s, color 0.3s;
    }

    textarea, article.immersive-content {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      padding: 12px;
      font-size: var(--font-size);
      line-height: var(--line-height);
      background-color: var(--article-bg-color);
      border: 1px solid var(--article-border-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    textarea {
      min-height: 150px;
      resize: vertical;
      overflow: hidden; /* Hide scrollbar, but still scrollable */
      background-color: var(--textarea-bg-color);
      border-color: var(--textarea-border-color);
    }

    button {
      margin: 6px 6px 6px 0;
      padding: 10px 16px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      color: white;
      cursor: pointer;
      background-color: var(--button-primary-bg);
      /* ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šå¢åŠ è§¦æ‘¸ç›®æ ‡å¤§å° */
      min-height: 44px;
      min-width: 44px;
    }
    button.copy { background-color: var(--button-secondary-bg); }
    button.delete { background-color: var(--button-danger-bg); }
    button.generate { background-color: var(--button-generate-bg); }

    #status {
      margin-top: 10px;
      color: var(--status-color);
      font-size: 14px;
    }

    #settings-icon {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: var(--settings-icon-color);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: var(--modal-bg);
      display: none; /* Initially hidden */
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      background: var(--modal-content-bg);
      color: var(--text-color);
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }
    .modal-content h3 {
      margin-top: 0;
    }
    .modal-content input, .modal-content select {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid var(--input-border-color);
      background-color: var(--textarea-bg-color);
      color: var(--text-color);
      box-sizing: border-box;
    }
    .modal-content label {
      display: block;
      margin-top: 15px;
      font-size: 14px;
      color: var(--status-color);
    }

    article.immersive-content {
      line-height: var(--line-height);
      font-size: var(--font-size);
    }
    article.immersive-content p {
      margin-bottom: 1em;
      white-space: pre-wrap;
    }

    .ai-inputs {
        display: none;
    }
  </style>
</head>
<body>
  <div id="settings-icon" title="è®¾ç½®" onclick="openSettingsModal()">âš™ï¸</div>
  <h2>ğŸ“¤ GitHub åŒæ­¥åŠ©æ‰‹</h2>

  <div>
    <button onclick="submitContent()">æäº¤</button>
    <button class="delete" onclick="deleteContent()">åˆ é™¤</button>
    <button class="copy" onclick="copyContent()">å¤åˆ¶</button>
    <button class="generate" onclick="generateStory()">ç”Ÿæˆ</button>
  </div>

  <textarea id="inputContent" placeholder="è¯·è¾“å…¥è‹±æ–‡æ–‡æœ¬ï¼ˆæ”¯æŒå¤šæ®µï¼Œæ¯æ®µç”¨ç©ºè¡Œåˆ†éš”ï¼‰..."></textarea>
  <article id="renderedContent" class="immersive-content" style="display:none;"></article>

  <div id="status">â³ æ­£åœ¨åˆå§‹åŒ–...</div>

  <div id="tokenModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ” è¯·è¾“å…¥ä½ çš„ GitHub Tokenï¼š</h3>
      <input type="password" id="tokenInput" placeholder="ghp_xxx æˆ– github_pat_xxx" />
      <button style="margin-top:10px;" onclick="saveToken()">ä¿å­˜ Token</button>
    </div>
  </div>

  <div id="storyThemeModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ“š è¯·è¾“å…¥å¾®å°è¯´çš„åˆ›ä½œä¸»é¢˜ï¼š</h3>
      <input type="text" id="themeInput" placeholder="ä¾‹å¦‚ï¼šå¤ªç©ºæ—…è¡Œã€å¤è€çš„å›¾ä¹¦é¦†..." />
      <button style="margin-top:10px;" onclick="handleStartGeneration(event)">ç¡®å®š</button>
      <button style="margin-top:10px; background-color: #6c757d;" onclick="closeThemeModal()">å–æ¶ˆ</button>
    </div>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h3>âš™ï¸ ä¸ªæ€§åŒ–è®¾ç½®</h3>

      <label for="theme-select">ç•Œé¢ä¸»é¢˜</label>
      <select id="theme-select">
        <option value="">é»˜è®¤ (äº®è‰²)</option>
        <option value="theme-dark">æŠ¤çœ¼ (æš—è‰²)</option>
        <option value="theme-sepia">çº¸å¼  (ç±³è‰²)</option>
      </select>

      <label for="font-family-select">é˜…è¯»å­—ä½“</label>
      <select id="font-family-select">
        <option value="'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif">æ— è¡¬çº¿ä½“ (é»˜è®¤)</option>
        <option value="'Georgia', 'Noto Serif SC', 'Songti SC', serif">è¡¬çº¿ä½“</option>
        <option value="'Courier New', 'SFMono-Regular', 'Consolas', monospace">ç­‰å®½å­—ä½“</option>
      </select>

      <label for="font-size-select">å†…å®¹å­—å·</label>
      <select id="font-size-select">
          <option value="15px">å°</option>
          <option value="17px">ä¸­ (é»˜è®¤)</option>
          <option value="19px">å¤§</option>
          <option value="21px">ç‰¹å¤§</option>
      </select>

      <label for="line-height-select">æ®µè½è¡Œé«˜</label>
      <select id="line-height-select">
          <option value="1.4">ç´§å‡‘</option>
          <option value="1.6">é€‚ä¸­ (é»˜è®¤)</option>
          <option value="1.8">å®½æ¾</option>
      </select>

      <hr style="border: 0; border-top: 1px solid var(--textarea-border-color); margin: 20px 0;">
      
      <label for="ai-provider-select">AI æ¨¡å‹æœåŠ¡å•†</label>
      <select id="ai-provider-select">
        <option value="kimi">Kimi</option>
        <option value="zhipu">æ™ºè°± (Zhipu)</option>
        <option value="custom">è‡ªå®šä¹‰</option>
      </select>

      <div id="ai-kimi-inputs" class="ai-inputs">
        <label for="ai-kimi-api-key">Kimi API Key</label>
        <input type="password" id="ai-kimi-api-key" placeholder="sk-xxx" />
        <label for="ai-kimi-model-name">Kimi æ¨¡å‹åç§°</label>
        <input type="text" id="ai-kimi-model-name" placeholder="moonshot-v1-8k" />
      </div>

      <div id="ai-zhipu-inputs" class="ai-inputs">
        <label for="ai-zhipu-api-key">æ™ºè°± API Key</label>
        <input type="password" id="ai-zhipu-api-key" placeholder="sk-xxx" />
        <label for="ai-zhipu-model-name">æ™ºè°± æ¨¡å‹åç§°</label>
        <input type="text" id="ai-zhipu-model-name" placeholder="glm-4" />
      </div>

      <div id="ai-custom-inputs" class="ai-inputs">
        <label for="ai-api-url">è‡ªå®šä¹‰ API URL</label>
        <input type="text" id="ai-api-url" placeholder="ä¾‹å¦‚ï¼šhttps://api.example.com/v1/chat/completions" />
        <label for="ai-custom-api-key">è‡ªå®šä¹‰ API Key</label>
        <input type="password" id="ai-custom-api-key" placeholder="sk-xxx" />
        <label for="ai-custom-model-name">è‡ªå®šä¹‰ æ¨¡å‹åç§°</label>
        <input type="text" id="ai-custom-model-name" placeholder="ä¾‹å¦‚ï¼šgpt-3.5-turbo" />
      </div>

      <hr style="border: 0; border-top: 1px solid var(--textarea-border-color); margin: 20px 0;">

      <button class="delete" onclick="resetToken()">é‡è®¾ GitHub Token</button>
      <button style="margin-top:10px; float: right;" onclick="saveAndApplySettings()">ä¿å­˜å¹¶å…³é—­</button>
    </div>
  </div>


  <script>
    const GITHUB_USERNAME = "moodHappy";
    const GITHUB_REPO = "HelloWorld";
    const WORD_FILE_PATH_GITHUB = "Notes/transfer.txt";
    const SETTINGS_KEY = "github_sync_assistant_settings";

    const DEFAULT_KIMI_API_URL = "https://api.moonshot.cn/v1/chat/completions";
    const DEFAULT_KIMI_MODEL = "moonshot-v1-8k";
    
    const DEFAULT_ZHIPU_API_URL = "https://open.bigmodel.cn/api/paas/v4/chat/completions";
    const DEFAULT_ZHIPU_MODEL = "glm-4";

    let GITHUB_TOKEN = localStorage.getItem("github_token") || null;
    const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${WORD_FILE_PATH_GITHUB}`;

    const textarea = document.getElementById("inputContent");
    const renderedDiv = document.getElementById("renderedContent");
    const statusDiv = document.getElementById("status");
    const tokenModal = document.getElementById("tokenModal");
    const settingsModal = document.getElementById("settingsModal");
    const storyThemeModal = document.getElementById("storyThemeModal");
    const themeInput = document.getElementById("themeInput");
    const rootElement = document.documentElement;
    
    // AI Settings Elements
    const aiProviderSelect = document.getElementById('ai-provider-select');
    const aiKimiInputsDiv = document.getElementById('ai-kimi-inputs');
    const aiZhipuInputsDiv = document.getElementById('ai-zhipu-inputs');
    const aiCustomInputsDiv = document.getElementById('ai-custom-inputs');
    
    // Kimi Inputs
    const aiKimiApiKeyInput = document.getElementById('ai-kimi-api-key');
    const aiKimiModelNameInput = document.getElementById('ai-kimi-model-name');
    
    // Zhipu Inputs
    const aiZhipuApiKeyInput = document.getElementById('ai-zhipu-api-key');
    const aiZhipuModelNameInput = document.getElementById('ai-zhipu-model-name');
    
    // Custom Inputs
    const aiApiUrlInput = document.getElementById('ai-api-url');
    const aiCustomApiKeyInput = document.getElementById('ai-custom-api-key');
    const aiCustomModelNameInput = document.getElementById('ai-custom-model-name');


    // --- Settings Management ---
    const defaultSettings = {
        theme: '',
        fontFamily: "'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif",
        fontSize: '17px',
        lineHeight: '1.6',
        aiProvider: 'kimi',
        aiKimiApiKey: '',
        aiKimiModelName: DEFAULT_KIMI_MODEL,
        aiZhipuApiKey: '',
        aiZhipuModelName: DEFAULT_ZHIPU_MODEL,
        aiApiUrl: '',
        aiCustomApiKey: '',
        aiCustomModelName: ''
    };

    function applySettings(settings) {
        document.body.className = settings.theme || '';
        rootElement.style.setProperty('--primary-font', settings.fontFamily);
        rootElement.style.setProperty('--font-size', settings.fontSize);
        rootElement.style.setProperty('--line-height', settings.lineHeight);
        
        aiProviderSelect.value = settings.aiProvider;
        updateAIInputsVisibility(settings.aiProvider);
    }
    
    function loadSettings() {
        const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY));
        const currentSettings = { ...defaultSettings, ...savedSettings };
        applySettings(currentSettings);
        
        // Load AI values into inputs
        aiKimiApiKeyInput.value = currentSettings.aiKimiApiKey;
        aiKimiModelNameInput.value = currentSettings.aiKimiModelName;
        aiZhipuApiKeyInput.value = currentSettings.aiZhipuApiKey;
        aiZhipuModelNameInput.value = currentSettings.aiZhipuModelName;
        aiApiUrlInput.value = currentSettings.aiApiUrl;
        aiCustomApiKeyInput.value = currentSettings.aiCustomApiKey;
        aiCustomModelNameInput.value = currentSettings.aiCustomModelName;
    }
    
    function updateAIInputsVisibility(provider) {
        aiKimiInputsDiv.style.display = provider === 'kimi' ? 'block' : 'none';
        aiZhipuInputsDiv.style.display = provider === 'zhipu' ? 'block' : 'none';
        aiCustomInputsDiv.style.display = provider === 'custom' ? 'block' : 'none';
    }

    aiProviderSelect.addEventListener('change', (event) => {
        updateAIInputsVisibility(event.target.value);
    });

    function openSettingsModal() {
        const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || defaultSettings;
        document.getElementById('theme-select').value = savedSettings.theme;
        document.getElementById('font-family-select').value = savedSettings.fontFamily;
        document.getElementById('font-size-select').value = savedSettings.fontSize;
        document.getElementById('line-height-select').value = savedSettings.lineHeight;

        // Load AI settings into modal
        aiProviderSelect.value = savedSettings.aiProvider;
        aiKimiApiKeyInput.value = savedSettings.aiKimiApiKey;
        aiKimiModelNameInput.value = savedSettings.aiKimiModelName;
        aiZhipuApiKeyInput.value = savedSettings.aiZhipuApiKey;
        aiZhipuModelNameInput.value = savedSettings.aiZhipuModelName;
        aiApiUrlInput.value = savedSettings.aiApiUrl;
        aiCustomApiKeyInput.value = savedSettings.aiCustomApiKey;
        aiCustomModelNameInput.value = savedSettings.aiCustomModelName;
        
        updateAIInputsVisibility(savedSettings.aiProvider);

        settingsModal.style.display = "flex";
    }

    function closeSettingsModal() {
        settingsModal.style.display = "none";
    }
    
    function saveAndApplySettings() {
        const newSettings = {
            theme: document.getElementById('theme-select').value,
            fontFamily: document.getElementById('font-family-select').value,
            fontSize: document.getElementById('font-size-select').value,
            lineHeight: document.getElementById('line-height-select').value,
            aiProvider: aiProviderSelect.value,
            aiKimiApiKey: aiKimiApiKeyInput.value,
            aiKimiModelName: aiKimiModelNameInput.value,
            aiZhipuApiKey: aiZhipuApiKeyInput.value,
            aiZhipuModelName: aiZhipuModelNameInput.value,
            aiApiUrl: aiApiUrlInput.value,
            aiCustomApiKey: aiCustomApiKeyInput.value,
            aiCustomModelName: aiCustomModelNameInput.value
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(newSettings));
        applySettings(newSettings);
        closeSettingsModal();
        statusDiv.textContent = "âš™ï¸ è®¾ç½®å·²ä¿å­˜ã€‚";
    }

    // --- GitHub Token Management ---
    function ensureToken() {
      if (!GITHUB_TOKEN) {
        tokenModal.style.display = "flex";
      }
    }

    function saveToken() {
      const token = document.getElementById("tokenInput").value.trim();
      if (!token.startsWith("ghp_") && !token.startsWith("github_pat_")) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ GitHub Tokenï¼");
        return;
      }
      localStorage.setItem("github_token", token);
      GITHUB_TOKEN = token;
      tokenModal.style.display = "none";
      statusDiv.textContent = "â³ æ­£åœ¨åŠ è½½ GitHub å†…å®¹...";
      loadContent();
    }

    function resetToken() {
      if (confirm("ç¡®å®šè¦æ¸…é™¤å·²ä¿å­˜çš„ GitHub Token å¹¶é‡æ–°è¾“å…¥å—ï¼Ÿ")) {
        localStorage.removeItem("github_token");
        GITHUB_TOKEN = null;
        closeSettingsModal();
        ensureToken();
      }
    }

    // --- Core GitHub API Functions ---
    function getHeaders() {
      return {
        Authorization: `Bearer ${GITHUB_TOKEN}`,
        Accept: "application/vnd.github.v3+json"
      };
    }

    async function getCurrentFileShaAndContent() {
      try {
        const res = await fetch(apiUrl, { headers: getHeaders() });
        if (res.status === 404) {
             statusDiv.textContent = "â„¹ï¸ ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæäº¤æ—¶å°†è‡ªåŠ¨åˆ›å»ºã€‚";
             return { sha: null, content: "" };
        }
        if (!res.ok) throw new Error(`GitHub çŠ¶æ€ç  ${res.status}`);
        const data = await res.json();
        const decoded = decodeURIComponent(escape(atob(data.content)));
        return { sha: data.sha, content: decoded };
      } catch (err) {
        console.warn("è¯»å–å¤±è´¥ï¼š", err.message);
        statusDiv.textContent = `âŒ è¯»å–å¤±è´¥: ${err.message}. è¯·æ£€æŸ¥ Token æˆ–ç½‘ç»œã€‚`;
        return { sha: null, content: "" };
      }
    }

    async function submitContent() {
      const content = textarea.value.trim();
      if (!content) return alert("è¯·è¾“å…¥å†…å®¹å†æäº¤ï¼");
      statusDiv.textContent = "ğŸ”„ æ­£åœ¨æäº¤åˆ° GitHub...";

      const { sha } = await getCurrentFileShaAndContent();
      const encodedContent = btoa(unescape(encodeURIComponent(content)));

      const res = await fetch(apiUrl, {
        method: "PUT",
        headers: { ...getHeaders(), "Content-Type": "application/json" },
        body: JSON.stringify({
          message: `Update ${WORD_FILE_PATH_GITHUB}`,
          content: encodedContent,
          committer: { name: "GitHub Sync Assistant", email: "bot@example.com" },
          ...(sha ? { sha } : {})
        })
      });

      if (res.ok) {
        renderMode(content);
        statusDiv.textContent = "âœ… æäº¤æˆåŠŸï¼Œæ®µè½å·²æ¸²æŸ“ã€‚";
      } else {
        statusDiv.textContent = "âŒ æäº¤å¤±è´¥ï¼š" + (await res.json()).message;
      }
    }

    async function deleteContent() {
      if (!confirm("ç¡®å®šè¦æ¸…ç©º GitHub ä¸Šçš„æ–‡ä»¶å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚")) return;

      statusDiv.textContent = "ğŸ—‘ï¸ æ­£åœ¨æ¸…ç©º GitHub æ–‡ä»¶...";
      const { sha } = await getCurrentFileShaAndContent();
      if (!sha) {
        textarea.value = "";
        editMode();
        statusDiv.textContent = "âœ… æ–‡ä»¶æœ¬å°±ä¸ºç©ºæˆ–ä¸å­˜åœ¨ã€‚";
        return;
      }

      const res = await fetch(apiUrl, {
        method: "PUT",
        headers: { ...getHeaders(), "Content-Type": "application/json" },
        body: JSON.stringify({
          message: `Empty ${WORD_FILE_PATH_GITHUB}`,
          content: btoa(""),
          sha,
          committer: { name: "GitHub Sync Assistant", email: "bot@example.com" }
        })
      });

      if (res.ok) {
        textarea.value = "";
        editMode();
        statusDiv.textContent = "âœ… GitHub å†…å®¹å·²æ¸…ç©ºã€‚";
      } else {
        statusDiv.textContent = "âŒ åˆ é™¤å¤±è´¥ï¼š" + (await res.json()).message;
      }
    }
    
    // --- AI Generation Functions (Updated with Mobile Fix) ---
    function generateStory() {
      // ç‚¹å‡»ç”ŸæˆæŒ‰é’®æ—¶ï¼Œæ˜¾ç¤ºä¸»é¢˜è¾“å…¥å¼¹çª—
      storyThemeModal.style.display = "flex";
      // å»¶è¿Ÿèšç„¦ä»¥ç¡®ä¿å¼¹çª—å®Œå…¨æ˜¾ç¤º
      setTimeout(() => {
        themeInput.focus();
      }, 100);
    }
    
    function closeThemeModal() {
        storyThemeModal.style.display = "none";
    }

    // ä¿®å¤ç§»åŠ¨ç«¯ç‚¹å‡»é—®é¢˜çš„æ ¸å¿ƒå‡½æ•°
    function handleStartGeneration(event) {
      // é˜»æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶å†’æ³¡
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }

      // å…ˆå¤±ç„¦è¾“å…¥æ¡†ï¼Œç¡®ä¿é”®ç›˜æ”¶èµ·
      themeInput.blur();

      // æ·»åŠ å»¶è¿Ÿç¡®ä¿é”®ç›˜å®Œå…¨æ”¶èµ·åå†æ‰§è¡Œ
      setTimeout(() => {
        startGeneration();
      }, 200);
    }

    async function startGeneration() {
      const theme = themeInput.value.trim();
      closeThemeModal(); // å…³é—­å¼¹çª—

      const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || defaultSettings;
      let aiApiUrl, aiApiKey, aiModelName;

      switch (savedSettings.aiProvider) {
        case 'kimi':
            aiApiUrl = DEFAULT_KIMI_API_URL;
            aiApiKey = savedSettings.aiKimiApiKey;
            aiModelName = savedSettings.aiKimiModelName || DEFAULT_KIMI_MODEL;
            if (!aiApiKey) {
                statusDiv.textContent = "âŒ è¯·åœ¨è®¾ç½®ä¸­è¾“å…¥ Kimi çš„ API Keyï¼";
                return;
            }
            break;
        case 'zhipu':
            aiApiUrl = DEFAULT_ZHIPU_API_URL;
            aiApiKey = savedSettings.aiZhipuApiKey;
            aiModelName = savedSettings.aiZhipuModelName || DEFAULT_ZHIPU_MODEL;
            if (!aiApiKey) {
                statusDiv.textContent = "âŒ è¯·åœ¨è®¾ç½®ä¸­è¾“å…¥ æ™ºè°± çš„ API Keyï¼";
                return;
            }
            break;
        case 'custom':
            aiApiUrl = savedSettings.aiApiUrl;
            aiApiKey = savedSettings.aiCustomApiKey;
            aiModelName = savedSettings.aiCustomModelName;
            if (!aiApiUrl || !aiApiKey || !aiModelName) {
                statusDiv.textContent = "âŒ è¯·åœ¨è®¾ç½®ä¸­è¡¥å…¨è‡ªå®šä¹‰ AI çš„æ‰€æœ‰ä¿¡æ¯ï¼";
                return;
            }
            break;
      }

      const prompt = theme ? `Write a short story in English, about 100 words, with the theme of: ${theme}.` : `Write a short story in English, about 100 words, with a random, creative theme.`;

      statusDiv.textContent = "âœ¨ æ­£åœ¨è°ƒç”¨ AI ç”Ÿæˆå¾®å°è¯´...";
      editMode();

      try {
        const response = await fetch(aiApiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${aiApiKey}`
          },
          body: JSON.stringify({
            model: aiModelName,
            messages: [
              { role: "system", content: "You are a helpful assistant." },
              { role: "user", content: prompt }
            ],
            temperature: 0.7
          })
        });

        if (!response.ok) {
          throw new Error(`API è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status} - ${await response.text()}`);
        }

        const data = await response.json();
        const storyContent = data.choices[0].message.content.trim();
        textarea.value = storyContent;

        statusDiv.textContent = "âœ… å¾®å°è¯´ç”ŸæˆæˆåŠŸï¼æ­£åœ¨è‡ªåŠ¨æäº¤åˆ° GitHub...";
        await submitContent();
      } catch (error) {
        statusDiv.textContent = `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`;
        console.error("ç”Ÿæˆå¤±è´¥:", error);
      }
    }

    // --- UI & Content Handling ---
    function copyContent() {
      const content = renderedDiv.style.display !== "none" ? renderedDiv.innerText : textarea.value;
      if (!content) {
        statusDiv.textContent = "ğŸ¤·â€â™€ï¸ å†…å®¹ä¸ºç©ºï¼Œæ— éœ€å¤åˆ¶ã€‚";
        return;
      }
      navigator.clipboard.writeText(content);
      statusDiv.textContent = "ğŸ“‹ å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚";
    }

    function renderMode(text) {
      renderedDiv.innerHTML = "";
      const paragraphs = text.split(/\n{2,}/);
      for (const para of paragraphs) {
        if (para.trim()) {
          const p = document.createElement("p");
          p.textContent = para.trim();
          renderedDiv.appendChild(p);
        }
      }
      renderedDiv.style.display = "block";
      textarea.style.display = "none";
    }

    function editMode() {
      textarea.style.display = "block";
      renderedDiv.style.display = "none";
    }

    async function loadContent() {
      statusDiv.textContent = "â³ æ­£åœ¨åŠ è½½ GitHub å†…å®¹...";
      const { content } = await getCurrentFileShaAndContent();
      if (content.trim()) {
        textarea.value = content;
        renderMode(content);
        statusDiv.textContent = "âœ… GitHub å†…å®¹å·²åŠ è½½å¹¶æ¸²æŸ“ã€‚";
      } else {
        textarea.value = "";
        editMode();
        statusDiv.textContent = "âœ… GitHub å†…å®¹ä¸ºç©ºï¼Œè¯·ç¼–è¾‘ã€‚";
      }
    }

    // --- Enhanced Mobile Support ---
    // æ·»åŠ å›è½¦é”®æ”¯æŒ
    themeInput.addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        handleStartGeneration(event);
      }
    });

    // æ¨¡æ€çª—å£ç‚¹å‡»å¤–éƒ¨å…³é—­
    window.addEventListener('click', function(event) {
      if (event.target === storyThemeModal) {
        closeThemeModal();
      }
      if (event.target === settingsModal) {
        closeSettingsModal();
      }
    });

    // --- Initial Load ---
    window.onload = () => {
      loadSettings();
      ensureToken();
      if (GITHUB_TOKEN) {
        loadContent();
      } else {
        statusDiv.textContent = "ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ï¼è¯·è¾“å…¥ GitHub Token ä»¥å¼€å§‹ã€‚";
      }
    };
  </script>
</body>
</html>
