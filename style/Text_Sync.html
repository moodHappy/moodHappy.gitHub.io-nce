<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>GitHub æ–‡æœ¬åŒæ­¥å™¨</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea { width: 100%; height: 150px; font-size: 16px; }
    button { margin-top: 10px; padding: 8px 16px; margin-right: 10px; }
    #status { margin-top: 10px; color: #333; }
  </style>
</head>
<body>
  <h2>ğŸ“¤ GitHub æ–‡æœ¬åŒæ­¥å™¨</h2>
  <textarea id="inputContent" placeholder="åŠ è½½ä¸­æˆ–è¾“å…¥å†…å®¹..."></textarea><br>
  <button onclick="submitContent()">æäº¤</button>
  <button onclick="deleteContent()">åˆ é™¤</button>
  <div id="status">â³ æ­£åœ¨åŠ è½½ GitHub å†…å®¹...</div>

  <script>
    const GITHUB_USERNAME = "moodHappy";
    const GITHUB_REPO = "HelloWorld";
    const GITHUB_TOKEN = "";
    const WORD_FILE_PATH_GITHUB = "Notes/transfer.txt";

    const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${WORD_FILE_PATH_GITHUB}`;
    const headers = {
      Authorization: `Bearer ${GITHUB_TOKEN}`,
      "Content-Type": "application/json"
    };

    async function getCurrentFileShaAndContent() {
      const res = await fetch(apiUrl, { headers });
      if (res.status === 404) return { sha: null, content: "" };
      const data = await res.json();
      const decoded = decodeURIComponent(escape(atob(data.content)));
      return { sha: data.sha, content: decoded };
    }

    async function submitContent() {
      const textarea = document.getElementById("inputContent");
      const content = textarea.value.trim();
      if (!content) return alert("è¯·è¾“å…¥å†…å®¹å†æäº¤ï¼");

      document.getElementById("status").textContent = "ğŸ”„ æ­£åœ¨æäº¤åˆ° GitHub...";

      const { sha } = await getCurrentFileShaAndContent();
      const encodedContent = btoa(unescape(encodeURIComponent(content)));

      const res = await fetch(apiUrl, {
        method: "PUT",
        headers,
        body: JSON.stringify({
          message: "æ›´æ–° transfer.txt",
          content: encodedContent,
          committer: { name: "AutoCommit", email: "bot@example.com" },
          ...(sha ? { sha } : {})
        })
      });

      if (res.ok) {
        document.getElementById("status").textContent = "âœ… æäº¤æˆåŠŸï¼Œå†…å®¹å·²åŒæ­¥ã€‚";
      } else {
        const err = await res.json();
        document.getElementById("status").textContent = "âŒ æäº¤å¤±è´¥ï¼š" + (err.message || res.statusText);
      }
    }

    async function deleteContent() {
      document.getElementById("status").textContent = "ğŸ—‘ï¸ æ­£åœ¨æ¸…ç©º GitHub æ–‡ä»¶...";
      const { sha } = await getCurrentFileShaAndContent();
      if (!sha) {
        document.getElementById("status").textContent = "âœ… æ–‡ä»¶å·²ä¸ºç©ºï¼Œæ— éœ€åˆ é™¤ã€‚";
        return;
      }

      const res = await fetch(apiUrl, {
        method: "PUT",
        headers,
        body: JSON.stringify({
          message: "æ¸…ç©º transfer.txt",
          content: btoa(""),
          sha,
          committer: { name: "AutoCommit", email: "bot@example.com" }
        })
      });

      if (res.ok) {
        document.getElementById("inputContent").value = "";
        document.getElementById("status").textContent = "âœ… åˆ é™¤æˆåŠŸï¼ŒGitHub å†…å®¹å·²æ¸…ç©ºã€‚";
      } else {
        const err = await res.json();
        document.getElementById("status").textContent = "âŒ åˆ é™¤å¤±è´¥ï¼š" + (err.message || res.statusText);
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å– GitHub å†…å®¹
    window.onload = async () => {
      const textarea = document.getElementById("inputContent");
      const status = document.getElementById("status");

      try {
        const { content } = await getCurrentFileShaAndContent();
        textarea.value = content;
        status.textContent = "âœ… å·²åŠ è½½ GitHub å†…å®¹ã€‚";
      } catch (err) {
        status.textContent = "âš ï¸ æ— æ³•åŠ è½½ GitHub å†…å®¹ï¼š" + err.message;
      }
    };
  </script>
</body>
</html>