<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GitHub 同步与文件管理助手</title>
  <style>
    /* CSS Variables for theming and typography */
    :root {
      --bg-color: #f9f9f9;
      --text-color: #222;
      --textarea-bg-color: #fff;
      --textarea-border-color: #ccc;
      --article-bg-color: #fff;
      --article-border-color: #ccc;
      --status-color: #444;
      --button-primary-bg: #4CAF50;
      --button-secondary-bg: #2196F3;
      --button-danger-bg: #f44336;
      --modal-bg: rgba(0,0,0,0.5);
      --modal-content-bg: #fff;
      --input-border-color: #aaa;
      --settings-icon-color: #333;
      --log-color: green;
      --link-color: #007bff; /* Added for links */

      --primary-font: 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      --font-size: 17px;
      --line-height: 1.6;
    }

    /* Dark Theme */
    body.theme-dark {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --textarea-bg-color: #1e1e1e;
      --textarea-border-color: #444;
      --article-bg-color: #1e1e1e;
      --article-border-color: #444;
      --status-color: #aaa;
      --modal-content-bg: #2d2d2d;
      --input-border-color: #555;
      --settings-icon-color: #ccc;
      --log-color: #90EE90; /* Light green for dark theme */
      --link-color: #61affe; /* Light blue for links in dark theme */
    }

    /* Sepia Theme */
    body.theme-sepia {
      --bg-color: #f4f0e8;
      --text-color: #5b4636;
      --textarea-bg-color: #fdfaf3;
      --textarea-border-color: #dcd3c3;
      --article-bg-color: #fdfaf3;
      --article-border-color: #dcd3c3;
      --status-color: #5b4636;
      --modal-content-bg: #fdfaf3;
      --input-border-color: #c9bca8;
      --settings-icon-color: #5b4636;
      --log-color: #487635; /* Darker green for sepia theme */
      --link-color: #964B00; /* Brown for links in sepia theme */
    }

    body {
      font-family: var(--primary-font);
      background: var(--bg-color);
      color: var(--text-color);
      padding: 1em;
      transition: background-color 0.3s, color 0.3s;
      max-width: 800px;
      margin: auto;
    }

    textarea, article.immersive-content, input[type="text"], input[type="password"] {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      padding: 12px;
      font-size: var(--font-size);
      line-height: var(--line-height);
      background-color: var(--textarea-bg-color);
      border: 1px solid var(--textarea-border-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
      margin-bottom: 10px;
    }

    textarea {
      min-height: 150px;
      resize: vertical;
      overflow: hidden; /* Hide scrollbar, but still scrollable */
    }

    button {
      margin: 6px 6px 6px 0;
      padding: 10px 16px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      color: white;
      cursor: pointer;
      background-color: var(--button-primary-bg);
    }
    button.copy { background-color: var(--button-secondary-bg); }
    button.delete { background-color: var(--button-danger-bg); }
    button.file-upload { background-color: var(--button-primary-bg); }
    button.file-delete { background-color: var(--button-danger-bg); }
    button.copy-link { background-color: var(--button-secondary-bg); margin-left: 0; } /* Specific style for copy link button */


    #status, #log {
      margin-top: 10px;
      font-size: 14px;
      white-space: pre-wrap;
    }
    #status { color: var(--status-color); }
    #log { color: var(--log-color); }
    #shareLinkContainer {
        margin-top: 10px;
        font-size: 14px;
        color: var(--status-color);
        display: none; /* Hidden by default */
    }
    #shareLink {
        word-break: break-all;
        color: var(--link-color);
        text-decoration: none;
    }
    #shareLink:hover {
        text-decoration: underline;
    }


    #settings-icon {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: var(--settings-icon-color);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: var(--modal-bg);
      display: none; /* Initially hidden */
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      background: var(--modal-content-bg);
      color: var(--text-color);
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }
    .modal-content h3 {
      margin-top: 0;
    }
    .modal-content input, .modal-content select {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid var(--input-border-color);
      background-color: var(--textarea-bg-color);
      color: var(--text-color);
      box-sizing: border-box;
    }
    .modal-content label {
      display: block;
      margin-top: 15px;
      font-size: 14px;
      color: var(--status-color);
    }

    article.immersive-content {
      line-height: var(--line-height);
      font-size: var(--font-size);
    }
    article.immersive-content p {
      margin-bottom: 1em;
      white-space: pre-wrap;
    }

    hr {
      border: 0;
      border-top: 1px solid var(--textarea-border-color);
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div id="settings-icon" title="设置" onclick="openSettingsModal()">⚙️</div>
  <h2>📤 GitHub 同步助手</h2>

  <div>
    <button onclick="submitContent()">提交（同步文字）</button>
    <button class="delete" onclick="deleteContent()">删除（清空同步文字）</button>
    <button class="copy" onclick="copyContent()">复制（同步文字）</button>
  </div>

  <textarea id="inputContent" placeholder="请输入英文文本（支持多段，每段用空行分隔）..."></textarea>
  <article id="renderedContent" class="immersive-content" style="display:none;"></article>

  <div id="status">⏳ 正在初始化...</div>

  <hr>

  <h2>📦 GitHub 文件管理</h2>
  <label>选择文件:</label>
  <input id="fileInput" type="file" onchange="autoFillPath()" />
  <label>上传到 GitHub 路径: <strong id="filePathDisplay">Notes/</strong><span id="fileNameInput"></span></label>
  <button class="file-upload" onclick="uploadFile()">⬆️ 上传文件到 GitHub</button>
  <button id="deleteFileBtn" class="file-delete" style="display:none;" onclick="deleteUploadedFile()">🗑️ 删除当前上传的文件</button>

  <div id="shareLinkContainer">
    分享链接: <a id="shareLink" href="#" target="_blank"></a>
    <button class="copy-link" onclick="copyShareLink()">复制链接</button>
  </div>


  <label>文件内容预览 (仅文本文件支持):</label>
  <textarea id="fileContentPreview" placeholder="文件内容（仅文本文件支持显示）" style="height:150px;"></textarea>

  <div id="log"></div>

  <div id="tokenModal" class="modal">
    <div class="modal-content">
      <h3>🔐 请输入你的 GitHub Token：</h3>
      <input type="password" id="tokenInput" placeholder="ghp_xxx 或 github_pat_xxx" />
      <button style="margin-top:10px;" onclick="saveToken()">保存 Token</button>
    </div>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h3>⚙️ 个性化设置</h3>

      <label for="theme-select">界面主题</label>
      <select id="theme-select">
        <option value="">默认 (亮色)</option>
        <option value="theme-dark">护眼 (暗色)</option>
        <option value="theme-sepia">纸张 (米色)</option>
      </select>

      <label for="font-family-select">阅读字体</label>
      <select id="font-family-select">
        <option value="'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif">无衬线体 (默认)</option>
        <option value="'Georgia', 'Noto Serif SC', 'Songti SC', serif">衬线体</option>
        <option value="'Courier New', 'SFMono-Regular', 'Consolas', monospace">等宽字体</option>
      </select>

      <label for="font-size-select">内容字号</label>
      <select id="font-size-select">
          <option value="15px">小</option>
          <option value="17px">中 (默认)</option>
          <option value="19px">大</option>
          <option value="21px">特大</option>
      </select>

      <label for="line-height-select">段落行高</label>
      <select id="line-height-select">
          <option value="1.4">紧凑</option>
          <option value="1.6">适中 (默认)</option>
          <option value="1.8">宽松</option>
      </select>

      <hr style="border: 0; border-top: 1px solid var(--textarea-border-color); margin: 20px 0;">

      <button class="delete" onclick="resetToken()">重设 GitHub Token</button>
      <button style="margin-top:10px; float: right;" onclick="saveAndApplySettings()">保存并关闭</button>
    </div>
  </div>


  <script>
    const GITHUB_USERNAME = "moodHappy";
    const GITHUB_REPO = "HelloWorld";
    const NOTES_FOLDER_PATH = "Notes/"; // Define the fixed folder path
    const WORD_FILE_PATH_GITHUB = NOTES_FOLDER_PATH + "transfer.txt"; // Full path for text sync file
    const SETTINGS_KEY = "github_sync_assistant_settings";

    let GITHUB_TOKEN = localStorage.getItem("github_token") || null;
    const syncApiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${WORD_FILE_PATH_GITHUB}`;

    // Elements for Text Sync
    const inputContentTextarea = document.getElementById("inputContent");
    const renderedContentDiv = document.getElementById("renderedContent");
    const statusDiv = document.getElementById("status");

    // Elements for File Management
    const fileInput = document.getElementById("fileInput");
    const fileNameInputSpan = document.getElementById("fileNameInput"); // To display only the file name
    const fileContentPreview = document.getElementById("fileContentPreview");
    const logDiv = document.getElementById("log");
    const deleteFileButton = document.getElementById("deleteFileBtn");
    const shareLinkContainer = document.getElementById("shareLinkContainer");
    const shareLink = document.getElementById("shareLink");

    let currentUploadedFilePath = null; // Stores the full path of the currently uploaded file for deletion
    let currentUploadedFileSha = null; // SHA for the currently uploaded/viewed file for deletion

    // Modals
    const tokenModal = document.getElementById("tokenModal");
    const settingsModal = document.getElementById("settingsModal");
    const rootElement = document.documentElement;

    // --- Settings Management ---
    const defaultSettings = {
        theme: '',
        fontFamily: "'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif",
        fontSize: '17px',
        lineHeight: '1.6'
    };

    function applySettings(settings) {
        document.body.className = settings.theme || '';
        rootElement.style.setProperty('--primary-font', settings.fontFamily);
        rootElement.style.setProperty('--font-size', settings.fontSize);
        rootElement.style.setProperty('--line-height', settings.lineHeight);
    }

    function loadSettings() {
        const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY));
        const currentSettings = { ...defaultSettings, ...savedSettings };
        applySettings(currentSettings);
    }

    function openSettingsModal() {
        const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || defaultSettings;
        document.getElementById('theme-select').value = savedSettings.theme;
        document.getElementById('font-family-select').value = savedSettings.fontFamily;
        document.getElementById('font-size-select').value = savedSettings.fontSize;
        document.getElementById('line-height-select').value = savedSettings.lineHeight;
        settingsModal.style.display = "flex";
    }

    function closeSettingsModal() {
        settingsModal.style.display = "none";
    }

    function saveAndApplySettings() {
        const newSettings = {
            theme: document.getElementById('theme-select').value,
            fontFamily: document.getElementById('font-family-select').value,
            fontSize: document.getElementById('font-size-select').value,
            lineHeight: document.getElementById('line-height-select').value
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(newSettings));
        applySettings(newSettings);
        closeSettingsModal();
        statusDiv.textContent = "⚙️ 设置已保存。";
    }


    // --- GitHub Token Management ---
    function ensureToken() {
      if (!GITHUB_TOKEN) {
        tokenModal.style.display = "flex";
      }
    }

    function saveToken() {
      const token = document.getElementById("tokenInput").value.trim();
      if (!token.startsWith("ghp_") && !token.startsWith("github_pat_")) {
        alert("请输入有效的 GitHub Token！");
        return;
      }
      localStorage.setItem("github_token", token);
      GITHUB_TOKEN = token;
      tokenModal.style.display = "none";
      statusDiv.textContent = "⏳ 正在加载 GitHub 内容...";
      loadContent(); // Load content for the text sync section
    }

    function resetToken() {
      if (confirm("确定要清除已保存的 GitHub Token 并重新输入吗？")) {
        localStorage.removeItem("github_token");
        GITHUB_TOKEN = null;
        closeSettingsModal();
        ensureToken();
      }
    }

    // --- Common GitHub API Helper ---
    function getHeaders() {
      return {
        Authorization: `Bearer ${GITHUB_TOKEN}`,
        Accept: "application/vnd.github.v3+json"
      };
    }

    async function getFileShaAndContent(filePath) {
      const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${filePath}`;
      try {
        const res = await fetch(url, { headers: getHeaders() });
        if (res.status === 404) {
             return { sha: null, content: null };
        }
        if (!res.ok) throw new Error(`GitHub API 错误：状态码 ${res.status}`);
        const data = await res.json();
        const decoded = decodeURIComponent(escape(atob(data.content)));
        return { sha: data.sha, content: decoded };
      } catch (err) {
        console.warn(`读取文件 ${filePath} 失败：`, err.message);
        throw err; // Re-throw to be handled by specific functions
      }
    }

    // --- Text Sync Functions (Original Code) ---
    async function getCurrentSyncFileShaAndContent() {
      try {
        const { sha, content } = await getFileShaAndContent(WORD_FILE_PATH_GITHUB);
        if (sha === null) {
          statusDiv.textContent = "ℹ️ 同步文字文件不存在，提交时将自动创建。";
        }
        return { sha, content: content || "" };
      } catch (err) {
        statusDiv.textContent = `❌ 读取同步文字失败: ${err.message}. 请检查 Token 或网络。`;
        return { sha: null, content: "" };
      }
    }

    async function submitContent() {
      const content = inputContentTextarea.value.trim();
      if (!content) return alert("请输入内容再提交！");
      statusDiv.textContent = "🔄 正在提交同步文字到 GitHub...";

      const { sha } = await getCurrentSyncFileShaAndContent();
      const encodedContent = btoa(unescape(encodeURIComponent(content)));

      const res = await fetch(syncApiUrl, {
        method: "PUT",
        headers: { ...getHeaders(), "Content-Type": "application/json" },
        body: JSON.stringify({
          message: `Update ${WORD_FILE_PATH_GITHUB}`,
          content: encodedContent,
          committer: { name: "GitHub Sync Assistant", email: "bot@example.com" },
          ...(sha ? { sha } : {})
        })
      });

      if (res.ok) {
        renderMode(content);
        statusDiv.textContent = "✅ 同步文字提交成功，段落已渲染。";
      } else {
        const errorData = await res.json();
        statusDiv.textContent = `❌ 同步文字提交失败：${errorData.message}`;
      }
    }

    async function deleteContent() {
      if (!confirm("确定要清空 GitHub 上的同步文件内容吗？此操作不可逆。")) return;

      statusDiv.textContent = "🗑️ 正在清空 GitHub 同步文件...";
      const { sha } = await getCurrentSyncFileShaAndContent();
      if (!sha) {
        inputContentTextarea.value = "";
        editMode();
        statusDiv.textContent = "✅ 同步文件本就为空或不存在。";
        return;
      }

      const res = await fetch(syncApiUrl, {
        method: "PUT", // GitHub API requires PUT with empty content to "delete" by clearing
        headers: { ...getHeaders(), "Content-Type": "application/json" },
        body: JSON.stringify({
          message: `Empty ${WORD_FILE_PATH_GITHUB}`,
          content: btoa(""),
          sha,
          committer: { name: "GitHub Sync Assistant", email: "bot@example.com" }
        })
      });

      if (res.ok) {
        inputContentTextarea.value = "";
        editMode();
        statusDiv.textContent = "✅ GitHub 同步内容已清空。";
      } else {
        const errorData = await res.json();
        statusDiv.textContent = `❌ 清空同步文件失败：${errorData.message}`;
      }
    }

    function copyContent() {
      const content = renderedContentDiv.style.display !== "none" ? renderedContentDiv.innerText : inputContentTextarea.value;
      if (!content) {
        statusDiv.textContent = "🤷‍♀️ 内容为空，无需复制。";
        return;
      }
      navigator.clipboard.writeText(content);
      statusDiv.textContent = "📋 内容已复制到剪贴板。";
    }

    function renderMode(text) {
      renderedContentDiv.innerHTML = ""; // Clear previous content
      const paragraphs = text.split(/\n{2,}/); // Split by one or more empty lines
      for (const para of paragraphs) {
        if (para.trim()) {
          const p = document.createElement("p");
          p.textContent = para.trim();
          renderedContentDiv.appendChild(p);
        }
      }
      renderedContentDiv.style.display = "block";
      inputContentTextarea.style.display = "none";
    }

    function editMode() {
      inputContentTextarea.style.display = "block";
      renderedContentDiv.style.display = "none";
    }

    async function loadContent() {
      statusDiv.textContent = "⏳ 正在加载 GitHub 同步文字内容...";
      try {
        const { content } = await getCurrentSyncFileShaAndContent();
        if (content && content.trim()) {
          inputContentTextarea.value = content; // Pre-fill textarea in case user wants to edit
          renderMode(content);
          statusDiv.textContent = "✅ GitHub 同步文字内容已加载并渲染。";
        } else {
          inputContentTextarea.value = "";
          editMode();
          statusDiv.textContent = "✅ GitHub 同步文字内容为空，请编辑。";
        }
      } catch (e) {
        // Error already handled by getCurrentSyncFileShaAndContent
      }
    }

    // --- File Management Functions (Integrated Code) ---
    function autoFillPath() {
      if (fileInput.files.length > 0) {
        const filename = fileInput.files[0].name;
        fileNameInputSpan.textContent = filename; // Display only the filename next to "Notes/"
        currentUploadedFilePath = NOTES_FOLDER_PATH + filename; // Set the full path for upload/delete
      } else {
        fileNameInputSpan.textContent = "";
        currentUploadedFilePath = null;
      }
      fileContentPreview.value = ""; // Clear preview when new file selected
      deleteFileButton.style.display = "none"; // Hide delete button until uploaded/checked
      shareLinkContainer.style.display = "none"; // Hide link container
      currentUploadedFileSha = null;
    }

    async function uploadFile() {
      if (!GITHUB_TOKEN) {
        alert("请先保存 GitHub Token！");
        ensureToken();
        return;
      }

      const file = fileInput.files[0];
      const path = currentUploadedFilePath; // Use the pre-filled path
      logDiv.textContent = ""; // Clear previous log
      fileContentPreview.value = "";
      deleteFileButton.style.display = "none";
      shareLinkContainer.style.display = "none"; // Hide link container
      currentUploadedFileSha = null;

      if (!file || !path) {
        logDiv.textContent = "❌ 请选择文件。";
        return;
      }

      if (file.size > 100 * 1024 * 1024) {
        logDiv.textContent = "❌ 文件过大，GitHub API 不支持超过 100MB 的上传。";
        return;
      }

      logDiv.textContent = `📦 正在读取 ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)...`;

      const reader = new FileReader();
      reader.onload = async () => {
        const base64Data = reader.result.split(',')[1];
        const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${path}`;

        let sha = null;
        try {
          const { sha: existingSha } = await getFileShaAndContent(path);
          if (existingSha) {
            sha = existingSha;
            logDiv.textContent += "\n📄 目标文件已存在，将覆盖。";
          } else {
            logDiv.textContent += "\n📄 目标文件不存在，将新建。";
          }
        } catch (e) {
          logDiv.textContent += "\n⚠️ 获取旧 SHA 失败，将尝试新建或覆盖： " + e.message;
        }

        const res = await fetch(url, {
          method: "PUT",
          headers: { ...getHeaders(), "Content-Type": "application/json" },
          body: JSON.stringify({
            message: `Upload ${file.name}`,
            content: base64Data,
            sha: sha,
            committer: { name: "GitHub Sync Assistant", email: "bot@example.com" }
          })
        });

        if (!res.ok) {
          const err = await res.json();
          logDiv.textContent += `\n❌ 上传失败：${res.status}\n${err.message}`;
          return;
        }

        logDiv.textContent += `\n✅ 上传成功！开始下载确认内容...`;

        try {
          const downData = await (await fetch(url, { headers: getHeaders() })).json();
          currentUploadedFileSha = downData.sha;

          // Generate and display shareable link
          const rawGitUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/main/${path}`;
          shareLink.href = rawGitUrl;
          shareLink.textContent = rawGitUrl;
          shareLinkContainer.style.display = "block";


          try {
            const content = atob(downData.content.replace(/\n/g, ""));
            // Basic check for binary content (non-printable characters)
            if (/[^\x20-\x7E\s]/.test(content)) { // Detect non-printable ASCII or extended chars
              fileContentPreview.value = "[非文本文件，无法显示内容]";
            } else {
              fileContentPreview.value = content;
            }
          } catch {
            fileContentPreview.value = "[内容解码失败]";
          }

          deleteFileButton.style.display = "block";
          logDiv.textContent += "\n✅ 下载完成，显示内容。你现在可以删除该文件或分享链接。";
        } catch (e) {
          logDiv.textContent += "\n⚠️ 下载确认失败：" + e.message;
        }
      };
      reader.readAsDataURL(file);
    }

    async function deleteUploadedFile() {
      if (!GITHUB_TOKEN) {
        alert("请先保存 GitHub Token！");
        ensureToken();
        return;
      }

      const pathToDelete = currentUploadedFilePath; // Use the stored full path
      if (!pathToDelete || !currentUploadedFileSha) {
        logDiv.textContent = "❌ 无法删除：没有选择文件或文件 SHA 不存在。";
        return;
      }

      if (!confirm(`确定删除 GitHub 文件 ${pathToDelete} 吗？此操作不可恢复！`)) {
        return;
      }

      const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${pathToDelete}`;

      try {
        const res = await fetch(url, {
          method: "DELETE",
          headers: { ...getHeaders(), "Content-Type": "application/json" },
          body: JSON.stringify({
            message: `Delete ${pathToDelete}`,
            sha: currentUploadedFileSha,
            committer: { name: "GitHub Sync Assistant", email: "bot@example.com" }
          })
        });

        if (!res.ok) {
          const err = await res.json();
          logDiv.textContent = `❌ 删除失败：${res.status}\n${err.message}`;
          return;
        }

        logDiv.textContent = `✅ 删除成功：${pathToDelete}`;
        fileContentPreview.value = "";
        deleteFileButton.style.display = "none";
        shareLinkContainer.style.display = "none"; // Hide link container on delete
        currentUploadedFileSha = null;
        currentUploadedFilePath = null; // Clear stored path
        fileInput.value = ''; // Clear file input selection
        fileNameInputSpan.textContent = ""; // Clear displayed file name
      } catch (e) {
        logDiv.textContent = "❌ 删除请求异常：" + e.message;
      }
    }

    function copyShareLink() {
        const link = shareLink.textContent;
        if (!link) {
            logDiv.textContent = "🤷‍♀️ 没有可复制的分享链接。";
            return;
        }
        navigator.clipboard.writeText(link);
        logDiv.textContent = "📋 分享链接已复制到剪贴板。";
    }

    // --- Initial Load ---
    window.onload = () => {
      loadSettings();
      ensureToken();
      if (GITHUB_TOKEN) {
        loadContent(); // Load content for the text sync section
      } else {
        statusDiv.textContent = "👋 欢迎使用！请输入 GitHub Token 以开始。";
      }
    };
  </script>
</body>
</html>
